"use strict";function _objectSpread(a){for(var b=1;b<arguments.length;b++){var c=null!=arguments[b]?arguments[b]:{},d=Object.keys(c);"function"==typeof Object.getOwnPropertySymbols&&(d=d.concat(Object.getOwnPropertySymbols(c).filter(function(a){return Object.getOwnPropertyDescriptor(c,a).enumerable}))),d.forEach(function(b){_defineProperty(a,b,c[b])})}return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var Interactive=function(){function a(){_classCallCheck(this,a),this.ready=0,this.content=document.getElementById("content"),this.overlay=null,this._16x9=null,this.video=document.getElementById("video"),this.mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.url=new URLSearchParams(location.search),this.debug=!!this.getCookie("test_interactive"),this.needToInitInteractive=void 0,this.needToInitChecked=!1,this.initialized=!1,this.playerState=void 0,this.needShowInteractive=this.debug||"yes"===this.url.get("interactive"),this.currentPositionIndex=void 0,this.domain=this.getDomain(),this.embed=this.url.get("embed"),this.isMobileApp=!!/^com.ipspirates.ort/i.test(window.navigator.userAgent)||!!/^ru.ottmedia.android/i.test(window.navigator.userAgent)||!!/^ru.ottmedia.ios/i.test(window.navigator.userAgent),this.ottTestPlaylist="30378",this.ottPlaylist=this.debug?this.ottTestPlaylist:this.url.get("ott-playlist"),this.queryForEmbed=this.getQueryForEmbed(),this.is4Orbit=4===+this.url.get("offcet"),this.advertInProcess=!1,this.checkNeedToInit(),this.initMainEmbed()}return _createClass(a,[{key:"getApiURL",value:function(){switch(location.hostname||document.domain){case"stage.1tv.ru":case"local.1tv.ru":return"https://stage.1tv.ru/api";case"cm.1tv.ru":return"https://cm.1tv.ru/api";default:return"https://api.1tv.ru"}}},{key:"checkNeedToInit",value:function(){var a=this;fetch(this.getApiURL()+"/www/v1/interactive_mode_in_player").then(function(a){return a.json()}).then(function(b){return a.needToInitInteractive=b.data.interactive_disabled===!1}).catch(function(a){return console.log("Error: "+a)}).finally(function(){a.needToInitChecked=!0,"playing"===a.playerState&&a.initialized!==!0&&a.needToInitInteractive===!0&&interactive.initOtt()})}},{key:"initMainEmbed",value:function(){this.video.setAttribute("src","".concat(this.embed,"?").concat(this.queryForEmbed))}},{key:"initOtt",value:function(){var a=this;this.initialized=!0,this._16x9=document.createElement("div"),this._16x9.id="_16x9";var b=this.ottPlaylist?"https://static-hbb.1tv.ru/integration/1tv/?type=stream&playlist=".concat(this.ottPlaylist):"https://static-hbb.1tv.ru/integration/1tv/?type=stream";!this.ottPlaylist&&this.is4Orbit&&(b+="&offset=4"),this._16x9.innerHTML='\n      <iframe\n        id="overlay"\n        frameborder="0"\n        allow="autoplay; encrypted-media"\n        scrolling="yes"\n        src="'.concat(b,'"\n      ></iframe>\n    '),this.content.appendChild(this._16x9),this.overlay=document.getElementById("overlay"),this.wr(),window.addEventListener("resize",function(){a.needShowInteractive&&(a.wr(),a.checkMobileInteractive())}),window.addEventListener("orientationchange",function(){interactive._16x9.style.zIndex="",interactive.switchStream(),interactive.mobileResize("reset"),interactive.sendAboutMobileTo1tv("toDesktop")}),document.addEventListener("fullscreenchange",function(b){document.fullscreenElement?(a.content.classList.add("interactive-fullscreen"),a.checkMobileInteractive()):(a.content.classList.remove("interactive-fullscreen"),a.switchStream())})}},{key:"checkAvailableDomain",value:function(a){if(this.isMobileApp)return!0;var b=/[A-z0-9]+\.(1tv+\.ru|teletarget.ru)(:[0-9]{4})?(\/[^.]*|)$/g;return a?!!a.match(b):!!this.domain.match(b)}},{key:"distroyInteractiveFrame",value:function(){this._16x9.parentNode.removeChild(this._16x9),this.overlay=null,this.ready=0}},{key:"getDomain",value:function(){var a=document.createElement("a");return a.href=this.url.get("__location")?this.url.get("__location"):document.referrer.toString(),a.hostname}},{key:"getQueryForEmbed",value:function(){var a=new URLSearchParams(location.search),b=a.get("__location"),c=a.get("embed");a.delete("embed"),a.delete("ott-playlist"),b?c.indexOf("public_live")===-1&&b.indexOf("1tv.ru")!==-1&&(a.delete("__location"),a.append("__location","http://restricted")):this.domain.indexOf("1tv.ru")===-1&&a.append("__location","https://".concat(this.domain));var d=decodeURIComponent(a.toString());return d}},{key:"switchMini",value:function(){this.content.classList.add("mini");var a="mini",b={left:"",top:"",width:"",height:""};Object.assign(this.video.style,b),Object.assign(this._16x9.style,b),Object.assign(this.overlay.style,b),this.overlay.contentWindow.postMessage({type:"layout",layout:a},"*")}},{key:"switchStream",value:function(){this.content.classList.remove("mini"),this.wr();var a="stream";this.overlay.contentWindow.postMessage({type:"layout",layout:a},"*")}},{key:"mobileResize",value:function(a){var b=this.video.getBoundingClientRect(),c=b.width/16*9;return"reset"===a?void(this.video.style.height=""):void(this.video.style.height=c+"px")}},{key:"sendAboutMobileTo1tv",value:function(a){var b={event:"toggleMobileInteractive",data:{action:a},remote_msg_1tv:!0},c=this.url.get("embed_id");c&&(b.embed_id=c),parent.postMessage(JSON.stringify(b),"*")}},{key:"toMobileInteractive",value:function(){this.content.classList.contains("mini")?this.switchStream():this.switchMini()}},{key:"resize",value:function(a){if(a){var b=this._16x9.getBoundingClientRect(),c=this.content.getBoundingClientRect();this.video.size=a,100===+a.width&&100===+a.height?Object.assign(this.video.style,{left:0,top:0,width:"100%",height:"100%"}):Object.assign(this.video.style,{left:b.left-c.left+a.left/100*b.width+"px",top:b.top-c.top+a.top/100*b.height+"px",width:a.width/100*b.width+"px",height:a.height/100*b.height+"px"})}}},{key:"resizeFrame",value:function(a){Object.assign(this.overlay.style,{left:a.left+"%",top:a.top+"%",width:a.width+"%",height:a.height+"%"})}},{key:"wr",value:function(){if(!this.content.classList.contains("mini")){var a=this.content.getBoundingClientRect(),b=a.width,c=a.height,d={};d=b/c<16/9?{width:"100%",height:b/16*9+"px",top:(c-b/16*9)/2+"px",left:0}:{width:c/9*16+"px",left:(b-c/9*16)/2+"px",top:0,height:"100%"},Object.assign(this._16x9.style,d),this.resize(this.video.size)}}},{key:"level",value:function(a){1===a&&(this.video.style.zIndex=2),0===a&&(this.video.style.zIndex="")}},{key:"checkMobileInteractive",value:function(){if(interactive.checkAvailableDomain()){var a=this.content.getBoundingClientRect();!this.content.classList.contains("mini")&&a.width<500&&this.content.classList.contains("interactive-fullscreen")&&(this.toMobileInteractive(),this.sendAboutMobileTo1tv("toMobile")),this.content.classList.contains("mini")&&a.width<500&&this.mobileResize(),this.content.classList.contains("mini")&&a.width>=520&&(this.switchStream(),this.mobileResize("reset"),this.sendAboutMobileTo1tv("toDesktop"))}}},{key:"getCookie",value:function(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]+)"));if(b)return b[2]}}]),a}(),interactive=new Interactive;window.addEventListener("message",function(a){var b=a.data,c=(a.source,a.origin);if(interactive.checkAvailableDomain(c)){if("string"==typeof b)try{b=JSON.parse(b)}catch(a){return}if(b.event&&"statechange"===b.event){var d=b.data.state;interactive.playerState=d,interactive.initialized!==!0&&"playing"===interactive.playerState&&interactive.needToInitChecked===!0&&interactive.needToInitInteractive===!0&&interactive.initOtt()}if(b.remote_msg_1tv&&(b.site?interactive.video&&interactive.video.contentWindow.postMessage(JSON.stringify(_objectSpread({},b)),"*"):parent.postMessage(JSON.stringify(_objectSpread({},b)),"*")),"time"===b.type&&interactive.ready&&interactive.overlay.contentWindow.postMessage(b,"*"),"interactiveActionFrom1Tv"===b.event&&("disableInteractive"===b.data&&(interactive.needShowInteractive=!1,interactive._16x9.style.zIndex="",interactive.mobileResize("reset"),interactive.switchStream(),interactive.sendAboutMobileTo1tv("toDesktop")),"enableInteractive"===b.data&&(interactive.needShowInteractive=!0),"hideInteractive"===b.data&&(interactive._16x9.style.zIndex="",interactive.mobileResize("reset"),interactive.switchStream(),interactive.sendAboutMobileTo1tv("toDesktop"))),interactive.needShowInteractive){if("interactive"===b.type){if(interactive.ready=1,!interactive.checkAvailableDomain()&&interactive.mobile&&!interactive.content.classList.contains("interactive-fullscreen"))return interactive.content.classList.contains("mini")&&(interactive.mobileResize("reset"),interactive.content.classList.remove("mini")),void(interactive._16x9.style.zIndex="");if("show"===b.action){if(interactive.advertInProcess)return;interactive._16x9.style.zIndex=1,interactive.checkMobileInteractive()}"hide"===b.action&&(interactive.isMobileApp&&(interactive.mobileResize("reset"),interactive.content.classList.contains("mini")&&interactive.content.classList.remove("mini")),interactive._16x9.style.zIndex="")}if("positionchange"===b.event){if(interactive.currentPositionIndex===+b.data.index)return;interactive.currentPositionIndex=+b.data.index,interactive.ready&&(interactive._16x9.style.zIndex=""),interactive.mobileResize("reset"),interactive.sendAboutMobileTo1tv("toDesktop")}interactive.ready&&("adStart"===b.type&&(interactive.advertInProcess=!0,interactive._16x9.style.zIndex=""),"adEnd"===b.type&&(interactive.advertInProcess=!1),"frame.resize"===b.type&&interactive.resizeFrame(b),"video.resize"===b.type&&interactive.resize(b),"video.level"===b.type&&interactive.level(b.level))}}});