/*! @license
 * Copyright (c) Teleport RUS. All rights reserved.
 * https://teleport.media
 *
 * Teleport SDK
 * generated: 2023-03-15T05:20:39.754Z
 * version: 1.91.26
 * ref: 27ab847c7f4511af6b696f2a79e39c8a8912f1ef
 * build: 806762162
 */
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=413)}([function(e,t,n){"use strict";n.r(t),n.d(t,"__extends",(function(){return i})),n.d(t,"__assign",(function(){return o})),n.d(t,"__rest",(function(){return s})),n.d(t,"__decorate",(function(){return a})),n.d(t,"__param",(function(){return u})),n.d(t,"__metadata",(function(){return c})),n.d(t,"__awaiter",(function(){return l})),n.d(t,"__generator",(function(){return h})),n.d(t,"__exportStar",(function(){return d})),n.d(t,"__values",(function(){return f})),n.d(t,"__read",(function(){return p})),n.d(t,"__spread",(function(){return _})),n.d(t,"__await",(function(){return g})),n.d(t,"__asyncGenerator",(function(){return m})),n.d(t,"__asyncDelegator",(function(){return y})),n.d(t,"__asyncValues",(function(){return v})),n.d(t,"__makeTemplateObject",(function(){return w})),n.d(t,"__importStar",(function(){return b})),n.d(t,"__importDefault",(function(){return S}));var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var o=function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function s(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n}function a(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}function u(e,t){return function(n,r){t(n,r,e)}}function c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,a)}u((r=r.apply(e,t||[])).next())}))}function h(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function d(e,t){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}function f(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function p(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function _(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}function g(e){return this instanceof g?(this.v=e,this):new g(e)}function m(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof g?Promise.resolve(n.value.v).then(u,c):l(o[0][2],n)}catch(e){l(o[0][3],e)}var n}function u(e){a("next",e)}function c(e){a("throw",e)}function l(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}}function y(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:g(e[r](t)),done:"return"===r}:i?i(t):t}:i}}function v(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=f(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,i,(t=e[n](t)).done,t.value)}))}}}function w(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function b(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function S(e){return e&&e.__esModule?e:{default:e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n){void 0===n&&(n="");var r=e.call(this,'Argument "'+t+'" is required',n)||this;return r.name="ArgumentNullException",r}return r.__extends(t,e),t}(n(11).Exception);t.ArgumentNullException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(0),o=n(17),s=n(3),a=n(51),u=n(7);!function(e){e[e.Debug=1]="Debug",e[e.Trace=2]="Trace",e[e.Info=3]="Info",e[e.Warn=4]="Warn",e[e.Error=5]="Error",e[e.None=999]="None"}(r=t.LogLevel||(t.LogLevel={}));var c=[];c[r.Debug]="background: #f2f2f2; color: #ff9900",c[r.Trace]="background: #f2f2f2; color: #3399ff",c[r.Info]="background: #3399ff; color: #fff",c[r.Warn]="background: #ff9900; color: #fff",c[r.Error]="background: #ff0000; color: #fff",c[6]="background: #f2f2f2; color: #9900cc",c[7]="background: #f2f2f2; color: #006e2a",c[r.None]="background: none; color: inherit";var l,h="%c\n                                                                                                                      \n                                                                                                                      \n ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______      \n/_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____/      \n                       ______    ______    __     ______    ____    ____     ____   ______                            \n                      /_  __/   / ____/   / /    / ____/   / __ \\  / __ \\   / __ \\ /_  __/                            \n                       / /     / __/     / /    / __/     / /_/ / / / / /  / /_/ /  / /                               \n                      / /     / /___    / /___ / /___    / ____/ / /_/ /  / _, _/  / /                                \n                     /_/     /_____/   /_____//_____/   /_/      \\____/  /_/ |_|  /_/                                 \n ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______ ______      \n/_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____//_____/      \n                                                                                                                      \n                                                                                                                      \n                                                                                                                      \n Environment: "+s.Environment.currentName+"                                                                                             \n Version: "+s.Environment.version+"                                                                                                       ",d=function(){function e(t){if(void 0===t&&(t="APP"),this.namespace=t,-1===e._logNamespaces.indexOf(t.toLocaleUpperCase())&&e._logNamespaces.length>0){var n=this;n.info=u.Runtime.noop,n.warn=u.Runtime.noop,n.error=u.Runtime.noop,n.trace=u.Runtime.noop,n.debug=u.Runtime.noop}}return e.prototype.info=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e._logLevel<=r.Info&&console.info.apply(console,i.__spread(this._formatMessage(r.Info,t),n))},e.prototype.infoIf=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];e&&this.info.apply(this,i.__spread([t],n))},e.prototype.warn=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e._logLevel<=r.Warn&&console.warn.apply(console,i.__spread(this._formatMessage(r.Warn,t),n))},e.prototype.warnIf=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];e&&this.warn.apply(this,i.__spread([t],n))},e.prototype.error=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e._logLevel<=r.Error&&console.error.apply(console,i.__spread(this._formatMessage(r.Error,t),n))},e.prototype.errorIf=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];e&&this.error.apply(this,i.__spread([t],n))},e.prototype.trace=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e._logLevel<=r.Trace&&console.debug.apply(console,i.__spread(this._formatMessage(r.Trace,t),n))},e.prototype.traceIf=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];e&&this.trace.apply(this,i.__spread([t],n))},e.prototype.debug=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e._logLevel<=r.Debug&&console.debug.apply(console,i.__spread(this._formatMessage(r.Debug,t),n))},e.prototype.debugIf=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];e&&this.debug.apply(this,i.__spread([t],n))},e.prototype._formatMessage=function(t,n){return n?[[(new Date).toISOString(),"%c["+e._prefix+"]%c","%c["+r[t].toUpperCase()[0]+"]%c","%c["+this.namespace+"]"].join(" "),""+c[6],""+c[r.None],""+c[t],""+c[r.None],""+c[7],n]:[]},e.info=function(t){for(var n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];return(n=e._ls).info.apply(n,i.__spread([t],r))},e.warn=function(t){for(var n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];return(n=e._ls).warn.apply(n,i.__spread([t],r))},e.error=function(t){for(var n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];return(n=e._ls).error.apply(n,i.__spread([t],r))},e.trace=function(t){for(var n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];return(n=e._ls).trace.apply(n,i.__spread([t],r))},e.debug=function(t){for(var n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];return(n=e._ls).debug.apply(n,i.__spread([t],r))},e.infoIf=function(t,n){for(var r,o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];return(r=e._ls).infoIf.apply(r,i.__spread([t,n],o))},e.warnIf=function(t,n){for(var r,o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];return(r=e._ls).warnIf.apply(r,i.__spread([t,n],o))},e.errorIf=function(t,n){for(var r,o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];return(r=e._ls).errorIf.apply(r,i.__spread([t,n],o))},e.traceIf=function(t,n){for(var r,o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];return(r=e._ls).traceIf.apply(r,i.__spread([t,n],o))},e.debugIf=function(t,n){for(var r,o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];return(r=e._ls).debugIf.apply(r,i.__spread([t,n],o))},e.promo=function(){return s.Environment.isDevelopment&&console.log(h,"background: #11051d; color: #fff")},e.setLogLevel=function(t){return e._logLevel=t,e},e.setLogNamespaces=function(t){return e._logNamespaces=t,e},e.setPrefix=function(t){return e._prefix=t,e},e._logNamespaces=[],e._logLevel=r.Debug,e._ls=new e,e._prefix="TLPRT",e}();t.Logger=d,d.setLogLevel(o.Convert.toInt(a.QueryParams.getValue("media_tlprt_log_lvl"))||(s.Environment.isDevelopment?r.Debug:r.Warn)).setLogNamespaces((a.QueryParams.getValue("media_tlprt_log_nss")||(s.Environment.isDevelopment?"":"APP")).split(",").filter((function(e){return!!e})).map((function(e){return e.toLocaleUpperCase()}))),t.PIPE_LOG=(l=new d("PIPELOG"),function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.debug.apply(l,i.__spread([e],t))})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i="object"==typeof window,o=self&&"function"==typeof self.importScripts;!function(e){e.Development="development",e.Production="production"}(r||(r={}));var s=function(){function e(){}return Object.defineProperty(e,"sessionStorage",{get:function(){try{return this.runtimeContext.sessionStorage||null}catch(e){return console.log("Can't reach sessionStorage",e),null}},enumerable:!0,configurable:!0}),Object.defineProperty(e,"localStorage",{get:function(){try{return this.runtimeContext.localStorage||null}catch(e){return console.log("Can't reach localStorage",e),null}},enumerable:!0,configurable:!0}),e.currentName="v1.91.26",e.isDevelopment=e.currentName===r.Development,e.isProduction=e.currentName===r.Production,e.version="1.91.26",e.isBrowser=i,e.isWebWorker=o,e.isServiceWorkerSupport="serviceWorker"in navigator,e.runtimeContext=i?window:o?self:window,e.isWebRtcSupported=!(!e.runtimeContext.RTCPeerConnection||!e.runtimeContext.RTCDataChannel&&!e.runtimeContext.DataChannel),e}();t.Environment=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=function(){function e(){}return e.toDisposable=function(t){return t&&t.dispose?t:new function(){var n=this;this.dispose=function(){e.destroyObject(n.instance),delete n.instance},this.instance=t}},e.disposeArray=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,Promise.all(e.map((function(e){return r.__awaiter(t,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),(t=e.dispose())instanceof Promise?[4,t]:[3,2];case 1:r.sent(),r.label=2;case 2:return[3,4];case 3:return n=r.sent(),i.Logger.trace("dispose error",n,e),[3,4];case 4:return[2]}}))}))})))];case 1:return n.sent(),this.destroyArray(e),[2]}}))}))},e.destroyArray=function(t,n,r){for(void 0===n&&(n=!1),void 0===r&&(r=!1);t.length>0;){var o=t.pop();try{r&&o&&o.dispose&&o.dispose(),n&&o&&this.destroyObject(o)}catch(e){i.Logger.trace("dispose error",e,o)}}return e},e.destroyObject=function(t,n){for(var r in void 0===n&&(n=!1),t)t.hasOwnProperty(r)&&(n&&t[r].dispose&&t[r].dispose(),delete t[r]);return Object.setPrototypeOf(t,null),e},e}();t.Destructor=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i,o,s=n(19),a=n(3),u=n(7),c=a.Environment.runtimeContext.performance&&a.Environment.runtimeContext.performance.now?(r=Date.now(),i=a.Environment.runtimeContext.performance,o=i.now(),function(){return r+Math.round(i.now()-o)}):function(){return Date.now()},l=function(){function e(e){if(!u.Runtime.isSafeNumber(e))throw new s.ArgumentException("value","must be a safe integer");this._value=e}return Object.defineProperty(e,"now",{get:function(){return new e(e.value)},enumerable:!0,configurable:!0}),Object.defineProperty(e,"value",{get:function(){return c()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"seconds",{get:function(){return this._value/1e3|0},enumerable:!0,configurable:!0}),e.fromMilliseconds=function(t){return new e(t)},e.fromSeconds=function(t){return new e(1e3*t)},e.fromMinutes=function(t){return new e(6e4*t)},e.fromHours=function(t){return new e(36e5*t)},e.fromDays=function(t){return new e(864e5*t)},e.fromDate=function(t){return new e(t.getTime())},e.prototype.add=function(t){var n=t instanceof e?t.value:t;return new e(this.value+n)},e.prototype.sub=function(t){var n=t instanceof e?t.value:t;return new e(this.value-n)},e.prototype.rdiff=function(t){void 0===t&&(t=e.value);var n=t instanceof e?t.value:t;return this.value-n},e.prototype.diff=function(t){return void 0===t&&(t=e.value),(t instanceof e?t.value:t)-this.value},e.prototype.toRelative=function(){return e.value+this.value},e.prototype.toRelativeSeconds=function(){return this.toRelative()/1e3|0},e.prototype.toSeconds=function(){return this.value/1e3|0},e.prototype.toRelativeUnixDate=function(){return new Date(this.value)},e.prototype.toString=function(){return this.value.toString()},e.prototype.toJSON=function(){return this.value},e}();t.TimeSpan=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=function(){function e(){this._logger=new o.Logger("TaskHandler")}return e.prototype._handleWrapper=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.handle(e)];case 1:return n.sent(),[3,3];case 2:return t=n.sent(),this._logger.errorIf(i.Environment.isDevelopment,"ERROR HANDLE WRAPPER",t),[3,3];case 3:return[2]}}))}))},e.prototype.dispose=function(){for(var e in this)this.hasOwnProperty(e)&&delete this[e]},e}();t.TaskHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.prototype.toString,i=function(){function e(){}return e.isString=function(e){return"[object String]"===r.call(e)},e.isFunction=function(e){return"[object Function]"===r.call(e)},e.isNumber=function(e){return"[object Number]"===r.call(e)},e.isDate=function(e){return"[object Date]"===r.call(e)},e.isRegExp=function(e){return"[object RegExp]"===r.call(e)},e.isSymbol=function(e){return"[object Symbol]"===r.call(e)},e.isMap=function(e){return"[object Map]"===r.call(e)},e.isWeakMap=function(e){return"[object WeakMap]"===r.call(e)},e.isSet=function(e){return"[object Set]"===r.call(e)},e.isWeakSet=function(e){return"[object WeakSet]"===r.call(e)},e.isBoolean=function(e){return!0===e||!1===e||"[object Boolean]"===r.call(e)},e.isArray=function(e){return Array.isArray(e)},e.isUndefined=function(e){return void 0===e},e.isDefined=function(t){return!e.isUndefined(t)&&!e.isNull(t)},e.isNull=function(e){return null===e},e.isNaN=function(t){return e.isNumber(t)&&isNaN(t)},e.isFinite=function(t){return e.isNumber(t)&&isFinite(t)},e.isSafeNumber=function(t){return e.isNumber(t)&&e.isFinite(t)&&!e.isNaN(t)},e.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},e.isPrimitive=function(t){return e.isNull(t)||e.isSafeNumber(t)||e.isBoolean(t)||e.isDate(t)||e.isString(t)},e.isTrueString=function(e){return"true"===(e||"").toLowerCase()},e.clone=function(e){return Object.assign({},e)},e.cloneDeep=function(e){return JSON.parse(JSON.stringify(e))},e.extend=function(e,t){return Object.assign({},e,t)},e.hasKeys=function(t){return e.isObject(t)&&Object.keys(t).length>0},e.noop=function(){},e}();t.Runtime=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(11),s=n(2),a=n(7),u=n(5),c=function(){function e(e,t,n){if(void 0===n&&(n=!0),this.delegate=e,this.interval=t,this.repeat=n,this._isStopped=!0,!e)throw new i.ArgumentNullException("delegate");if(!t)throw new i.ArgumentNullException("interval")}return e.delay=function(t){return new Promise((function(n){return setTimeout(n,e.resolveTick(t))}))},e.timeout=function(t,n){return setTimeout(t,e.resolveTick(n))},e.removeTimeout=function(e){clearTimeout(e)},e.resolveTick=function(e,t){if(void 0===t&&(t=0),t>1)throw new o.Exception("TimeoutResolver callstack overflow");return e instanceof u.TimeSpan?e.value:a.Runtime.isSafeNumber(e)?e:a.Runtime.isFunction(e)?this.resolveTick(e(),t+1):100},e.prototype.start=function(t){this._isStopped=!1,this.startTick(e.resolveTick(t||this.interval))},e.prototype.stop=function(){this._isStopped=!0,this.stopTick()},e.prototype.dispose=function(){this.stop(),this.delegate=null,this.interval=null},Object.defineProperty(e.prototype,"isStopped",{get:function(){return this._isStopped},enumerable:!0,configurable:!0}),e.prototype.onHandleTimeout=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),(e=this.delegate())instanceof Promise?[4,e]:[3,2];case 1:n.sent(),n.label=2;case 2:return[3,4];case 3:return t=n.sent(),s.Logger.error(o.Exception.fromNativeError(t).toString()),[3,4];case 4:return this.repeat&&!this._isStopped&&this.start(),[2]}}))}))},e.prototype.startTick=function(e){var t=this;this.stopTick(),this.timeout=setTimeout((function(){return t.onHandleTimeout()}),e)},e.prototype.stopTick=function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},e}();t.Timer=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Video=1]="Video",e[e.Audio=2]="Audio",e[e.Caption=4]="Caption",e[e.Mixed=8]="Mixed",e[e.Unknown=128]="Unknown",e[e.Other=256]="Other"}(t.SegmentType||(t.SegmentType={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.MEMORY="MEMORY",e.IDB="IDB",e.CDN="CDN",e.PDN="PDN",e.NDR="NDR"}(t.DataSourceId||(t.DataSourceId={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.fromNativeError=function(e,n,r){return t.isNativeError(e)?new t(n||e.message,r,e):e},t.isNativeError=function(e){return!e.__custom_error__},t.prototype.toString=function(){var e=this._getInnerExceptionText(),t=this.details?"\r\n"+this.details:"",n="\r\nTrace "+this.stack;return this.name+": "+this.message+t+n+e},t.prototype.toJSON=function(){return{name:this.name,message:this.message,details:this.details,code:this.code,stack:this.toString()}},t.prototype._getInnerExceptionText=function(){var e="";return this.innerException&&(e="\r\n----------------------------------------------------------------\r\nInner exception: "+this.innerException.toString(),t.isNativeError(this.innerException)&&(e+="\r\nTrace "+this.innerException.stack)),e},t}(n(134).ExceptionBase);t.Exception=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return Object.defineProperty(e,"empty",{get:function(){return new ArrayBuffer(0)},enumerable:!0,configurable:!0}),e.copy=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=e.byteLength);for(var r=new Uint8Array(e),i=new ArrayBuffer(n-t),o=new Uint8Array(i),s=0;s<o.length;s++)o[s]=r[s+t];return i},e.write=function(e,t,n){return void 0===n&&(n=0),new Uint8Array(e).set(new Uint8Array(t),n),n+t.byteLength},e.concat=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=e.reduce((function(e,t){return e+t.byteLength}),0),r=new Uint8Array(n),i=0,o=0;o<e.length;o++)e[o].byteLength&&(r.set(new Uint8Array(e[o]),i),i+=e[o].byteLength);return r.buffer},e.stringifyUTF8=function(e){return String.fromCharCode.apply(null,new Uint16Array(e))},e.fromStringUTF8=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0,i=e.length;r<i;r++)n[r]=e.charCodeAt(r);return t},e.stringify=function(e){return String.fromCharCode.apply(null,new Uint8Array(e))},e.fromString=function(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),r=0,i=e.length;r<i;r++)n[r]=e.charCodeAt(r);return t},e}();t.Buffer=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){void 0===e&&(e=0),this._value=e}return e.set=function(e,t){return e|t},e.toggleIf=function(e,t,n){return e?this.set(t,n):this.unset(t,n)},e.unset=function(e,t){return e&~t},e.check=function(e,t){return(e&t)===t},e.checkEvery=function(e,t){for(var n=0;n<t.length;n++)if(!this.check(e,t[n]))return!1;return!0},e.checkSome=function(e,t){for(var n=0;n<t.length;n++)if(this.check(e,t[n]))return!0;return!1},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),e.prototype.set=function(t){return this._value=e.set(this._value,t),this},e.prototype.unset=function(t){return this._value=e.unset(this._value,t),this},e.prototype.toggleIf=function(t,n){return this._value=e.toggleIf(t,this._value,n),this},e.prototype.has=function(t){return e.check(this._value,t)},e.prototype.hasAll=function(t){return e.checkEvery(this._value,t)},e.prototype.hasAny=function(t){return e.checkSome(this._value,t)},e}();t.Bitmask=r},function(e,t,n){var r=n(85)("wks"),i=n(46),o=n(15).Symbol,s="function"==typeof o;(e.exports=function(e){return r[e]||(r[e]=s&&o[e]||(s?o:i)("Symbol."+e))}).store=r},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(1),o=n(13),s=n(8),a=n(5);!function(e){e[e.Off=0]="Off",e[e.Download=1]="Download",e[e.Upload=2]="Upload",e[e.Full=3]="Full"}(r=t.PeeringMode||(t.PeeringMode={}));var u=function(){function e(e,t,n){var r=this;if(this._config=e,this._session=t,this._active=!0,!e)throw new i.ArgumentNullException("config");if(!t)throw new i.ArgumentNullException("session");if(!n)throw new i.ArgumentNullException("metrics");n.addAppender((function(e){r.isSilent()&&e.register("SILENT_MODE",1,!0)})),this.registerSelfActivity()}return e.checkFullPM=function(e){return o.Bitmask.check(e,r.Full)},e.checkUploadPM=function(e){return o.Bitmask.check(e,r.Upload)},e.checkDownloadPM=function(e){return o.Bitmask.check(e,r.Download)},e.checkNotOffPM=function(e){return o.Bitmask.checkSome(e,[r.Upload,r.Download])},e.checkOffPM=function(e){return!this.checkNotOffPM(e)},Object.defineProperty(e.prototype,"selfPM",{get:function(){var e=parseInt(this._session.connectionId.slice(0,2),16);return this._config.peeringMode|+(e<this._config.forceDwPeeringQuota)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"safeMode",{get:function(){return this._config.pdnSafeMode},enumerable:!0,configurable:!0}),e.prototype.toNumber=function(){return this.selfPM},e.prototype.toString=function(){return this.selfPM.toString(10)},e.prototype.isFull=function(){return e.checkFullPM(this.selfPM)},e.prototype.isUpload=function(){return e.checkUploadPM(this.selfPM)},e.prototype.isDownload=function(){return e.checkDownloadPM(this.selfPM)},e.prototype.isNotOff=function(){return e.checkNotOffPM(this.selfPM)},e.prototype.isOff=function(){return e.checkOffPM(this.selfPM)},e.prototype.isSilent=function(){var e=this,t=a.TimeSpan.now.rdiff(this._lastSelfActivity)>this._config.silentActivityLimit;return this._active&&t&&(this._active=!1,s.Timer.timeout((function(){e.onSilentModeChange&&e.onSilentModeChange(!0)}),1)),t},e.prototype.isSafeDownload=function(){return!!this._lastDownloadActivity&&a.TimeSpan.now.rdiff(this._lastDownloadActivity)>this._config.pdnSafeModeDelta},e.prototype.registerSelfActivity=function(){this._lastSelfActivity=a.TimeSpan.now,this._active||(this._active=!0,this.onSilentModeChange&&this.onSilentModeChange(!1))},e.prototype.registerDownloadActivity=function(){this._lastDownloadActivity=a.TimeSpan.now},e.prototype.hasUpload=function(){return e.checkUploadPM(this.selfPM)},e.prototype.hasDownload=function(){return e.checkDownloadPM(this.selfPM)},e}();t.WorkMode=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),i=function(){function e(){}return e.toString=function(e){return r.Runtime.isDefined(e)?e.toString?e.toString():Object.prototype.toString.call(e):""},e.toBoolean=function(e){return!!r.Runtime.isDefined(e)&&!!e},e.toInt=function(e,t){void 0===t&&(t=10);var n=parseInt(e,t);return r.Runtime.isSafeNumber(n)?n:0},e.toNumber=function(e){var t=parseFloat(e);return r.Runtime.isSafeNumber(t)?t:0},e.toArray=function(e){return r.Runtime.isDefined(e)?r.Runtime.isArray(e)?e:[e]:[]},e}();t.Convert=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Off=0]="Off",e[e.CDN=1]="CDN",e[e.PDN=2]="PDN",e[e.NoWebRTC=4]="NoWebRTC",e[e.Blacklist=8]="Blacklist",e[e.Audio=16]="Audio",e[e.Caption=32]="Caption",e[e.All=15]="All"}(t.AvailableStatTypes||(t.AvailableStatTypes={})),function(e){e[e.OFF=0]="OFF",e[e.CDN=1]="CDN",e[e.PDN=2]="PDN",e[e.ALL=3]="ALL"}(t.AvailableStreamSource||(t.AvailableStreamSource={})),function(e){e[e.NO=0]="NO",e[e.WEBRTC=1]="WEBRTC",e[e.WS=2]="WS"}(t.AvailablePdnTransport||(t.AvailablePdnTransport={})),function(e){e[e.NO=0]="NO",e[e.LIVE=1]="LIVE",e[e.VOD=2]="VOD"}(t.StreamType||(t.StreamType={})),function(e){e[e.ALL_LAST_BYTE=0]="ALL_LAST_BYTE",e[e.PDN_FIRST_BYTE=1]="PDN_FIRST_BYTE",e[e.CDN_FIRST_BYTE=2]="CDN_FIRST_BYTE",e[e.NDR_FIRST_BYTE=4]="NDR_FIRST_BYTE",e[e.ALL_FIRST_BYTE=7]="ALL_FIRST_BYTE"}(t.SourceHaveFirstByte||(t.SourceHaveFirstByte={})),function(e){e[e.NO=0]="NO",e[e.NODR_LOW_PRIORITY=1]="NODR_LOW_PRIORITY",e[e.NODR_EXTRA_CYCLE=2]="NODR_EXTRA_CYCLE",e[e.NODR_PROXY=4]="NODR_PROXY",e[e.NODR_BYTE_RANGE=8]="NODR_BYTE_RANGE",e[e.NODR_PUT_SEGMENT=16]="NODR_PUT_SEGMENT",e[e.NODR_SEND_EVENT=32]="NODR_SEND_EVENT",e[e.ALL=63]="ALL"}(t.NodrStrategy||(t.NodrStrategy={})),function(e){e[e.OFF=0]="OFF",e[e.SERVER_LOADING=1]="SERVER_LOADING"}(t.ExternalHashCheckMode||(t.ExternalHashCheckMode={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n){void 0===n&&(n="");var r=e.call(this,'Incorrect argument "'+t+'"',n)||this;return r.name="ArgumentException",r}return r.__extends(t,e),t}(n(11).Exception);t.ArgumentException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(17),i=function(){function e(){}return e.parse=function(e){var t={};return e.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((function(e){var n=e.split(": "),r=(n.shift()+"").toLowerCase();t[r]=n.join(": ")})),t},e.parseRange=function(e){if(!e||0!==e.indexOf("bytes="))return[];for(var t=[],n=e.substr(6).split(","),i=0;i<n.length;i++){var o=n[i].split("-"),s=o[0]&&r.Convert.toInt(o[0])||0,a=o[1]&&r.Convert.toInt(o[1])||-1;(s>0||-1!==a&&a>s)&&t.push([s,a])}return t},e.parseRace=function(e){if(!e||0!==e.indexOf("race="))return null;var t=e.substr(5).split(",").map((function(e){return parseInt(e,10)}));return[t[0],t[1]]},e.generateContentRangeValue=function(e,t,n){return e>0||-1!==t&&e<t?"bytes "+e+"-"+(-1!==t?t.toString(10):"")+"/"+n:""},e.Range="range",e.RangeRequest="range-request",e.ContentRange="content-range",e.TransferMode="x-transfer-mode",e.ContentLength="content-length",e.AcceptRanges="accept-ranges",e.Status="status",e.RaceRequest="x-race-request",e}();t.HttpHeaders=i},function(e,t){var n=e.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.round=function(e,t){void 0===t&&(t=0);var n=Math.pow(10,t);return Math.round(e*n)/n},e.digits=function(e){for(var t=0;e>=1;)e/=10,++t;return t},e.randomInt=function(e,t){return void 0===t&&(t=0),Math.floor(Math.random()*(e-t))+t},e}();t.MathUtils=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(19),o=n(1),s=n(12),a=n(4),u=n(3),c=n(2),l=n(7),h=n(52),d=n(20),f=n(142);t.HTTP_ORIGIN_XHR=u.Environment.runtimeContext.XMLHttpRequest,t.HTTP_MOZ_CHUNKED_RESPONSE="moz-chunked-arraybuffer",t.HTTP_IS_CHUNKED=function(){try{var e=t.HTTP_ORIGIN_XHR();return e.responseType=t.HTTP_MOZ_CHUNKED_RESPONSE,e.responseType===t.HTTP_MOZ_CHUNKED_RESPONSE}catch(e){return!1}}(),function(e){e[e.UNSENT=0]="UNSENT",e[e.OPENED=1]="OPENED",e[e.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",e[e.LOADING=3]="LOADING",e[e.DONE=4]="DONE"}(r=t.HttpRequestState||(t.HttpRequestState={}));var p=function(){function e(e){if(this._opts=e,this.onStateChange=null,this.onProgress=null,this.onHeaders=null,this._logger=new c.Logger("HttpRequest"),!e)throw new o.ArgumentNullException("opts");if(!e.url)throw new o.ArgumentNullException("opts.url");if(!e.method)throw new o.ArgumentNullException("opts.method");if(this._opts.streaming&&!this._opts.binary)throw new i.ArgumentException("streaming available only for binary data");this._progressOffset=0}return Object.defineProperty(e.prototype,"method",{get:function(){return this._opts.method},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._opts.url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"body",{get:function(){return this._opts.body},enumerable:!0,configurable:!0}),e.prototype.setRequestHeader=function(e,t){this._opts.headers||(this._opts.headers={}),this._opts.headers[e]=t},e.prototype.dispose=function(){this._unbindEvents(),a.Destructor.destroyObject(this)},e.prototype.abort=function(){this._unbindEvents();try{this._xhr.abort()}catch(e){this._logger.errorIf(u.Environment.isDevelopment,"abort",this._opts)}},e.prototype.send=function(){var e=this;return new Promise((function(t,n){var r=e._opts,i=e._createXhr(r),o=new f.HttpResponse(i);i.onprogress=function(t){return e.handleProgress(t)},i.onreadystatechange=function(){return e.handleReadyState(i.readyState)},i.onerror=function(t){return n(new h.HttpException(e,o,t.error))},i.onabort=function(){return n(new h.HttpAbortException(e,o))},i.ontimeout=function(){return n(new h.HttpTimeoutException(e,o))},i.onload=function(){return o.ok?t(o):n(new h.HttpException(e,o))},e._xhr=i;try{i.open(r.method,r.url,!0),e._writeResponseType(i,r),e._writeHeaders(i,r),e._send(i,r)}catch(t){n(new h.HttpException(e,o,t))}}))},e.prototype.handleProgress=function(e){var n=this._xhr.readyState===r.DONE&&(!this._xhr.status||200!==this._xhr.status);if(this.onProgress&&!n){var i=null;if(this._opts.streaming&&t.HTTP_IS_CHUNKED)i=this._xhr.response;else if(this._opts.streaming){var o=this._xhr.responseText.substr(this._progressOffset);i=s.Buffer.fromString(o),this._progressOffset=this._xhr.responseText.length}else i="arraybuffer"===this._xhr.responseType?this._xhr.response:s.Buffer.fromString(this._xhr.responseText);this.onProgress(i,e.loaded,e.total)}},e.prototype.handleReadyState=function(e){if(e===r.HEADERS_RECEIVED&&this.onHeaders&&this.onHeaders(d.HttpHeaders.parse(this._xhr)),this.onStateChange){var n;n=this._opts.streaming&&t.HTTP_IS_CHUNKED||"arraybuffer"===this._xhr.responseType?this._xhr.response:s.Buffer.fromString(this._xhr.responseText||""),this.onStateChange(e,n)}},e.prototype._createXhr=function(e){var n=new t.HTTP_ORIGIN_XHR;return e.timeout&&(n.timeout=e.timeout.value),n},e.prototype._writeResponseType=function(e,n){n.binary&&(n.streaming?(e.overrideMimeType("text/plain; charset=x-user-defined"),e.responseType=t.HTTP_IS_CHUNKED?t.HTTP_MOZ_CHUNKED_RESPONSE:"text"):e.responseType="arraybuffer")},e.prototype._writeHeaders=function(e,t){var n=t.headers;if(n)for(var r in n)n.hasOwnProperty(r)&&e.setRequestHeader(r,n[r])},e.prototype._send=function(e,t){l.Runtime.isDefined(t.body)?e.send(!l.Runtime.isObject(t.body)||t.body instanceof FormData||t.body instanceof ArrayBuffer?t.body:JSON.stringify(t.body)):e.send(void 0)},e.prototype._unbindEvents=function(){this.onProgress=null,this.onStateChange=null,this.onHeaders=null},e}();t.HttpRequest=p},function(e,t,n){var r=n(25);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){"use strict";(function(e){var r=n(147),i=n(148),o=n(149);function s(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return u.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=u.prototype:(null===e&&(e=new u(t)),e.length=t),e}function u(e,t,n){if(!(u.TYPED_ARRAY_SUPPORT||this instanceof u))return new u(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return c(this,e,t,n)}function c(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");return t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r),u.TYPED_ARRAY_SUPPORT?(e=t).__proto__=u.prototype:e=d(e,t),e}(e,t,n,r):"string"==typeof t?function(e,t,n){if("string"==typeof n&&""!==n||(n="utf8"),!u.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|p(t,n),i=(e=a(e,r)).write(t,n);return i!==r&&(e=e.slice(0,i)),e}(e,t,n):function(e,t){if(u.isBuffer(t)){var n=0|f(t.length);return 0===(e=a(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?a(e,0):d(e,t);if("Buffer"===t.type&&o(t.data))return d(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(l(t),e=a(e,t<0?0:0|f(t)),!u.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function d(e,t){var n=t.length<0?0:0|f(t.length);e=a(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function f(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function p(e,t){if(u.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return U(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return W(e).length;default:if(r)return U(e).length;t=(""+t).toLowerCase(),r=!0}}function _(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function g(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:m(e,t,n,r,i);if("number"==typeof t)return t&=255,u.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):m(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function m(e,t,n,r,i){var o,s=1,a=e.length,u=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,u/=2,n/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(o=n;o<a;o++)if(c(e,o)===c(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===u)return l*s}else-1!==l&&(o-=o-l),l=-1}else for(n+u>a&&(n=a-u),o=n;o>=0;o--){for(var h=!0,d=0;d<u;d++)if(c(e,o+d)!==c(t,d)){h=!1;break}if(h)return o}return-1}function y(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var s=0;s<r;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function v(e,t,n,r){return F(U(t,e.length-n),e,n,r)}function w(e,t,n,r){return F(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function b(e,t,n,r){return w(e,t,n,r)}function S(e,t,n,r){return F(W(t),e,n,r)}function E(e,t,n,r){return F(function(e,t){for(var n,r,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)r=(n=e.charCodeAt(s))>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function T(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function P(e,t,n){n=Math.min(e.length,n);for(var r=[],i=t;i<n;){var o,s,a,u,c=e[i],l=null,h=c>239?4:c>223?3:c>191?2:1;if(i+h<=n)switch(h){case 1:c<128&&(l=c);break;case 2:128==(192&(o=e[i+1]))&&(u=(31&c)<<6|63&o)>127&&(l=u);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(u=(15&c)<<12|(63&o)<<6|63&s)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(u=(15&c)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(l=u)}null===l?(l=65533,h=1):l>65535&&(l-=65536,r.push(l>>>10&1023|55296),l=56320|1023&l),r.push(l),i+=h}return function(e){var t=e.length;if(t<=C)return String.fromCharCode.apply(String,e);for(var n="",r=0;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=C));return n}(r)}t.Buffer=u,t.SlowBuffer=function(e){return+e!=e&&(e=0),u.alloc(+e)},t.INSPECT_MAX_BYTES=50,u.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),u.poolSize=8192,u._augment=function(e){return e.__proto__=u.prototype,e},u.from=function(e,t,n){return c(null,e,t,n)},u.TYPED_ARRAY_SUPPORT&&(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&u[Symbol.species]===u&&Object.defineProperty(u,Symbol.species,{value:null,configurable:!0})),u.alloc=function(e,t,n){return function(e,t,n,r){return l(t),t<=0?a(e,t):void 0!==n?"string"==typeof r?a(e,t).fill(n,r):a(e,t).fill(n):a(e,t)}(null,e,t,n)},u.allocUnsafe=function(e){return h(null,e)},u.allocUnsafeSlow=function(e){return h(null,e)},u.isBuffer=function(e){return!(null==e||!e._isBuffer)},u.compare=function(e,t){if(!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=u.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var s=e[n];if(!u.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(r,i),i+=s.length}return r},u.byteLength=p,u.prototype._isBuffer=!0,u.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)_(this,t,t+1);return this},u.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},u.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},u.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?P(this,0,e):function(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return I(this,t,n);case"utf8":case"utf-8":return P(this,t,n);case"ascii":return D(this,t,n);case"latin1":case"binary":return O(this,t,n);case"base64":return T(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}.apply(this,arguments)},u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},u.prototype.compare=function(e,t,n,r,i){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(o,s),c=this.slice(r,i),l=e.slice(t,n),h=0;h<a;++h)if(c[h]!==l[h]){o=c[h],s=l[h];break}return o<s?-1:s<o?1:0},u.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},u.prototype.indexOf=function(e,t,n){return g(this,e,t,n,!0)},u.prototype.lastIndexOf=function(e,t,n){return g(this,e,t,n,!1)},u.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return y(this,e,t,n);case"utf8":case"utf-8":return v(this,e,t,n);case"ascii":return w(this,e,t,n);case"latin1":case"binary":return b(this,e,t,n);case"base64":return S(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var C=4096;function D(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function O(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function I(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=t;o<n;++o)i+=B(e[o]);return i}function A(e,t,n){for(var r=e.slice(t,n),i="",o=0;o<r.length;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function R(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,n,r,i,o){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function N(e,t,n,r){t<0&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-n,2);i<o;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function k(e,t,n,r){t<0&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-n,4);i<o;++i)e[n+i]=t>>>8*(r?i:3-i)&255}function x(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function L(e,t,n,r,o){return o||x(e,0,n,4),i.write(e,t,n,r,23,4),n+4}function H(e,t,n,r,o){return o||x(e,0,n,8),i.write(e,t,n,r,52,8),n+8}u.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),u.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=u.prototype;else{var i=t-e;n=new u(i,void 0);for(var o=0;o<i;++o)n[o]=this[o+e]}return n},u.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||R(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r},u.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||R(e,t,this.length);for(var r=this[e+--t],i=1;t>0&&(i*=256);)r+=this[e+--t]*i;return r},u.prototype.readUInt8=function(e,t){return t||R(e,1,this.length),this[e]},u.prototype.readUInt16LE=function(e,t){return t||R(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUInt16BE=function(e,t){return t||R(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUInt32LE=function(e,t){return t||R(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUInt32BE=function(e,t){return t||R(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||R(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||R(e,t,this.length);for(var r=t,i=1,o=this[e+--r];r>0&&(i*=256);)o+=this[e+--r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},u.prototype.readInt8=function(e,t){return t||R(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){t||R(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt16BE=function(e,t){t||R(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt32LE=function(e,t){return t||R(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return t||R(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readFloatLE=function(e,t){return t||R(e,4,this.length),i.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return t||R(e,4,this.length),i.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return t||R(e,8,this.length),i.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return t||R(e,8,this.length),i.read(this,e,!1,52,8)},u.prototype.writeUIntLE=function(e,t,n,r){e=+e,t|=0,n|=0,r||M(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,o=0;for(this[t]=255&e;++o<n&&(i*=256);)this[t+o]=e/i&255;return t+n},u.prototype.writeUIntBE=function(e,t,n,r){e=+e,t|=0,n|=0,r||M(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+n},u.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,255,0),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},u.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):N(this,e,t,!0),t+2},u.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):N(this,e,t,!1),t+2},u.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):k(this,e,t,!0),t+4},u.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},u.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);M(this,e,t,n,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<n&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},u.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);M(this,e,t,n,i-1,-i)}var o=n-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},u.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,127,-128),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):N(this,e,t,!0),t+2},u.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):N(this,e,t,!1),t+2},u.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):k(this,e,t,!0),t+4},u.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},u.prototype.writeFloatLE=function(e,t,n){return L(this,e,t,!0,n)},u.prototype.writeFloatBE=function(e,t,n){return L(this,e,t,!1,n)},u.prototype.writeDoubleLE=function(e,t,n){return H(this,e,t,!0,n)},u.prototype.writeDoubleBE=function(e,t,n){return H(this,e,t,!1,n)},u.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,o=r-n;if(this===e&&n<t&&t<r)for(i=o-1;i>=0;--i)e[i+t]=this[i+n];else if(o<1e3||!u.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+o),t);return o},u.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var o;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(o=t;o<n;++o)this[o]=e;else{var s=u.isBuffer(e)?e:U(new u(e,r).toString()),a=s.length;for(o=0;o<n-t;++o)this[o+t]=s[o%a]}return this};var j=/[^+\/0-9A-Za-z-_]/g;function B(e){return e<16?"0"+e.toString(16):e.toString(16)}function U(e,t){var n;t=t||1/0;for(var r=e.length,i=null,o=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function W(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(j,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function F(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}}).call(this,n(34))},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.InSwarm="ISS",e.Backend="SRV"}(t.ConnectionProviderId||(t.ConnectionProviderId={}))},function(e,t,n){var r=n(15),i=n(21),o=n(31),s=n(39),a=n(47),u=function(e,t,n){var c,l,h,d,f=e&u.F,p=e&u.G,_=e&u.S,g=e&u.P,m=e&u.B,y=p?r:_?r[t]||(r[t]={}):(r[t]||{}).prototype,v=p?i:i[t]||(i[t]={}),w=v.prototype||(v.prototype={});for(c in p&&(n=t),n)h=((l=!f&&y&&void 0!==y[c])?y:n)[c],d=m&&l?a(h,r):g&&"function"==typeof h?a(Function.call,h):h,y&&s(y,c,h,e&u.U),v[c]!=h&&o(v,c,d),g&&w[c]!=h&&(w[c]=h)};r.core=i,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},function(e,t,n){var r=n(32),i=n(62);e.exports=n(33)?function(e,t,n){return r.f(e,t,i(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var r=n(24),i=n(120),o=n(79),s=Object.defineProperty;t.f=n(33)?Object.defineProperty:function(e,t,n){if(r(e),t=o(t,!0),r(n),i)try{return s(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){e.exports=!n(45)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var u,c=[],l=!1,h=-1;function d(){l&&u&&(l=!1,u.length?c=u.concat(c):h=-1,c.length&&f())}function f(){if(!l){var e=a(d);l=!0;for(var t=c.length;t;){for(u=c,c=[];++h<t;)u&&u[h].run();h=-1,t=c.length}u=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function _(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new p(e,t)),1!==c.length||l||a(f)},p.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=_,i.addListener=_,i.once=_,i.off=_,i.removeListener=_,i.removeAllListeners=_,i.emit=_,i.prependListener=_,i.prependOnceListener=_,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(0),o=n(13);!function(e){e[e.None=0]="None",e[e.Peeringable=1]="Peeringable",e[e.MinBufferBound=2]="MinBufferBound",e[e.SafeDownload=4]="SafeDownload",e[e.DownloadOff=8]="DownloadOff",e[e.NoWebRtc=16]="NoWebRtc",e[e.EmptyReadySwarm=32]="EmptyReadySwarm",e[e.Buffering=64]="Buffering",e[e.EmptySelectorResult=128]="EmptySelectorResult",e[e.WaitHaveTimeout=256]="WaitHaveTimeout",e[e.DownloadTimeout=512]="DownloadTimeout",e[e.HashCheckSuccess=1024]="HashCheckSuccess",e[e.HashCheckFail=2048]="HashCheckFail",e[e.SeedMode=4096]="SeedMode",e[e.PdnPartialDownload=8192]="PdnPartialDownload",e[e.SelfBlocking=16384]="SelfBlocking",e[e.BufferingMode=32768]="BufferingMode",e[e.HttpNodrDownload=65536]="HttpNodrDownload",e[e.NodrRedirect301=131072]="NodrRedirect301",e[e.NodrRedirect302=262144]="NodrRedirect302",e[e.NodrDwTimeout=524288]="NodrDwTimeout",e[e.Upload=1048576]="Upload",e[e.QualitySwitch=2097152]="QualitySwitch",e[e.RaceRequest=4194304]="RaceRequest",e[e.HashChainCheckFail=8388608]="HashChainCheckFail",e[e.PdnDownloadZeroByteError=16777216]="PdnDownloadZeroByteError",e[e.ResolveWithRedelegate=33554432]="ResolveWithRedelegate",e[e.DownloadStreamingMode=67108864]="DownloadStreamingMode",e[e.UploadStreamingMode=134217728]="UploadStreamingMode",e[e.NoGoodPeed=268435456]="NoGoodPeed",e[e.Repeat=536870912]="Repeat",e[e.PipeOverflow=1073741824]="PipeOverflow",e[e.PartialDownload=-2147483648]="PartialDownload"}(r=t.SegmentFlags||(t.SegmentFlags={}));var s=function(e){function t(){return e.call(this,r.None)||this}return i.__extends(t,e),Object.defineProperty(t.prototype,"isWaitHaveTimeout",{get:function(){return this.has(r.WaitHaveTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDownloadTimeout",{get:function(){return this.has(r.DownloadTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRepeated",{get:function(){return this.has(r.Repeat)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUpload",{get:function(){return this.has(r.Upload)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNoWebRtc",{get:function(){return this.has(r.NoWebRtc)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSelfBlocking",{get:function(){return this.has(r.SelfBlocking)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isBuffering",{get:function(){return this.has(r.Buffering)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHttpNodrDownload",{get:function(){return this.has(r.HttpNodrDownload)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMinBufferBound",{get:function(){return this.has(r.MinBufferBound)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDownloadOff",{get:function(){return this.has(r.DownloadOff)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isEmptyReadySwarm",{get:function(){return this.has(r.EmptyReadySwarm)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isEmptySelectorResult",{get:function(){return this.has(r.EmptySelectorResult)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPeeringable",{get:function(){return this.has(r.Peeringable)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSeedMode",{get:function(){return this.has(r.SeedMode)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDownloadStreamingMode",{get:function(){return this.has(r.DownloadStreamingMode)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUploadStreamingMode",{get:function(){return this.has(r.UploadStreamingMode)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPartialDownload",{get:function(){return this.has(r.PartialDownload)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPdnPartialDownload",{get:function(){return this.has(r.PdnPartialDownload)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPdnDownloadZeroByteError",{get:function(){return this.has(r.PdnDownloadZeroByteError)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isBufferingMode",{get:function(){return this.has(r.BufferingMode)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPipeOverflow",{get:function(){return this.has(r.PipeOverflow)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHashCheckSuccess",{get:function(){return this.has(r.HashCheckSuccess)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHashCheckFail",{get:function(){return this.has(r.HashCheckFail)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSafeDownload",{get:function(){return this.has(r.SafeDownload)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNodrDwTimeout",{get:function(){return this.has(r.NodrDwTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNodrRedirect301",{get:function(){return this.has(r.NodrRedirect301)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNodrRedirect302",{get:function(){return this.has(r.NodrRedirect302)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRaceRequest",{get:function(){return this.has(r.RaceRequest)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHashChainFail",{get:function(){return this.has(r.HashChainCheckFail)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNoGoodPeed",{get:function(){return this.has(r.NoGoodPeed)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isQualitySwitch",{get:function(){return this.has(r.QualitySwitch)},enumerable:!0,configurable:!0}),t.prototype.setIsWaitHaveTimeout=function(){this.set(r.WaitHaveTimeout)},t.prototype.setIsDownloadTimeout=function(){this.set(r.DownloadTimeout)},t.prototype.setIsRepeated=function(){this.set(r.Repeat)},t.prototype.setIsUpload=function(){this.set(r.Upload)},t.prototype.setIsNoWebRtc=function(){this.set(r.NoWebRtc)},t.prototype.setIsSelfBlocking=function(){this.set(r.SelfBlocking)},t.prototype.setIsBuffering=function(){this.set(r.Buffering)},t.prototype.setIsHttpNodrDownload=function(){this.set(r.HttpNodrDownload)},t.prototype.setIsMinBufferBound=function(){this.set(r.MinBufferBound)},t.prototype.setIsDownloadOff=function(){this.set(r.DownloadOff)},t.prototype.setIsEmptyReadySwarm=function(){this.set(r.EmptyReadySwarm)},t.prototype.setIsEmptySelectorResult=function(){this.set(r.EmptySelectorResult)},t.prototype.setIsPeeringable=function(){this.set(r.Peeringable)},t.prototype.setIsSeedMode=function(){this.set(r.SeedMode)},t.prototype.setIsDownloadStreamingMode=function(){this.set(r.DownloadStreamingMode)},t.prototype.setIsUploadStreamingMode=function(){this.set(r.UploadStreamingMode)},t.prototype.setIsPartialDownload=function(){this.set(r.PartialDownload)},t.prototype.setIsPdnPartialDownload=function(){this.set(r.PdnPartialDownload)},t.prototype.setIsPdnDownloadZeroByteError=function(){this.set(r.PdnDownloadZeroByteError)},t.prototype.setIsBufferingMode=function(){this.set(r.BufferingMode)},t.prototype.setIsPipeOverflow=function(){this.set(r.PipeOverflow)},t.prototype.setIsHashCheckSuccess=function(){this.set(r.HashCheckSuccess)},t.prototype.setIsHashCheckFail=function(){this.set(r.HashCheckFail)},t.prototype.setIsSafeDownload=function(){this.set(r.SafeDownload)},t.prototype.setIsNoGoodPeer=function(){this.set(r.NoGoodPeed)},t.prototype.setIsNodrDwTimeout=function(){this.set(r.NodrDwTimeout)},t.prototype.setIsNodrRedirect301=function(){this.set(r.NodrRedirect301)},t.prototype.setIsNodrRedirect302=function(){this.set(r.NodrRedirect302)},t.prototype.setRaceRequest=function(){this.set(r.RaceRequest)},t.prototype.setHashChainFail=function(){this.set(r.HashChainCheckFail)},t.prototype.setResolveWithRedelegate=function(){this.set(r.ResolveWithRedelegate)},t.prototype.setQualitySwitch=function(){this.set(r.QualitySwitch)},t}(o.Bitmask);t.SegmentBitmask=s},function(e,t,n){"use strict";var r={};function i(e,t,n){n||(n=Error);var i=function(e){var n,r;function i(n,r,i){return e.call(this,function(e,n,r){return"string"==typeof t?t:t(e,n,r)}(n,r,i))||this}return r=e,(n=i).prototype=Object.create(r.prototype),n.prototype.constructor=n,n.__proto__=r,i}(n);i.prototype.name=n.name,i.prototype.code=e,r[e]=i}function o(e,t){if(Array.isArray(e)){var n=e.length;return e=e.map((function(e){return String(e)})),n>2?"one of ".concat(t," ").concat(e.slice(0,n-1).join(", "),", or ")+e[n-1]:2===n?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}i("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),i("ERR_INVALID_ARG_TYPE",(function(e,t,n){var r,i,s;if("string"==typeof t&&(i="not ",t.substr(0,i.length)===i)?(r="must not be",t=t.replace(/^not /,"")):r="must be",function(e,t,n){return(void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t}(e," argument"))s="The ".concat(e," ").concat(r," ").concat(o(t,"type"));else{var a=function(e,t,n){return"number"!=typeof n&&(n=0),!(n+".".length>e.length)&&-1!==e.indexOf(".",n)}(e)?"property":"argument";s='The "'.concat(e,'" ').concat(a," ").concat(r," ").concat(o(t,"type"))}return s+". Received type ".concat(typeof n)}),TypeError),i("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),i("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),i("ERR_STREAM_PREMATURE_CLOSE","Premature close"),i("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),i("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),i("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),i("ERR_STREAM_WRITE_AFTER_END","write after end"),i("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),i("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),i("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),e.exports.codes=r},function(e,t,n){"use strict";(function(t){var r=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t};e.exports=c;var i=n(101),o=n(106);n(28)(c,i);for(var s=r(o.prototype),a=0;a<s.length;a++){var u=s[a];c.prototype[u]||(c.prototype[u]=o.prototype[u])}function c(e){if(!(this instanceof c))return new c(e);i.call(this,e),o.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",l)))}function l(){this._writableState.ended||t.nextTick(h,this)}function h(e){e.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this,n(35))},function(e,t,n){var r=n(15),i=n(31),o=n(26),s=n(46)("src"),a=Function.toString,u=(""+a).split("toString");n(21).inspectSource=function(e){return a.call(e)},(e.exports=function(e,t,n,a){var c="function"==typeof n;c&&(o(n,"name")||i(n,"name",t)),e[t]!==n&&(c&&(o(n,s)||i(n,s,e[t]?""+e[t]:u.join(String(t)))),e===r?e[t]=n:a?e[t]?e[t]=n:i(e,t,n):(delete e[t],i(e,t,n)))})(Function.prototype,"toString",(function(){return"function"==typeof this&&this[s]||a.call(this)}))},function(e,t,n){var r=n(80),i=n(82);e.exports=function(e){return r(i(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Unknown=0]="Unknown",e[e.Q144P=1]="Q144P",e[e.Q240P=2]="Q240P",e[e.Q360P=3]="Q360P",e[e.Q480P=4]="Q480P",e[e.Q720P=5]="Q720P",e[e.Q1080P=6]="Q1080P",e[e.Q4K=7]="Q4K",e[e.Q144PHigh=8]="Q144PHigh",e[e.Q144PLow=9]="Q144PLow",e[e.Q240PHigh=10]="Q240PHigh",e[e.Q240PLow=11]="Q240PLow",e[e.Q360PHigh=12]="Q360PHigh",e[e.Q360PLow=13]="Q360PLow",e[e.Q480PHigh=14]="Q480PHigh",e[e.Q480PLow=15]="Q480PLow",e[e.Q720PHigh=16]="Q720PHigh",e[e.Q720PLow=17]="Q720PLow",e[e.Q1080PHigh=18]="Q1080PHigh",e[e.Q1080PLow=19]="Q1080PLow",e[e.Other=255]="Other"}(t.Quality||(t.Quality={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(145),i=n(53),o=function(){function e(){}return e.generate=function(e){return i.StringUtils.padStart(r.h32(e,this._SEED).toString(16),8,"0")},e.generateNumber=function(e){return r.h32(e,this._SEED).toNumber()},e.generate64=function(e){return i.StringUtils.padStart(r.h64(e,this._SEED).toString(16),16,"0")},e.generate64Number=function(e){return r.h64(e,this._SEED).toNumber()},e._SEED=51901,e}();t.XXHash=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r,i)||this;return o.name="OperationTimeoutException",o}return r.__extends(t,e),t}(n(11).Exception);t.OperationTimeoutException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.STUN_SERVERS=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.teleport.media:19302"}];var r=function(){function e(){this.statuses=t.STUN_SERVERS.map((function(){return!0}))}return e.prototype.canOpen=function(e,t){return this.statuses[this.getStunIndex(e,t)]},e.prototype.getStunsForConnection=function(e,n){return[t.STUN_SERVERS[this.getStunIndex(e,n)]]},e.prototype.getServers=function(){return t.STUN_SERVERS},e.prototype.disableStun=function(e){var n=this;e.forEach((function(e){var r=t.STUN_SERVERS.indexOf(e);-1!==r&&(n.statuses[r]=!1)}))},e.prototype.getAvailableCount=function(){return this.statuses.reduce((function(e,t){return e+ +t}),0)},e.prototype.getCount=function(){return t.STUN_SERVERS.length},e.prototype.getStunIndex=function(e,n){return(parseInt(e[e.length-1],16)+parseInt(n[n.length-1],16))%t.STUN_SERVERS.length},e}();t.default=new r},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(63);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)}}return function(){return e.apply(t,arguments)}}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var r=n(123),i=n(87);e.exports=Object.keys||function(e){return r(e,i)}},function(e,t){e.exports={}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),i=function(){function e(){}return Object.defineProperty(e,"data",{get:function(){return this._data||(this._data=this._readData()),this._data},enumerable:!0,configurable:!0}),e.getValue=function(e){return this.data[e]||""},e._readData=function(){var e="";return r.Environment.isBrowser&&(e=(window&&window.location&&window.location.search||"").substr(1)),decodeURIComponent(e).split("&").map((function(e){return e.split("=")})).filter((function(e){return e[0]&&e[1]})).reduce((function(e,t){return e[t[0]]=t[1],e}),{})},e}();t.QueryParams=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r){void 0===r&&(r=null);var i=e.call(this,t.method+" "+t.url+" "+n.statusCode+" "+n.statusMessage+"\r",n.text()||"",r,n.statusCode)||this;return i.req=t,i.res=n,i}return r.__extends(t,e),t}(n(11).Exception);t.HttpException=i;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t}(i);t.HttpTimeoutException=o;var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t}(i);t.HttpAbortException=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.padStart=function(e,t,n){var r="",i=t-e.length;if(i<1)return e;for(;r.length<i;)r+=n;return r+e},e}();t.StringUtils=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r,i)||this;return o.name="OperationAbortException",o}return r.__extends(t,e),t}(n(11).Exception);t.OperationAbortException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5);!function(e){e.RequestSent="ttsent",e.ReceiveHave="tthave",e.Loading="ttfb",e.Loaded="ttlb",e.Finish="ttfinish"}(t.RequestState||(t.RequestState={}));var i=function(){function e(){this.req_start=r.TimeSpan.now,this.tthave=0,this.ttsent=0,this.ttfb=0,this.ttlb=0,this.ttfinish=0}return e.prototype.register=function(e){this[e]=this.req_start.diff()},e.prototype.getDiff=function(){return this.req_start.diff()},e.prototype.toJSON=function(){return{req_start:this.req_start.value,tthave:this.tthave,ttsent:this.ttsent,ttfb:this.ttfb,ttlb:this.ttlb,ttfinish:this.ttfinish}},e}();t.RequestTimings=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),i=n(3),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,a=function(){function e(){}return e.encode=function(e,t){void 0===t&&(t=!1);var n=(i.Environment.runtimeContext.btoa||function(e){for(var t,n,i,s,a="",u=0,c=e.length%3;u<e.length;){if((n=e.charCodeAt(u++))>255||(i=e.charCodeAt(u++))>255||(s=e.charCodeAt(u++))>255)throw new r.Exception("Failed to execute 'btoa' on 'Window': The string to be encoded contains characters outside of the Latin1 range.");a+=o.charAt((t=n<<16|i<<8|s)>>18&63)+o.charAt(t>>12&63)+o.charAt(t>>6&63)+o.charAt(63&t)}return c?a.slice(0,c-3)+"===".substring(c):a})(e);return t?function(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}(n):n},e.decode=function(e){return(i.Environment.runtimeContext.atob||function(e){if(e=e.replace(/[\t\n\f\r ]+/g,""),!s.test(e))throw new TypeError("Failed to execute 'atob' on 'Window': The string to be decoded is not correctly encoded.");e+="==".slice(2-(3&e.length));for(var t,n,r,i="",a=0;a<e.length;)t=o.indexOf(e.charAt(a++))<<18|o.indexOf(e.charAt(a++))<<12|(n=o.indexOf(e.charAt(a++)))<<6|(r=o.indexOf(e.charAt(a++))),i+=64===n?String.fromCharCode(t>>16&255):64===r?String.fromCharCode(t>>16&255,t>>8&255):String.fromCharCode(t>>16&255,t>>8&255,255&t);return i})(e)},e}();t.Base64=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(22),i=function(){function e(){}return e.calc=function(e,t){return t>0&&e>0?r.MathUtils.round(e/t*8/1e3,3):0},e.hack=function(e,t){var n=this.calc(e,t),i=r.MathUtils.digits(n);return i>2?r.MathUtils.round(n/Math.pow(10,i-2),3):n},e}();t.Speed=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=n(5),s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.timeout=o.TimeSpan.fromSeconds(3),t.count=0,t}return r.__extends(t,e),t.prototype.abort=function(){i.Logger.info("abort is not implemented")},t.prototype.updateStat=function(e,t,n,r,o){i.Logger.info("updateStat is not implemented")},t.prototype.countRedelegations=function(){return-1},t}(n(59).P2PMessage);t.P2PRequest=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(20),i=n(12),o=n(17),s=n(2),a=n(5),u=function(){function e(){this.body=null,this.headers={}}return Object.defineProperty(e.prototype,"status",{get:function(){return o.Convert.toInt(this.headers[r.HttpHeaders.Status])},set:function(e){this.headers[r.HttpHeaders.Status]=e},enumerable:!0,configurable:!0}),e.generateRequestId=function(){return Math.floor(a.TimeSpan.value/1e3*Math.random())},e.prototype.writeJSON=function(e){this.writeText(JSON.stringify(e))},e.prototype.writeText=function(e){this.body=i.Buffer.fromStringUTF8(e)},e.prototype.json=function(){try{return JSON.parse(this.text())}catch(e){return null}},e.prototype.text=function(){return this.body?i.Buffer.stringifyUTF8(this.body):""},e.prototype.writeContentLength=function(){this.headers[r.HttpHeaders.ContentLength]||(this.headers[r.HttpHeaders.ContentLength]=this.body&&this.body.byteLength||0),s.PIPE_LOG("write content-length header call",this.headers)},e}();t.P2PMessage=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r,i)||this;return o.name="UnsupportedException",o}return r.__extends(t,e),t}(n(11).Exception);t.UnsupportedException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(20),o=n(12),s=n(17),a=n(4),u=n(114),c=n(100),l=n(71),h=function(){function e(e){if(this._msg=e,!e)throw new r.ArgumentNullException("msg");this._offset=0,this._chunkNumber=-1,this._chunkCount=l.P2PDataChunk.calculateChunkCount(this.dataCapacity),this._metadata=this._prepareMetaPayload()}return Object.defineProperty(e.prototype,"data",{get:function(){return this._msg.body||o.Buffer.empty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metaLength",{get:function(){return this._metadata.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataCapacity",{get:function(){return s.Convert.toInt(this._msg.headers[i.HttpHeaders.ContentLength])||this.dataLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataLength",{get:function(){return this._msg.body&&this._msg.body.byteLength||0},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){a.Destructor.destroyObject(this)},e.prototype.next=function(e){if(void 0===e&&(e=u.DefaultChecksum.instance),this._offset>=this.metaLength+this.dataLength)return null;var t=this._offset<this.metaLength,n=this._createDataFrame(t),r=t?0:e.calc(n),i=this._createFlags(n.byteLength);return this._offset+=n.byteLength,t||(this._chunkNumber+=1),new l.P2PDataChunk(this._msg.id,i,this._chunkNumber,this._chunkCount,r,n)},e.prototype._prepareMetaPayload=function(){var e=JSON.stringify(this._msg.headers||{});return o.Buffer.fromStringUTF8(e)},e.prototype._createFlags=function(e){var t=new c.P2PChunkBitmask,n=Math.min(e,l.P2PDataChunk.PAYLOAD_MAX_SIZE);return t.isMeta=this._offset<this.metaLength,t.isMetaLast=t.isMeta&&this._offset+n>=this.metaLength,t.isLastPacket=t.isMeta?t.isMetaLast&&0===this.dataCapacity:this._offset+n>=this.metaLength+this.dataCapacity,t},e.prototype._createDataFrame=function(e){var t=e?this._metadata:this.data,n=e?this._offset:this._offset-this.metaLength,r=n+l.P2PDataChunk.PAYLOAD_MAX_SIZE;return t.slice(n,r)},e}();t.ChunkIterator=h},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t){e.exports=!1},function(e,t,n){var r=n(32).f,i=n(26),o=n(14)("toStringTag");e.exports=function(e,t,n){e&&!i(e=n?e:e.prototype,o)&&r(e,o,{configurable:!0,value:t})}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(){function t(){this.events=new Map}return t.prototype.dispose=function(){var e,t;try{for(var n=r.__values(this.events.values()),i=n.next();!i.done;i=n.next())i.value.clear()}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}this.events.clear()},t.prototype.on=function(e,t){var n=this.events.get(e);return n||(n=new Set,this.events.set(e,n)),n.add(t),function(){return n.delete(t)}},t.prototype.off=function(e,t){var n=this.events.get(e);n&&n.delete(t)},t.prototype.emit=function(t,n,i){var o,s;void 0===i&&(i=!1);var a=this.events.get(t);if(a){var u=function(t){i?e((function(){return t(n)})):t(n)};try{for(var c=r.__values(a),l=c.next();!l.done;l=c.next())u(l.value)}catch(e){o={error:e}}finally{try{l&&!l.done&&(s=c.return)&&s.call(c)}finally{if(o)throw o.error}}}},t}();t.SimpleEventEmitter=i}).call(this,n(135).setImmediate)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=n(3),o=n(2),s=n(69),a=n(7),u=function(){function e(){this._resolvers=[],this._rejectors=[],this._isFullfilled=!1,this._isRejected=!1}return e.prototype.acquire=function(e){var t=this;return this._isFullfilled?Promise.resolve(this._res):this._isRejected?Promise.reject(this._err):new Promise((function(n,r){t._resolvers.push(n),t._rejectors.push(r),e&&e(n,r)}))},e.prototype.acquireTimeout=function(e,t){var n=this;return this._isFullfilled?Promise.resolve(this._res):this._isRejected?Promise.reject(this._err):new s.TimeoutPromise((function(e,r){n._resolvers.push(e),n._rejectors.push(r),t&&t(e,r)}),e)},e.prototype.resolveAll=function(e){this._resolvers.forEach((function(t){a.Runtime.isFunction(t)?t(e):i.Environment.isDevelopment&&o.Logger.warn("x is not a function")})),r.Destructor.destroyArray(this._resolvers),r.Destructor.destroyArray(this._rejectors),this._isFullfilled=!0,this._res=e},e.prototype.rejectAll=function(e){this._rejectors.forEach((function(t){return t(e)})),r.Destructor.destroyArray(this._resolvers),r.Destructor.destroyArray(this._rejectors),this._isRejected=!0,this._err=e},e}();t.PromiseGroup=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(43),i=n(4),o=n(8),s=function(){function e(e,t,n){void 0===n&&(n="");var s=this;this._p=new Promise((function(a,u){s._rejector=function(e){o.Timer.removeTimeout(s._timeout),i.Destructor.destroyObject(s),u(e)},s._resolver=function(e){o.Timer.removeTimeout(s._timeout),i.Destructor.destroyObject(s),a(e)},s._timeout=o.Timer.timeout((function(){var e=o.Timer.resolveTick(t);s._rejector(new r.OperationTimeoutException("operation "+n+" is timeout in "+e+" ms"))}),t),o.Timer.timeout((function(){return e(s._resolver,s._rejector)}),10)}))}return e.prototype.then=function(e,t){return this._p.then(e,t)},e.prototype.catch=function(e){return this._p.catch(e)},e.prototype.finally=function(e){return this._p.finally(e)},e}();t.TimeoutPromise=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(179),i=function(){function e(){}return e.generate=function(e){var t=r.buf(new Uint8Array(e))>>>0;return t?t.toString(16):""},e}();t.Crc32=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(12),i=n(100),o=function(){function e(e,t,n,o,s,a){void 0===e&&(e=0),void 0===t&&(t=new i.P2PChunkBitmask),void 0===n&&(n=-1),void 0===o&&(o=-1),void 0===s&&(s=0),void 0===a&&(a=r.Buffer.empty),this.id=e,this.meta=t,this.position=n,this.chunkCount=o,this.checkSum=s,this.data=a}return e.fromBuffer=function(t){var n=0,r=new DataView(t),o=r.getUint32(0);n+=e.ID_LENGTH;var s=new i.P2PChunkBitmask(r.getUint8(n));n+=e.META_LENGTH;var a=r.getUint16(n);n+=e.POSITION_LENGTH;var u=r.getUint16(n);n+=e.CHUNK_COUNT_LENGTH;var c=r.getUint32(n);return n+=e.CHECKSUM_LENGTH,new e(o,s,a,u,c,t.slice(n))},e.calculateChunkCount=function(t){return Math.ceil(t/e.PAYLOAD_MAX_SIZE)},e.prototype.toArrayBuffer=function(){var t=new ArrayBuffer(e.ID_LENGTH+e.META_LENGTH+e.POSITION_LENGTH+e.CHUNK_COUNT_LENGTH+e.CHECKSUM_LENGTH),n=new DataView(t),i=0;return n.setUint32(i,this.id),i+=e.ID_LENGTH,n.setUint8(i,this.meta.value),i+=e.META_LENGTH,n.setUint16(i,this.position),i+=e.POSITION_LENGTH,n.setUint16(i,this.chunkCount),i+=e.CHUNK_COUNT_LENGTH,n.setUint32(i,this.checkSum),r.Buffer.concat(t,this.data)},e.ID_LENGTH=4,e.META_LENGTH=1,e.POSITION_LENGTH=2,e.CHUNK_COUNT_LENGTH=2,e.CHECKSUM_LENGTH=4,e.PAYLOAD_MAX_SIZE=15987,e}();t.P2PDataChunk=o},function(e,t,n){var r=n(27),i=r.Buffer;function o(e,t){for(var n in e)t[n]=e[n]}function s(e,t,n){return i(e,t,n)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=r:(o(r,t),t.Buffer=s),o(i,s),s.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,n)},s.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"==typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}},function(e,t,n){"use strict";var r=n(37).codes.ERR_STREAM_PREMATURE_CLOSE;function i(){}e.exports=function e(t,n,o){if("function"==typeof n)return e(t,null,n);n||(n={}),o=function(e){var t=!1;return function(){if(!t){t=!0;for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];e.apply(this,r)}}}(o||i);var s=n.readable||!1!==n.readable&&t.readable,a=n.writable||!1!==n.writable&&t.writable,u=function(){t.writable||l()},c=t._writableState&&t._writableState.finished,l=function(){a=!1,c=!0,s||o.call(t)},h=t._readableState&&t._readableState.endEmitted,d=function(){s=!1,h=!0,a||o.call(t)},f=function(e){o.call(t,e)},p=function(){var e;return s&&!h?(t._readableState&&t._readableState.ended||(e=new r),o.call(t,e)):a&&!c?(t._writableState&&t._writableState.ended||(e=new r),o.call(t,e)):void 0},_=function(){t.req.on("finish",l)};return function(e){return e.setHeader&&"function"==typeof e.abort}(t)?(t.on("complete",l),t.on("abort",p),t.req?_():t.on("request",_)):a&&!t._writableState&&(t.on("end",u),t.on("close",u)),t.on("end",d),t.on("finish",l),!1!==n.error&&t.on("error",f),t.on("close",p),function(){t.removeListener("complete",l),t.removeListener("abort",p),t.removeListener("request",_),t.req&&t.req.removeListener("finish",l),t.removeListener("end",u),t.removeListener("close",u),t.removeListener("finish",l),t.removeListener("end",d),t.removeListener("error",f),t.removeListener("close",p)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(2),a=n(223);t.NO_GOOD_PEER_RESULT="-";var u=function(e){function n(t,n,r,o){var a=e.call(this,t,n,o)||this;if(a.pool=t,a.meta=n,a.scoring=r,a.config=o,a._logger=new s.Logger("EstimatePeerSelector"),!t)throw new i.ArgumentNullException("pool");if(!n)throw new i.ArgumentNullException("meta");if(!r)throw new i.ArgumentNullException("scoring");if(!o)throw new i.ArgumentNullException("config");return a}return r.__extends(n,e),n.prototype.dispose=function(){o.Destructor.destroyObject(this)},n.prototype.select=function(n,r){if(r=r||{},!this.config.useEstimatePeerSelector)return e.prototype.select.call(this,n,r);for(var i=r.filter?r.filter:function(){return!0},o=r.timeout?r.timeout:1,s=this.scoring.restoredValue/o,a=0;a<n.length;a++){var u=n[a];if(this.isReady(u)&&i(u)){var c=this.meta.getByUUId(u);if(c&&c.lastDownloadSpeed>=s)return[u]}}return[t.NO_GOOD_PEER_RESULT]},n.prototype.isReady=function(e){var t=this.pool.get(e);return t&&t.ready||!1},n}(a.SpeedIntervalPeerSelector);t.EstimatePeerSelector=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=function(){function e(){this.cbs=new Set}return e.prototype.add=function(e){"function"!=typeof e&&o.Logger.warnIf(i.Environment.isDevelopment,"Can not add cb to collection",e),this.cbs.add(e)},e.prototype.exec=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.cbs.forEach((function(t){"function"==typeof t&&t.apply(void 0,r.__spread(e))}))},e.prototype.dispose=function(){this.cbs.clear(),delete this.cbs},e}();t.DelegateCollection=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(60),o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.write=function(e){throw new i.UnsupportedException("Client response is not supports writing")},t.prototype.flush=function(){throw new i.UnsupportedException("Client response is not supports flushing")},t.prototype.close=function(){throw new i.UnsupportedException("Client response is not supports closing")},t.prototype.setChunkIteratorFactory=function(e){throw new i.UnsupportedException("Client response is not supports setChunkIterator")},t}(n(113).P2PResponse);t.ClientP2PResponse=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.None=0]="None",e[e.NoActivity=1]="NoActivity",e[e.NoPeering=2]="NoPeering",e[e.NotCompatibleConnect=3]="NotCompatibleConnect",e[e.NoMatching=4]="NoMatching",e[e.ManyDownloadTimeout=5]="ManyDownloadTimeout",e[e.ManyPdnZeroByteDownloads=6]="ManyPdnZeroByteDownloads",e[e.BadScore=7]="BadScore",e[e.LowSpeed=8]="LowSpeed"}(t.RTCDisconnectReason||(t.RTCDisconnectReason={}))},function(e,t,n){var r=n(25),i=n(15).document,o=r(i)&&r(i.createElement);e.exports=function(e){return o?i.createElement(e):{}}},function(e,t,n){var r=n(25);e.exports=function(e,t){if(!r(e))return e;var n,i;if(t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;if("function"==typeof(n=e.valueOf)&&!r(i=n.call(e)))return i;if(!t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;throw TypeError("Can't convert object to primitive value")}},function(e,t,n){var r=n(48);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,n){var r=n(82);e.exports=function(e){return Object(r(e))}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(84),i=Math.min;e.exports=function(e){return e>0?i(r(e),9007199254740991):0}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t,n){var r=n(15),i=r["__core-js_shared__"]||(r["__core-js_shared__"]={});e.exports=function(e){return i[e]||(i[e]={})}},function(e,t,n){var r=n(85)("keys"),i=n(46);e.exports=function(e){return r[e]||(r[e]=i(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var r=n(48),i=n(14)("toStringTag"),o="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,n,s;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),i))?n:o?r(t):"Object"==(s=r(t))&&"function"==typeof t.callee?"Arguments":s}},function(e,t,n){"use strict";var r=n(63);e.exports.f=function(e){return new function(e){var t,n;this.promise=new e((function(e,r){if(void 0!==t||void 0!==n)throw TypeError("Bad Promise constructor");t=e,n=r})),this.resolve=r(t),this.reject=r(n)}(e)}},function(e,t,n){var r=n(15),i=n(21),o=n(65),s=n(132),a=n(32).f;e.exports=function(e){var t=i.Symbol||(i.Symbol=o?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||a(t,e,{value:s.f(e)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4);if(!teleport)throw new Error("TeleportSDK isn't initialized. check your html-page.");var i=function(){function e(){this.UNKNOWN_BUFFER_SIZE=-1,this._throwRequest=!0,this._listener=null,this._media=null}return Object.defineProperty(e.prototype,"playerName",{get:function(){return this._playerName||(this._playerName=this.getPlayerName()),this._playerName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playerVersion",{get:function(){return this._playerVersion||(this._playerVersion=this.getPlayerVersion()),this._playerVersion},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.onAbort&&(this.onAbort=void 0),this.setListener(null),r.Destructor.destroyObject(this)},e.prototype.setListener=function(e){this._listener=e,this._listener?this.onStartListening():this.onStopListening()},e.prototype.mergeParams=function(e){return e},e.prototype.getPublicApi=function(){var e=this;return{pause:function(){return e.throwRequests(!0)},resume:function(){return e.throwRequests(!1)}}},e.prototype.execute=function(e){return this._listener?this._listener(e):Promise.resolve(null)},e.prototype.abort=function(e){this.onAbort&&this.onAbort(e)},e.prototype.getPathThrowRequest=function(){return this._throwRequest},e.prototype.throwRequests=function(e){this._throwRequest=e},e.prototype.onStartListening=function(){this.throwRequests(!1)},e.prototype.onStopListening=function(){this.throwRequests(!0)},e.prototype.setMediaElement=function(e){this._media=e},e.prototype.calculateBufferSize=function(){if(!this._media)return this.UNKNOWN_BUFFER_SIZE;var e=this._media,t=e.buffered,n=e.currentTime,r=this.UNKNOWN_BUFFER_SIZE;return t.length>0&&(r=Math.max(t.end(t.length-1)-n,0)),r},e}();t.BaseLoaderPlugin=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),i=n(138);r.Environment.runtimeContext.Symbol||(r.Environment.runtimeContext.Symbol={iterator:"mock"});var o=r.Environment.runtimeContext,s=!!(o.Promise&&o.Symbol&&"mock"!==o.Symbol.iterator&&o.Array.prototype.find&&o.Object.assign&&document.currentScript),a=function(){function e(){}return e.install=function(){i.installURLSearchParams()},e.IS_SUPPORTED=s,e}();t.Polyfill=a},function(e,t,n){t.UINT32=n(150),t.UINT64=n(151)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(13),o=n(4),s=function(){function e(e,t,n,i){if(this._config=e,this._blacklist=t,this._compability=n,this._wm=i,!e)throw new r.ArgumentNullException("config");if(!t)throw new r.ArgumentNullException("blacklist");if(!n)throw new r.ArgumentNullException("compability");if(!i)throw new r.ArgumentNullException("workMode")}return e.prototype.dispose=function(){o.Destructor.destroyObject(this)},e.prototype.isCanStreamingUpload=function(){return!1},e.prototype.isCanUpload=function(){return!1},e.prototype.isCanDownload=function(){return this._config.active&&this._wm.isDownload()},e.prototype.isCanDownloadSegment=function(e){var t=this.isCanDownload(),n=-1===e.bufferSize&&this._config.useMinusBufferSize,r=this.isCanSafeDownload()&&this._wm.safeMode,o=this.isGoodBuffer(e),s=i.Bitmask.check(this._config.availablePdnDownloadType,e.type);return t&&s&&(n||r||o)},e.prototype.isGoodBuffer=function(e){return e.bufferSize>=this._config.msMinBufferSize/1e3},e.prototype.isCanDownloadPartial=function(){return!1},e.prototype.isCanPdnDownloadPartial=function(){return!1},e.prototype.isCanSafeDownload=function(){return this._wm.isSafeDownload()},e}();t.NoWebRtcPeeringStrategy=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(4),o=n(172),s=n(173),a=n(6),u=n(174),c=function(){function e(){this._handlers=[],this._destructors=[]}return e.prototype.dispose=function(){this._destructors.forEach((function(e){return e()})),i.Destructor.destroyArray(this._destructors).destroyArray(this._handlers).destroyObject(this)},e.prototype.create=function(e){var t=new u.TaskRunner(this._handlers,this._errorHandler);return this.createTask(t,e)},e.prototype.useIf=function(e,t){return e&&this.use(t),this},e.prototype.use=function(e){var t=this.wrap(e);return this._handlers.push(t),this},e.prototype.when=function(e,t){return this.wrap(new o.ConditionHandler(e,this.wrap(t)))},e.prototype.parallel=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=t.map((function(t){return e.wrap(t)}));return this.wrap((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,Promise.all(i.map((function(e){return e(t)})))];case 1:return e.sent(),[2]}}))}))}))},e.prototype.serialOutside=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=t.map((function(t){return e.wrap(t)})),o=i.length;return this.wrap((function(t){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(n){switch(n.label){case 0:e=0,n.label=1;case 1:return e<o?[4,i[e](t)]:[3,4];case 2:n.sent(),n.label=3;case 3:return e++,[3,1];case 4:return[2]}}))})),Promise.resolve()}))},e.prototype.serialCycleOutside=function(e,t,n){var r=this;void 0===n&&(n=[]);var i=t.map((function(e){return r.wrap(e)})),o=n.map((function(e){return r.wrap(e)}));return this.wrap(new s.CycleHandler(e,i,o))},e.prototype.concurrent=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=t.map((function(t){return e.wrap(t)}));return this.wrap((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,Promise.race(i.map((function(e){return e(t)})))];case 1:return e.sent(),[2]}}))}))}))},e.prototype.useWhen=function(e,t){return this.use(this.when(e,t))},e.prototype.useParallel=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.use(this.parallel.apply(this,r.__spread(e)))},e.prototype.useConcurrent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.use(this.concurrent.apply(this,r.__spread(e)))},e.prototype.useSerialOutside=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.use(this.serialOutside.apply(this,r.__spread(e)))},e.prototype.useSerialCycleOutside=function(e,t,n){return this.use(this.serialCycleOutside(e,t,n))},e.prototype.useErrorHandler=function(e){return this._errorHandler=e,this},e.prototype.wrap=function(e){return e instanceof a.TaskHandler?(this._destructors.push((function(){return e.dispose()})),function(t){return e._handleWrapper(t)}):e},e}();t.TaskPipeline=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(55),s=n(4),a=n(176),u=n(177),c=n(36),l=function(e){function t(t,n,r){var s=e.call(this,r)||this;if(s.id="",s.flags=new c.SegmentBitmask,s.timings=new o.RequestTimings,s.getDataLoadingAwaiter=function(){return s.stream.getLoadingAwaiter()},s.getDataLoadedAwaiter=function(){return s.stream.getFinishAwaiter()},!t)throw new i.ArgumentNullException("id");if(!n)throw new i.ArgumentNullException("request");if(!r)throw new i.ArgumentNullException("runner");return s.id=t,s.request=n,s.stream=new u.DataStream(t),s.stream.onOpened=function(){return s.timings.register(o.RequestState.RequestSent)},s.stream.onLoading=function(){return s.timings.register(o.RequestState.Loading)},s.stream.onClosed=function(){return s.timings.register(o.RequestState.Loaded)},s}return r.__extends(t,e),t.prototype.dispose=function(){this.stream&&(this.stream.close(!0),s.Destructor.destroyObject(this.stream)),s.Destructor.destroyObject(this)},t.prototype.abort=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this.stream&&this.stream.close(),[4,e.prototype.abort.call(this)];case 1:return t.sent(),[2]}}))}))},t}(a.Task);t.BaseLoadingTask=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(12),i=n(70),o=n(3),s=n(2),a=n(53),u=n(42),c=function(){function e(e){this._capacity=e,this._value="",this._pointer=-1,this._cache=new Map,this._metacache=new Map,this._checksumcache=new Map,this._checkedData=new ArrayBuffer(0),this._previous=[],this._logger=new s.Logger("HashChain"),this._completed=!1,this._currentvalidity=!0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointer",{get:function(){return this._pointer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isCompleted",{get:function(){return this._completed},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"trace",{get:function(){return{value:this._value,capacity:this._capacity,pointer:this._pointer,cached:this._cache.size,previous:this._previous}},enumerable:!0,configurable:!0}),e.prototype.add=function(e,t,n,s){if(t<=this._pointer)return null;if(!this.isNextPosition(t))return this._cache.set(t,e),n&&this._metacache.set(t,n),s&&this._checksumcache.set(t,s),null;var a=i.Crc32.generate(e);this._previous.push(this._value),this._value=u.XXHash.generate(this._value+a),this._pointer=t,this._checkedData=r.Buffer.concat(this._checkedData,e),s&&(this._currentvalidity=this.equal(s));var c=t+1;if(this._cache.has(c)){this._metacache.has(c)&&this._metacache.get(c).isLastPacket&&(this._logger.infoIf(o.Environment.isDevelopment,"RACELOG found last chunk in cache"),this._completed=!0);var l=this._cache.get(c);this._cache.delete(c);var h=this.add(l,c,this._metacache.get(c),this._checksumcache.get(c));h&&(this._checkedData=r.Buffer.concat(this._checkedData,h))}var d=r.Buffer.copy(this._checkedData);return this._checkedData=r.Buffer.empty,d},e.prototype.equal=function(e){return!!e&&a.StringUtils.padStart(e.toString(16),8,"0")===this._value},e.prototype.isCurrentValid=function(){return this._currentvalidity},e.prototype.toString=function(){return"HashChain ("+this._pointer+"/"+this._capacity+"/"+this._cache.size+") "+this._value},e.prototype.toJSON=function(){return{$type:this.toString()}},e.prototype.isNextPosition=function(e){return e-this._pointer==1},e}();t.HashChain=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r,i)||this;return o.name="PipeOverflowException",o}return r.__extends(t,e),t}(n(11).Exception);t.PipeOverflowException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(0),o=n(13);!function(e){e[e.Meta=1]="Meta",e[e.MetaLast=2]="MetaLast",e[e.LastPacket=4]="LastPacket",e[e.Response=8]="Response",e[e.NeedAnswer=16]="NeedAnswer",e[e.Race=32]="Race",e[e.EndOfTransfer=64]="EndOfTransfer",e[e._R3=128]="_R3"}(r=t.WebRtcChunkMeta||(t.WebRtcChunkMeta={}));var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i.__extends(t,e),Object.defineProperty(t.prototype,"isResponse",{get:function(){return this.has(r.Response)},set:function(e){this.toggleIf(e,r.Response)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isNeedAnswer",{get:function(){return this.has(r.NeedAnswer)},set:function(e){this.toggleIf(e,r.NeedAnswer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMeta",{get:function(){return this.has(r.Meta)},set:function(e){this.toggleIf(e,r.Meta)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMetaLast",{get:function(){return this.has(r.MetaLast)},set:function(e){this.toggleIf(e,r.MetaLast)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLastPacket",{get:function(){return this.has(r.LastPacket)},set:function(e){this.toggleIf(e,r.LastPacket)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRace",{get:function(){return this.has(r.Race)},set:function(e){this.toggleIf(e,r.Race)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isEndOfTransfer",{get:function(){return this.has(r.EndOfTransfer)},set:function(e){this.toggleIf(e,r.EndOfTransfer)},enumerable:!0,configurable:!0}),t}(o.Bitmask);t.P2PChunkBitmask=s},function(e,t,n){"use strict";(function(t,r){var i;e.exports=P,P.ReadableState=T,n(102).EventEmitter;var o,s=function(e,t){return e.listeners(t).length},a=n(103),u=n(27).Buffer,c=t.Uint8Array||function(){},l=n(214);o=l&&l.debuglog?l.debuglog("stream"):function(){};var h,d,f,p=n(215),_=n(104),g=n(105).getHighWaterMark,m=n(37).codes,y=m.ERR_INVALID_ARG_TYPE,v=m.ERR_STREAM_PUSH_AFTER_EOF,w=m.ERR_METHOD_NOT_IMPLEMENTED,b=m.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;n(28)(P,a);var S=_.errorOrDestroy,E=["error","close","destroy","pause","resume"];function T(e,t,r){i=i||n(38),e=e||{},"boolean"!=typeof r&&(r=t instanceof i),this.objectMode=!!e.objectMode,r&&(this.objectMode=this.objectMode||!!e.readableObjectMode),this.highWaterMark=g(this,e,"readableHighWaterMark",r),this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(h||(h=n(107).StringDecoder),this.decoder=new h(e.encoding),this.encoding=e.encoding)}function P(e){if(i=i||n(38),!(this instanceof P))return new P(e);var t=this instanceof i;this._readableState=new T(e,this,t),this.readable=!0,e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy)),a.call(this)}function C(e,t,n,r,i){o("readableAddChunk",t);var s,a=e._readableState;if(null===t)a.reading=!1,function(e,t){if(o("onEofChunk"),!t.ended){if(t.decoder){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,t.sync?A(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,R(e)))}}(e,a);else if(i||(s=function(e,t){var n,r;return r=t,u.isBuffer(r)||r instanceof c||"string"==typeof t||void 0===t||e.objectMode||(n=new y("chunk",["string","Buffer","Uint8Array"],t)),n}(a,t)),s)S(e,s);else if(a.objectMode||t&&t.length>0)if("string"==typeof t||a.objectMode||Object.getPrototypeOf(t)===u.prototype||(t=function(e){return u.from(e)}(t)),r)a.endEmitted?S(e,new b):D(e,a,t,!0);else if(a.ended)S(e,new v);else{if(a.destroyed)return!1;a.reading=!1,a.decoder&&!n?(t=a.decoder.write(t),a.objectMode||0!==t.length?D(e,a,t,!1):M(e,a)):D(e,a,t,!1)}else r||(a.reading=!1,M(e,a));return!a.ended&&(a.length<a.highWaterMark||0===a.length)}function D(e,t,n,r){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",n)):(t.length+=t.objectMode?1:n.length,r?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&A(e)),M(e,t)}Object.defineProperty(P.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),P.prototype.destroy=_.destroy,P.prototype._undestroy=_.undestroy,P.prototype._destroy=function(e,t){t(e)},P.prototype.push=function(e,t){var n,r=this._readableState;return r.objectMode?n=!0:"string"==typeof e&&((t=t||r.defaultEncoding)!==r.encoding&&(e=u.from(e,t),t=""),n=!0),C(this,e,t,!1,n)},P.prototype.unshift=function(e){return C(this,e,null,!0,!1)},P.prototype.isPaused=function(){return!1===this._readableState.flowing},P.prototype.setEncoding=function(e){h||(h=n(107).StringDecoder);var t=new h(e);this._readableState.decoder=t,this._readableState.encoding=this._readableState.decoder.encoding;for(var r=this._readableState.buffer.head,i="";null!==r;)i+=t.write(r.data),r=r.next;return this._readableState.buffer.clear(),""!==i&&this._readableState.buffer.push(i),this._readableState.length=i.length,this};var O=1073741824;function I(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=O?e=O:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function A(e){var t=e._readableState;o("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(o("emitReadable",t.flowing),t.emittedReadable=!0,r.nextTick(R,e))}function R(e){var t=e._readableState;o("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,H(e)}function M(e,t){t.readingMore||(t.readingMore=!0,r.nextTick(N,e,t))}function N(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var n=t.length;if(o("maybeReadMore read 0"),e.read(0),n===t.length)break}t.readingMore=!1}function k(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function x(e){o("readable nexttick read 0"),e.read(0)}function L(e,t){o("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),H(e),t.flowing&&!t.reading&&e.read(0)}function H(e){var t=e._readableState;for(o("flow",t.flowing);t.flowing&&null!==e.read(););}function j(e,t){return 0===t.length?null:(t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):n=t.buffer.consume(e,t.decoder),n);var n}function B(e){var t=e._readableState;o("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,r.nextTick(U,t,e))}function U(e,t){if(o("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var n=t._writableState;(!n||n.autoDestroy&&n.finished)&&t.destroy()}}function W(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}P.prototype.read=function(e){o("read",e),e=parseInt(e,10);var t=this._readableState,n=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return o("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?B(this):A(this),null;if(0===(e=I(e,t))&&t.ended)return 0===t.length&&B(this),null;var r,i=t.needReadable;return o("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&o("length less than watermark",i=!0),t.ended||t.reading?o("reading or ended",i=!1):i&&(o("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=I(n,t))),null===(r=e>0?j(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&B(this)),null!==r&&this.emit("data",r),r},P.prototype._read=function(e){S(this,new w("_read()"))},P.prototype.pipe=function(e,t){var n=this,i=this._readableState;switch(i.pipesCount){case 0:i.pipes=e;break;case 1:i.pipes=[i.pipes,e];break;default:i.pipes.push(e)}i.pipesCount+=1,o("pipe count=%d opts=%j",i.pipesCount,t);var a=t&&!1===t.end||e===r.stdout||e===r.stderr?_:u;function u(){o("onend"),e.end()}i.endEmitted?r.nextTick(a):n.once("end",a),e.on("unpipe",(function t(r,s){o("onunpipe"),r===n&&s&&!1===s.hasUnpiped&&(s.hasUnpiped=!0,o("cleanup"),e.removeListener("close",f),e.removeListener("finish",p),e.removeListener("drain",c),e.removeListener("error",d),e.removeListener("unpipe",t),n.removeListener("end",u),n.removeListener("end",_),n.removeListener("data",h),l=!0,!i.awaitDrain||e._writableState&&!e._writableState.needDrain||c())}));var c=function(e){return function(){var t=e._readableState;o("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&s(e,"data")&&(t.flowing=!0,H(e))}}(n);e.on("drain",c);var l=!1;function h(t){o("ondata");var r=e.write(t);o("dest.write",r),!1===r&&((1===i.pipesCount&&i.pipes===e||i.pipesCount>1&&-1!==W(i.pipes,e))&&!l&&(o("false write response, pause",i.awaitDrain),i.awaitDrain++),n.pause())}function d(t){o("onerror",t),_(),e.removeListener("error",d),0===s(e,"error")&&S(e,t)}function f(){e.removeListener("finish",p),_()}function p(){o("onfinish"),e.removeListener("close",f),_()}function _(){o("unpipe"),n.unpipe(e)}return n.on("data",h),function(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}(e,"error",d),e.once("close",f),e.once("finish",p),e.emit("pipe",n),i.flowing||(o("pipe resume"),n.resume()),e},P.prototype.unpipe=function(e){var t=this._readableState,n={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,n)),this;if(!e){var r=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var o=0;o<i;o++)r[o].emit("unpipe",this,{hasUnpiped:!1});return this}var s=W(t.pipes,e);return-1===s||(t.pipes.splice(s,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,n)),this},P.prototype.on=function(e,t){var n=a.prototype.on.call(this,e,t),i=this._readableState;return"data"===e?(i.readableListening=this.listenerCount("readable")>0,!1!==i.flowing&&this.resume()):"readable"===e&&(i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.flowing=!1,i.emittedReadable=!1,o("on readable",i.length,i.reading),i.length?A(this):i.reading||r.nextTick(x,this))),n},P.prototype.addListener=P.prototype.on,P.prototype.removeListener=function(e,t){var n=a.prototype.removeListener.call(this,e,t);return"readable"===e&&r.nextTick(k,this),n},P.prototype.removeAllListeners=function(e){var t=a.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||r.nextTick(k,this),t},P.prototype.resume=function(){var e=this._readableState;return e.flowing||(o("resume"),e.flowing=!e.readableListening,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(L,e,t))}(this,e)),e.paused=!1,this},P.prototype.pause=function(){return o("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(o("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},P.prototype.wrap=function(e){var t=this,n=this._readableState,r=!1;for(var i in e.on("end",(function(){if(o("wrapped end"),n.decoder&&!n.ended){var e=n.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(i){o("wrapped data"),n.decoder&&(i=n.decoder.write(i)),(!n.objectMode||null!=i)&&(n.objectMode||i&&i.length)&&(t.push(i)||(r=!0,e.pause()))})),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));for(var s=0;s<E.length;s++)e.on(E[s],this.emit.bind(this,E[s]));return this._read=function(t){o("wrapped _read",t),r&&(r=!1,e.resume())},this},"function"==typeof Symbol&&(P.prototype[Symbol.asyncIterator]=function(){return void 0===d&&(d=n(218)),d(this)}),Object.defineProperty(P.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(P.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(P.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),P._fromList=j,Object.defineProperty(P.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(P.from=function(e,t){return void 0===f&&(f=n(219)),f(P,e,t)})}).call(this,n(34),n(35))},function(e,t,n){"use strict";var r,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,e.exports.once=function(e,t){return new Promise((function(n,r){function i(){void 0!==o&&e.removeListener("error",o),n([].slice.call(arguments))}var o;"error"!==t&&(o=function(n){e.removeListener(t,i),r(n)},e.once("error",o)),e.once(t,i)}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var u=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function h(e,t,n,r){var i,o,s,a;if(c(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=l(e))>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,a=u,console&&console.warn&&console.warn(a)}return e}function d(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(r);return i.listener=n,r.wrapFn=i,i}function f(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):_(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function _(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");u=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=i[e];if(void 0===u)return!1;if("function"==typeof u)o(u,this,t);else{var c=u.length,l=_(u,c);for(n=0;n<c;++n)o(l[n],this,t)}return!0},a.prototype.addListener=function(e,t){return h(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return h(this,e,t,!0)},a.prototype.once=function(e,t){return c(t),this.on(e,d(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,d(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,r,i,o,s;if(c(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return f(this,e,!0)},a.prototype.rawListeners=function(e){return f(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,n){e.exports=n(102).EventEmitter},function(e,t,n){"use strict";(function(t){function n(e,t){i(e,t),r(e)}function r(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function i(e,t){e.emit("error",t)}e.exports={destroy:function(e,o){var s=this,a=this._readableState&&this._readableState.destroyed,u=this._writableState&&this._writableState.destroyed;return a||u?(o?o(e):e&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,t.nextTick(i,this,e)):t.nextTick(i,this,e)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,(function(e){!o&&e?s._writableState?s._writableState.errorEmitted?t.nextTick(r,s):(s._writableState.errorEmitted=!0,t.nextTick(n,s,e)):t.nextTick(n,s,e):o?(t.nextTick(r,s),o(e)):t.nextTick(r,s)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(e,t){var n=e._readableState,r=e._writableState;n&&n.autoDestroy||r&&r.autoDestroy?e.destroy(t):e.emit("error",t)}}}).call(this,n(35))},function(e,t,n){"use strict";var r=n(37).codes.ERR_INVALID_OPT_VALUE;e.exports={getHighWaterMark:function(e,t,n,i){var o=function(e,t,n){return null!=e.highWaterMark?e.highWaterMark:t?e[n]:null}(t,i,n);if(null!=o){if(!isFinite(o)||Math.floor(o)!==o||o<0)throw new r(i?n:"highWaterMark",o);return Math.floor(o)}return e.objectMode?16:16384}}},function(e,t,n){"use strict";(function(t,r){function i(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,n){var r=e.entry;for(e.entry=null;r;){var i=r.callback;t.pendingcb--,i(void 0),r=r.next}t.corkedRequestsFree.next=e}(t,e)}}var o;e.exports=P,P.WritableState=T;var s,a={deprecate:n(217)},u=n(103),c=n(27).Buffer,l=t.Uint8Array||function(){},h=n(104),d=n(105).getHighWaterMark,f=n(37).codes,p=f.ERR_INVALID_ARG_TYPE,_=f.ERR_METHOD_NOT_IMPLEMENTED,g=f.ERR_MULTIPLE_CALLBACK,m=f.ERR_STREAM_CANNOT_PIPE,y=f.ERR_STREAM_DESTROYED,v=f.ERR_STREAM_NULL_VALUES,w=f.ERR_STREAM_WRITE_AFTER_END,b=f.ERR_UNKNOWN_ENCODING,S=h.errorOrDestroy;function E(){}function T(e,t,s){o=o||n(38),e=e||{},"boolean"!=typeof s&&(s=t instanceof o),this.objectMode=!!e.objectMode,s&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=d(this,e,"writableHighWaterMark",s),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var a=!1===e.decodeStrings;this.decodeStrings=!a,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n=e._writableState,i=n.sync,o=n.writecb;if("function"!=typeof o)throw new g;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(n),t)!function(e,t,n,i,o){--t.pendingcb,n?(r.nextTick(o,i),r.nextTick(R,e,t),e._writableState.errorEmitted=!0,S(e,i)):(o(i),e._writableState.errorEmitted=!0,S(e,i),R(e,t))}(e,n,i,t,o);else{var s=I(n)||e.destroyed;s||n.corked||n.bufferProcessing||!n.bufferedRequest||O(e,n),i?r.nextTick(D,e,n,s,o):D(e,n,s,o)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new i(this)}function P(e){var t=this instanceof(o=o||n(38));if(!t&&!s.call(P,this))return new P(e);this._writableState=new T(e,this,t),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),u.call(this)}function C(e,t,n,r,i,o,s){t.writelen=r,t.writecb=s,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new y("write")):n?e._writev(i,t.onwrite):e._write(i,o,t.onwrite),t.sync=!1}function D(e,t,n,r){n||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,r(),R(e,t)}function O(e,t){t.bufferProcessing=!0;var n=t.bufferedRequest;if(e._writev&&n&&n.next){var r=t.bufferedRequestCount,o=new Array(r),s=t.corkedRequestsFree;s.entry=n;for(var a=0,u=!0;n;)o[a]=n,n.isBuf||(u=!1),n=n.next,a+=1;o.allBuffers=u,C(e,t,!0,t.length,o,"",s.finish),t.pendingcb++,t.lastBufferedRequest=null,s.next?(t.corkedRequestsFree=s.next,s.next=null):t.corkedRequestsFree=new i(t),t.bufferedRequestCount=0}else{for(;n;){var c=n.chunk,l=n.encoding,h=n.callback;if(C(e,t,!1,t.objectMode?1:c.length,c,l,h),n=n.next,t.bufferedRequestCount--,t.writing)break}null===n&&(t.lastBufferedRequest=null)}t.bufferedRequest=n,t.bufferProcessing=!1}function I(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function A(e,t){e._final((function(n){t.pendingcb--,n&&S(e,n),t.prefinished=!0,e.emit("prefinish"),R(e,t)}))}function R(e,t){var n=I(t);if(n&&(function(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,r.nextTick(A,e,t)))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var i=e._readableState;(!i||i.autoDestroy&&i.endEmitted)&&e.destroy()}return n}n(28)(P,u),T.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(T.prototype,"buffer",{get:a.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(s=Function.prototype[Symbol.hasInstance],Object.defineProperty(P,Symbol.hasInstance,{value:function(e){return!!s.call(this,e)||this===P&&e&&e._writableState instanceof T}})):s=function(e){return e instanceof this},P.prototype.pipe=function(){S(this,new m)},P.prototype.write=function(e,t,n){var i,o=this._writableState,s=!1,a=!o.objectMode&&(i=e,c.isBuffer(i)||i instanceof l);return a&&!c.isBuffer(e)&&(e=function(e){return c.from(e)}(e)),"function"==typeof t&&(n=t,t=null),a?t="buffer":t||(t=o.defaultEncoding),"function"!=typeof n&&(n=E),o.ending?function(e,t){var n=new w;S(e,n),r.nextTick(t,n)}(this,n):(a||function(e,t,n,i){var o;return null===n?o=new v:"string"==typeof n||t.objectMode||(o=new p("chunk",["string","Buffer"],n)),!o||(S(e,o),r.nextTick(i,o),!1)}(this,o,e,n))&&(o.pendingcb++,s=function(e,t,n,r,i,o){if(!n){var s=function(e,t,n){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=c.from(t,n)),t}(t,r,i);r!==s&&(n=!0,i="buffer",r=s)}var a=t.objectMode?1:r.length;t.length+=a;var u=t.length<t.highWaterMark;if(u||(t.needDrain=!0),t.writing||t.corked){var l=t.lastBufferedRequest;t.lastBufferedRequest={chunk:r,encoding:i,isBuf:n,callback:o,next:null},l?l.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else C(e,t,!1,a,r,i,o);return u}(this,o,a,e,t,n)),s},P.prototype.cork=function(){this._writableState.corked++},P.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||O(this,e))},P.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new b(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(P.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(P.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),P.prototype._write=function(e,t,n){n(new _("_write()"))},P.prototype._writev=null,P.prototype.end=function(e,t,n){var i=this._writableState;return"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),i.corked&&(i.corked=1,this.uncork()),i.ending||function(e,t,n){t.ending=!0,R(e,t),n&&(t.finished?r.nextTick(n):e.once("finish",n)),t.ended=!0,e.writable=!1}(this,i,n),this},Object.defineProperty(P.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(P.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),P.prototype.destroy=h.destroy,P.prototype._undestroy=h.undestroy,P.prototype._destroy=function(e,t){t(e)}}).call(this,n(34),n(35))},function(e,t,n){"use strict";var r=n(72).Buffer,i=r.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function o(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(r.isEncoding===i||!i(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=u,this.end=c,t=4;break;case"utf8":this.fillLast=a,t=4;break;case"base64":this.text=l,this.end=h,t=3;break;default:return this.write=d,void(this.end=f)}this.lastNeed=0,this.lastTotal=0,this.lastChar=r.allocUnsafe(t)}function s(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function a(e){var t=this.lastTotal-this.lastNeed,n=function(e,t,n){if(128!=(192&t[0]))return e.lastNeed=0,"";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,""}}(this,e);return void 0!==n?n:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function u(e,t){if((e.length-t)%2==0){var n=e.toString("utf16le",t);if(n){var r=n.charCodeAt(n.length-1);if(r>=55296&&r<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],n.slice(0,-1)}return n}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function c(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var n=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,n)}return t}function l(e,t){var n=(e.length-t)%3;return 0===n?e.toString("base64",t):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-n))}function h(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function d(e){return e.toString(this.encoding)}function f(e){return e&&e.length?this.write(e):""}t.StringDecoder=o,o.prototype.write=function(e){if(0===e.length)return"";var t,n;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";n=this.lastNeed,this.lastNeed=0}else n=0;return n<e.length?t?t+this.text(e,n):this.text(e,n):t||""},o.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"":t},o.prototype.text=function(e,t){var n=function(e,t,n){var r=t.length-1;if(r<n)return 0;var i=s(t[r]);return i>=0?(i>0&&(e.lastNeed=i-1),i):--r<n||-2===i?0:(i=s(t[r]))>=0?(i>0&&(e.lastNeed=i-2),i):--r<n||-2===i?0:(i=s(t[r]))>=0?(i>0&&(2===i?i=0:e.lastNeed=i-3),i):0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=n;var r=e.length-(n-this.lastNeed);return e.copy(this.lastChar,0,r),e.toString("utf8",t,r)},o.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},function(e,t,n){"use strict";e.exports=c;var r=n(37).codes,i=r.ERR_METHOD_NOT_IMPLEMENTED,o=r.ERR_MULTIPLE_CALLBACK,s=r.ERR_TRANSFORM_ALREADY_TRANSFORMING,a=r.ERR_TRANSFORM_WITH_LENGTH_0,u=n(38);function c(e){if(!(this instanceof c))return new c(e);u.call(this,e),this._transformState={afterTransform:function(e,t){var n=this._transformState;n.transforming=!1;var r=n.writecb;if(null===r)return this.emit("error",new o);n.writechunk=null,n.writecb=null,null!=t&&this.push(t),r(e);var i=this._readableState;i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",l)}function l(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?h(this,null,null):this._flush((function(t,n){h(e,t,n)}))}function h(e,t,n){if(t)return e.emit("error",t);if(null!=n&&e.push(n),e._writableState.length)throw new a;if(e._transformState.transforming)throw new s;return e.push(null)}n(28)(c,u),c.prototype.push=function(e,t){return this._transformState.needTransform=!1,u.prototype.push.call(this,e,t)},c.prototype._transform=function(e,t,n){n(new i("_transform()"))},c.prototype._write=function(e,t,n){var r=this._transformState;if(r.writecb=n,r.writechunk=e,r.writeencoding=t,!r.transforming){var i=this._readableState;(r.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},c.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},c.prototype._destroy=function(e,t){u.prototype._destroy.call(this,e,(function(e){t(e)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(75),o=n(3);!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.INTERVAL_REVIVE=1]="INTERVAL_REVIVE",e[e.STOP=2]="STOP"}(r=t.BackendWorkMode||(t.BackendWorkMode={}));var s=function(){function e(e,t,n){var o=this;this.config=e,this.backend=t,this.blackList=n,this._workMode=r.DEFAULT,this.onBackendWorkModeChangeDC=new i.DelegateCollection,this.blackList.onBlocking=function(){return o.onBlocking()},this.config.onChangedBulk=function(e){return o.onConfigChange(e)}}return Object.defineProperty(e.prototype,"workMode",{get:function(){return this._workMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onWorkModeChange",{get:function(){return this.onBackendWorkModeChangeDC.exec.bind(this.onBackendWorkModeChangeDC)},set:function(e){this.onBackendWorkModeChangeDC.add(e)},enumerable:!0,configurable:!0}),e.prototype.onBlocking=function(){0!==this.config.backendLoadMode&&this._workMode!==r.STOP&&(this._workMode=r.STOP,this._fireWorkMode())},e.prototype.onConfigChange=function(e){for(var t=0;t<e.length;t++){var n=e[t];if("backendLoadMode"===n.paramName){var i=this._workMode;if(0!==n.newValue)switch(!0){case this.blackList.isBlocked()||!o.Environment.isWebRtcSupported:this._workMode=r.STOP;break;case 1===n.newValue:this._workMode=r.DEFAULT;break;case 2===n.newValue&&this.config.peeringMode<2:case 2===n.newValue&&1===this.backend.configLoadCount:this._workMode=r.INTERVAL_REVIVE}else this._workMode=r.DEFAULT;return void(i!==this._workMode&&this._fireWorkMode())}}},e.prototype._fireWorkMode=function(){var e=this;setTimeout((function(){return e.onWorkModeChange(e._workMode)}),100)},e}();t.BackendManager=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i,o=n(0),s=n(19),a=n(1),u=n(254),c=n(13),l=n(12),h=n(4),d=n(3),f=n(2),p=n(8);!function(e){e[e.HAVE_SEGMENT=0]="HAVE_SEGMENT",e[e.DOWNLOAD_SEGMENT=1]="DOWNLOAD_SEGMENT",e[e.SEARCH_PEERS=2]="SEARCH_PEERS",e[e.SIGNAL=3]="SIGNAL",e[e.PING=4]="PING",e[e.SPEEDTEST=5]="SPEEDTEST",e[e.CHOKE=6]="CHOKE",e[e.PEER_INFO=7]="PEER_INFO",e[e.SCORE=8]="SCORE",e[e.TIMESLOT=9]="TIMESLOT",e[e.MULTIHAVE_SEGMENT=10]="MULTIHAVE_SEGMENT",e[e.HTS=11]="HTS",e[e.SEGMENT_HASH=12]="SEGMENT_HASH",e[e.SEGMENT_HASH_MUTE=13]="SEGMENT_HASH_MUTE",e[e.IMPACT_MATCHER_CANDIDATE=14]="IMPACT_MATCHER_CANDIDATE",e[e.IMPACT_MATCHER_MUTE=15]="IMPACT_MATCHER_MUTE",e[e.SEGMENT_URL=16]="SEGMENT_URL"}(r||(r={})),function(e){e[e.BROADCAST_HAVE=1]="BROADCAST_HAVE",e[e.BROADCAST_SCORE=2]="BROADCAST_SCORE",e[e.BROADCAST_CHOKE=4]="BROADCAST_CHOKE",e[e.BROADCAST_TIMESLOT=8]="BROADCAST_TIMESLOT",e[e.BROADCAST_INFO=16]="BROADCAST_INFO",e[e.BROADCAST_HTS=32]="BROADCAST_HTS",e[e.BROADCAST_SEGMENT_HASH=64]="BROADCAST_SEGMENT_HASH",e[e.OLD_HAVES=256]="OLD_HAVES",e[e.SINGLE_CHOKE=512]="SINGLE_CHOKE"}(i=t.PdnMessageType||(t.PdnMessageType={}));var _=function(){function e(e,t,n){var r=this;if(this._socket=e,this._metrics=t,this._config=n,this._logger=new f.Logger("PdnApi"),!e)throw new a.ArgumentNullException("socket");if(!t)throw new a.ArgumentNullException("metrics");if(!n)throw new a.ArgumentNullException("config");this._client=new u.P2PClient(e),this._socket.onRequest=function(e,t){return r.handleRequest(e,t)}}return e.prototype.dispose=function(){this._socket.onRequest=void 0,this._client.dispose(),h.Destructor.destroyObject(this)},e.prototype.downloadSegment=function(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=1),this._metrics.register("PDN_GET_SEND"),this.registerOutgoingMessage();var o=this._client.createRequest(e,{segmentId:t});return o.headers={type:r.DOWNLOAD_SEGMENT},o.writeJSON({s:t,tm:Math.max(this._config.rtcDownloadTimeout-200,0),sc:n,sh:i}),(n>0||i>1)&&this._logger.infoIf(d.Environment.isDevelopment,"RACELOG "+t+" generate get seg sc="+n+", sh="+i+" "+o.id),o},e.prototype.getSegmentURL=function(e,t){this._metrics.register("PDN_GET_URL_SEND"),this.registerOutgoingMessage();var n=this._client.createRequest(e,{segmentId:t});return n.headers={type:r.SEGMENT_URL},n.writeJSON({s:t}),n},e.prototype.search=function(e,t,n){this._metrics.register("PDN_SEARCH_SEND"),this.registerOutgoingMessage();var i=this._client.createRequest(e);return i.headers={type:r.SEARCH_PEERS},i.writeJSON({count:t,except:n}),i},e.prototype.signal=function(e,t,n,i){this._metrics.register("PDN_SIGNAL_SEND"),this.registerOutgoingMessage();var o=this._client.createRequest(e);return o.headers={type:r.SIGNAL},o.writeJSON({from:t,to:n,signal:i}),o},e.prototype.ping=function(e){this._metrics.register("PDN_PING_SEND"),this.registerOutgoingMessage();var t=this._client.createRequest(e);return t.headers={type:r.PING},t},e.prototype.speedtest=function(e,t){this._metrics.register("PDN_PROBE_SEND"),this.registerOutgoingMessage();var n=this._client.createRequest(e);return n.headers={type:r.SPEEDTEST},n.writeJSON({size:t}),n},e.prototype.multiHave=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){var n,s;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.OLD_HAVES))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2];this._metrics.register("PDN_MULTIHAVE_SEND"),(n=this._client.createRequest(e)).headers={type:r.MULTIHAVE_SEGMENT},n.writeJSON({items:t}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.send(!1)];case 2:return o.sent(),this.registerOutgoingMessage(n.count),[3,4];case 3:return s=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"multi have error",{items:t,e:s}),[3,4];case 4:return[2]}}))}))},e.prototype.muteSegmentHash=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){var n,i;return o.__generator(this,(function(o){switch(o.label){case 0:this._metrics.register("PDN_SEGMENT_HASH_MUTE_SEND"),(n=this._client.createRequest(e)).headers={type:r.SEGMENT_HASH_MUTE},n.writeJSON({mute:t}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.send(!1)];case 2:return o.sent(),this.registerOutgoingMessage(n.count),[3,4];case 3:return i=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"stopSegmentHash error",{stop:t,e:i}),[3,4];case 4:return[2]}}))}))},e.prototype.muteImpactMatcher=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){var n,i;return o.__generator(this,(function(o){switch(o.label){case 0:this._metrics.register("PDN_IMPACT_MATCH_MUTE_SEND"),(n=this._client.createRequest(e)).headers={type:r.IMPACT_MATCHER_MUTE},n.writeJSON({mute:t}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.send(!1)];case 2:return o.sent(),this.registerOutgoingMessage(n.count),[3,4];case 3:return i=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"muteImpactMatcher error",{mute:t,e:i}),[3,4];case 4:return[2]}}))}))},e.prototype.broadcastMuteImpactMatcher=function(e){return o.__awaiter(this,void 0,void 0,(function(){var t,n;return o.__generator(this,(function(i){switch(i.label){case 0:(t=this._client.createBroadcast()).headers={type:r.IMPACT_MATCHER_MUTE},t.writeJSON({mute:e}),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t.send(!1)];case 2:return i.sent(),this._metrics.register("PDN_IMPACT_MATCH_MUTE_SEND",t.count),this.registerOutgoingMessage(t.count),[3,4];case 3:return n=i.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcastMuteImpactMatcher error",{mute:e,e:n}),[3,4];case 4:return[2]}}))}))},e.prototype.impactMatcherCandidate=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){var n,i;return o.__generator(this,(function(o){switch(o.label){case 0:this._metrics.register("PDN_IMPACT_MATCH_CANDIDATE_SEND"),(n=this._client.createRequest(e)).headers={type:r.IMPACT_MATCHER_CANDIDATE},n.writeJSON({connectionId:t}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.send(!1)];case 2:return o.sent(),this.registerOutgoingMessage(n.count),[3,4];case 3:return i=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"impactMatcherCandidate error",{connectionId:t,e:i}),[3,4];case 4:return[2]}}))}))},e.prototype.broadcastHave=function(e,t,n,s){return o.__awaiter(this,void 0,void 0,(function(){var a,u;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_HAVE))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.register("PDN_HAVE_BROADCAST"),(a=this._client.createBroadcast()).headers={type:r.HAVE_SEGMENT},a.writeJSON({s:e,tt:t,ty:n,cl:s}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,a.send()];case 2:return o.sent(),this.registerOutgoingMessage(a.count),[3,4];case 3:return u=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast have error",{segmentId:e,ttl:t,type:n,e:u}),[3,4];case 4:return[2,a.count]}}))}))},e.prototype.broadcastHTS=function(e,t,n,s,a,u,l,h){return o.__awaiter(this,void 0,void 0,(function(){var f,p;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_HTS))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.register("PDN_HTS_BROADCAST"),(f=this._client.createBroadcast()).headers={type:r.HTS},f.writeJSON({s:e,tt:t,ty:n,score:a,timeslot:s,issTrigger:u,edgeTimeSlot:l,cl:h}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,f.send()];case 2:return o.sent(),this.registerOutgoingMessage(f.count),[3,4];case 3:return p=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast HTS error",{segmentId:e,ttl:t,type:n,e:p}),[3,4];case 4:return[2,f.count]}}))}))},e.prototype.broadcastScore=function(e){return o.__awaiter(this,void 0,void 0,(function(){var t,n;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_SCORE))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.register("PDN_SCORE_BROADCAST"),(t=this._client.createBroadcast()).headers={type:r.SCORE},t.writeJSON({score:e}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,t.send()];case 2:return o.sent(),this.registerOutgoingMessage(t.count),[3,4];case 3:return n=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast score error",{score:e,e:n}),[3,4];case 4:return[2,t.count]}}))}))},e.prototype.broadcastSegmentHash=function(e,t,n,s){return o.__awaiter(this,void 0,void 0,(function(){var a,u;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_SEGMENT_HASH))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.register("PDN_SEGMENT_HASH_BROADCAST"),(a=this._client.createBroadcast((function(e){return e.ready&&!s.has(e.uuid)}))).headers={type:r.SEGMENT_HASH},a.writeJSON({s:e,h:t,tt:n}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,a.send()];case 2:return o.sent(),this.registerOutgoingMessage(a.count),[3,4];case 3:return u=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast SegmentHash error",{segmentId:e,segmentHash:t,e:u}),[3,4];case 4:return[2,a.count]}}))}))},e.prototype.choke=function(e,t,n){return o.__awaiter(this,void 0,void 0,(function(){var s,a;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.SINGLE_CHOKE))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2];this._metrics.registerIf(t,"PDN_CHOKE_SEND").registerIf(!t,"PDN_UNCHOKE_SEND"),(s=this._client.createRequest(e)).headers={type:r.CHOKE},s.writeJSON({isChoked:t,tt:n}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,s.send()];case 2:return o.sent(),this.registerOutgoingMessage(s.count),[3,4];case 3:return a=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"choke error",{isChoked:t,e:a}),[3,4];case 4:return[2]}}))}))},e.prototype.broadcastChoke=function(e,t,n){return o.__awaiter(this,void 0,void 0,(function(){var s,a;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_CHOKE))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.registerIf(e,"PDN_CHOKE_BROADCAST").registerIf(!e,"PDN_UNCHOKE_BROADCAST"),(s=this._client.createBroadcast(n)).headers={type:r.CHOKE},s.writeJSON({isChoked:e,tt:t}),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,s.send()];case 2:return o.sent(),this.registerOutgoingMessage(s.count),[3,4];case 3:return a=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast choke error",{isChoked:e,e:a}),[3,4];case 4:return[2,s.count]}}))}))},e.prototype.broadcastInfo=function(e){return o.__awaiter(this,void 0,void 0,(function(){var t,n;return o.__generator(this,(function(o){switch(o.label){case 0:if(!c.Bitmask.check(this._config.availablePdnMessageType,i.BROADCAST_INFO))return this._metrics.register("TOTAL_PDN_MESSAGES_SKIPED"),[2,0];this._metrics.register("PDN_INFO_BROADCAST"),(t=this._client.createBroadcast()).headers={type:r.PEER_INFO},t.writeJSON(e),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,t.send()];case 2:return o.sent(),this.registerOutgoingMessage(t.count),[3,4];case 3:return n=o.sent(),this._logger.errorIf(d.Environment.isDevelopment,"broadcast info error",{info:e,e:n}),[3,4];case 4:return[2,t.count]}}))}))},e.prototype.handleRequest=function(e,t){return o.__awaiter(this,void 0,void 0,(function(){var n,i=this;return o.__generator(this,(function(o){switch(o.label){case 0:switch(o.trys.push([0,61,62,64]),p.Timer.timeout((function(){i.onRequest&&i.onRequest(e)}),100),e.headers.type){case r.HAVE_SEGMENT:return[3,1];case r.DOWNLOAD_SEGMENT:return[3,4];case r.SEARCH_PEERS:return[3,7];case r.SIGNAL:return[3,10];case r.PING:return[3,13];case r.SPEEDTEST:return[3,16];case r.CHOKE:return[3,19];case r.PEER_INFO:return[3,22];case r.SCORE:return[3,27];case r.TIMESLOT:return[3,30];case r.MULTIHAVE_SEGMENT:return[3,33];case r.HTS:return[3,38];case r.SEGMENT_HASH:return[3,47];case r.SEGMENT_HASH_MUTE:return[3,50];case r.IMPACT_MATCHER_CANDIDATE:return[3,53];case r.IMPACT_MATCHER_MUTE:return[3,56]}return[3,59];case 1:return this._metrics.register("PDN_HAVE_RECEIVE"),this.onHave?[4,this.onHave(e,t)]:[3,3];case 2:o.sent(),o.label=3;case 3:return[3,60];case 4:return this._metrics.register("PDN_GET_RECEIVE"),this._logger.infoIf(d.Environment.isDevelopment,"Segment get received",{req:e,res:t}),this.onDownload?[4,this.onDownload(e,t)]:[3,6];case 5:o.sent(),o.label=6;case 6:return[3,60];case 7:return this._metrics.register("PDN_SEARCH_RECEIVE"),this.onSearch?[4,this.onSearch(e,t)]:[3,9];case 8:o.sent(),o.label=9;case 9:return[3,60];case 10:return this._metrics.register("PDN_SIGNAL_RECEIVE"),this.onSdp?[4,this.onSdp(e,t)]:[3,12];case 11:o.sent(),o.label=12;case 12:return[3,60];case 13:return this._metrics.register("PDN_PING_RECEIVE"),this._logger.infoIf(d.Environment.isDevelopment,"Ping received",{req:e,res:t}),this.onPing?[4,this.onPing(e,t)]:[3,15];case 14:o.sent(),o.label=15;case 15:return[3,60];case 16:return this._metrics.register("PDN_PROBE_RECEIVE"),this.onSpeedtest?[4,this.onSpeedtest(e,t)]:[3,18];case 17:o.sent(),o.label=18;case 18:return[3,60];case 19:return this.onChoke?[4,this.onChoke(e,t)]:[3,21];case 20:o.sent(),o.label=21;case 21:return[3,60];case 22:return this._metrics.register("PDN_INFO_RECEIVE"),this._logger.infoIf(d.Environment.isDevelopment,"Peer info received",{req:e,res:t}),this.onPeerInfo?[4,this.onPeerInfo(e,t)]:[3,24];case 23:o.sent(),o.label=24;case 24:return this.onIssTrigger?[4,this.onIssTrigger(e,t)]:[3,26];case 25:o.sent(),o.label=26;case 26:return[3,60];case 27:return this._metrics.register("PDN_SCORE_RECEIVE"),this.onScore?[4,this.onScore(e,t)]:[3,29];case 28:o.sent(),o.label=29;case 29:return[3,60];case 30:return this._metrics.register("PDN_TIMESLOT_RECEIVE"),this.onTimeslot?[4,this.onTimeslot(e,t)]:[3,32];case 31:o.sent(),o.label=32;case 32:return[3,60];case 33:return this._metrics.register("PDN_MULTIHAVE_RECEIVE"),e.body,this.onMultiHave?[4,this.onMultiHave(e,t)]:[3,35];case 34:o.sent(),o.label=35;case 35:return this.onMultiHash?[4,this.onMultiHash(e,t)]:[3,37];case 36:o.sent(),o.label=37;case 37:return[3,60];case 38:return this._metrics.register("PDN_HTS_RECEIVE"),e.body,this.onHave?[4,this.onHave(e,t)]:[3,40];case 39:o.sent(),o.label=40;case 40:return this.onScore?[4,this.onScore(e,t)]:[3,42];case 41:o.sent(),o.label=42;case 42:return this.onTimeslot?[4,this.onTimeslot(e,t)]:[3,44];case 43:o.sent(),o.label=44;case 44:return this.onIssTrigger?[4,this.onIssTrigger(e,t)]:[3,46];case 45:o.sent(),o.label=46;case 46:return[3,60];case 47:return this._metrics.register("PDN_SEGMENT_HASH_RECEIVE"),e.body&&this._logger.infoIf(d.Environment.isDevelopment,"Segment hash received",{req:e,res:t},l.Buffer.stringifyUTF8(e.body)),this.onSegmentHash?[4,this.onSegmentHash(e,t)]:[3,49];case 48:o.sent(),o.label=49;case 49:return[3,60];case 50:return this._metrics.register("PDN_SEGMENT_HASH_MUTE_RECEIVE"),this.onMuteSegmentHash?[4,this.onMuteSegmentHash(e,t)]:[3,52];case 51:o.sent(),o.label=52;case 52:return[3,60];case 53:return this._metrics.register("PDN_IMPACT_MATCH_CANDIDATE_RECEIVE"),this.onImpactMatchCandidate?[4,this.onImpactMatchCandidate(e,t)]:[3,55];case 54:o.sent(),o.label=55;case 55:return[3,60];case 56:return this._metrics.register("PDN_IMPACT_MATCH_MUTE_RECEIVE"),this.onMuteImpactMatch?[4,this.onMuteImpactMatch(e,t)]:[3,58];case 57:o.sent(),o.label=58;case 58:return[3,60];case 59:throw new s.ArgumentException("unknown request type");case 60:return[3,64];case 61:return n=o.sent(),f.Logger.errorIf(d.Environment.isDevelopment,"handle pdn request error",n),[3,64];case 62:return[4,t.close()];case 63:return o.sent(),this._metrics.register("TOTAL_PDN_MESSAGES_RECEIVE"),[7];case 64:return[2]}}))}))},e.prototype.registerOutgoingMessage=function(e){void 0===e&&(e=1),this._metrics.register("TOTAL_PDN_MESSAGES_SEND",e)},e}();t.PdnApi=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(99),i=n(20),o=n(12),s=n(17),a=n(4),u=n(3),c=n(2),l=function(){function e(e){void 0===e&&(e={}),this._meta=o.Buffer.empty,this._data=o.Buffer.empty,this._offset=0,this._isAllocated=!1,this._logger=new c.Logger("CHUNK_READER:__________"),this._offsetError=!1,this._customData={},this._currentChunk=0,this._messageId=null,Object.assign(this._customData,e)}return e.prototype.read=function(e){if(e.meta.isMeta||(this._currentChunk=e.position),this._messageId||(this._messageId=e.id,this._logger=new c.Logger("CHUNK_READER:"+("_".repeat(10)+e.id).slice(-10))),!this._offsetError){if(e.meta.isMeta)this._meta=o.Buffer.concat(this._meta,e.data);else if(this._isAllocated)try{this._offset=o.Buffer.write(this._data,e.data,this._offset),this._logger.debugIf(u.Environment.isDevelopment,"readwrite","customData",this._customData,"currentChunk",this._currentChunk)}catch(t){throw this._logger.errorIf(u.Environment.isDevelopment,t.message,"data.length",this._data.byteLength,"offset",this._offset,"chunk.data.length",e.data.byteLength,"customData",this._customData,"currentChunk",this._currentChunk),this._offsetError=!0,new r.PipeOverflowException(t.message,"data.length: "+this._data.byteLength+"\noffset: "+this._offset+"\nchunk.data.length: "+e.data.byteLength,t)}else this._data=o.Buffer.concat(this._data,e.data);this.onProgress&&!e.meta.isMeta&&this.onProgress(e,this._offset,this._isAllocated?this._data.byteLength:0),e.meta.isMetaLast&&this._exposeHeaders(),!e.meta.isRace&&e.meta.isLastPacket?this._complete():e.meta.isRace&&e.meta.isEndOfTransfer&&(this._logger.debugIf(u.Environment.isDevelopment,"Try to dispose by EndOfTransfer="+e.meta.isEndOfTransfer,"RaceFlag="+e.meta.isRace),this._complete())}},e.prototype.error=function(e){this.onError&&(this._logger.debugIf(u.Environment.isDevelopment,"error",this._customData),this.onError(e)),this.dispose()},e.prototype.dispose=function(){a.Destructor.destroyObject(this)},e.prototype._parseHeaders=function(){return JSON.parse(o.Buffer.stringifyUTF8(this._meta))},e.prototype._exposeHeaders=function(){var e=this._parseHeaders(),t=s.Convert.toInt(e[i.HttpHeaders.ContentLength]);t>0&&(this._data=new ArrayBuffer(t),this._isAllocated=!0),this.onHeaders&&this.onHeaders(e)},e.prototype._complete=function(){this.onData&&this.onData(this._data),this.dispose()},e}();t.ChunkReader=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(59),s=n(58),a=n(76),u=function(e){function t(t){var n=e.call(this)||this;if(n._socket=t,!t)throw new i.ArgumentNullException("socket");return n.id=o.P2PMessage.generateRequestId(),n.connectionId="broadcast",n}return r.__extends(t,e),t.prototype.send=function(){return this.count=this._socket.broadcast(this),delete this._socket,Promise.resolve(new a.ClientP2PResponse)},t}(s.P2PRequest);t.BroadcastP2PRequest=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t}(n(59).P2PMessage);t.P2PResponse=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.calc=function(e){return 0},e.instance=new e,e}();t.DefaultChecksum=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(13),a=n(4),u=n(3),c=n(2),l=n(77),h=function(){function e(e,t,n,r,i,s,a,u,l,h){if(this._meta=e,this._config=t,this._pool=n,this._session=r,this._blacklist=i,this._back=s,this._wm=a,this._buff=u,this._tsh=l,this._rtcCheckService=h,this.logger=new c.Logger("NoWebRtcPeerConnectionStrategy"),!e)throw new o.ArgumentNullException("meta");if(!t)throw new o.ArgumentNullException("config");if(!n)throw new o.ArgumentNullException("pool");if(!r)throw new o.ArgumentNullException("session");if(!i)throw new o.ArgumentNullException("blacklist");if(!a)throw new o.ArgumentNullException("workMode");if(!u)throw new o.ArgumentNullException("buff");if(!l)throw new o.ArgumentNullException("tsh");if(!h)throw new o.ArgumentNullException("rtcCheckService")}return e.prototype.dispose=function(){a.Destructor.destroyObject(this)},e.prototype.isDoubleConnect=function(e){return!!this._meta.findBySessionId(e)||!!this._meta.findByConnectionId(e)},e.prototype.isCounterOffer=function(e,t){return!1},e.prototype.isOverflow=function(){return this._wm.isSilent()?this._pool.size>=Math.floor(Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota)/4):this._pool.size>=Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota)},e.prototype.isNoEmptySlots=function(){return this._wm.isSilent()?this._pool.size>=Math.floor(Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota)/4):this._pool.size>=Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota)-2},e.prototype.isCompatibleMode=function(e){return!1},e.prototype.canWebRtcConnect=function(e){return!1},e.prototype.canWsConnect=function(e){this.logger.infoIf(u.Environment.isDevelopment,"canWsConnect");var t=this._meta.resolveInternalId(e);return!!e&&this._session.connectionId!==e&&this._back.isConnected&&!this._pool.contains(t)&&s.Bitmask.check(this._config.availablePdnTransport,i.AvailablePdnTransport.WS)},e.prototype.isConnectable=function(){return this.logger.infoIf(u.Environment.isDevelopment,"isConnectable",this._config.active),this._config.active},e.prototype.canDisconnect=function(e,t){return l.RTCDisconnectReason.NotCompatibleConnect},e.prototype.canSearch=function(){return this.logger.infoIf(u.Environment.isDevelopment,"canSearch","this.isConnectable()",this.isConnectable(),"this._wm.isNotOff()",this._wm.isNotOff(),"!this._wm.isSilent()",!this._wm.isSilent(),"!this.isOverflow()",!this.isOverflow()),this.isConnectable()&&this._wm.isNotOff()&&!this._wm.isSilent()&&!this.isOverflow()},e.prototype.canIssSearch=function(){return!1},e.prototype.canSrvWebRtcSearch=function(){return!1},e.prototype.canSrvWsSearch=function(){return s.Bitmask.check(this._config.availablePdnTransport,i.AvailablePdnTransport.WS)},e.prototype.canRegisterInSwarm=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,!1]}))}))},e}();t.NoWebRtcPeerConnectionStrategy=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(44),s=n(3),a=n(2),u=n(8),c=n(117),l=n(286),h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.createConnection=function(e,t,n){if(!e)throw new i.ArgumentNullException("providerId");var a=new l.WebRtcConnection(!0,e,o.default.getStunsForConnection(t,n));return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,u.Timer.delay(100)];case 1:return t.sent(),[4,a.openWithOffer()];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this._logger.errorIf(s.Environment.isDevelopment,"createConnection error",e),[3,4];case 4:return[2]}}))})),a},t.createFromOffer=function(e,t,n,a){if(!e)throw new i.ArgumentNullException("providerId");if(!t)throw new i.ArgumentNullException("signal");var c=new l.WebRtcConnection(!1,e,o.default.getStunsForConnection(n,a));return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,u.Timer.delay(100)];case 1:return n.sent(),[4,c.openWithAnswer(t)];case 2:return n.sent(),[3,4];case 3:return e=n.sent(),this._logger.errorIf(s.Environment.isDevelopment,"createFromOffer error",e),[3,4];case 4:return[2]}}))})),c},t._logger=new a.Logger("WebRtcConnectionFactory"),t}(c.P2PConnectionFactory);t.WebRtcConnectionFactory=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(285),i=function(){function e(){}return e.createConnection=function(e,t,n){throw new r.NotImplementedException("P2PConnectionFactory.createConnection")},e.createFromOffer=function(e,t,n,i){throw new r.NotImplementedException("P2PConnectionFactory.createFromOffer")},e}();t.P2PConnectionFactory=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return Object.defineProperty(e,"lut",{get:function(){if(!this._lut){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);this._lut=e}return this._lut},enumerable:!0,configurable:!0}),e.generate=function(){var e=this.lut,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&n]+e[n>>8&255]+"-"+e[n>>16&15|64]+e[n>>24&255]+"-"+e[63&r|128]+e[r>>8&255]+"-"+e[r>>16&255]+e[r>>24&255]+e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]},e}();t.UUID=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(8),s=n(117),a=n(288),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.createConnection=function(e){if(!e)throw new i.ArgumentNullException("providerId");var t=new a.WSPeerConnection(!0,e);return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,o.Timer.delay(100)];case 1:return e.sent(),[4,t.openWithOffer()];case 2:return e.sent(),[2]}}))})),t},t}(s.P2PConnectionFactory);t.WSPeerConnectionFactory=u},function(e,t,n){e.exports=!n(33)&&!n(45)((function(){return 7!=Object.defineProperty(n(78)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,n){var r=n(48);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){var r=n(14)("unscopables"),i=Array.prototype;null==i[r]&&n(31)(i,r,{}),e.exports=function(e){i[r][e]=!0}},function(e,t,n){var r=n(26),i=n(40),o=n(318)(!1),s=n(86)("IE_PROTO");e.exports=function(e,t){var n,a=i(e),u=0,c=[];for(n in a)n!=s&&r(a,n)&&c.push(n);for(;t.length>u;)r(a,n=t[u++])&&(~o(c,n)||c.push(n));return c}},function(e,t,n){"use strict";var r=n(89),i={};i[n(14)("toStringTag")]="z",i+""!="[object z]"&&n(39)(Object.prototype,"toString",(function(){return"[object "+r(this)+"]"}),!0)},function(e,t,n){"use strict";var r=n(65),i=n(30),o=n(39),s=n(31),a=n(26),u=n(50),c=n(323),l=n(66),h=n(325),d=n(14)("iterator"),f=!([].keys&&"next"in[].keys()),p=function(){return this};e.exports=function(e,t,n,_,g,m,y){c(n,t,_);var v,w,b,S=function(e){if(!f&&e in C)return C[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},E=t+" Iterator",T="values"==g,P=!1,C=e.prototype,D=C[d]||C["@@iterator"]||g&&C[g],O=!f&&D||S(g),I=g?T?S("entries"):O:void 0,A="Array"==t&&C.entries||D;if(A&&(b=h(A.call(new e)))!==Object.prototype&&b.next&&(l(b,E,!0),r||a(b,d)||s(b,d,p)),T&&D&&"values"!==D.name&&(P=!0,O=function(){return D.call(this)}),r&&!y||!f&&!P&&C[d]||s(C,d,O),u[t]=O,u[E]=p,g)if(v={values:T?O:S("values"),keys:m?O:S("keys"),entries:I},y)for(w in v)w in C||o(C,w,v[w]);else i(i.P+i.F*(f||P),t,v);return v}},function(e,t,n){var r=n(24),i=n(324),o=n(87),s=n(86)("IE_PROTO"),a=function(){},u=function(){var e,t=n(78)("iframe"),r=o.length;for(t.style.display="none",n(127).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),u=e.F;r--;)delete u.prototype[o[r]];return u()};e.exports=Object.create||function(e,t){var n;return null!==e?(a.prototype=r(e),n=new a,a.prototype=null,n[s]=e):n=u(),void 0===t?n:i(n,t)}},function(e,t,n){var r=n(15).document;e.exports=r&&r.documentElement},function(e,t,n){var r=n(24),i=n(63),o=n(14)("species");e.exports=function(e,t){var n,s=r(e).constructor;return void 0===s||null==(n=r(s)[o])?t:i(n)}},function(e,t,n){var r,i,o,s=n(47),a=n(335),u=n(127),c=n(78),l=n(15),h=l.process,d=l.setImmediate,f=l.clearImmediate,p=l.MessageChannel,_=l.Dispatch,g=0,m={},y=function(){var e=+this;if(m.hasOwnProperty(e)){var t=m[e];delete m[e],t()}},v=function(e){y.call(e.data)};d&&f||(d=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return m[++g]=function(){a("function"==typeof e?e:Function(e),t)},r(g),g},f=function(e){delete m[e]},"process"==n(48)(h)?r=function(e){h.nextTick(s(y,e,1))}:_&&_.now?r=function(e){_.now(s(y,e,1))}:p?(o=(i=new p).port2,i.port1.onmessage=v,r=s(o.postMessage,o,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*")},l.addEventListener("message",v,!1)):r="onreadystatechange"in c("script")?function(e){u.appendChild(c("script")).onreadystatechange=function(){u.removeChild(this),y.call(e)}}:function(e){setTimeout(s(y,e,1),0)}),e.exports={set:d,clear:f}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,n){var r=n(24),i=n(25),o=n(90);e.exports=function(e,t){if(r(e),i(t)&&t.constructor===e)return t;var n=o.f(e);return(0,n.resolve)(t),n.promise}},function(e,t,n){t.f=n(14)},function(e,t,n){var r=n(123),i=n(87).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,i)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,n,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===n&&(n=null),void 0===r&&(r=-1),this.message=e,Error.captureStackTrace?Error.captureStackTrace(this):this.stack=(new Error).stack||"",this.name="Exception",this.message=e,this._code=r,this._details=t,this._innerException=n,this.__custom_error__=!0}return Object.defineProperty(e.prototype,"innerException",{get:function(){return this._innerException},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"details",{get:function(){return this._details},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this._code},enumerable:!0,configurable:!0}),e.prototype.setDetails=function(e){this._details=e},e}();t.ExceptionBase=r},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(i.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(i.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(136),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(34))},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,i,o,s,a,u=1,c={},l=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){p(e)}))}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?(s="setImmediate$"+Math.random()+"$",a=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(s)&&p(+t.data.slice(s.length))},e.addEventListener?e.addEventListener("message",a,!1):e.attachEvent("onmessage",a),r=function(t){e.postMessage(s+t,"*")}):e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){p(e.data)},r=function(e){o.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(i=h.documentElement,r=function(e){var t=h.createElement("script");t.onreadystatechange=function(){p(e),t.onreadystatechange=null,i.removeChild(t),t=null},i.appendChild(t)}):r=function(e){setTimeout(p,0,e)},d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var i={callback:e,args:t};return c[u]=i,r(u),u++},d.clearImmediate=f}function f(e){delete c[e]}function p(e){if(l)setTimeout(p,0,e);else{var t=c[e];if(t){l=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{f(e),l=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(34),n(35))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),i=n(93),o=n(139),s=n(308);!function(){if(i.Polyfill.IS_SUPPORTED){if(r.Environment.runtimeContext.teleport)throw new Error("TeleportSDK already initialized. check your html-page.");r.Environment.runtimeContext.teleport=new o.TeleportStatic}else r.Environment.runtimeContext.teleport=new s.TeleportStaticOldBrowser}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3);t.installURLSearchParams=function(){!function(e){function t(t){return!!t&&("Symbol"in e&&"iterator"in e.Symbol&&"function"==typeof t[Symbol.iterator]||!!Array.isArray(t))}function n(e){return"from"in Array?Array.from(e):Array.prototype.slice.call(e)}!function(){var r,i=e.URL;try{if(i){if((r=new e.URL("http://example.com"))&&"searchParams"in r){var o=new e.URL("http://example.com");if(o.search="a=1&b=2","http://example.com/?a=1&b=2"===o.href&&(o.search="","http://example.com/"===o.href))return}!r||"href"in r||(r=void 0),r=void 0}}catch(e){}function s(e){return e.map((function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)})).join("&").replace(/%20/g,"+")}function a(e){var t=[];return e.split("&").forEach((function(e){if(0!==e.length){var n=e.indexOf("="),r=-1!==n?e.substring(0,n):e,i=-1!==n?e.substring(n+1):"";t.push({name:decodeURIComponent(r.replace(/\+/g," ")),value:decodeURIComponent(i.replace(/\+/g," "))})}})),t}function u(e){var r=this;this._list=[],null==e||(e instanceof u?this._list=a(String(e)):"object"==typeof e&&t(e)?n(e).forEach((function(e){if(!t(e))throw TypeError();var i=n(e);if(2!==i.length)throw TypeError();r._list.push({name:String(i[0]),value:String(i[1])})})):"object"==typeof e&&e?Object.keys(e).forEach((function(t){r._list.push({name:String(t),value:String(e[t])})})):("?"===(e=String(e)).substring(0,1)&&(e=e.substring(1)),this._list=a(e))),this._url_object=null,this._setList=function(e){i||(r._list=e)};var i=!1;this._update_steps=function(){i||(i=!0,r._url_object&&("about:"===r._url_object.protocol&&-1!==r._url_object.pathname.indexOf("?")&&(r._url_object.pathname=r._url_object.pathname.split("?")[0]),r._url_object.search=s(r._list),i=!1))}}function c(e,t){var n=0;this.next=function(){if(n>=e.length)return{done:!0,value:void 0};var r=e[n++];return{done:!1,value:"key"===t?r.name:"value"===t?r.value:[r.name,r.value]}}}function l(t,n){if(!(this instanceof e.URL))throw new TypeError("Failed to construct 'URL': Please use the 'new' operator.");n&&(t=function(){if(r)return new i(t,n).href;var e;try{var o=void 0;if("[object OperaMini]"===Object.prototype.toString.call(window.operamini)?((e=document.createElement("iframe")).style.display="none",document.documentElement.appendChild(e),o=e.contentWindow.document):document.implementation&&document.implementation.createHTMLDocument?o=document.implementation.createHTMLDocument(""):document.implementation&&document.implementation.createDocument?((o=document.implementation.createDocument("http://www.w3.org/1999/xhtml","html",null)).documentElement.appendChild(o.createElement("head")),o.documentElement.appendChild(o.createElement("body"))):window.ActiveXObject&&((o=new window.ActiveXObject("htmlfile")).write("<head></head><body></body>"),o.close()),!o)throw Error("base not supported");var s=o.createElement("base");s.href=n,o.getElementsByTagName("head")[0].appendChild(s);var a=o.createElement("a");return a.href=t,a.href}catch(t){e&&e.parentNode.removeChild(e)}finally{e&&e.parentNode.removeChild(e)}}());var o=function(e){if(r)return new i(e);var t=document.createElement("a");return t.href=e,t}(t||""),s=function(){if(!("defineProperties"in Object))return!1;try{var e={};return Object.defineProperties(e,{prop:{get:function(){return!0}}}),e.prop}catch(e){return!1}}()?this:document.createElement("a"),c=new u(o.search?o.search.substring(1):null);function l(){var e=o.href.replace(/#$|\?$|\?(?=#)/g,"");o.href!==e&&(o.href=e)}function h(){c._setList(o.search?a(o.search.substring(1)):[]),c._update_steps()}return c._url_object=s,Object.defineProperties(s,{href:{get:function(){return o.href},set:function(e){o.href=e,l(),h()},enumerable:!0,configurable:!0},origin:{get:function(){return"origin"in o?o.origin:this.protocol+"//"+this.host},enumerable:!0,configurable:!0},protocol:{get:function(){return o.protocol},set:function(e){o.protocol=e},enumerable:!0,configurable:!0},username:{get:function(){return o.username},set:function(e){o.username=e},enumerable:!0,configurable:!0},password:{get:function(){return o.password},set:function(e){o.password=e},enumerable:!0,configurable:!0},host:{get:function(){var e={"http:":/:80$/,"https:":/:443$/,"ftp:":/:21$/}[o.protocol];return e?o.host.replace(e,""):o.host},set:function(e){o.host=e},enumerable:!0,configurable:!0},hostname:{get:function(){return o.hostname},set:function(e){o.hostname=e},enumerable:!0,configurable:!0},port:{get:function(){return o.port},set:function(e){o.port=e},enumerable:!0,configurable:!0},pathname:{get:function(){return"/"!==o.pathname.charAt(0)?"/"+o.pathname:o.pathname},set:function(e){o.pathname=e},enumerable:!0,configurable:!0},search:{get:function(){return o.search},set:function(e){o.search!==e&&(o.search=e,l(),h())},enumerable:!0,configurable:!0},searchParams:{get:function(){return c},enumerable:!0,configurable:!0},hash:{get:function(){return o.hash},set:function(e){o.hash=e,l()},enumerable:!0,configurable:!0},toString:{value:function(){return o.toString()},enumerable:!1,configurable:!0},valueOf:{value:function(){return o.valueOf()},enumerable:!1,configurable:!0}}),s}if(Object.defineProperties(u.prototype,{append:{value:function(e,t){this._list.push({name:e,value:t}),this._update_steps()},writable:!0,enumerable:!0,configurable:!0},delete:{value:function(e){for(var t=0;t<this._list.length;)this._list[t].name===e?this._list.splice(t,1):++t;this._update_steps()},writable:!0,enumerable:!0,configurable:!0},get:{value:function(e){for(var t=0;t<this._list.length;++t)if(this._list[t].name===e)return this._list[t].value;return null},writable:!0,enumerable:!0,configurable:!0},getAll:{value:function(e){for(var t=[],n=0;n<this._list.length;++n)this._list[n].name===e&&t.push(this._list[n].value);return t},writable:!0,enumerable:!0,configurable:!0},has:{value:function(e){for(var t=0;t<this._list.length;++t)if(this._list[t].name===e)return!0;return!1},writable:!0,enumerable:!0,configurable:!0},set:{value:function(e,t){for(var n=!1,r=0;r<this._list.length;)this._list[r].name===e?n?this._list.splice(r,1):(this._list[r].value=t,n=!0,++r):++r;n||this._list.push({name:e,value:t}),this._update_steps()},writable:!0,enumerable:!0,configurable:!0},entries:{value:function(){return new c(this._list,"key+value")},writable:!0,enumerable:!0,configurable:!0},keys:{value:function(){return new c(this._list,"key")},writable:!0,enumerable:!0,configurable:!0},values:{value:function(){return new c(this._list,"value")},writable:!0,enumerable:!0,configurable:!0},forEach:{value:function(e){var t=arguments.length>1?arguments[1]:void 0;this._list.forEach((function(n){e.call(t,n.value,n.name)}))},writable:!0,enumerable:!0,configurable:!0},toString:{value:function(){return s(this._list)},writable:!0,enumerable:!1,configurable:!0}}),"Symbol"in e&&"iterator"in e.Symbol&&(Object.defineProperty(u.prototype,e.Symbol.iterator,{value:u.prototype.entries,writable:!0,enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,e.Symbol.iterator,{value:function(){return this},writable:!0,enumerable:!0,configurable:!0})),i)for(var h in i)i.hasOwnProperty(h)&&"function"==typeof i[h]&&(l[h]=i[h]);e.URL=l,e.URLSearchParams=u}(),function(){if("1"!==new e.URLSearchParams([["a",1]]).get("a")||"1"!==new e.URLSearchParams({a:1}).get("a")){var r=e.URLSearchParams;e.URLSearchParams=function(e){var i;return e&&"object"==typeof e&&t(e)?(i=new r,n(e).forEach((function(e){if(!t(e))throw TypeError();var r=n(e);if(2!==r.length)throw TypeError();i.append(r[0],r[1])})),i):e&&"object"==typeof e?(i=new r,Object.keys(e).forEach((function(t){i.set(t,e[t])})),i):new r(e)}}}()}(r.Environment.runtimeContext)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(140),o=n(16),s=n(41),a=n(9),u=n(18),c=n(1),l=n(23),h=n(3),d=n(2),f=n(5),p=n(93),_=n(143),g=function(){function e(){this.disposes=new Map}return Object.defineProperty(e.prototype,"Quality",{get:function(){return s.Quality},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"SegmentType",{get:function(){return a.SegmentType},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"PeeringMode",{get:function(){return o.PeeringMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"version",{get:function(){return h.Environment.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"NodrStrategy",{get:function(){return u.NodrStrategy},enumerable:!0,configurable:!0}),e.prototype.initialize=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){if(this.stat||(this.stat={lastInitTime:0,initCount:0,prevInitTime:0}),d.Logger.promo(),h.Environment.isWebRtcSupported||d.Logger.warn("Your browser is not supporting WebRTC. Teleport PDN isn't available."),this.stat.initCount>0?d.Logger.warn("re-initialization of the teleport. Perhaps there are errors in the video player's startup."):p.Polyfill.install(),this.stat.initCount+=1,this.stat.prevInitTime=this.stat.lastInitTime,this.stat.lastInitTime=f.TimeSpan.now.value,!e.loader)throw new c.ArgumentNullException("loader");return e.apiKey||d.Logger.warn("Start without apiKey."),t=this.createBuilder(e),this._sla(e.apiKey),[2,t.createApi(i.TeleportLoaders.resolve(e.loader.type)(e.loader.params)(n=t.createApp()).listen().getLoaderApi(),n)]}))}))},e.prototype.registerPlugin=function(e,t){if(!e)throw new c.ArgumentNullException("typeName");if(!t)throw new c.ArgumentNullException("plugin");0===e.indexOf("media.teleport.loaders.")&&i.TeleportLoaders.register(e,t)},e.prototype.createBuilder=function(e){return new _.DefaultAppBuilder(e.apiKey,this.stat,this.disposes).useDefault(e.config)},e.prototype._sla=function(e){var t=h.Environment.isWebRtcSupported?"https://sla.tlprt.cloud/strike_":"https://sla.tlprt.cloud/split_",n=new l.HttpRequest({url:""+t+(e||"empty_key"),method:"GET",timeout:f.TimeSpan.fromSeconds(5)});r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,n.send()];case 1:return t.sent(),[3,3];case 2:return e=t.sent(),d.Logger.warnIf(h.Environment.isDevelopment,e),[3,3];case 3:return[2]}}))}))},e}();t.TeleportStatic=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(141),i=n(19),o=function(){function e(){}return e.register=function(e,t){this._LOADERS[e]=function(e){return function(n){var i=t(),o=new r.Interceptor(n,i);return o.configure(e),o}}},e.resolve=function(e){var t=this._LOADERS["media.teleport.loaders."+e];if(!t)throw new i.ArgumentException('Loader "'+e+"\" isn't registered");return t},e._LOADERS={},e}();t.TeleportLoaders=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(11),s=n(4),a=n(3),u=n(2),c=n(22),l=n(5),h=n(41),d=n(9),f=function(e){return/\.m3u8$|\.mpd$/i.test(new URL(e).pathname)},p=function(e){return/\.ts$|.m4v$|.m4a$|.m4s$|.mp4$/i.test(new URL(e).pathname)},_=function(e){return""+new URL(e).pathname},g=function(){return h.Quality.Unknown},m=function(){return d.SegmentType.Unknown},y=function(){return-1},v=function(){return 0},w=function(){function e(e,t){var n=this;if(this._app=e,this._loader=t,this.EXECUTE_TIMEOUT=l.TimeSpan.fromSeconds(30),this._streamUrl="",this._active=!1,this._logger=new u.Logger("interceptor"),!e)throw new i.ArgumentNullException("app");if(!t)throw new i.ArgumentNullException("loader");t.onAbort=function(e){return n.abortSegment(e)},e.registerDisposableObjects(this)}return e.prototype.dispose=function(){this.stop(),this._loader.dispose(),s.Destructor.destroyObject(this)},e.prototype.configure=function(e){var t=this._loader.mergeParams(e||{});return this.manifestAcceptor=t&&t.manifestAcceptor||f,this.segmentAcceptor=t&&t.segmentAcceptor||p,this.urlCleaner=t&&t.urlCleaner||_,this.qualityGetter=t&&t.qualityGetter||g,this.segmentTypeGetter=t&&t.segmentTypeGetter||m,this.bufferSizeGetter=t&&t.bufferSizeGetter||y,this.durationGetter=t&&t.durationGetter||v,this},e.prototype.listen=function(){var e=this;return this._active||(this._active=!0,this._loader.setListener((function(t){return e.handle(t)}))),this},e.prototype.getLoaderApi=function(){return this._loader.getPublicApi()},e.prototype.stop=function(){this._active&&(this._active=!1,this._loader.setListener(null))},e.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:if(!this._active)return[2,null];n.label=1;case 1:return n.trys.push([1,7,,8]),this.manifestAcceptor(e.url)?[4,this.processManifest(e)]:[3,3];case 2:return[2,n.sent()];case 3:return this.segmentAcceptor(e.url)?[4,this.processSegment(e)]:[3,5];case 4:return[2,n.sent()];case 5:return u.Logger.warnIf(a.Environment.isDevelopment,"Unsupported player request",e),[2,null];case 6:return[3,8];case 7:return t=n.sent(),this._logger.errorIf(a.Environment.isDevelopment,"handle request error",e.url,o.Exception.fromNativeError(t).toString()),[2,null];case 8:return[2]}}))}))},e.prototype.processManifest=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._streamUrl=this.urlCleaner(e.url),this._app.setActiveStream(this._streamUrl),[2,null]}))}))},e.prototype.processSegment=function(e){var t=this,n=this.createQuery(e),i=this._app.download(n);return new Promise((function(e,n){return r.__awaiter(t,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:i.playerRequestResolver=e,r.label=1;case 1:return r.trys.push([1,3,4,5]),[4,i.execute(this.EXECUTE_TIMEOUT.value)];case 2:return r.sent(),[3,5];case 3:return t=r.sent(),n(o.Exception.fromNativeError(t)),[3,5];case 4:return i.dispose(),[7];case 5:return[2]}}))}))}))},e.prototype.abortSegment=function(e){this._app.abort(this.createQuery(e))},e.prototype.createQuery=function(e){return Object.assign({},{uri:this.urlCleaner(e.url),quality:this.qualityGetter(e.url),type:this.segmentTypeGetter(e.url),duration:this.durationGetter(e.url),bufferSize:c.MathUtils.round(this.bufferSizeGetter(e.url),3)},e)},e}();t.Interceptor=w},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(12),o=n(20),s=function(){function e(e){if(this.request=e,!e)throw new r.ArgumentNullException("req")}return Object.defineProperty(e.prototype,"ok",{get:function(){return 200===this.statusCode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statusCode",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){return o.HttpHeaders.parse(this.request)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statusMessage",{get:function(){return this.request.statusText},enumerable:!0,configurable:!0}),e.prototype.arrayBuffer=function(){return"arraybuffer"===this.request.responseType?this.request.response:i.Buffer.fromString(this.request.responseText)},e.prototype.text=function(){try{return"arraybuffer"===this.request.responseType?i.Buffer.stringify(this.request.response):this.request.responseText||""}catch(e){return""}},e.prototype.json=function(){try{return JSON.parse(this.text())}catch(e){return{}}},e}();t.HttpResponse=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(144),o=n(153),s=n(154),a=n(155),u=n(156),c=n(157),l=n(158),h=n(159),d=n(160),f=n(161),p=n(162),_=n(95),g=n(163),m=n(165),y=n(166),v=n(167),w=n(169),b=n(170),S=n(16),E=n(171),T=n(180),P=n(181),C=n(182),D=n(183),O=n(184),I=n(186),A=n(187),R=n(188),M=n(190),N=n(191),k=n(192),x=n(193),L=n(194),H=n(195),j=n(197),B=n(200),U=n(201),W=n(202),F=n(203),q=n(204),V=n(205),z=n(206),G=n(207),Q=n(209),K=n(222),Y=n(226),Z=n(227),J=n(228),X=n(229),$=n(230),ee=n(231),te=n(232),ne=n(233),re=n(234),ie=n(235),oe=n(236),se=n(237),ae=n(238),ue=n(239),ce=n(240),le=n(241),he=n(242),de=n(243),fe=n(244),pe=n(245),_e=n(246),ge=n(248),me=n(249),ye=n(250),ve=n(109),we=n(251),be=n(253),Se=n(1),Ee=n(257),Te=n(258),Pe=n(110),Ce=n(262),De=n(264),Oe=n(265),Ie=n(266),Ae=n(268),Re=n(269),Me=n(74),Ne=n(270),ke=n(272),xe=n(273),Le=n(274),He=n(279),je=n(280),Be=n(281),Ue=n(282),We=n(115),Fe=n(283),qe=n(284),Ve=n(292),ze=n(293),Ge=n(294),Qe=n(295),Ke=n(297),Ye=n(299),Ze=n(301),Je=n(302),Xe=n(4),$e=n(3),et=n(2),tt=n(8),nt=n(5),rt=n(303),it=n(305),ot=n(307),st=function(){function e(e,t,n){var r=this;this.apiKey=e,this.teleportStaticStat=t,this.disposes=n,this.useSession=this.use((function(e){r.svc.session=e})),this.useScoring=this.use((function(e){r.svc.scoring=e})),this.useTaskInfoHolder=this.use((function(e){r.svc.tasks=e})),this.useMetrics=this.use((function(e){r.svc.metrics=e})),this.usePdnMetrics=this.use((function(e){r.svc.pdnMetrics=e})),this.useBufferingMarker=this.use((function(e){r.svc.buffering=e})),this.useConnection=this.use((function(e){r.svc.connection=e})),this.useBackend=this.use((function(e){r.svc.backend=e})),this.useCache=this.use((function(e){r.svc.cache=e})),this.usePeeringStrategy=this.use((function(e){r.svc.peeringStrategy=e})),this.useBlacklist=this.use((function(e){r.svc.blacklist=e})),this.useSwarmMetadata=this.use((function(e){r.svc.swarmMetadata=e})),this.useMatcher=this.use((function(e){r.svc.matcher=e})),this.useHaveStorage=this.use((function(e){r.svc.haves=e})),this.useDownloadTimeout=this.use((function(e){r.svc.timeout=e})),this.useStatistics=this.use((function(e){r.svc.statistics=e})),this.usePdn=this.use((function(e){r.svc.pdn=e})),this.useStatAggregator=this.use((function(e){r.svc.statAggregator=e})),this.useSwarmStat=this.use((function(e){r.svc.swarmStat=e})),this.useWebRtcPool=this.use((function(e){r.svc.webrtcPool=e})),this.useWebRtcSocket=this.use((function(e){r.svc.webrtcSocket=e})),this.useAuth=this.use((function(e){r.svc.auth=e})),this.useSwarm=this.use((function(e){r.svc.swarm=e})),this.useSwarmBuilder=this.use((function(e){r.svc.swarmBuilder=e})),this.useSwarmJoggler=this.use((function(e){r.svc.swarmJoggler=e})),this.useConnectionStrategy=this.use((function(e){r.svc.connectionStrategy=e})),this.usePeerSelector=this.use((function(e){r.svc.selector=e})),this.useHeartbeat=this.use((function(e){r.svc.heartbeat=e})),this.useUploadController=this.use((function(e){r.svc.uploadController=e})),this.useSpeedTest=this.use((function(e){r.svc.speedtest=e})),this.useCompability=this.use((function(e){r.svc.compability=e})),this.useSegmentFactory=this.use((function(e){r.svc.segmentFactory=e})),this.useHaveSender=this.use((function(e){r.svc.haveSender=e})),this.useWorkModeGetter=this.use((function(e){r.svc.workMode=e})),this.useTimeslotExtractor=this.use((function(e){r.svc.timeslotExtractor=e})),this.useTimeslotHolder=this.use((function(e){r.svc.timeslotHolder=e})),this.useESD=this.use((function(e){r.svc.esd=e})),this.useIssTrigger=this.use((function(e){r.svc.issTrigger=e})),this.useBackendManager=this.use((function(e){r.svc.backendManager=e})),this.useHaveDensity=this.use((function(e){r.svc.haveDensityHolder=e})),this.useTimeSlotCorrector=this.use((function(e){r.svc.timeSlotCorrector=e})),this.useRtcCheckService=this.use((function(e){r.svc.rtcCheckService=e})),this.useMaxReadyHolder=this.use((function(e){r.svc.maxReadyHolder=e})),this.useSegmentHashStorage=this.use((function(e){r.svc.segmentHashes=e})),this.useImpactMatcher=this.use((function(e){r.svc.impactMatcher=e})),this.useNodrCheckService=this.use((function(e){r.svc.nodrCheckService=e})),this.useNodrPeersController=this.use((function(e){r.svc.nodrPeersController=e})),this.svc=new ot.DefaultAppContainer,this.its=[],this.logger=new et.Logger("AppBuilder"),e||this.logger.warn("Start without apiKey.")}return e.prototype.createApp=function(){var e,t=this.svc;return(e=new it.DefaultApp(t.backend,t.auth,t.config,t.metrics,this.createDownloadPipeline(),this.createUploadPipeline(),t.swarmBuilder,t.connection,t.swarm,t.pdn,t.session,t.workMode,t.swarmMetadata,t.backendManager,t.segmentHashes,t.tasks,t.issTrigger)).registerDisposableObjects.apply(e,r.__spread(this.its.reverse()))},e.prototype.createApi=function(e,t){var n=this,i=this.svc.session,o=this.svc.connection,s=this.svc.config,a=this.svc.statistics,u=this.svc.swarm,c=this.svc.buffering,l=this.svc.auth,h=this.svc.workMode,d=this.svc.backend,f=this.teleportStaticStat,p=this.disposes,_=new(function(){function n(){var n=this;this.onPeeringModeChanged=null,this.onPeerConnectionOpened=null,this.onPeerConnectionClosed=null,this.onSegmentLoaded=null,this.onSegmentUploaded=null,this.onSignallerConnectionStateChange=null,this.onConfigChanged=null,this.buffering=function(){return c.markExternalBuffering()},this.getStatTotals=function(){return a.getTotals()},this.getStatDetails=function(){return a.getDetails()},this.getLoader=function(){return e||null},this.dispose=function(){return r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,t.dispose()];case 1:return e.sent(),Xe.Destructor.destroyObject(this),[2]}}))}))}}return Object.defineProperty(n.prototype,"version",{get:function(){return $e.Environment.version},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"apiKey",{get:function(){return i.apiKey},set:function(e){l.authenticate(e,"")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connectionId",{get:function(){return i.connectionId},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connected",{get:function(){return o.isOpened},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"peeringMode",{get:function(){return h.selfPM},set:function(e){s.updateConfig({peeringMode:e})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"nodrStrategy",{get:function(){return s.nodrStrategy},set:function(e){s.updateConfig({nodrStrategy:e})},enumerable:!0,configurable:!0}),n}());return t.onPeeringModeChanged=function(e){return tt.Timer.timeout((function(){return r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(t){return _.onPeeringModeChanged&&_.onPeeringModeChanged(e),[2]}))}))}),1)},t.onExternConfigChanged=function(e){return tt.Timer.timeout((function(){return r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(t){return _.onConfigChanged&&_.onConfigChanged(e),[2]}))}))}),1)},o.onConnectionStateChange=function(e){return tt.Timer.timeout((function(){_.onSignallerConnectionStateChange&&_.onSignallerConnectionStateChange(e)}),1)},a.onDownload=function(e){return tt.Timer.timeout((function(){_.onSegmentLoaded&&_.onSegmentLoaded(e)}),1)},a.onUpload=function(e){return tt.Timer.timeout((function(){_.onSegmentUploaded&&_.onSegmentUploaded(e)}),1)},u.onReady=function(e){return tt.Timer.timeout((function(){_.onPeerConnectionOpened&&_.onPeerConnectionOpened(e)}),1)},u.onDisconnected=function(e){return tt.Timer.timeout((function(){_.onPeerConnectionClosed&&_.onPeerConnectionClosed(e)}),1)},u.onError=function(e){return tt.Timer.timeout((function(){_.onPeerConnectionClosed&&_.onPeerConnectionClosed(e)}),1)},d.onInit=function(){return tt.Timer.timeout((function(){r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,d.sendTeleportStaticStat(f)];case 1:return[2,e.sent()]}}))})),d.onInit=void 0}),1)},d.onAuth=function(e){return r.__awaiter(n,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:if(!(t=p.get(e)))return[3,5];n.label=1;case 1:return n.trys.push([1,4,,5]),[4,d.sendDisposeEvent(!0)];case 2:return n.sent(),[4,t(!0)];case 3:return n.sent(),et.Logger.info("Prev instance "+e+" successfully disposed"),[3,5];case 4:return n.sent(),et.Logger.info("Prev instance "+e+" already disposed"),[3,5];case 5:return p.set(e,_.dispose),[2]}}))}))},$e.Environment.isDevelopment?$e.Environment.runtimeContext.teleport.debug={api:_,app:t,svc:this.svc}:this.svc.dispose(),Xe.Destructor.destroyObject(this),_},e.prototype.configure=function(e){return this.svc.config=new be.Configuration,this.svc.config.updateConfig(e),this},e.prototype.useDefault=function(e){var t,n,r,E=this.svc;return this.configure(e).useTaskInfoHolder(new o.ActiveTasks).useMetrics(new Ke.MetricsWithCondition(E.config)).useTimeSlotCorrector(new Je.TimeSlotCorrector(E.config)).useIssTrigger(new d.DefaultIssTrigger(E.config)).useMaxReadyHolder(new ze.SwarmMaxReadyHolder).usePdnMetrics((r=new Ke.MetricsWithCondition(E.config),this.svc.metrics.addMetrics(r),r)).useESD(new c.EstimateSegmentDuration).useBufferingMarker(new s.DefaultBuffering(E.config)).useSession(new ge.Session(this.apiKey)).useWorkModeGetter(new S.WorkMode(E.config,E.session,E.metrics)).useScoring(new g.SSNormalizeScoring(E.metrics,E.config)).useHaveDensity(new u.DefaultHaveDensity(E.metrics)).useStatistics(new Ze.Statistics).useStatAggregator(new Ye.StatAggregator(E.config)).useConnection((n=new ye.BackendConnectionStringBuilder(E.session),new rt.WebSocketConnection(n,E.config.signalReconnectDelay,E.workMode,E.metrics))).useBackend((t=new URL(E.config.backendEntrypointUrl),t.searchParams.set("ver",$e.Environment.version),new me.Backend(t.toString(),E.connection,E.session,E.scoring,E.config,E.buffering,E.metrics))).useAuth(new i.Authenticator(E.backend,E.session,E.metrics,E.config,E.connection)).useCache(new we.LifetimeInMemoryCache(E.config,E.metrics)).useWebRtcPool(new Ee.P2PConnectionPool).useWebRtcSocket(new Te.P2PSocketSync(E.webrtcPool,E.backend)).usePdn(new Pe.PdnApi(E.webrtcSocket,E.pdnMetrics,E.config)).useSwarmMetadata(new Ae.SwarmMetadata(E.metrics,E.pdn,E.scoring)).useNodrCheckService(new Re.NodrCheckService(E.swarmMetadata)).useMatcher(new Ie.Matcher(E.pdnMetrics,E.swarmMetadata,E.config.matcherSize)).useSwarmStat(new Ge.SwarmStat(E.webrtcPool,E.swarmMetadata,E.config,E.pdnMetrics,E.workMode)).useBlacklist(new Ce.SeparatedBlackList(E.config,E.metrics,E.swarmStat)).useRtcCheckService(new Ne.RtcCheckService(E.blacklist,E.config,E.metrics)).useCompability(new a.DefaultCompability).usePeeringStrategy($e.Environment.isWebRtcSupported?new p.DefaultPeeringStrategy(E.config,E.blacklist,E.compability,E.workMode):new _.NoWebRtcPeeringStrategy(E.config,E.blacklist,E.compability,E.workMode)).useTimeslotExtractor(new w.DefaultTimeSlotExtractor(E.config)).useTimeslotHolder(new b.DefaultTimeslotHolder(E.metrics,E.swarmMetadata,E.timeSlotCorrector,E.pdn)).useDownloadTimeout(new v.AutoDownloadTimeout(E.peeringStrategy,E.config,E.session,E.swarmStat,E.timeslotHolder,E.esd)).useHeartbeat(new Oe.Heartbeat(E.pdn,E.swarmMetadata,E.config)).useHaveStorage(new l.HaveStorage(E.matcher,E.pdn,E.swarmMetadata)).useSpeedTest(new Be.SpeedTester(E.pdn,E.swarmMetadata)).useSegmentHashStorage(new y.SegmentHashController(E.pdn,E.config,E.swarmMetadata)).useHaveSender(new De.HaveSender(E.pdn,E.config,E.cache,E.segmentHashes)).useSwarm(new Fe.Swarm(E.webrtcPool,E.pdnMetrics,E.swarmMetadata,E.blacklist,E.matcher,E.heartbeat,E.haves,E.speedtest,E.haveSender,E.config,E.issTrigger,E.backend)).usePeerSelector(new Me.EstimatePeerSelector(E.webrtcPool,E.swarmMetadata,E.scoring,E.config)).useConnectionStrategy($e.Environment.isWebRtcSupported?new Ue.DefaultPeerConnectionStrategy(E.swarmMetadata,E.config,E.webrtcPool,E.session,E.blacklist,E.backend,E.workMode,E.buffering,E.timeslotHolder,E.rtcCheckService):new We.NoWebRtcPeerConnectionStrategy(E.swarmMetadata,E.config,E.webrtcPool,E.session,E.blacklist,E.backend,E.workMode,E.buffering,E.timeslotHolder,E.rtcCheckService)).useSwarmBuilder(new qe.QueueSwarmBuilder(E.connectionStrategy,E.swarmMetadata,E.pdnMetrics,E.session,E.config,E.swarm,E.workMode,E.buffering,E.haveDensityHolder,E.rtcCheckService,E.nodrCheckService).addSignaller(new He.BackendSignaller(E.backend)).addSearcher(new ke.BackendSearcher(E.backend,E.timeslotHolder,E.config)).addSignaller(new je.InSwarmSignaller(E.pdn,E.swarmMetadata,E.session)).addSearcher(new xe.DefaultInSwarmSearcher(E.pdn,E.swarmMetadata,E.config,new Le.TimeslotTrickySearchService(E.swarmMetadata,E.webrtcPool,E.config,E.timeSlotCorrector),E.scoring,E.buffering,E.timeslotHolder,E.timeSlotCorrector))).useUploadController(new Qe.FloatCUUploadController(E.config,E.pdn,E.swarmMetadata,E.metrics,E.session,E.webrtcPool)).useSegmentFactory(new m.DefaultSegmentFactory(E.config,E.swarmStat,E.connection,E.haves,E.swarmMetadata,E.workMode,E.segmentHashes)).useSwarmJoggler(new Ve.SwarmJoggler(E.config,E.swarmBuilder,E.metrics)).useNodrPeersController(new f.NodrPeersController(E.backend,E.config,E.swarmMetadata,E.metrics)),this.useBackendManager(new ve.BackendManager(E.config,E.backend,E.blacklist)),this.useImpactMatcher(new h.ImpactMatcherController(E.pdn,E.swarm,E.swarmBuilder,E.config,E.swarmMetadata,E.haves,E.haveDensityHolder)),this},e.prototype.createDownloadPipeline=function(){var e=this,t=new E.DownloadTaskPipeline,n=this.svc,i=n.tasks,o=n.metrics,s=n.backend,a=n.workMode,u=n.config,c=n.esd,l=n.haveDensityHolder,h=n.segmentHashes,d=n.session;return t.useIf($e.Environment.isDevelopment,new L.LogHandler).useIf(!$e.Environment.isWebRtcSupported,new U.NoWebRTCHandler).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,et.PIPE_LOG(t.id+" start pipe",t.request)]}))}))})).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,i.setDownloadTask(t.id,t)]}))}))})).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,a.registerSelfActivity()]}))}))})).use(new x.HavesOnStartHandler(n.haves)).use(new N.ESDHandler(c)).use(new q.QualitySwitchHandler(n.metrics)).use(new V.RepeatRequestHandler).use(new Z.SelectSourceHandler(n.peeringStrategy,n.config,n.metrics,n.webrtcPool,n.workMode)).use(new z.RetrieveExternalHashHandler(s,u)).use(new T.BlacklistHandler(n.blacklist)).use(new se.WaitHaveHandler(n.timeout,n.haves,n.swarmJoggler,n.config,n.session)).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return t.cycleCountdown=u.pdnCycleCount,[2]}))}))})).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return t.abrPdnFakeStatFactor=u.abrPdnFakeStatFactor,[2]}))}))})).useSerialCycleOutside((function(e){return!(e.isExternalHashCheckEnabled&&!e.externalHash)&&!!e.flags&&e.flags.isPeeringable&&e.cycleCountdown>0&&e.globalCycleCountdown>0&&!e.isPdnDataFinished}),[new K.CycleSelectPeerHandler(n.selector,n.haves,n.swarmMetadata,n.timeout,n.config),new j.NodrCyclePdnDownloadHandler(n.timeout,n.metrics,n.pdn,n.segmentFactory,n.peeringStrategy,n.segmentHashes,n.swarmMetadata,d,n.backend,n.config,n.haves),new R.CycleIncrementDownloadZBEH(n.swarmMetadata),new O.CycleIncrementDownloadTimeoutH(n.swarmMetadata),new I.CycleDecrementTry],[new Y.NodrSelectPeerHandler(n.selector,n.haves,n.swarmMetadata,n.timeout,n.config),new B.NodrExtraCycleDownloadHandler(n.timeout,n.metrics,n.pdn,n.peeringStrategy,n.swarmMetadata,n.config,d,n.backend),new A.CycleEndHandler]).useSerialOutside(new te.TryNodrDownloadHandler(n.nodrPeersController,n.timeout,n.config,d,n.metrics,n.backend,n.timeout),new Q.SegmentHashCheckerHandler(h,n.metrics,n.config),new ee.TryCdnDownloadHandler(n.compability,n.peeringStrategy)).use(new $.TimeslotHandler(n.timeslotExtractor,n.timeslotHolder)).useParallel(new P.BroadcastHaveHandler(n.pdn,n.config,n.timeslotHolder,n.scoring,n.issTrigger),new oe.WaitFullPayloadHandler).use(new D.BufferingHandler(n.buffering)).use(new k.HaveDensityHandler(n.haves,l)).useParallel(new X.SendPlayerResponseHandler,new C.BroadcastSegmentHashHandler(n.segmentHashes,n.config),new W.PutCacheHandler(n.cache,n.peeringStrategy),new M.DownloadWaitToHaveTriggerHandler(n.haves,n.session,n.config)).use(new F.PutNodrHandler(n.config,n.peeringStrategy,n.segmentHashes)).useParallel(new H.MultiSendStatHandler(n.backend,n.config,n.metrics,n.statistics,n.statAggregator,n.segmentFactory),new J.SendNodrEventHandler(n.backend,n.session,n.config),(function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,i.setDownloadTask(t.id,null)]}))}))})).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,a.registerDownloadActivity()]}))}))})).use(new G.SegmentSizeScoringHandler(n.scoring)).useParallel(new re.UpdateMetricsHandler(n.metrics),new ne.UpdateMatchHandler(n.matcher),new ie.UpdatePeerSpeed(n.swarmMetadata)).use((function(t){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,et.PIPE_LOG(t.id+" finish pipe",t.flags)]}))}))})).useErrorHandler((function(t,n){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(r){return et.PIPE_LOG(t.id+" error pipe",n),i.setDownloadTask(t.id,null),o.register("HANDLE_DOWNLOAD_ERROR"),$e.Environment.isDevelopment||(e=Object.assign({id:t.id,url:t.request.url,type:"download"},n.toJSON()),tt.Timer.timeout((function(){return s.error(nt.TimeSpan.now,e)}),100)),[2]}))}))}))},e.prototype.createUploadPipeline=function(){var e=this,t=new _e.UploadTaskPipeline,n=this.svc,i=n.pdnMetrics,o=n.backend;return t.useIf($e.Environment.isDevelopment,new pe.UploadLogHandler).use(new fe.UploadControlHandler(n.peeringStrategy,n.uploadController)).useWhen((function(e){return e.isCanUpload}),new ce.RangeCheckHandler).useWhen((function(e){return e.isCanUpload}),new le.RetrieveCachedSegmentHandler(n.cache,n.metrics)).useWhen((function(e){return e.isCanUpload&&!e.payload}),new he.RetrieveLoadingSegmentHandler(n.tasks,n.metrics,n.config)).use(new ue.FlushDataHandler).useParallel(new de.UpdateUploadMetricsHandler(n.metrics,n.uploadController),new ae.FireStatHandler(n.config,n.connection,n.statistics,n.swarmMetadata,n.swarmStat,n.workMode,n.segmentHashes)).useErrorHandler((function(t,n){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(r){return i.register("HANDLE_UPLOAD_ERROR"),$e.Environment.isDevelopment||(e=Object.assign({id:t.id,type:"upload"},n.toJSON()),tt.Timer.timeout((function(){return o.error(nt.TimeSpan.now,e)}),100)),[2]}))}))}))},e.prototype.use=function(e){var t=this;return function(n){if(!n)throw new Se.ArgumentNullException("value");return e(n),t.its.push(n),t}},e}();t.DefaultAppBuilder=st},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(2),a=n(8),u=n(5),c=n(42),l=function(){function e(e,t,n,r,o){var c=this;if(this._backend=e,this._session=t,this._metrics=n,this._config=r,this._wsconn=o,this.BACKGROUND_TIMEOUT=u.TimeSpan.fromMinutes(1),this.ACTIVE_TIMEOUT=u.TimeSpan.fromMinutes(2),this._logger=new s.Logger("Authenticator"),!e)throw new i.ArgumentNullException("backend");if(!t)throw new i.ArgumentNullException("session");if(!r)throw new i.ArgumentNullException("config");if(!o)throw new i.ArgumentNullException("wsconn");this._timer=new a.Timer((function(){return c.handleTick()}),(function(){return c.getAuthTimer()})),this._reAuthTimer=new a.Timer((function(){return c.handleReconnectTick()}),(function(){return c._config.backendReconnectTimeout}),!0),this._wsconn.onNeedNewAddress=this.handleReconnectRequest.bind(this)}return e.prototype.dispose=function(){this._timer.dispose(),o.Destructor.destroyObject(this)},e.prototype.authenticate=function(e,t){var n=this._session;e&&e!==n.apiKey&&(n.apiKey=e,n.accessToken="",this._metrics.register("AUTH_APIKEY_CHANGE")),t&&t!==n.streamUrl&&(n.streamId=c.XXHash.generate(t),n.streamUrl=t,n.accessToken="",this._metrics.register("AUTH_STREAM_CHANGE")),this._timer.start(1)},e.prototype.restartReauthTimer=function(){this._reAuthTimer.start(),this._logger.debug("restartReauthTimer")},e.prototype.getAuthTimer=function(){return this._session.isAuthenticated?this.BACKGROUND_TIMEOUT.value:this.ACTIVE_TIMEOUT.value},e.prototype.handleTick=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return this._session.isAuthenticated?[2]:this._session.streamId?this._lastAuthTry&&this._lastAuthTry.diff()<this.ACTIVE_TIMEOUT.value?[2]:(this._lastAuthTry=u.TimeSpan.now,[4,this._backend.init(this._session.apiKey,this._session.streamId,this._session.streamUrl)]):[2];case 1:return(e=t.sent())&&(this.setSessionOpts(e),this.onAuthenticate&&this.onAuthenticate(!1),this._reAuthTimer.start()),[2]}}))}))},e.prototype.setSessionOpts=function(e){this._session.userId=e.uid,this._session.sessionId=e.sid,this._session.connectionId=e.id,this._session.signalEndpoint=e.signalUrl,this._session.swarmEndpoint=e.swarmUrl,this._session.statEndpoint=e.statUrl,this._session.accessToken=e.token},e.prototype.handleReconnectTick=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._backend.init(this._session.apiKey,this._session.streamId,this._session.streamUrl)];case 1:return(e=t.sent())&&(this._logger.debug("handleReconnectTick",e),e.uid===this._session.userId&&this._session.sessionId===e.sid&&this._session.connectionId===e.id&&this._session.signalEndpoint===e.signalUrl&&this._session.swarmEndpoint===e.swarmUrl&&this._session.statEndpoint===e.statUrl&&this._session.accessToken===e.token||(this.setSessionOpts(e),this.onAuthenticate&&this.onAuthenticate(!1))),[2]}}))}))},e.prototype.handleReconnectRequest=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._backend.init(this._session.apiKey,this._session.streamId,this._session.streamUrl)];case 1:return(e=t.sent())?(this._logger.debug("handleReconnectTick",e),this.setSessionOpts(e),[4,this._wsconn.open()]):[3,3];case 2:t.sent(),this.onAuthenticate&&this.onAuthenticate(!1),t.label=3;case 3:return[2]}}))}))},e}();t.Authenticator=l},function(e,t,n){e.exports={h32:n(146),h64:n(152)}},function(e,t,n){(function(t){var r=n(94).UINT32;r.prototype.xxh_update=function(e,t){var n,r,s=o._low,a=o._high;n=(r=e*s)>>>16,n+=t*s,n&=65535,n+=e*a;var u=this._low+(65535&r),c=u>>>16,l=(c+=this._high+(65535&n))<<16|65535&u;u=65535&(l=l<<13|l>>>19),c=l>>>16,n=(r=u*(s=i._low))>>>16,n+=c*s,n&=65535,n+=u*(a=i._high),this._low=65535&r,this._high=65535&n};var i=r("2654435761"),o=r("2246822519"),s=r("3266489917"),a=r("668265263"),u=r("374761393");function c(){return 2==arguments.length?new c(arguments[1]).update(arguments[0]).digest():this instanceof c?void l.call(this,arguments[0]):new c(arguments[0])}function l(e){return this.seed=e instanceof r?e.clone():r(e),this.v1=this.seed.clone().add(i).add(o),this.v2=this.seed.clone().add(o),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(i),this.total_len=0,this.memsize=0,this.memory=null,this}c.prototype.init=l,c.prototype.update=function(e){var n,r="string"==typeof e;r&&(e=function(e){for(var t=[],n=0,r=e.length;n<r;n++){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(n++,i=65536+((1023&i)<<10|1023&e.charCodeAt(n)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return new Uint8Array(t)}(e),r=!1,n=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(n=!0,e=new Uint8Array(e));var i=0,o=e.length,s=i+o;if(0==o)return this;if(this.total_len+=o,0==this.memsize&&(this.memory=r?"":n?new Uint8Array(16):new t(16)),this.memsize+o<16)return r?this.memory+=e:n?this.memory.set(e.subarray(0,o),this.memsize):e.copy(this.memory,this.memsize,0,o),this.memsize+=o,this;if(this.memsize>0){r?this.memory+=e.slice(0,16-this.memsize):n?this.memory.set(e.subarray(0,16-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,16-this.memsize);var a=0;r?(this.v1.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v2.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v3.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v4.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2))):(this.v1.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v2.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v3.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v4.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2])),i+=16-this.memsize,this.memsize=0,r&&(this.memory="")}if(i<=s-16){var u=s-16;do{r?(this.v1.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v2.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v3.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2)),i+=4,this.v4.xxh_update(e.charCodeAt(i+1)<<8|e.charCodeAt(i),e.charCodeAt(i+3)<<8|e.charCodeAt(i+2))):(this.v1.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v2.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v3.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2]),i+=4,this.v4.xxh_update(e[i+1]<<8|e[i],e[i+3]<<8|e[i+2])),i+=4}while(i<=u)}return i<s&&(r?this.memory+=e.slice(i):n?this.memory.set(e.subarray(i,s),this.memsize):e.copy(this.memory,this.memsize,i,s),this.memsize=s-i),this},c.prototype.digest=function(){var e,t,n=this.memory,c="string"==typeof n,l=0,h=this.memsize,d=new r;for((e=this.total_len>=16?this.v1.rotl(1).add(this.v2.rotl(7).add(this.v3.rotl(12).add(this.v4.rotl(18)))):this.seed.clone().add(u)).add(d.fromNumber(this.total_len));l<=h-4;)c?d.fromBits(n.charCodeAt(l+1)<<8|n.charCodeAt(l),n.charCodeAt(l+3)<<8|n.charCodeAt(l+2)):d.fromBits(n[l+1]<<8|n[l],n[l+3]<<8|n[l+2]),e.add(d.multiply(s)).rotl(17).multiply(a),l+=4;for(;l<h;)d.fromBits(c?n.charCodeAt(l++):n[l++],0),e.add(d.multiply(u)).rotl(11).multiply(i);return t=e.clone().shiftRight(15),e.xor(t).multiply(o),t=e.clone().shiftRight(13),e.xor(t).multiply(s),t=e.clone().shiftRight(16),e.xor(t),this.init(this.seed),e},e.exports=c}).call(this,n(27).Buffer)},function(e,t,n){"use strict";t.byteLength=function(e){var t=c(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,r=c(e),s=r[0],a=r[1],u=new o(function(e,t,n){return 3*(t+n)/4-n}(0,s,a)),l=0,h=a>0?s-4:s;for(n=0;n<h;n+=4)t=i[e.charCodeAt(n)]<<18|i[e.charCodeAt(n+1)]<<12|i[e.charCodeAt(n+2)]<<6|i[e.charCodeAt(n+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;return 2===a&&(t=i[e.charCodeAt(n)]<<2|i[e.charCodeAt(n+1)]>>4,u[l++]=255&t),1===a&&(t=i[e.charCodeAt(n)]<<10|i[e.charCodeAt(n+1)]<<4|i[e.charCodeAt(n+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t),u},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,o=[],s=0,a=n-i;s<a;s+=16383)o.push(l(e,s,s+16383>a?a:s+16383));return 1===i?(t=e[n-1],o.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],o.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),o.join("")};for(var r=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,u=s.length;a<u;++a)r[a]=s[a],i[s.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var i,o,s=[],a=t;a<n;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(r[(o=i)>>18&63]+r[o>>12&63]+r[o>>6&63]+r[63&o]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,r,i){var o,s,a=8*i-r-1,u=(1<<a)-1,c=u>>1,l=-7,h=n?i-1:0,d=n?-1:1,f=e[t+h];for(h+=d,o=f&(1<<-l)-1,f>>=-l,l+=a;l>0;o=256*o+e[t+h],h+=d,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=r;l>0;s=256*s+e[t+h],h+=d,l-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),o-=c}return(f?-1:1)*s*Math.pow(2,o-r)},t.write=function(e,t,n,r,i,o){var s,a,u,c=8*o-i-1,l=(1<<c)-1,h=l>>1,d=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:o-1,p=r?1:-1,_=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+h>=1?d/u:d*Math.pow(2,1-h))*u>=2&&(s++,u/=2),s+h>=l?(a=0,s=l):s+h>=1?(a=(t*u-1)*Math.pow(2,i),s+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,i),s=0));i>=8;e[n+f]=255&a,f+=p,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[n+f]=255&s,f+=p,s/=256,c-=8);e[n+f-p]|=128*_}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t,n){var r;!function(n){function i(e,t){return this instanceof i?(this._low=0,this._high=0,this.remainder=null,void 0===t?s.call(this,e):"string"==typeof e?a.call(this,e,t):void o.call(this,e,t)):new i(e,t)}function o(e,t){return this._low=0|e,this._high=0|t,this}function s(e){return this._low=65535&e,this._high=e>>>16,this}function a(e,t){var n=parseInt(e,t||10);return this._low=65535&n,this._high=n>>>16,this}i(Math.pow(36,5)),i(Math.pow(16,7)),i(Math.pow(10,9)),i(Math.pow(2,30)),i(36),i(16),i(10),i(2),i.prototype.fromBits=o,i.prototype.fromNumber=s,i.prototype.fromString=a,i.prototype.toNumber=function(){return 65536*this._high+this._low},i.prototype.toString=function(e){return this.toNumber().toString(e||10)},i.prototype.add=function(e){var t=this._low+e._low,n=t>>>16;return n+=this._high+e._high,this._low=65535&t,this._high=65535&n,this},i.prototype.subtract=function(e){return this.add(e.clone().negate())},i.prototype.multiply=function(e){var t,n,r=this._high,i=this._low,o=e._high,s=e._low;return t=(n=i*s)>>>16,t+=r*s,t&=65535,t+=i*o,this._low=65535&n,this._high=65535&t,this},i.prototype.div=function(e){if(0==e._low&&0==e._high)throw Error("division by zero");if(0==e._high&&1==e._low)return this.remainder=new i(0),this;if(e.gt(this))return this.remainder=this.clone(),this._low=0,this._high=0,this;if(this.eq(e))return this.remainder=new i(0),this._low=1,this._high=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._low=0,this._high=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=16?this._high|=1<<n-16:this._low|=1<<n);return this},i.prototype.negate=function(){var e=1+(65535&~this._low);return this._low=65535&e,this._high=~this._high+(e>>>16)&65535,this},i.prototype.equals=i.prototype.eq=function(e){return this._low==e._low&&this._high==e._high},i.prototype.greaterThan=i.prototype.gt=function(e){return this._high>e._high||!(this._high<e._high)&&this._low>e._low},i.prototype.lessThan=i.prototype.lt=function(e){return this._high<e._high||!(this._high>e._high)&&this._low<e._low},i.prototype.or=function(e){return this._low|=e._low,this._high|=e._high,this},i.prototype.and=function(e){return this._low&=e._low,this._high&=e._high,this},i.prototype.not=function(){return this._low=65535&~this._low,this._high=65535&~this._high,this},i.prototype.xor=function(e){return this._low^=e._low,this._high^=e._high,this},i.prototype.shiftRight=i.prototype.shiftr=function(e){return e>16?(this._low=this._high>>e-16,this._high=0):16==e?(this._low=this._high,this._high=0):(this._low=this._low>>e|this._high<<16-e&65535,this._high>>=e),this},i.prototype.shiftLeft=i.prototype.shiftl=function(e,t){return e>16?(this._high=this._low<<e-16,this._low=0,t||(this._high&=65535)):16==e?(this._high=this._low,this._low=0):(this._high=this._high<<e|this._low>>16-e,this._low=this._low<<e&65535,t||(this._high&=65535)),this},i.prototype.rotateLeft=i.prototype.rotl=function(e){var t=this._high<<16|this._low;return t=t<<e|t>>>32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.rotateRight=i.prototype.rotr=function(e){var t=this._high<<16|this._low;return t=t>>>e|t<<32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.clone=function(){return new i(this._low,this._high)},void 0===(r=function(){return i}.apply(t,[]))||(e.exports=r)}()},function(e,t,n){var r;!function(n){var i={16:s(Math.pow(16,5)),10:s(Math.pow(10,5)),2:s(Math.pow(2,5))},o={16:s(16),10:s(10),2:s(2)};function s(e,t,n,r){return this instanceof s?(this.remainder=null,"string"==typeof e?c.call(this,e,t):void 0===t?u.call(this,e):void a.apply(this,arguments)):new s(e,t,n,r)}function a(e,t,n,r){return void 0===n?(this._a00=65535&e,this._a16=e>>>16,this._a32=65535&t,this._a48=t>>>16,this):(this._a00=0|e,this._a16=0|t,this._a32=0|n,this._a48=0|r,this)}function u(e){return this._a00=65535&e,this._a16=e>>>16,this._a32=0,this._a48=0,this}function c(e,t){t=t||10,this._a00=0,this._a16=0,this._a32=0,this._a48=0;for(var n=i[t]||new s(Math.pow(t,5)),r=0,o=e.length;r<o;r+=5){var a=Math.min(5,o-r),u=parseInt(e.slice(r,r+a),t);this.multiply(a<5?new s(Math.pow(t,a)):n).add(new s(u))}return this}s.prototype.fromBits=a,s.prototype.fromNumber=u,s.prototype.fromString=c,s.prototype.toNumber=function(){return 65536*this._a16+this._a00},s.prototype.toString=function(e){var t=o[e=e||10]||new s(e);if(!this.gt(t))return this.toNumber().toString(e);for(var n=this.clone(),r=new Array(64),i=63;i>=0&&(n.div(t),r[i]=n.remainder.toNumber().toString(e),n.gt(t));i--);return r[i-1]=n.toNumber().toString(e),r.join("")},s.prototype.add=function(e){var t=this._a00+e._a00,n=t>>>16,r=(n+=this._a16+e._a16)>>>16,i=(r+=this._a32+e._a32)>>>16;return i+=this._a48+e._a48,this._a00=65535&t,this._a16=65535&n,this._a32=65535&r,this._a48=65535&i,this},s.prototype.subtract=function(e){return this.add(e.clone().negate())},s.prototype.multiply=function(e){var t=this._a00,n=this._a16,r=this._a32,i=this._a48,o=e._a00,s=e._a16,a=e._a32,u=t*o,c=u>>>16,l=(c+=t*s)>>>16;c&=65535,l+=(c+=n*o)>>>16;var h=(l+=t*a)>>>16;return l&=65535,h+=(l+=n*s)>>>16,l&=65535,h+=(l+=r*o)>>>16,h+=t*e._a48,h&=65535,h+=n*a,h&=65535,h+=r*s,h&=65535,h+=i*o,this._a00=65535&u,this._a16=65535&c,this._a32=65535&l,this._a48=65535&h,this},s.prototype.div=function(e){if(0==e._a16&&0==e._a32&&0==e._a48){if(0==e._a00)throw Error("division by zero");if(1==e._a00)return this.remainder=new s(0),this}if(e.gt(this))return this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0,this;if(this.eq(e))return this.remainder=new s(0),this._a00=1,this._a16=0,this._a32=0,this._a48=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=48?this._a48|=1<<n-48:n>=32?this._a32|=1<<n-32:n>=16?this._a16|=1<<n-16:this._a00|=1<<n);return this},s.prototype.negate=function(){var e=1+(65535&~this._a00);return this._a00=65535&e,e=(65535&~this._a16)+(e>>>16),this._a16=65535&e,e=(65535&~this._a32)+(e>>>16),this._a32=65535&e,this._a48=~this._a48+(e>>>16)&65535,this},s.prototype.equals=s.prototype.eq=function(e){return this._a48==e._a48&&this._a00==e._a00&&this._a32==e._a32&&this._a16==e._a16},s.prototype.greaterThan=s.prototype.gt=function(e){return this._a48>e._a48||!(this._a48<e._a48)&&(this._a32>e._a32||!(this._a32<e._a32)&&(this._a16>e._a16||!(this._a16<e._a16)&&this._a00>e._a00))},s.prototype.lessThan=s.prototype.lt=function(e){return this._a48<e._a48||!(this._a48>e._a48)&&(this._a32<e._a32||!(this._a32>e._a32)&&(this._a16<e._a16||!(this._a16>e._a16)&&this._a00<e._a00))},s.prototype.or=function(e){return this._a00|=e._a00,this._a16|=e._a16,this._a32|=e._a32,this._a48|=e._a48,this},s.prototype.and=function(e){return this._a00&=e._a00,this._a16&=e._a16,this._a32&=e._a32,this._a48&=e._a48,this},s.prototype.xor=function(e){return this._a00^=e._a00,this._a16^=e._a16,this._a32^=e._a32,this._a48^=e._a48,this},s.prototype.not=function(){return this._a00=65535&~this._a00,this._a16=65535&~this._a16,this._a32=65535&~this._a32,this._a48=65535&~this._a48,this},s.prototype.shiftRight=s.prototype.shiftr=function(e){return(e%=64)>=48?(this._a00=this._a48>>e-48,this._a16=0,this._a32=0,this._a48=0):e>=32?(e-=32,this._a00=65535&(this._a32>>e|this._a48<<16-e),this._a16=this._a48>>e&65535,this._a32=0,this._a48=0):e>=16?(e-=16,this._a00=65535&(this._a16>>e|this._a32<<16-e),this._a16=65535&(this._a32>>e|this._a48<<16-e),this._a32=this._a48>>e&65535,this._a48=0):(this._a00=65535&(this._a00>>e|this._a16<<16-e),this._a16=65535&(this._a16>>e|this._a32<<16-e),this._a32=65535&(this._a32>>e|this._a48<<16-e),this._a48=this._a48>>e&65535),this},s.prototype.shiftLeft=s.prototype.shiftl=function(e,t){return(e%=64)>=48?(this._a48=this._a00<<e-48,this._a32=0,this._a16=0,this._a00=0):e>=32?(e-=32,this._a48=this._a16<<e|this._a00>>16-e,this._a32=this._a00<<e&65535,this._a16=0,this._a00=0):e>=16?(e-=16,this._a48=this._a32<<e|this._a16>>16-e,this._a32=65535&(this._a16<<e|this._a00>>16-e),this._a16=this._a00<<e&65535,this._a00=0):(this._a48=this._a48<<e|this._a32>>16-e,this._a32=65535&(this._a32<<e|this._a16>>16-e),this._a16=65535&(this._a16<<e|this._a00>>16-e),this._a00=this._a00<<e&65535),t||(this._a48&=65535),this},s.prototype.rotateLeft=s.prototype.rotl=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,r=this._a16<<16|this._a00,i=n<<e|r>>>32-e,o=r<<e|n>>>32-e;return this._a00=65535&o,this._a16=o>>>16,this._a32=65535&i,this._a48=i>>>16,this},s.prototype.rotateRight=s.prototype.rotr=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,r=this._a16<<16|this._a00,i=n>>>e|r<<32-e,o=r>>>e|n<<32-e;return this._a00=65535&o,this._a16=o>>>16,this._a32=65535&i,this._a48=i>>>16,this},s.prototype.clone=function(){return new s(this._a00,this._a16,this._a32,this._a48)},void 0===(r=function(){return s}.apply(t,[]))||(e.exports=r)}()},function(e,t,n){(function(t){var r=n(94).UINT64,i=r("11400714785074694791"),o=r("14029467366897019727"),s=r("1609587929392839161"),a=r("9650029242287828579"),u=r("2870177450012600261");function c(){return 2==arguments.length?new c(arguments[1]).update(arguments[0]).digest():this instanceof c?void l.call(this,arguments[0]):new c(arguments[0])}function l(e){return this.seed=e instanceof r?e.clone():r(e),this.v1=this.seed.clone().add(i).add(o),this.v2=this.seed.clone().add(o),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(i),this.total_len=0,this.memsize=0,this.memory=null,this}c.prototype.init=l,c.prototype.update=function(e){var n,s="string"==typeof e;s&&(e=function(e){for(var t=[],n=0,r=e.length;n<r;n++){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(n++,i=65536+((1023&i)<<10|1023&e.charCodeAt(n)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return new Uint8Array(t)}(e),s=!1,n=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(n=!0,e=new Uint8Array(e));var a=0,u=e.length,c=a+u;if(0==u)return this;if(this.total_len+=u,0==this.memsize&&(this.memory=s?"":n?new Uint8Array(32):new t(32)),this.memsize+u<32)return s?this.memory+=e:n?this.memory.set(e.subarray(0,u),this.memsize):e.copy(this.memory,this.memsize,0,u),this.memsize+=u,this;if(this.memsize>0){s?this.memory+=e.slice(0,32-this.memsize):n?this.memory.set(e.subarray(0,32-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,32-this.memsize);var l=0;s?(d=r(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v1.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v2.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v3.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v4.add(d.multiply(o)).rotl(31).multiply(i)):(d=r(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v1.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v2.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v3.add(d.multiply(o)).rotl(31).multiply(i),l+=8,d=r(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v4.add(d.multiply(o)).rotl(31).multiply(i)),a+=32-this.memsize,this.memsize=0,s&&(this.memory="")}if(a<=c-32){var h=c-32;do{var d;s?(d=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v1.add(d.multiply(o)).rotl(31).multiply(i),a+=8,d=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v2.add(d.multiply(o)).rotl(31).multiply(i),a+=8,d=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v3.add(d.multiply(o)).rotl(31).multiply(i),a+=8,d=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v4.add(d.multiply(o)).rotl(31).multiply(i)):(d=r(e[a+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v1.add(d.multiply(o)).rotl(31).multiply(i),d=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v2.add(d.multiply(o)).rotl(31).multiply(i),d=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v3.add(d.multiply(o)).rotl(31).multiply(i),d=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v4.add(d.multiply(o)).rotl(31).multiply(i)),a+=8}while(a<=h)}return a<c&&(s?this.memory+=e.slice(a):n?this.memory.set(e.subarray(a,c),this.memsize):e.copy(this.memory,this.memsize,a,c),this.memsize=c-a),this},c.prototype.digest=function(){var e,t,n=this.memory,c="string"==typeof n,l=0,h=this.memsize,d=new r;for(this.total_len>=32?((e=this.v1.clone().rotl(1)).add(this.v2.clone().rotl(7)),e.add(this.v3.clone().rotl(12)),e.add(this.v4.clone().rotl(18)),e.xor(this.v1.multiply(o).rotl(31).multiply(i)),e.multiply(i).add(a),e.xor(this.v2.multiply(o).rotl(31).multiply(i)),e.multiply(i).add(a),e.xor(this.v3.multiply(o).rotl(31).multiply(i)),e.multiply(i).add(a),e.xor(this.v4.multiply(o).rotl(31).multiply(i)),e.multiply(i).add(a)):e=this.seed.clone().add(u),e.add(d.fromNumber(this.total_len));l<=h-8;)c?d.fromBits(n.charCodeAt(l+1)<<8|n.charCodeAt(l),n.charCodeAt(l+3)<<8|n.charCodeAt(l+2),n.charCodeAt(l+5)<<8|n.charCodeAt(l+4),n.charCodeAt(l+7)<<8|n.charCodeAt(l+6)):d.fromBits(n[l+1]<<8|n[l],n[l+3]<<8|n[l+2],n[l+5]<<8|n[l+4],n[l+7]<<8|n[l+6]),d.multiply(o).rotl(31).multiply(i),e.xor(d).rotl(27).multiply(i).add(a),l+=8;for(l+4<=h&&(c?d.fromBits(n.charCodeAt(l+1)<<8|n.charCodeAt(l),n.charCodeAt(l+3)<<8|n.charCodeAt(l+2),0,0):d.fromBits(n[l+1]<<8|n[l],n[l+3]<<8|n[l+2],0,0),e.xor(d.multiply(i)).rotl(23).multiply(o).add(s),l+=4);l<h;)d.fromBits(c?n.charCodeAt(l++):n[l++],0,0,0),e.xor(d.multiply(u)).rotl(11).multiply(i);return t=e.clone().shiftRight(33),e.xor(t).multiply(o),t=e.clone().shiftRight(29),e.xor(t).multiply(s),t=e.clone().shiftRight(32),e.xor(t),this.init(this.seed),e},e.exports=c}).call(this,n(27).Buffer)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=function(){function e(){this.downloading={}}return e.prototype.dispose=function(){r.Destructor.destroyObject(this)},e.prototype.setDownloadTask=function(e,t){t?this.downloading[e]=t:delete this.downloading[e]},e.prototype.getDownloadTask=function(e){return this.downloading[e]||null},e}();t.ActiveTasks=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=n(5),o=function(){function e(e){this._config=e,this._hasExternalBufferingMark=!1,this._lastBufferingTime=new i.TimeSpan(0)}return e.prototype.dispose=function(){r.Destructor.destroyObject(this)},Object.defineProperty(e.prototype,"hasExternalBufferingMark",{get:function(){return this._hasExternalBufferingMark},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"swarmSizeQuota",{get:function(){return this.inBufferingMode?this._config.swarmSizeQuota/100:1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"inBufferingMode",{get:function(){return this._lastBufferingTime.diff()<this._config.bufferDecayTime},enumerable:!0,configurable:!0}),e.prototype.markExternalBuffering=function(){this._hasExternalBufferingMark=!0,this._lastBufferingTime=i.TimeSpan.now},e.prototype.reset=function(){this._hasExternalBufferingMark=!1},e}();t.DefaultBuffering=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(20),i=function(){function e(){this._rangeRequest=!1}return e.prototype.hasRangeRequest=function(){return this._rangeRequest},e.prototype.checkCdnHeaders=function(e){this._rangeRequest="bytes"===e[r.HttpHeaders.AcceptRanges]},e}();t.DefaultCompability=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(67),o=n(22),s=function(e){function t(t){var n=e.call(this)||this;return n.TUNE_FACTOR=3,n.DEFAULT_VALUE=1,n._value=0,t.addAppender((function(e){e.register("CURRENT_HAVE_DENSITY",Math.round(n.value),!0)})),n}return r.__extends(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this._value||this.DEFAULT_VALUE},enumerable:!0,configurable:!0}),t.prototype.update=function(e){var t=this.value;this._value=o.MathUtils.round(2*t/this.TUNE_FACTOR+e/this.TUNE_FACTOR,3),this.emit("newDensity",{density:this.value},!0)},t}(i.SimpleEventEmitter);t.DefaultHaveDensity=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),i=n(2),o=n(22),s=function(){function e(){this.TUNE_FACTOR=3,this.DEFAULT_ESTIMATE_DURATION=2e3,this._value=0,this._logger=new i.Logger("EstimateSegmentDuration")}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value||this.DEFAULT_ESTIMATE_DURATION},enumerable:!0,configurable:!0}),e.prototype.update=function(e){var t=this.value,n=e||this.DEFAULT_ESTIMATE_DURATION;this._value?this._value=o.MathUtils.round(2*t/this.TUNE_FACTOR+n/this.TUNE_FACTOR,3):this._value=n,this._logger.debugIf(r.Environment.isDevelopment&&t!==n,"New value",this._value)},e}();t.EstimateSegmentDuration=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(13),s=n(4),a=n(3),u=n(67),c=n(2),l=n(68),h=n(8),d=n(5),f=n(16),p=n(9),_=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._matcher=t,o._pdn=n,o._meta=r,o.logger=new c.Logger("HaveStorage"),o._REMOVE_TIMEOUT=d.TimeSpan.fromSeconds(10).value,o._removeQueue=[],o._haves={},o._sizes={},o._firstSeen={},o._awaiters={},!t)throw new i.ArgumentNullException("matcher");if(!n)throw new i.ArgumentNullException("pdn");if(!r)throw new i.ArgumentNullException("meta");return o._pdn.onHave=function(e,t){return o._handleHaveRequest(e,t)},o._pdn.onMultiHave=function(e,t){return o._handleMultiHaveRequest(e,t)},o._removeTimer=new h.Timer((function(){return o._unqueue()}),o._REMOVE_TIMEOUT),o._removeTimer.start(),o}return r.__extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._pdn.onHave=void 0,this._removeTimer&&this._removeTimer.dispose(),s.Destructor.destroyObject(this)},t.prototype.exist=function(e){return!!this._haves[e]&&this._haves[e].length>0},t.prototype.await=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:n=this._awaiters[e]||new l.PromiseGroup,this._awaiters[e]=n,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,n.acquireTimeout(t)];case 2:return r.sent(),[2,!0];case 3:return r.sent(),[2,!1];case 4:return[2]}}))}))},t.prototype.getBySegmentId=function(e){return this._haves[e]||[]},t.prototype.getCountBySegmentId=function(e){return this.getBySegmentId(e).length},t.prototype.getSegmentSize=function(e){return this._sizes[e]||-1},t.prototype.add=function(e,t,n,r){var i=this._haves[e]||[];if(i.push(t),this._haves[e]=i,this._sizes[e]=r,void 0===this._firstSeen[e]&&(this._firstSeen[e]=d.TimeSpan.now),this._awaiters[e]){try{this._awaiters[e].resolveAll(!0)}catch(e){this.logger.errorIf(a.Environment.isDevelopment,"this._awaiters[segmentId]!.resolveAll",e)}delete this._awaiters[e]}if(-1!==n){var o=Math.floor(n/this._REMOVE_TIMEOUT),s=this._removeQueue[o]||[];s.push(e+"|"+t),this._removeQueue[o]=s,this.emit("addHave",{segmentId:e,uuid:t},!0)}},t.prototype.getFirstSeenTime=function(e){return this._firstSeen[e]},t.prototype.removeByConnectionId=function(e){for(var t in this._haves)if(this._haves.hasOwnProperty(t)){var n=this._haves[t]||[],r=n.indexOf(e);r>-1&&n.splice(r,1)}},t.prototype._handleHaveRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return(n=e.json())?(this._meta.registerLastHaveTime(e.connectionId),(i=this._meta.resolve(e.connectionId))&&o.Bitmask.check(i.mode,f.PeeringMode.Upload)&&this.add(n.s,e.connectionId,1e3*n.tt,n.cl),n.ty!==p.SegmentType.Audio&&n.ty!==p.SegmentType.Caption&&this._matcher.register(e.connectionId,n.s),t.status=200,[2]):[2]}))}))},t.prototype._handleMultiHaveRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,s,a;return r.__generator(this,(function(r){if(!(n=e.json()))return[2];for(this._meta.registerLastHaveTime(e.connectionId),i=this._meta.resolve(e.connectionId),s=0;s<n.items.length;s++)a=n.items[s],i&&o.Bitmask.check(i.mode,f.PeeringMode.Upload)&&this.add(a.s,e.connectionId,1e3*a.tt,a.cl),a.ty!==p.SegmentType.Audio&&a.ty!==p.SegmentType.Caption&&this._matcher.register(e.connectionId,a.s);return t.status=200,[2]}))}))},t.prototype._unqueue=function(){var e=this._removeQueue.shift();if(e)for(var t=0;t<e.length;t++){var n=r.__read(e[t].split("|"),2),i=n[0],o=n[1];if(i&&o&&this._haves[i]){var s=this._haves[i],a=s.indexOf(o);a>-1&&s.splice(a,1),s.length||(delete this._haves[i],delete this._sizes[i])}}},t}(u.SimpleEventEmitter);t.HaveStorage=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(3),a=n(2),u=n(16),c=function(){function e(e,t,n,r,o,s,u){var c=this;if(this.pdnApi=e,this.swarm=t,this.swarmBuilder=n,this.config=r,this.meta=o,this.haveStorage=s,this.haveDensity=u,this.logger=new a.Logger("ImpactMatcherController"),this.selfIncomingOpen=!1,!e)throw new i.ArgumentNullException("pdnApi");if(!t)throw new i.ArgumentNullException("swarm");if(!r)throw new i.ArgumentNullException("config");if(!o)throw new i.ArgumentNullException("meta");if(!s)throw new i.ArgumentNullException("haveStorage");if(!u)throw new i.ArgumentNullException("haveDensity");this._selfBind(),s.on("addHave",this._handleAddHaveEvent),u.on("newDensity",this._handleNewDensityEvent),t.on("connectionReady",this._handleConnectionReadyEvent),this.pdnApi.onMuteImpactMatch=function(e,t){return c._handleImpactMatchMute(e,t)},this.pdnApi.onImpactMatchCandidate=function(e,t){return c._handleImpactMatchCandidate(e,t)}}return e.prototype.dispose=function(){this.pdnApi.onImpactMatchCandidate=void 0,this.pdnApi.onMuteImpactMatch=void 0,this.haveStorage.off("addHave",this._handleAddHaveEvent),this.haveDensity.off("newDensity",this._handleNewDensityEvent),this.swarm.off("connectionReady",this._handleConnectionReadyEvent),o.Destructor.destroyObject(this)},e.prototype._selfBind=function(){this._handleAddHaveEvent=this._handleAddHaveEvent.bind(this),this._handleNewDensityEvent=this._handleNewDensityEvent.bind(this),this._handleConnectionReadyEvent=this._handleConnectionReadyEvent.bind(this)},e.prototype._handleAddHaveEvent=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o,a=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this.config.useImpactMatcher&&(t=this.meta.getByUUId(e.uuid))?t.muteImpactMatcher?[2]:u.WorkMode.checkDownloadPM(t.mode)?(n=this.haveStorage.getBySegmentId(e.segmentId).filter((function(n){var r=a.meta.getByUUId(n);return!!r&&n!==e.uuid&&!t.impactMatcherCandidates.has(n)&&u.WorkMode.checkUploadPM(r.mode)&&r.issTrigger})),(i=n[0])?(t.impactMatcherCandidates.add(i),(o=this.meta.getByUUId(i))&&o.connectionId?[4,this.pdnApi.impactMatcherCandidate(e.uuid,o.connectionId)]:[3,2]):[2]):[2]:[2];case 1:r.sent(),this.logger.traceIf(s.Environment.isDevelopment,"candidate connection Id",o.connectionId),r.label=2;case 2:return[2]}}))}))},e.prototype._handleNewDensityEvent=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return this.config.useImpactMatcher?(this.logger.traceIf(s.Environment.isDevelopment,"handleNewDensityEvent",e),(t=e.density>this.config.impactMatcherHaveDensityThreshold)===this.selfIncomingOpen?[2]:(this.selfIncomingOpen=t,[4,this.pdnApi.broadcastMuteImpactMatcher(this.selfIncomingOpen)])):[2];case 1:return n.sent(),[2]}}))}))},e.prototype._handleConnectionReadyEvent=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this.config.useImpactMatcher?(this.logger.traceIf(s.Environment.isDevelopment,"handleNewDensityEvent",e),[4,this.pdnApi.muteImpactMatcher(e.uuid,this.selfIncomingOpen)]):[2];case 1:return t.sent(),[2]}}))}))},e.prototype._handleImpactMatchCandidate=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return this.config.useImpactMatcher&&(n=e.json())?(i=n.connectionId,t.status=200,this.logger.traceIf(s.Environment.isDevelopment,"_handleImpactMatchCandidate new candidate",i),this.swarmBuilder.addExternalCandidate({providerId:e.connectionId,result:[i],type:"webrtc"}),[2]):[2]}))}))},e.prototype._handleImpactMatchMute=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){return(n=e.json())?(t.status=200,this.meta.resolve(e.connectionId).muteImpactMatcher=n.mute,this.logger.traceIf(s.Environment.isDevelopment,"_handleImpactMatchMute",n.mute),[2]):[2]}))}))},e}();t.ImpactMatcherController=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this._config=e,this._val=!0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._val},enumerable:!0,configurable:!0}),e.prototype.update=function(e){this._val=e<this._config.maxSwarmSize},e}();t.DefaultIssTrigger=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(3),s=n(2),a=n(8),u=n(5),c=function(){function e(e,t,n,o){var c=this;if(this.backend=e,this.config=t,this.meta=n,this.metrics=o,this.logger=new s.Logger("NodrPeersController"),this.nodrsAvailable={},this.nodrs=new Set,!t)throw new i.ArgumentNullException("config");if(!n)throw new i.ArgumentNullException("meta");if(!e)throw new i.ArgumentNullException("backend");if(!o)throw new i.ArgumentNullException("metrics");this.config.onChanged=function(e){return c.onConfigChange(e)},this.timer=new a.Timer((function(){return r.__awaiter(c,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this.searchNodrPeers()];case 1:return[2,e.sent()]}}))}))}),u.TimeSpan.fromMinutes(10),!0),o.addAppender((function(e){var t=Object.keys(c.nodrsAvailable).reduce((function(e,t){return e+ +(c.nodrsAvailable[t]||0)}),0);e.register("NODR_NODES_COUNT",1e3*c.nodrs.size+t,!0)}))}return e.prototype.getNodrPeerUrl=function(e){var t,n,i,s,a=new Map,u=parseInt(e.id.slice(0,4),16);this.logger.infoIf(o.Environment.isDevelopment,"segment id "+e.id+", prefix "+u);try{for(var c=r.__values(this.nodrs),l=c.next();!l.done;l=c.next()){var h=l.value;if(this.nodrsAvailable[h]){var d=parseInt(h.slice(-16).slice(0,4),16);a.set(u^d>>>0,h)}}}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}if(a.size>0){var f=1/0;try{for(var p=r.__values(a.keys()),_=p.next();!_.done;_=p.next()){var g=_.value;g<f&&(f=g)}}catch(e){i={error:e}}finally{try{_&&!_.done&&(s=p.return)&&s.call(p)}finally{if(i)throw i.error}}return this.logger.infoIf(o.Environment.isDevelopment,e.id,"available nodr url count",a.size,"choose",a.get(f)),a.get(f)}return null},e.prototype.dispose=function(){this.timer.dispose(),this.backend=void 0,this.config=void 0,this.meta=void 0,this.metrics=void 0,this.nodrsAvailable=void 0,this.nodrs=void 0},e.prototype.disablePeer=function(e){var t,n,i=0;try{for(var s=r.__values(this.nodrs),a=s.next();!a.done;a=s.next()){var u=a.value;this.nodrsAvailable[u]&&i++}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}i>1?(this.logger.infoIf(o.Environment.isDevelopment,"Disabling nodr, active nodrs count "+i+", disable "+e),this.nodrsAvailable[e]=!1):this.logger.infoIf(o.Environment.isDevelopment,"Disabling nodr, active nodrs count "+i+", do not disable")},e.prototype.forceDisablePeer=function(e){this.nodrsAvailable[e]=!1},e.prototype.searchNodrPeers=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this.backend.searchNodrPeers()];case 1:return(e=n.sent()).length>0&&(this.nodrsAvailable={},this.nodrs.clear(),e.forEach((function(e){t.nodrsAvailable[e]=!0,t.nodrs.add(e)}))),[2]}}))}))},e.prototype.onConfigChange=function(e){this.timer.isStopped&&(this.config.nodrProxy?this.timer.start(1):this.timer.stop())},e}();t.NodrPeersController=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){return e.call(this,t,n,r,i)||this}return r.__extends(t,e),t.prototype.isCanUpload=function(){return this._config.active&&this._wm.isUpload()},t.prototype.isCanStreamingUpload=function(){return this._config.streamingUpload&&this.isCanUpload()},t.prototype.isCanDownloadPartial=function(){return this._config.partialDownload&&this._compability.hasRangeRequest()},t.prototype.isCanPdnDownloadPartial=function(){return this._config.pdnPartialDownload},t}(n(95).NoWebRtcPeeringStrategy);t.DefaultPeeringStrategy=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n){var r=e.call(this)||this;return r.configuration=n,r.TUNE_FACTOR=3,r.DEFAULT_VALUE=11,r._value=11,t.addAppender((function(e){e.register("CURRENT_SCORE",Math.round(r.value))})),r}return r.__extends(t,e),Object.defineProperty(t.prototype,"restoredValue",{get:function(){return this.restoreValue(this._value)},enumerable:!0,configurable:!0}),t.prototype.restoreValue=function(e){return 1024*Math.pow(e*this.configuration.scoreNormalizer,3)},t.prototype.update=function(t){var n=Math.cbrt(t/1024)/this.configuration.scoreNormalizer;e.prototype.update.call(this,n)},t}(n(164).DefaultScoring);t.SSNormalizeScoring=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(22),i=n(41),o=function(){function e(){this.TUNE_FACTOR=3,this.DEFAULT_VALUE=i.Quality.Q720P,this._value=0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value||this.DEFAULT_VALUE},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"restoredValue",{get:function(){return this.value},enumerable:!0,configurable:!0}),e.prototype.restoreValue=function(e){return e},e.prototype.update=function(e){var t=this.value,n=e||this.DEFAULT_VALUE;this._value?this._value=r.MathUtils.round(2*t/this.TUNE_FACTOR+n/this.TUNE_FACTOR,3):this._value=n},e}();t.DefaultScoring=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=n(5),o=function(){function e(e,t,n,r,i,o,s){this._config=e,this._swarmStat=t,this._conn=n,this._haves=r,this._meta=i,this._pm=o,this._hashes=s}return e.prototype.dispose=function(){r.Destructor.destroyObject(this)},e.prototype.create=function(e,t){void 0===t&&(t="");var n=this._swarmStat.getStat(),r=e.id,o=this.getTargetId(e),s=this.getHaves(e);return{timestamp:i.TimeSpan.value,request:e.request,timings:e.timings.toJSON(),result:{skippedPdnSize:e.pdnReceivedBytes,flags:e.flags.value,sourceId:e.responseSource,active:this._config.active,connected:this._conn.isOpened,downloadTimeout:e.downloadTimeout,waitTimeout:e.waitTimeout,size:e.responseLength,segmentId:r,targetId:o,haves:s,mode:this._pm.selfPM,range:t,swarmSize:n.ready,swarmSizeTotal:n.total}}},e.prototype.getTargetId=function(e){return(e.flags.isSeedMode||e.flags.isWaitHaveTimeout||e.flags.isMinBufferBound||e.flags.isEmptyReadySwarm)&&!e.flags.isHttpNodrDownload&&null!=this._hashes.getBySegmentId(e.id)?(""+this._hashes.getBySegmentId(e.id)).padStart(16,"0"):e.targetId&&16===e.targetId.length?e.targetId:e.targetId?this._meta.resolvePublicId(e.targetId):void 0},e.prototype.getHaves=function(e){var t=100*e.haveCountOnRequest+this._haves.getCountBySegmentId(e.id);return t>32767&&(t=-1),t},e}();t.DefaultSegmentFactory=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(2),a=function(){function e(e,t,n){var r=this;if(this.pdn=e,this.config=t,this.meta=n,this.logger=new s.Logger("SegmentHashController"),this.hashes={},this.counter={},this.connectionSetHolder={},this.broadcastHashes=new Set,this.mutedSet=new Set,!e)throw new i.ArgumentNullException("pdn");if(!t)throw new i.ArgumentNullException("config");if(!n)throw new i.ArgumentNullException("meta");this.pdn.onSegmentHash=function(e,t){return r._handleSegmentHashRequest(e,t)},this.pdn.onMuteSegmentHash=function(e,t){return r._handleMuteSegmentHashRequest(e,t)},this.pdn.onMultiHash=function(e,t){return r._handleMultiSegmentHash(e,t)}}return e.prototype.dispose=function(){this.pdn.onSegmentHash=void 0,this.pdn.onMuteSegmentHash=void 0,this.pdn.onMultiHash=void 0,o.Destructor.destroyObject(this)},e.prototype.addHash=function(e,t){this.hashes[e]=t},e.prototype.getBySegmentId=function(e){return this.hashes[e]||null},e.prototype.getCountBySegmentId=function(e){return this.counter[e]||0},e.prototype.bindConnectionToHash=function(e,t){var n=this.connectionSetHolder[e]||new Set;this.connectionSetHolder[e]=n,n.add(t)},e.prototype.isConnectionHasHash=function(e,t){var n=this.connectionSetHolder[e];return!!n&&n.has(t)},e.prototype.getBindSetForHash=function(e){return this.connectionSetHolder[e]||new Set},e.prototype.incrementCount=function(e){return this.counter[e]=(this.counter[e]||0)+1,this.counter[e]},e.prototype.broadcastHash=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i=this;return r.__generator(this,(function(o){return this.broadcastHashes.has(e)||(this.broadcastHashes.add(e),this.addHash(e,t),r.__awaiter(i,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.pdn.broadcastSegmentHash(e,t,n,this._getExcludedUuidSetForHash(t))];case 1:return i=r.sent(),this.logger.info("Broadcast",e,t,n,i),[2]}}))}))),[2]}))}))},e.prototype._handleMultiSegmentHash=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i=this;return r.__generator(this,(function(r){return(n=e.json())?(n.items.forEach((function(e){i.addHash(e.s,e.h),i.incrementCount(e.s)})),t.status=200,[2]):[2]}))}))},e.prototype._handleSegmentHashRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return(n=e.json())?(this.addHash(n.s,n.h),i=this.incrementCount(n.s),this.bindConnectionToHash(n.h,e.connectionId),t.status=200,this._segmentHashRebroadcast(n),i>this.config.hashDensityThreshold&&this._sendMuteSegmentHashes(e.connectionId),[2]):[2]}))}))},e.prototype._handleMuteSegmentHashRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){return(n=e.json())?(t.status=200,this.meta.resolve(e.connectionId).muteSegmentHash=n.mute,this.mutedSet.add(e.connectionId),[2]):[2]}))}))},e.prototype._segmentHashRebroadcast=function(e){this.broadcastHashes.has(e.s)||0!==e.tt&&(this.broadcastHashes.add(e.s),r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this.pdn.broadcastSegmentHash(e.s,e.h,e.tt-1,this._getExcludedUuidSetForHash(e.h))];case 1:return t=n.sent(),this.logger.info("Rebroadcast",e.s,e.h,e.tt-1,t),[2]}}))})))},e.prototype._sendMuteSegmentHashes=function(e){r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this.logger.info("Mute Segment hash"),[4,this.pdn.muteSegmentHash(e,!0)];case 1:return t.sent(),[2]}}))}))},e.prototype._getExcludedUuidSetForHash=function(e){return new Set(r.__spread(this.getBindSetForHash(e),this.mutedSet))},e}();t.SegmentHashController=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i,o,s){var a=e.call(this,t,n,r,i,o)||this;return a._esd=s,a}return r.__extends(t,e),t.prototype.getDownloadTimeout=function(){return 1===this._config.rtcDownloadTimeout?Math.floor(this._esd.value*(this._config.estimateTimeoutRatio/100)):e.prototype.getDownloadTimeout.call(this)},t}(n(168).DefaultDownloadTimeout);t.AutoDownloadTimeout=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(4),o=n(2),s=n(22),a=function(){function e(e,t,n,i,o){if(this._strategy=e,this._config=t,this._session=n,this._stat=i,this._timeslot=o,!e)throw new r.ArgumentNullException("strategy");if(!t)throw new r.ArgumentNullException("config");if(!n)throw new r.ArgumentNullException("session");if(!i)throw new r.ArgumentNullException("stat");if(!o)throw new r.ArgumentNullException("timeslot")}return e.prototype.dispose=function(){i.Destructor.destroyObject(this)},e.prototype.getWaitTimeout=function(e,t){return o.PIPE_LOG(t,"getWaitTimeout Calculate wait to have timeout, current buffer= ",e.bufferSize,"rtcWaitTimeout=",this._config.rtcWaitTimeout,"msMinBufferSize=",this._config.msMinBufferSize),this._strategy.isCanDownload()?1e3*e.bufferSize-this._config.rtcWaitTimeout<this._config.msMinBufferSize?(o.PIPE_LOG(t,"getWaitTimeout Current buffer is too small, do not wait to have"),0):this._strategy.isCanUpload()?this._session.waitToHaveOnNextDownload?(o.PIPE_LOG(t,"getWaitTimeout will wait to have for",this._config.rtcWaitTimeout,"msec"),s.MathUtils.round(this._config.rtcWaitTimeout)):(o.PIPE_LOG(t,"getWaitTimeout choose to be seed wait trigger = false"),0):s.MathUtils.round(this._config.rtcWaitTimeoutMobile):-1},e.prototype.getCalcDownloadTimeout=function(e){return this._strategy.isCanPdnDownloadPartial()||0!==e.tryPdnCount?0===e.tryPdnCount?this._config.rtcSoftDownloadTimeout:this._config.rtcDownloadTimeout-this._config.rtcSoftDownloadTimeout:s.MathUtils.round(this._config.rtcDownloadTimeout)},e.prototype.getDownloadTimeout=function(){return this._config.rtcDownloadTimeout},e.prototype.getSoftTimeout=function(){return this._config.rtcSoftDownloadTimeout},e.prototype.checkSeedChance=function(){return 100*Math.random()<this._config.seedChance},e}();t.DefaultDownloadTimeout=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),i=function(){function e(e){this._config=e}return e.prototype.extract=function(e){var t;if(r.Runtime.isRegExp(this._config.timeSlotParser)&&this._config.timeSlotParser.test(e)){var n=e.match(this._config.timeSlotParser);n&&(t=n[0])}else r.Runtime.isFunction(this._config.timeSlotParser)&&(t=this._config.timeSlotParser(e));return t?5*parseInt(t,10):-1},e}();t.DefaultTimeSlotExtractor=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(7),s=n(5),a=function(){function e(e,t,n,r){var o=this;if(this.meta=t,this.timeSlotCorrector=n,this.pdnApi=r,this._selfValue=0,this._selfLastTime=s.TimeSpan.value,this._diff=0,!e)throw new i.ArgumentNullException("metrics");if(!t)throw new i.ArgumentNullException("meta");if(!n)throw new i.ArgumentNullException("timeSlotCorrector");if(!r)throw new i.ArgumentNullException("pdnApi");this.pdnApi.onTimeslot=function(e,t){return o.handleRemoteTimeslot(e,t)},e.addAppender((function(e){o.calcDiff(),o.calcTSDMetrics(e),e.register("CURRENT_TIMESLOT_DIFF",o.currentTimeSlotDiff,!0).register("CURRENT_TIMESLOT",o._selfValue,!0)}))}return Object.defineProperty(e.prototype,"value",{get:function(){return this._selfValue+this.timeSlotCorrector.getCorrection({timeslotLastTime:this._selfLastTime})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"edge",{get:function(){var e=this,t=s.TimeSpan.value,n=this.value,i=this.meta.getAll().map((function(n){return n.timeslot+e.timeSlotCorrector.getCorrection(n,t)}));return Math.max.apply(Math,r.__spread(i,[n]))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentTimeSlotDiff",{get:function(){return this._diff},enumerable:!0,configurable:!0}),e.prototype.registerSelf=function(e){this._selfValue=e,this._selfLastTime=s.TimeSpan.value},e.prototype.handleRemoteTimeslot=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return n=e.json(),t.status=n?200:400,n&&n.timeslot&&((i=this.meta.resolve(e.connectionId)).timeslot=o.Runtime.isDefined(n.timeslot)?n.timeslot:0,i.edgeTimeSlot=o.Runtime.isDefined(n.edgeTimeSlot)?n.edgeTimeSlot:0,i.timeslotLastTime=s.TimeSpan.value),[2]}))}))},e.prototype.calcDiff=function(){var e=this,t=s.TimeSpan.value,n=this.value,i=this.meta.getAll().map((function(n){return n.edgeTimeSlot+e.timeSlotCorrector.getCorrection(n,t)})),o=Math.max.apply(Math,r.__spread(i,[n]));this._diff=o-n},e.prototype.calcTSDMetrics=function(e){var t=this,n=this.value,r=s.TimeSpan.value;this.meta.getAll().forEach((function(i){var o=i.timeslot+t.timeSlotCorrector.getCorrection(i,r),s=Math.abs(o-n);s?e.register("SWARM_SIZE_TSDL"+(0|Math.log2(s))):e.register("SWARM_SIZE_TSD0")}))},e}();t.DefaultTimeslotHolder=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(42),a=n(96),u=n(175),c=function(e){function t(){var t=e.call(this)||this;return t.useErrorHandler((function(e,n){return r.__awaiter(t,void 0,void 0,(function(){return r.__generator(this,(function(t){return o.Logger.errorIf(i.Environment.isDevelopment,"Execute downloading error:"+n.message,e),[2]}))}))})),t}return r.__extends(t,e),t.prototype.createTask=function(e,t){var n=s.XXHash.generate(t.uri.toLocaleLowerCase());return new u.DownloadTask(n,t,e)},t}(a.TaskPipeline);t.DownloadTaskPipeline=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._whenFunc=t,r._handlerFunc=n,!t)throw new i.ArgumentNullException("condition");if(!n)throw new i.ArgumentNullException("handler");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return(t=this._whenFunc(e))instanceof Promise?[4,t]:[3,2];case 1:t=n.sent(),n.label=2;case 2:return t?[4,this._handlerFunc(e)]:[3,4];case 3:n.sent(),n.label=4;case 4:return[2]}}))}))},t}(n(6).TaskHandler);t.ConditionHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._checkFunc=t,o._cycleHandlersFunc=n,o._endCycleHandlersFunc=r,!t)throw new i.ArgumentNullException("condition");if(!n)throw new i.ArgumentNullException("cycleHandlers");if(!r)throw new i.ArgumentNullException("endCycleHandlers");return o}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(n){return r.__awaiter(t,void 0,void 0,(function(){var t,n,i;return r.__generator(this,(function(r){switch(r.label){case 0:t=this._cycleHandlersFunc.length,n=this._endCycleHandlersFunc.length,r.label=1;case 1:return[4,this._checkFunc(e)];case 2:if(!r.sent())return[3,7];i=0,r.label=3;case 3:return i<t?[4,this._cycleHandlersFunc[i](e)]:[3,6];case 4:r.sent(),r.label=5;case 5:return i++,[3,3];case 6:return[3,1];case 7:i=0,r.label=8;case 8:return i<n?[4,this._endCycleHandlersFunc[i](e)]:[3,11];case 9:r.sent(),r.label=10;case 10:return i++,[3,8];case 11:return[2]}}))})),[2,Promise.resolve()]}))}))},t}(n(6).TaskHandler);t.CycleHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(11),s=n(54),a=n(43),u=n(8),c=0,l=function(){function e(e,t){if(this._handlers=e,this._errorHandler=t,this._id=++c,this._current=-1,this._isStarted=!1,this._isAborted=!1,!e)throw new i.ArgumentNullException("handlers");if(!t)throw new i.ArgumentNullException("errorHandler")}return e.prototype.run=function(e,t){return void 0===t&&(t=0),r.__awaiter(this,void 0,void 0,(function(){var n,i,s=this;return r.__generator(this,(function(c){switch(c.label){case 0:if(this._isStarted)throw new o.Exception("Task #"+this._id+" already running");this._isStarted=!0,this._ctx=e,c.label=1;case 1:return c.trys.push([1,6,,8]),t>0?[4,Promise.race([this._run(),r.__awaiter(s,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,u.Timer.delay(t)];case 1:throw e.sent(),new a.OperationTimeoutException("Execute task timeout. runner_id="+this._id+" step="+this._current)}}))}))])]:[3,3];case 2:return c.sent(),[3,5];case 3:return[4,this._run()];case 4:c.sent(),c.label=5;case 5:return[3,8];case 6:return n=c.sent(),i=o.Exception.fromNativeError(n,"Task #"+this._id+" executing error"),[4,this._errorHandler(e,i)];case 7:throw c.sent(),i;case 8:return this.dispose(),[2]}}))}))},e.prototype.abort=function(){var e=this;return this._isAborted=!0,new Promise((function(t){e._abortResolve=t}))},e.prototype.next=function(){return this._run()},e.prototype.dispose=function(){delete this._ctx,delete this._isStarted,delete this._current,delete this._handlers,delete this._errorHandler},e.prototype._run=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(n){switch(n.label){case 0:if(this._isAborted)throw u.Timer.timeout((function(){return t._abortResolve()}),100),new s.OperationAbortException("Execute task timeout. runner_id="+this._id+" step="+this._current);return this._isStarted?(this._current+=1,(e=this._handlers[this._current])?[4,e(this._ctx)]:[3,3]):[2];case 1:return n.sent(),[4,this._run()];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))},e}();t.TaskRunner=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(68),o=n(5),s=n(97),a=n(98),u=n(10),c=n(9),l=function(e){function t(t,n,r){var o=e.call(this,t,n,r)||this;return o.haveCountOnRequest=0,o.waitTimeout=-1,o.downloadTimeout=-1,o.streamingMode=!1,o.exceptConnectionList=[],o.pdnReceivedBytes=0,o.isPdnDataFinished=!1,o.isHashchainValid=!0,o.isHashchainCheckCompleted=!1,o.raceRedelegationsCount=-1,o.goodPdnDownload=!0,o.rangeOffset=0,o.segmentAttempts=[],o.tryPdnCount=0,o.worstSpeed=0,o.worstPeer=null,o.prevOffset=0,o.cycleCountdown=1,o.streamFromPdn=!1,o.abrPdnFakeStatFactor=100,o.awaitPdnTryFinish=new i.PromiseGroup,o.awaitCdnTryFinish=new i.PromiseGroup,o.nodrTry=!1,o.downloadedThrowNodr=!1,o.nodrPutUrl=null,o.downloadSourceId=u.DataSourceId.CDN,o.currentDownloadZeroByteError=!1,o.globalCycleCountdown=20,o.segmentType=c.SegmentType.Unknown,o.externalHash=null,o.isExternalHashCheckEnabled=!1,o._extraTargetId=[],o._debug=[],o.segmentType=n.type,o.stream.onProgress=function(e,t,r){if(o.stream.sourceId===u.DataSourceId.PDN&&(o.pdnReceivedBytes+=e.byteLength),n.onProgressCb){var i={headers:o.responseHeaders,sourceId:o.stream.sourceId,payload:o.stream.payload,timings:o.timings.toJSON(),tryPdnCount:o.tryPdnCount,abrPdnFakeStatFactor:o.abrPdnFakeStatFactor,loaded:t,total:r};n.onProgressCb(i)}},o}return r.__extends(t,e),Object.defineProperty(t.prototype,"targetId",{get:function(){return this._targetId||null},set:function(e){this._targetId=e||void 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extraTargetId",{get:function(){return this._extraTargetId||[]},set:function(e){this._extraTargetId=e||[]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nodrTargetId",{get:function(){return this._nodrTargetId||null},set:function(e){this._nodrTargetId=e||void 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"response",{get:function(){return this.stream.payload},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"responseSource",{get:function(){return this.stream.sourceId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"responseLength",{get:function(){return this.stream.payloadCap},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"responseHeaders",{get:function(){return this.stream.payloadHeaders||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spentTime",{get:function(){return this.segmentAttempts.reduce((function(e,t){return e+t.timings.ttlb-t.timings.ttfb}),0)},enumerable:!0,configurable:!0}),t.prototype.debug=function(e){this._debug.push(e)},Object.defineProperty(t.prototype,"debugString",{get:function(){return JSON.stringify(this._debug)},enumerable:!0,configurable:!0}),t.prototype.getHashChain=function(e){return this._hashChain||(this._hashChain=new a.HashChain(e)),this._hashChain},t.prototype.toSegment=function(){return{timestamp:o.TimeSpan.value,request:this.request,timings:this.timings.toJSON(),result:{skippedPdnSize:this.pdnReceivedBytes,flags:this.flags.value,sourceId:this.responseSource,active:!0,connected:!0,downloadTimeout:this.downloadTimeout,waitTimeout:this.waitTimeout,size:this.responseLength,segmentId:this.id,targetId:this.targetId||void 0,haves:0,mode:3,range:"",swarmSize:-1,swarmSizeTotal:-1}}},t.prototype.generateRangeOffset=function(){return this.pdnReceivedBytes>0?this.pdnReceivedBytes:0},t}(s.BaseLoadingTask);t.DownloadTask=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(){function e(e){if(this._runner=e,this._isCompleted=!1,!e)throw new i.ArgumentNullException("runner")}return Object.defineProperty(e.prototype,"isCompleted",{get:function(){return this._isCompleted},enumerable:!0,configurable:!0}),e.prototype.execute=function(e){return void 0===e&&(e=0),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._runner.run(this,e)];case 1:return t.sent(),this._isCompleted=!0,[2]}}))}))},e.prototype.next=function(){return this._runner.next()},e.prototype.abort=function(){return this._runner.abort()},e}();t.Task=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),i=n(54),o=n(12),s=n(3),a=n(2),u=n(68),c=n(7),l=n(10),h=n(178),d=function(){function e(e){var t=this;this.sourceId=l.DataSourceId.CDN,this.awaitGroupLoading=new u.PromiseGroup,this.awaitGroupLoaded=new u.PromiseGroup,this._isLoadingFired=!1,this._isClosed=!1,this._pipe=new h.Pipe(this),this.getLoadingAwaiter=function(){return t.awaitGroupLoading.acquire()},this.getFinishAwaiter=function(){return t.awaitGroupLoaded.acquire()},this.setAbortHandler=function(e){t._close=e},this.reset(),this._logger=new a.Logger("DATA_STREAM:"+e)}return Object.defineProperty(e.prototype,"payload",{get:function(){return this._payload},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"payloadSize",{get:function(){return this._payload.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"payloadCap",{get:function(){return this._payloadCap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"payloadHeaders",{get:function(){return this._payloadHeaders},enumerable:!0,configurable:!0}),e.prototype.open=function(e,t){void 0===t&&(t=!1),this.throwIfClosed(),e&&this.reset(),t&&this.dropPipes(),this.onOpened&&this.onOpened()},e.prototype.resetLoadingFlag=function(){this._isLoadingFired=!1},e.prototype.write=function(e,t,n){this.throwIfClosed(),this.fireLoading(),this.onProgress&&this.onProgress(e,t,n);var r=e&&e.byteLength||0;if(n&&!this._payloadCap&&(this._payloadCap=n),e&&(this._payload=r===this._payloadCap?e:o.Buffer.concat(this._payload||o.Buffer.empty,e)),this._pipe.write(e,t,n),this.payloadSize===this.payloadCap){this.onClosed&&this.onClosed(this.payload,this._payloadHeaders);try{this.awaitGroupLoaded.resolveAll()}catch(e){this._logger.errorIf(s.Environment.isDevelopment,"this.awaitGroupLoaded.resolveAll",e)}this._close=null,this.unbindEvents()}},e.prototype.writeHeaders=function(e){this.throwIfClosed(),this._payloadHeaders=c.Runtime.extend(this._payloadHeaders,e),this._pipe.writeHeaders(e)},e.prototype.error=function(e){this.onError&&this.onError(e),this._pipe.error(e),this.awaitGroupLoading.rejectAll(e),this.awaitGroupLoaded.rejectAll(e)},e.prototype.pipe=function(e,t,n){this.throwIfClosed(),this._pipe.attach(e,t,n)},e.prototype.close=function(e){void 0===e&&(e=!1),this.throwIfClosed(e),this.setIsClosed(),this._close&&this._close(),this.unbindEvents();var t=new i.OperationAbortException("DataStream is closed");this.awaitGroupLoading.rejectAll(t),this.awaitGroupLoaded.rejectAll(t)},e.prototype.reset=function(){this._isLoadingFired=!1,this._payload=o.Buffer.empty,this._payloadCap=0,this._payloadHeaders={}},e.prototype.setIsClosed=function(){this._isClosed=!0},e.prototype.throwIfClosed=function(e){if(void 0===e&&(e=!1),this._isClosed&&!e)throw new r.Exception("Stream already closed")},e.prototype.fireLoading=function(){if(!this._isLoadingFired){this._isLoadingFired=!0,this.onLoading&&this.onLoading();try{this.awaitGroupLoading.resolveAll()}catch(e){this._logger.errorIf(s.Environment.isDevelopment,"this.awaitGroupLoading.resolveAll",e)}}},e.prototype.unbindEvents=function(){this.onOpened=void 0,this.onLoading=void 0,this.onProgress=void 0,this.onError=void 0,this.onClosed=void 0},e.prototype.dropPipes=function(){this._logger.debugIf(s.Environment.isDevelopment,"dropPipes"),this._pipe.dropPipes()},e}();t.DataStream=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(4),o=n(3),s=n(2),a=n(7),u=function(){function e(e){if(this.source=e,this.streams=[],!e)throw new r.ArgumentNullException("source")}return e.prototype.attach=function(e,t,n){this.streams.push(new c(this.source,e,t,n))},e.prototype.write=function(e,t,n){for(var r=0;r<this.streams.length;r++)this.streams[r].write(e,t,n)},e.prototype.writeHeaders=function(e){for(var t=0;t<this.streams.length;t++)this.streams[t].writeHeaders(e)},e.prototype.error=function(e){for(var t=0;t<this.streams.length;t++)this.streams[t].error(e)},e.prototype.dropPipes=function(){for(var e=0;e<this.streams.length;e++)this.streams[e]&&this.streams[e].dispose();this.streams=[]},e}();t.Pipe=u;var c=function(){function e(e,t,n,r){void 0===n&&(n=0),void 0===r&&(r=-1);var i=this;this.source=e,this.dest=t,this.rangeStart=n,this.rangeEnd=r,this.offset=0,this.writeHeaders=function(e){return i.dest.writeHeaders(e)},this.error=function(e){return i.dest.error(e)},this.populate()}return e.prototype.write=function(e,t,n){if(e.byteLength&&n){var r=Math.max(this.offset,this.rangeStart),i=-1!==this.rangeEnd?this.rangeEnd:void 0,a=i&&r>i?null:this.source.payload&&this.source.payload.slice(r,i)||null;a&&a.byteLength>0&&(this.offset+=a.byteLength,this.dest.write(a,a.byteLength,-1!==this.rangeEnd?this.rangeEnd-this.rangeStart:this.source.payloadCap-this.rangeStart))}else s.Logger.warnIf(o.Environment.isDevelopment,"empty progress result",e,t,n)},e.prototype.dispose=function(){this.source=null,this.dest=null,this.rangeStart=null,this.rangeEnd=null,this.writeHeaders=a.Runtime.noop,this.error=a.Runtime.noop,this.write=a.Runtime.noop,i.Destructor.destroyObject(this)},e.prototype.populate=function(){var e=this.source.payload;if(e&&e.byteLength>0){var t=this.rangeStart,n=-1!==this.rangeEnd?Math.min(this.rangeEnd,e.byteLength):e.byteLength;this.dest.write(e.slice(t,n),n-t,-1!==this.rangeEnd?this.rangeEnd-this.rangeStart:this.source.payloadCap-this.rangeStart),this.offset+=e.byteLength}},e}()},function(e,t,n){var r;r=function(e){e.version="1.2.0";var t=function(){for(var e=0,t=new Array(256),n=0;256!=n;++n)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=n)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1,t[n]=e;return"undefined"!=typeof Int32Array?new Int32Array(t):t}();e.table=t,e.bstr=function(e,n){for(var r=-1^n,i=e.length-1,o=0;o<i;)r=(r=r>>>8^t[255&(r^e.charCodeAt(o++))])>>>8^t[255&(r^e.charCodeAt(o++))];return o===i&&(r=r>>>8^t[255&(r^e.charCodeAt(o))]),-1^r},e.buf=function(e,n){if(e.length>1e4)return function(e,n){for(var r=-1^n,i=e.length-7,o=0;o<i;)r=(r=(r=(r=(r=(r=(r=(r=r>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])];for(;o<i+7;)r=r>>>8^t[255&(r^e[o++])];return-1^r}(e,n);for(var r=-1^n,i=e.length-3,o=0;o<i;)r=(r=(r=(r=r>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])])>>>8^t[255&(r^e[o++])];for(;o<i+3;)r=r>>>8^t[255&(r^e[o++])];return-1^r},e.str=function(e,n){for(var r,i,o=-1^n,s=0,a=e.length;s<a;)(r=e.charCodeAt(s++))<128?o=o>>>8^t[255&(o^r)]:r<2048?o=(o=o>>>8^t[255&(o^(192|r>>6&31))])>>>8^t[255&(o^(128|63&r))]:r>=55296&&r<57344?(r=64+(1023&r),i=1023&e.charCodeAt(s++),o=(o=(o=(o=o>>>8^t[255&(o^(240|r>>8&7))])>>>8^t[255&(o^(128|r>>2&63))])>>>8^t[255&(o^(128|i>>6&15|(3&r)<<4))])>>>8^t[255&(o^(128|63&i))]):o=(o=(o=o>>>8^t[255&(o^(224|r>>12&15))])>>>8^t[255&(o^(128|r>>6&63))])>>>8^t[255&(o^(128|63&r))];return-1^o}},"undefined"==typeof DO_NOT_EXPORT_CRC?r(t):r({})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t){var n=e.call(this)||this;if(n._blacklist=t,!t)throw new i.ArgumentNullException("blacklist");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._blacklist.isBlocked()?(e.flags.setIsSelfBlocking(),[2]):[2]}))}))},t}(n(6).TaskHandler);t.BlacklistHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(13),a=n(2),u=n(10),c=n(9),l=function(e){function t(t,n,r,i,s){var a=e.call(this)||this;if(a._pdn=t,a._config=n,a._holder=r,a._scoring=i,a._issTrigger=s,!t)throw new o.ArgumentNullException("pdn");if(!n)throw new o.ArgumentNullException("config");if(!r)throw new o.ArgumentNullException("holder");if(!i)throw new o.ArgumentNullException("scoring");if(!s)throw new o.ArgumentNullException("issTrigger");return a}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,l,h,d,f=this;return r.__generator(this,(function(p){switch(p.label){case 0:return t=e.request.type,n=this.getTTL(),o=!0,s.Bitmask.check(this._config.availablePdnDownloadType,t)?[4,e.getDataLoadingAwaiter()]:[2];case 1:switch(p.sent(),l=s.Bitmask.check(this._config.sourceHaveFirstByte,i.SourceHaveFirstByte.CDN_FIRST_BYTE),h=s.Bitmask.check(this._config.sourceHaveFirstByte,i.SourceHaveFirstByte.PDN_FIRST_BYTE),d=s.Bitmask.check(this._config.sourceHaveFirstByte,i.SourceHaveFirstByte.NDR_FIRST_BYTE),e.downloadSourceId){case u.DataSourceId.CDN:o=!l;break;case u.DataSourceId.PDN:o=!h;break;case u.DataSourceId.NDR:o=!d}return o?[4,e.getDataLoadedAwaiter()]:[3,3];case 2:p.sent(),p.label=3;case 3:return r.__awaiter(f,void 0,void 0,(function(){var i,s,u,l,h;return r.__generator(this,(function(r){switch(r.label){case 0:return i=e.stream.payloadCap,a.PIPE_LOG(e.id+" BroadcastHaveHandler, is full loaded="+o+" source="+e.downloadSourceId,{source:e.downloadSourceId,loadedSize:e.stream.payloadSize,totalSize:i,segmentType:t,segmentTTL:n}),e.request.type!==c.SegmentType.Audio&&e.request.type!==c.SegmentType.Caption?[3,2]:[4,this._pdn.broadcastHave(e.id,n,t,i)];case 1:return r.sent(),[3,4];case 2:return s=this._scoring.value,u=this._holder.value,l=this._holder.edge,h=this._issTrigger.value,[4,this._pdn.broadcastHTS(e.id,n/1e3|0,t,u,s,h,l,i)];case 3:r.sent(),r.label=4;case 4:return[2]}}))})),[2]}}))}))},t.prototype.getTTL=function(){return this._config.segmentTTL-this._config.segmentTtlDecrement},t}(n(6).TaskHandler);t.BroadcastHaveHandler=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(70),s=n(2),a=n(10),u=function(e){function t(t,n){var r=e.call(this)||this;if(r.hashStorage=t,r.config=n,r.logger=new s.Logger("BroadcastSegmentHashHandler"),!t)throw new i.ArgumentNullException("pdn");if(!n)throw new i.ArgumentNullException("pdn");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(n){return e.response?(r.__awaiter(t,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return e.response?e.responseSource!==a.DataSourceId.CDN?(this.logger.info("skip broadcast for non CDN",e.id),[2]):(t=o.Crc32.generate(e.response))?[4,this.hashStorage.broadcastHash(e.id,t,this.config.segmentHashTtl)]:[3,2]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))})),[2]):(this.logger.info("ctx.response not exist",e.id),[2])}))}))},t}(n(6).TaskHandler);t.BroadcastSegmentHashHandler=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t){var n=e.call(this)||this;if(n._buff=t,!t)throw new i.ArgumentNullException("buff");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._buff.inBufferingMode&&e.flags.setIsBufferingMode(),this._buff.hasExternalBufferingMark?(e.flags.setIsBuffering(),this._buff.reset(),[2]):[2]}))}))},t}(n(6).TaskHandler);t.BufferingHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.flags.isDownloadTimeout&&(t=this._meta.getByUUId(e.targetId||""))?(t.downloadTimeout+=1,[2]):[2]}))}))},t}(n(185).IncrementDownloadTimeoutHandler);t.CycleIncrementDownloadTimeoutH=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t){var n=e.call(this)||this;if(n._meta=t,!t)throw new i.ArgumentNullException("meta");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.flags.isDownloadTimeout&&(t=this._meta.getByUUId(e.worstPeer||""))?(t.downloadTimeout+=1,[2]):[2]}))}))},t}(n(6).TaskHandler);t.IncrementDownloadTimeoutHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=n(7),s=function(e){function t(){var t=e.call(this)||this;return t.logger=new i.Logger("CycleDecrementTry"),t}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.globalCycleCountdown--,this.logger.trace("ctx.id = "+e.id+" END CYCLE, globalCycleCountDown",e.globalCycleCountdown,"cycleCountdown",e.cycleCountdown),o.Runtime.isNull(e.targetId)?(this.logger.trace("DROP cycleCountdown on step "+e.tryPdnCount+" because ctx.targetId = "+e.targetId),e.cycleCountdown=0,[2]):e.currentDownloadZeroByteError?(this.logger.trace("ctx.id = "+e.id+" currentDownloadZeroByteError",e.currentDownloadZeroByteError,"return without cycle decrement"),e.currentDownloadZeroByteError=!1,[2]):(e.cycleCountdown--,[2])}))}))},t}(n(6).TaskHandler);t.CycleDecrementTry=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=function(e){function t(){var t=e.call(this)||this;return t.logger=new o.Logger("CycleEndHandler"),t}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){this.logger.info("Cycle FINISH"),o.PIPE_LOG(e.id+" CycleEndHandler :: step "+e.tryPdnCount+" FINISH");try{e.awaitPdnTryFinish.resolveAll()}catch(e){this.logger.errorIf(i.Environment.isDevelopment,"ctx.awaitPdnTryFinish.resolveAll",e)}return[2]}))}))},t}(n(6).TaskHandler);t.CycleEndHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.currentDownloadZeroByteError&&(t=this._meta.getByUUId(e.targetId||""))?(t.pdnZeroByteDownload+=1,[2]):[2]}))}))},t}(n(189).IncrementDownloadZBEHandler);t.CycleIncrementDownloadZBEH=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t){var n=e.call(this)||this;if(n._meta=t,!t)throw new i.ArgumentNullException("meta");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.flags.isPdnDownloadZeroByteError&&(t=this._meta.getByUUId(e.targetId||""))?(t.pdnZeroByteDownload+=1,[2]):[2]}))}))},t}(n(6).TaskHandler);t.IncrementDownloadZBEHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=n(10),s=n(9),a=function(e){function t(t,n,r){var o=e.call(this)||this;return o._haves=t,o._session=n,o._config=r,o.logger=new i.Logger("DWTHT"),o}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,a;return r.__generator(this,(function(r){return e.downloadSourceId===o.DataSourceId.PDN||e.request.type===s.SegmentType.Audio||e.request.type===s.SegmentType.Caption||(t=this._haves.getCountBySegmentId(e.id),!e.flags.isSeedMode||t<1||(n=e.timings.req_start,i=this._haves.getFirstSeenTime(e.id),a=i.rdiff(n),this.logger.trace(e.id+" haves on stop = "+t+", timeToFirstHave = "+a+", trigger = "+this._session.waitToHaveOnNextDownload+", seed = "+e.flags.isSeedMode),a>this._config.rtcWaitTimeout||(this._session.waitToHaveOnNextDownload=!0,this.logger.trace(e.id+" set wait to have = true for the next download")))),[2]}))}))},t}(n(6).TaskHandler);t.DownloadWaitToHaveTriggerHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(5),s=n(9),a=function(e){function t(t){var n=e.call(this)||this;if(n._esd=t,n.lastSegmentRequest=null,!t)throw new i.ArgumentNullException("_esd");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.request.type===s.SegmentType.Audio||e.request.type===s.SegmentType.Caption?[2]:this.lastSegmentRequest?(this._esd.update(o.TimeSpan.now.rdiff(this.lastSegmentRequest)),this.lastSegmentRequest=o.TimeSpan.now,[2]):(this.lastSegmentRequest=o.TimeSpan.now,[2])}))}))},t}(n(6).TaskHandler);t.ESDHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._haves=t,r._densityHolder=n,!t)throw new i.ArgumentNullException("haves");if(!n)throw new i.ArgumentNullException("densityHolder");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return t=this._haves.getCountBySegmentId(e.id),this._densityHolder.update(t),[2]}))}))},t}(n(6).TaskHandler);t.HaveDensityHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(3),s=function(e){function t(t){var n=e.call(this)||this;if(n._haves=t,!t)throw new i.ArgumentNullException("haves");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return t=this._haves.getCountBySegmentId(e.id),this._logger.debugIf(o.Environment.isDevelopment,e.id,"HavesOnStart: ",t),e.haveCountOnRequest=t,[2]}))}))},t}(n(6).TaskHandler);t.HavesOnStartHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(5),a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._logger=new o.Logger("download-pipe"),t}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return t=s.TimeSpan.now,[4,e.next()];case 1:return n.sent(),e.error?this._logger.errorIf(i.Environment.isDevelopment,"error  "+e.id+": "+e.request.url+" | "+t.diff()+" ms",e.error):this._logger.info("handle "+e.id+": "+e.request.url+" | "+t.diff()+" ms"),[2]}}))}))},t}(n(6).TaskHandler);t.LogHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=function(e){function t(t,n,r,i,o,s){return e.call(this,t,n,r,i,o,s)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,s,a=this;return r.__generator(this,(function(u){switch(u.label){case 0:i.PIPE_LOG(e.id+" MultiSendStatHandler",e.flags),t=this.createSegments(e),i.PIPE_LOG(e.id+" MultiSendStatHandler","segments",t),n=function(n){var i,s,u;return r.__generator(this,(function(c){switch(c.label){case 0:return i=t[n],s=[],o.willSkip(e,i)?o._metrics.register("SRV_STAT_SKIPPED"):(o._aggr.append(i),o._metrics.register("SRV_STAT_HANDLE"),s=o._aggr.flush()),o._stat.download(i),[4,Promise.all(s.map((function(e){return a._metrics.register("SRV_STAT_SEND"),a._backend.stat(e)})))];case 1:return c.sent(),u=JSON.parse(JSON.stringify(s)),r.__awaiter(a,void 0,void 0,(function(){var e=this;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,Promise.all(u.map((function(t){return t.result.size=1,t.result.skippedPdnSize=0,t.timings.tthave=0,t.timings.ttsent=0,t.timings.ttfb=0,t.timings.ttlb=0,t.timings.ttfinish=0,t.result.flags=0,e.repeat(t,e._config.statMultiplier)})))];case 1:return t.sent(),[2]}}))})),[2]}}))},o=this,s=0,u.label=1;case 1:return s<t.length?[5,n(s)]:[3,4];case 2:u.sent(),u.label=3;case 3:return s++,[3,1];case 4:return[2]}}))}))},t.prototype.repeat=function(e,t){return void 0===t&&(t=0),r.__awaiter(this,void 0,void 0,(function(){var n=this;return r.__generator(this,(function(i){return 0===t||setTimeout((function(){return r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this._backend.stat(e)];case 1:return n.sent(),[4,this.repeat(e,t-1)];case 2:return n.sent(),[2]}}))}))}),this._config.statMultiplierTimeout),[2]}))}))},t}(n(196).SendStatHandler);t.MultiSendStatHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(13),a=n(3),u=n(2),c=n(10),l=n(9),h=function(e){function t(t,n,r,i,s,a){var u=e.call(this)||this;if(u._backend=t,u._config=n,u._metrics=r,u._stat=i,u._aggr=s,u._factory=a,!t)throw new o.ArgumentNullException("backend");if(!n)throw new o.ArgumentNullException("config");if(!r)throw new o.ArgumentNullException("metrics");if(!i)throw new o.ArgumentNullException("stats");if(!s)throw new o.ArgumentNullException("aggregator");if(!a)throw new o.ArgumentNullException("factory");return u}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o=this;return r.__generator(this,(function(r){switch(r.label){case 0:t=this.createSegments(e),u.PIPE_LOG(e.id+" SendStatHandler","segments",t),n=0,r.label=1;case 1:return n<t.length?(i=t[n],this.willSkip(e,i)?this._metrics.register("SRV_STAT_SKIPPED"):(this._aggr.append(i),this._metrics.register("SRV_STAT_HANDLE")),this._stat.download(i),[4,Promise.all(this._aggr.flush().map((function(e){return o._metrics.register("SRV_STAT_SEND"),o._backend.stat(e)})))]):[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},t.prototype.createSegments=function(e){var t=[],n=this._factory.create(e);t.push(n);var i=function(e,t){return t.result.range?""+e+t.result.range.split("-")[0]+"-":e};return n.result.sourceId===c.DataSourceId.PDN?(n.result.range=e.prevOffset+"-",n.result.skippedPdnSize=e.tryPdnCount,n.result.range=r.__spread(e.segmentAttempts,[n]).reduce(i,""),n.timings=e.segmentAttempts.reduce((function(e,t){return{tthave:e.tthave+t.timings.tthave,ttsent:Math.abs(e.ttsent+t.timings.ttsent),ttfb:Math.abs(e.ttfb+t.timings.ttfb),ttlb:e.ttlb+t.timings.ttlb,ttfinish:e.ttfinish+t.timings.ttfinish,req_start:e.req_start}}),n.timings),n.timings.ttlb-n.timings.ttfb>this._config.rtcDownloadTimeout&&e.tryPdnCount>1&&(n.timings.ttfb=n.timings.ttlb-this._config.rtcDownloadTimeout)):n.result.range=e.segmentAttempts.reduce(i,""),a.Environment.isDevelopment&&(e.debug({range:n.result.range}),n.result.range=e.debugString),t},t.prototype.willSkip=function(e,t){var n=new s.Bitmask(this._config.availableStatTypes),r=t.result.sourceId===c.DataSourceId.CDN,o=t.result.sourceId===c.DataSourceId.PDN,a=e.flags.isSelfBlocking,u=e.flags.isNoWebRtc,h=e.request.type===l.SegmentType.Audio,d=e.request.type===l.SegmentType.Caption;return o&&!n.has(i.AvailableStatTypes.PDN)||a&&!n.has(i.AvailableStatTypes.Blacklist)||u&&!n.has(i.AvailableStatTypes.NoWebRTC)||r&&!n.has(i.AvailableStatTypes.CDN)||h&&!n.has(i.AvailableStatTypes.Audio)||d&&!n.has(i.AvailableStatTypes.Caption)},t}(n(6).TaskHandler);t.SendStatHandler=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(52),o=n(23),s=n(56),a=n(12),u=n(2),c=n(5),l=n(36),h=n(10),d=function(e){function t(t,n,r,i,o,s,a,c,l,h,d){var f=e.call(this,t,n,r,i,o,s,h,l,d,a)||this;return f._meta=a,f.session=c,f.config=h,f.haveStorage=d,f.logger=new u.Logger("NodrCyclePdnDownloadHandler"),f}return r.__extends(t,e),t.prototype.handle=function(t){return r.__awaiter(this,void 0,void 0,(function(){var n,o,a,d,f,p,_,g,m,y,v=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(!t.targetId||!this.canDownloadSegment(t))return[2];if(t.flags.isPipeOverflow)return[2];if(t.flags.unset(l.SegmentFlags.DownloadTimeout),!(n=this._meta.getByUUId(t.targetId))||"nodr"!==n.type)return[2,e.prototype.handle.call(this,t)];if(a=!1,!n.nodrUrlAvailable)return[2,e.prototype.handle.call(this,t)];if((d=new URL(n.nodrUrl)).searchParams.set("pid",this.session.connectionId),d.searchParams.set("stream",this.session.tokenStreamId),d.searchParams.set("s",t.id),d.searchParams.set("url",s.Base64.encode(t.request.url,!0)),d.searchParams.set("ty",t.request.type+""),o=d.toString(),a=!0,!o)return[2,e.prototype.handle.call(this,t)];t.downloadSourceId=h.DataSourceId.NDR,t.flags.setIsHttpNodrDownload(),f=this.createRequest(t,o+""),r.label=1;case 1:return r.trys.push([1,3,4,5]),t.nodrTry=!0,[4,f.send()];case 2:return p=r.sent(),_=p.headers,t.id&&!t.streamingMode&&(g=p.arrayBuffer(),u.PIPE_LOG(t.id+" NodrCyclePdnDownloadHandler","headers",_,"body",g),m=g&&g.byteLength||0,t.stream.write(g,m,m)),t.isPdnDataFinished=!0,[3,5];case 3:switch(y=r.sent(),u.PIPE_LOG(t.id+" NodrCyclePdnDownloadHandler","error",y),!0){case y instanceof i.HttpException&&302===y.code:break;case y instanceof i.HttpTimeoutException:t.flags.set(l.SegmentFlags.DownloadTimeout);break;case y instanceof i.HttpException&&301===y.code:n.nodrUrlAvailable=!1;break;default:n.nodrUrlAvailable=!1,t.stream.error&&t.stream.error(y)}return v.backend.error(c.TimeSpan.now,{type:"nodrDownloadError NodrCyclePdnDownloadHandler",fromNodrUrl:a,segmentId:t.id,nodrUrl:n.nodrUrl,segmentUrl:o}),[3,5];case 4:return t.stream&&t.stream.setAbortHandler&&t.stream.setAbortHandler(null),f.dispose(),[7];case 5:return[2]}}))}))},t.prototype.createRequest=function(e,t,n){void 0===n&&(n=!0),u.PIPE_LOG(e.id+" NodrCyclePdnDownloadHandler");var r={method:"GET",url:t,binary:!0,streaming:e.streamingMode};if(r.timeout=c.TimeSpan.fromMilliseconds(this._timeout.getDownloadTimeout()),!(n=!(e.stream.payloadSize&&this.config.nodrByteRange)&&n)){var i=new URL(t);i.searchParams.set("range",e.stream.payloadSize.toString(10)),r.url=i.toString()}var s=new o.HttpRequest(r),l=e.stream;return s.onProgress=function(t,n,r){return l.write(e.streamingMode&&t||a.Buffer.empty,n,r)},s.onHeaders=function(e){return l.writeHeaders(e)},l.setAbortHandler((function(){return s.abort()})),l.sourceId=h.DataSourceId.PDN,l.open(n,e.tryPdnCount>0),s},t}(n(198).CyclePdnDownloadHandler);t.NodrCyclePdnDownloadHandler=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(54),o=n(43),s=n(99),a=n(20),u=n(199),c=n(3),l=n(2),h=n(7),d=n(8),f=n(5),p=n(36),_=n(10),g=n(9),m=function(e){function t(t,n,r,i,o,s,a,u,c,h){var d=e.call(this)||this;return d._timeout=t,d._metrics=n,d._pdn=r,d._factory=i,d._strategy=o,d._hashStorage=s,d._config=a,d.backend=u,d._haves=c,d._meta=h,d.logger=new l.Logger("CyclePdnDownloadHandler"),d}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,u,c,h,f,m,y,v=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(t=e.id,!e.targetId||!this.canDownloadSegment(e))return[2];if((n=this._haves.getCountBySegmentId(e.id))<this._config.haveWaitCount&&(e.segmentType===g.SegmentType.Video||e.segmentType===g.SegmentType.Unknown))return l.PIPE_LOG(e.id+" Not enough haves to start p2p dw "+n+":"+this._config.haveWaitCount),[2];if(e.flags.isPipeOverflow)return[2];e.flags.unset(p.SegmentFlags.DownloadTimeout),e.downloadSourceId=_.DataSourceId.PDN,u=this.prepareRequest(e),c=this._timeout.getSoftTimeout(),h=new d.Timer((function(){return v.handleSoftDownloadTimeout(e,u,c)}),c,!1),e.tryPdnCount>1&&e.flags.setIsPdnPartialDownload(),c<u.timeout.value&&h.start(),f=u.id,r.label=1;case 1:return r.trys.push([1,3,4,5]),e.stream.resetLoadingFlag(),[4,u.send()];case 2:return m=r.sent(),l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"headers",m.headers),m.body&&m.body.byteLength?(h.dispose(),"streaming"===m.headers[a.HttpHeaders.TransferMode]?(e.flags.setIsDownloadStreamingMode(),this.logger.debug("finish loading from PDN with streaming mode",e.id,e.targetId,"step :: "+e.tryPdnCount)):l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"not streaming headers","headers",m.headers,"body"),e.isPdnDataFinished=!0):this.handleZeroByteAttempt(e),[3,5];case 3:return y=r.sent(),l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"messageId",f,"error",y),y instanceof i.OperationAbortException?(this._metrics.register("DOWNLOAD_PDN_ABORT"),this.handleBadDownloadAttempt(e,c,t)):y instanceof o.OperationTimeoutException?(this._metrics.register("DOWNLOAD_PDN_TIMEOUT"),this.handleBadDownloadAttempt(e,e.downloadTimeout,t)):(y instanceof s.PipeOverflowException&&(e.flags.setIsPipeOverflow(),l.PIPE_LOG(e.id+" CyclePdnDownloadHandler","PipeOverflowException","step "+e.tryPdnCount,"error",y)),this._metrics.register("DOWNLOAD_ERROR")),[3,5];case 4:return e.stream&&e.stream.setAbortHandler&&e.stream.setAbortHandler(null),u.onHeaders=void 0,u.onProgress=void 0,h.dispose(),[7];case 5:return[2]}}))}))},t.prototype.canDownloadSegment=function(e){var t=h.Runtime.clone(e.request);return t.bufferSize=f.TimeSpan.fromMilliseconds(t.bufferSize).sub(f.TimeSpan.fromMilliseconds(e.spentTime)).value,l.PIPE_LOG(e.id+" canDownloadSegment ",t,"isGoodBuffer",this._strategy.isGoodBuffer(t),"isCanDownloadSegment",this._strategy.isCanDownloadSegment(t)),e.tryPdnCount>0&&!this._strategy.isGoodBuffer(t)?(e.flags.setIsMinBufferBound(),!1):this._strategy.isCanDownloadSegment(t)},t.prototype.prepareRequest=function(e){var t=this;e.tryPdnCount++;var n=this._timeout.getDownloadTimeout();e.downloadTimeout=n;var i,o=this._haves.getSegmentSize(e.id);if(e.request.type!==g.SegmentType.Video&&e.request.type!==g.SegmentType.Unknown||l.PIPE_LOG("RACELOG "+e.id+" "+o+" ","hos="+e.haveCountOnRequest+", targetId="+e.targetId,"extraTarget="+e.extraTargetId.length+" maxRace="+this._config.raceRequestMaxPower),this.isRaceAllowed(o,n)&&e.extraTargetId.length>0&&this._config.raceRequestMaxPower>1){e.flags.setRaceRequest();var s=r.__spread([e.targetId],e.extraTargetId),c=Math.min(this._config.raceRequestMaxPower,s.length);i=new u.RaceRequest(s,e.id,o,this._pdn,this._config,e,this._meta,f.TimeSpan.fromMilliseconds(n),c),l.PIPE_LOG(e.id+" CyclePdnDownloadHandler new RaceRequest with "+s.length+" peers created")}else(i=this._pdn.downloadSegment(e.targetId,e.id,0,1)).timeout=f.TimeSpan.fromMilliseconds(n);var h=e.stream,d=e.generateRangeOffset();return i.onHeaders=function(n){if(n.segmentHash&&(t._hashStorage.addHash(e.id,n.segmentHash),t._hashStorage.bindConnectionToHash(n.segmentHash,i.connectionId)),d>0&&!n[a.HttpHeaders.ContentRange])return l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount+" bad headers data",n),i.onProgress=void 0,void i.abort();l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"onHeaders",n),"streaming"===n.transferMode&&(e.streamFromPdn=!0),t.logger.debugIf("streaming"===n.transferMode,"start loading from PDN with streaming mode",e.id,e.targetId),h.writeHeaders(n)},l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"range offset",d),d>0&&(e.rangeOffset=d,i.headers[a.HttpHeaders.Range]="bytes="+d+"-"),i.onProgress=function(n,o,s){var a=e.getHashChain(n.chunkCount),u=a.add(n.data,n.position,n.meta),c=!0;if(u&&(c=a.isCurrentValid(),l.PIPE_LOG(e.id+" HashChain check for chunk "+u.byteLength+", "+c)),e.flags.isRaceRequest&&(e.raceRedelegationsCount=i.countRedelegations()),e.isHashchainCheckCompleted=a.isCompleted,e.isHashchainValid=c,c||(t._metrics.register("DOWNLOAD_HASHCHAIN_FAILED"),e.flags.setHashChainFail(),r.__awaiter(t,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.backend.error(f.TimeSpan.now,{type:"HashChainError",hashChain:a.trace,segmentId:e.id,targetId:e.targetId})];case 1:return t.sent(),[2]}}))}))),l.PIPE_LOG(e.id+" CyclePdnDownloadHandler :: step "+e.tryPdnCount,"onProgress","BUF",n,"loaded",o,"total",s,i.onLoad,"redelegations=",e.raceRedelegationsCount),u)return h.write(u,o,s)},h.setAbortHandler((function(){return i.abort()})),h.sourceId=_.DataSourceId.PDN,h.open(0===e.tryPdnCount),i},t.prototype.handleSoftDownloadTimeout=function(e,t,n){if(t.response&&t.response.body&&t.response.body.byteLength){var r=t.headers[a.HttpHeaders.ContentLength]||1/0;if(t.response.body.byteLength/r>n/e.downloadTimeout)return}t.abort()},t.prototype.handleBadDownloadAttempt=function(e,t,n){try{e.flags.setIsDownloadTimeout(),e.exceptConnectionList.push(e.targetId);var r=e.generateRangeOffset(),i=this._factory.create(e);e.segmentAttempts.push(i),i.result.range=e.prevOffset+"-"+(r?r-1:0),i.result.size=r,i.result.sourceId=_.DataSourceId.PDN,i.timings.ttlb=i.timings.ttsent+t,e.prevOffset=r}catch(e){this.logger.warnIf(c.Environment.isDevelopment,"["+n+"]","[HBDA]",new Date,e)}},t.prototype.handleZeroByteAttempt=function(e){this.logger.warnIf(c.Environment.isDevelopment,"handleZeroByteAttempt","["+e.id+"]","step "+e.tryPdnCount),e.flags.setIsPdnDownloadZeroByteError(),e.currentDownloadZeroByteError=!0,this._metrics.register("DOWNLOAD_ZERO_BYTE_ERROR"),e.exceptConnectionList.push(e.targetId)},t.prototype.isRaceAllowed=function(e,t){var n=this._config.p2pSpeedThreshold/1e3,r=Math.round(n*t/1e3*125e3),i=e>r;return i&&l.PIPE_LOG("isRaceAllowed seg size="+e+", threshold size="+r,"for speed="+n+" timeout="+t+" is "+i),i},t}(n(6).TaskHandler);t.CyclePdnDownloadHandler=m},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(43),o=n(3),s=n(2),a=n(22),u=n(69),c=n(7),l=n(57),h=n(5),d=n(71),f=function(e){function t(t,n,r,i,o,a,u,c,l){var h=e.call(this)||this;return h._peers=t,h._segmentId=n,h._segmentSize=r,h._pdn=i,h._config=o,h._ctx=a,h._meta=u,h._logger=new s.Logger("RaceRequest "+h._segmentId),h._requests=[],h._activeTasks=new Map,h._activeProgress=new Map,h._redelegateTasks=new Map,h._redelegateProgress=new Map,h._finishedTasks=new Map,h._resolved=!1,h._shift=1,h._maxReDelegations=0,h._reDelegateCounter=0,h._totalChunks=-1,h._forceResolve=!1,h.timeout=c,h._shift=l,h._maxReDelegations=l-1,h._initialize(),h}return r.__extends(t,e),t.prototype.abort=function(){this._requests.forEach((function(e){return e.abort()}))},t.prototype.send=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(n){return e=new u.TimeoutPromise((function(e,n){t._resolve=e,t._reject=t._wrapRejector(n)}),this.timeout),this._startLoading(),[2,e]}))}))},t.prototype.updateStat=function(e,t,n,r,i){this._totalChunks<0&&(this._totalChunks=n),(r||t<this._shift)&&this._logger.infoIf(o.Environment.isDevelopment,"Update stat for "+e+", pos="+t+", end="+r),this._activeTasks.has(e)&&this._activeProgress.set(e,{chunk:t,time:h.TimeSpan.now}),this._redelegateTasks.has(e)&&this._redelegateProgress.set(e,{chunk:t,time:h.TimeSpan.now}),r&&(this._finishedTasks.set(t,{reqId:e,time:h.TimeSpan.now}),this._logger.infoIf(o.Environment.isDevelopment,"Redelegation max="+this._maxReDelegations,"count="+this._reDelegateCounter+" config="+this._config.raceRedelegate),this._reDelegateCounter<this._maxReDelegations&&this._reDelegateTask(e)),t<this._shift&&i&&(this._forceResolve=!0)},t.prototype.countRedelegations=function(){return this._reDelegateCounter},t.prototype.createRequest=function(e,t,n,r){var i=this;void 0===r&&(r=!1);var o=this._pdn.downloadSegment(e,this._segmentId,t,n);return o.timeout=this.timeout,o.onHeaders=function(e){return i.onHeaders&&i.onHeaders(e)},o.onProgress=function(e,t,n){return i._handleProgress(o,e,t,n)},o.onLoad=function(){return i._handleLoad(o)},o.onTimeout=function(){return i._handleTimeout(o)},o.onError=function(e){return i._handleError(o,e)},this._requests.push(o),r||this._activeTasks.set(o.id,{chunk:t,time:h.TimeSpan.now}),r&&this._redelegateTasks.set(o.id,{chunk:t,time:h.TimeSpan.now}),o},t.prototype._startLoading=function(){var e=this;this._logger.infoIf(o.Environment.isDevelopment,"Try to send initial requests");for(var t=0;t<this._requests.length;t++)this._logger.infoIf(o.Environment.isDevelopment,"req"+t+" "+this._requests[t].id),this._requests[t].send().catch((function(t){return e._logger.debug("Send (init) from RaceRequest error",t)}))},t.prototype._initialize=function(){var e=this;this._logger.infoIf(o.Environment.isDevelopment,"START RaceRequest with shift="+this._shift+" on "+this._peers.length+" peers, contentLength: "+this._segmentSize);for(var t=0;t<this._shift;t++)this.createRequest(this._peers[t],t,this._shift);this._activeTasks.forEach((function(t,n){e._logger.infoIf(o.Environment.isDevelopment,"Initial tasks "+n+":"+t.chunk+":"+t.time)}))},t.prototype._handleTimeout=function(e){this.onTimeout&&this.onTimeout(),this._reject(new i.OperationTimeoutException("RaceRequest is timed out for segment["+this._segmentId+"]"))},t.prototype._handleError=function(e,t){this.onError&&this.onError(t),this._reject(t)},t.prototype._handleProgress=function(e,t,n,r){this.onProgress&&this.onProgress(t,n,r),this.updateStat(t.id,t.position,t.chunkCount,t.meta.isEndOfTransfer,t.meta.isLastPacket)},t.prototype._handleLoad=function(e){var t=this;this._logger.infoIf(o.Environment.isDevelopment,"Call onLoad "+e.id),(this._finishedTasks.size===this._shift&&!this._resolved||this._forceResolve)&&(this._finishedTasks.forEach((function(e,n){t._logger.infoIf(o.Environment.isDevelopment,"onLoad finish chunks "+n+":"+e.reqId+":"+e.time),t._redelegateTasks.has(e.reqId)&&(t._logger.infoIf(o.Environment.isDevelopment,"finished task is re-delegated"),t._ctx.flags.setResolveWithRedelegate())})),this._logger.infoIf(o.Environment.isDevelopment,"Call resolve"),this._resolved=!0,this._resolve(e.response))},t.prototype._wrapRejector=function(e){var t=this;return function(n){n instanceof i.OperationTimeoutException?t.onTimeout&&t.onTimeout():t.onError&&t.onError(n),e(n)}},t.prototype._reDelegateTask=function(e){var t=this,n="";this._requests.forEach((function(t){t.id===e&&(n=t.connectionId)})),this._logger.infoIf(o.Environment.isDevelopment,"Redelegating task to faster peer "+n+", counter="+this._reDelegateCounter),this._logger.infoIf(o.Environment.isDevelopment,"Active tasks "+this._activeTasks.size),this._activeProgress.forEach((function(e,n){t._logger.infoIf(o.Environment.isDevelopment,"Current progress "+n+":"+e.chunk+":"+e.time)})),this._activeTasks.delete(e),this._activeProgress.delete(e);var r=this._findSlowestReq(e),i=null,s=null;if(null!=r&&(this._requests.forEach((function(e){e.id===r&&(i=e.connectionId)})),s=this._activeProgress.get(r)?this._activeProgress.get(r).chunk+this._shift:this._activeTasks.get(r).chunk),this._logger.infoIf(o.Environment.isDevelopment,"Slowest req="+r+", target="+i+", sC="+s),null!=i&&null!=s){for(var a=this.createRequest(n,s,this._shift,!0),u=0;u<this._requests.length;u++)this._logger.infoIf(o.Environment.isDevelopment,"req"+u+" "+this._requests[u].id);this._logger.infoIf(o.Environment.isDevelopment,"Send additional request "+a.id+" target="+n+" sC="+s),a.send().catch((function(e){return t._logger.debug("Send (add) from RaceRequest error",e)})),this._reDelegateCounter++,this._activeTasks.delete(r),this._activeProgress.delete(r),this._requests.forEach((function(e){e.id===r&&(e.onHeaders=void 0,e.onProgress=void 0,e.onLoad=void 0,e.onTimeout=void 0,e.onError=void 0,t._logger.infoIf(o.Environment.isDevelopment,"Abort_request "+r),e.abort())}))}},t.prototype._findSlowestReq=function(e){var t=this,n=this._calculateTaskSpeed(e),r=null,i=a.MathUtils.round(.75*n,3);if(this._totalChunks>0){var s=d.P2PDataChunk.PAYLOAD_MAX_SIZE*this._totalChunks,u=a.MathUtils.round(8*s/this.timeout.toSeconds()/1024/1024,3);i=2*a.MathUtils.round(u/this._shift,3),this._logger.infoIf(o.Environment.isDevelopment,"Threshold for segment size="+s+" is "+u+" Mbps,","for each peer("+this._shift+") is "+i)}return this._activeTasks.forEach((function(e,n){var s=t._calculateTaskSpeed(n);t._logger.infoIf(o.Environment.isDevelopment,"Speed for "+n+" is "+s+", threshold speed="+i),t._updatePeerSpeed(n,s),s<i&&(r=n,i=s)})),r},t.prototype._calculateTaskSpeed=function(e){if(this._activeTasks.has(e)&&this._activeProgress.has(e)){var t=this._activeTasks.get(e).chunk,n=this._activeTasks.get(e).time,r=this._activeProgress.get(e).chunk,i=this._activeProgress.get(e).time,o=d.P2PDataChunk.PAYLOAD_MAX_SIZE*(r-t)/this._shift;return l.Speed.calc(o,i.rdiff(n))}return this._redelegateTasks.has(e)&&this._redelegateProgress.has(e)?(t=this._redelegateTasks.get(e).chunk,n=this._redelegateTasks.get(e).time,r=this._redelegateProgress.get(e).chunk,i=this._redelegateProgress.get(e).time,o=d.P2PDataChunk.PAYLOAD_MAX_SIZE*(r-t)/this._shift,l.Speed.calc(o,i.rdiff(n))):0},t.prototype._updatePeerSpeed=function(e,t){var n="";this._requests.forEach((function(t){t.id===e&&(n=t.connectionId)}));var r=this._meta.getByUUId(n);r&&(c.Runtime.isSafeNumber(t)&&t>0&&(r.lastDownloadSpeed=t),this._logger.infoIf(o.Environment.isDevelopment,"Speed updated for "+e+", "+n+", with speed="+t))},t}(n(58).P2PRequest);t.RaceRequest=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(52),o=n(23),s=n(56),a=n(12),u=n(2),c=n(7),l=n(5),h=n(36),d=n(10),f=function(e){function t(t,n,r,i,o,s,a,u){var c=e.call(this)||this;return c._timeout=t,c._metrics=n,c._pdn=r,c._strategy=i,c._meta=o,c._config=s,c.session=a,c.backend=u,c}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,a,c,d,f,p,_,g,m,y,v=this;return r.__generator(this,(function(r){switch(r.label){case 0:if(e.isPdnDataFinished||e.nodrTry||!this._config.nodrExtraCycle)return[2];if(!e.nodrTargetId||!this.canDownloadSegment(e))return[2];if(e.flags.isPipeOverflow)return[2];if(!(t=this._meta.getByUUId(e.nodrTargetId))||"nodr"!==t.type)return[2];if(o=!1,t.nodrUrlAvailable)return[3,5];a=this._pdn.getSegmentURL(e.nodrTargetId,e.id),c=void 0,a.timeout=l.TimeSpan.fromMilliseconds(this._timeout.getDownloadTimeout()),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,a.send(!0)];case 2:return c=r.sent(),[3,4];case 3:return r.sent(),[2];case 4:return n=c.headers.url||"",[3,6];case 5:(d=new URL(t.nodrUrl)).searchParams.set("pid",this.session.connectionId),d.searchParams.set("stream",this.session.tokenStreamId),d.searchParams.set("s",e.id),d.searchParams.set("url",s.Base64.encode(e.request.url,!0)),d.searchParams.set("ty",e.request.type+""),n=d.toString(),o=!0,r.label=6;case 6:if(!n)return[2];e.flags.setIsHttpNodrDownload(),f=this.createRequest(e,n+""),r.label=7;case 7:return r.trys.push([7,9,10,11]),this._metrics.register("NODR_EXTRA_CYCLE"),[4,f.send()];case 8:return p=r.sent(),_=p.headers,e.id&&!e.streamingMode&&(g=p.arrayBuffer(),u.PIPE_LOG(e.id+" NodrExtraCycleDownloadHandler","headers",_,"body",g),m=g&&g.byteLength||0,e.stream.write(g,m,m)),e.isPdnDataFinished=!0,e.downloadedThrowNodr=!0,this._metrics.register("NODR_EXTRA_CYCLE_SUCCESS"),e.targetId=e.nodrTargetId,[3,11];case 9:switch(y=r.sent(),u.PIPE_LOG(e.id+" NodrExtraCycleDownloadHandler","error",y),this._metrics.register("NODR_EXTRA_CYCLE_FAIL"),!0){case y instanceof i.HttpException&&301===y.code:t.nodrUrlAvailable=!1;break;case y instanceof i.HttpException&&302===y.code:break;case y instanceof i.HttpTimeoutException:e.flags.set(h.SegmentFlags.DownloadTimeout);break;default:t.nodrUrlAvailable=!1,e.stream.error&&e.stream.error(y)}return v.backend.error(l.TimeSpan.now,{type:"nodrDownloadError NodrExtraCycleDownloadHandler",fromNodrUrl:o,segmentId:e.id,nodrUrl:t.nodrUrl,segmentUrl:n}),[3,11];case 10:return e.stream&&e.stream.setAbortHandler&&e.stream.setAbortHandler(null),f.dispose(),[7];case 11:return[2]}}))}))},t.prototype.canDownloadSegment=function(e){var t=c.Runtime.clone(e.request);return t.bufferSize=l.TimeSpan.fromMilliseconds(t.bufferSize).sub(l.TimeSpan.fromMilliseconds(e.spentTime)).value,this._strategy.isGoodBuffer(t)?this._strategy.isCanDownloadSegment(t):(e.flags.setIsMinBufferBound(),!1)},t.prototype.createRequest=function(e,t,n){void 0===n&&(n=!0),u.PIPE_LOG(e.id+" NodrExtraCycleDownloadHandler");var r={method:"GET",url:t,binary:!0,streaming:e.streamingMode};if(r.timeout=l.TimeSpan.fromMilliseconds(this._timeout.getDownloadTimeout()),!(n=!(e.stream.payloadSize&&this._config.nodrByteRange)&&n)){var i=new URL(t);i.searchParams.set("range",e.stream.payloadSize.toString(10)),r.url=i.toString()}var s=new o.HttpRequest(r),c=e.stream;return s.onProgress=function(t,n,r){return c.write(e.streamingMode&&t||a.Buffer.empty,n,r)},s.onHeaders=function(e){return c.writeHeaders(e)},c.setAbortHandler((function(){return s.abort()})),c.sourceId=d.DataSourceId.PDN,c.open(n,e.tryPdnCount>0),s},t}(n(6).TaskHandler);t.NodrExtraCycleDownloadHandler=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.flags.setIsNoWebRtc(),[2]}))}))},t}(n(6).TaskHandler);t.NoWebRTCHandler=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._cache=t,r._strategy=n,!t)throw new i.ArgumentNullException("cache");if(!n)throw new i.ArgumentNullException("peeringStrategy");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return this._strategy.isCanUpload()?(t=e.response)?[4,this._cache.save(e.id,t,e.request.type)]:[3,2]:[2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},t}(n(6).TaskHandler);t.PutCacheHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(23),s=n(3),a=n(2),u=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._config=t,o._strategy=n,o._hahses=r,o._logger=new a.Logger("PutNodrHandler"),!n)throw new i.ArgumentNullException("peeringStrategy");return o}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,a,u;return r.__generator(this,(function(r){switch(r.label){case 0:if(!this._strategy.isCanUpload())return this._logger.debugIf(s.Environment.isDevelopment,"Peer can not upload by peeringStrategy"),[2];if(!this._config.nodrPutSegment)return this._logger.debugIf(s.Environment.isDevelopment,"Peer can not upload by nodrStrategy"),[2];if(!(t=e.response))return this._logger.debugIf(s.Environment.isDevelopment,"ctx.response is empty"),[2];if(!t||!e.nodrPutUrl)return[3,4];e.flags.setIsUpload(),this._logger.debugIf(s.Environment.isDevelopment,"Starting PUT segment to "+e.nodrPutUrl),(n=new URL(e.nodrPutUrl)).searchParams.set("h",this._hahses.getBySegmentId(e.id)),i=n.toString(),a=new o.HttpRequest({binary:!0,url:i,method:"PUT",body:t}),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,a.send()];case 2:return r.sent(),this._logger.debugIf(s.Environment.isDevelopment,"Finished PUT segment to "+i),[3,4];case 3:return u=r.sent(),this._logger.errorIf(s.Environment.isDevelopment,"Error PUT segment to "+i,u),[3,4];case 4:return[2]}}))}))},t}(n(6).TaskHandler);t.PutNodrHandler=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(7),s=n(9),a=function(e){function t(t){var n=e.call(this)||this;if(n._metrics=t,!t)throw new i.ArgumentNullException("metrics");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.request.type===s.SegmentType.Audio||e.request.type===s.SegmentType.Caption||(t=e.request.quality,o.Runtime.isDefined(this._quality)||(this._quality=t),this._quality!==t&&(this._quality=t,this._metrics.register("QUALITY_SWITCH_COUNT"),e.flags.setQualitySwitch()),this._metrics.register("CURRENT_QUALITY",this._quality,!0)),[2]}))}))},t}(n(6).TaskHandler);t.QualitySwitchHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.HISTORY_LENGTH=100,t._history=[],t._hash={},t}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return t=e.id,this._hash[t]&&e.flags.setIsRepeated(),this._history.push(t),this._hash[t]=!0,this._history.length>this.HISTORY_LENGTH&&delete this._hash[this._history.shift()],[2]}))}))},t}(n(6).TaskHandler);t.RepeatRequestHandler=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(13),a=function(e){function t(t,n){var r=e.call(this)||this;if(r._backend=t,r._configuration=n,!t)throw new o.ArgumentNullException("backend");if(!n)throw new o.ArgumentNullException("configuration");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return e.flags.isPeeringable&&new s.Bitmask(this._configuration.externalHashCheck).has(i.ExternalHashCheckMode.SERVER_LOADING)?(e.isExternalHashCheckEnabled=!0,t=e,[4,this._backend.loadExternalHash(e.request.url)]):[2];case 1:return t.externalHash=n.sent(),this._logger.info("ExternalHashHandler segId=",e.id,"externalStoredHash=",e.externalHash),[2]}}))}))},t}(n(6).TaskHandler);t.RetrieveExternalHashHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(9),o=function(e){function t(t){return e.call(this,t)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.request.type===i.SegmentType.Audio||e.request.type===i.SegmentType.Caption||this._scoring.update(e.response?e.response.byteLength:0),[2]}))}))},t}(n(208).DefaultScoringHandler);t.SegmentSizeScoringHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t){var n=e.call(this)||this;if(n._scoring=t,!t)throw new i.ArgumentNullException("scoring");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._scoring.update(e.request.quality),[2]}))}))},t}(n(6).TaskHandler);t.DefaultScoringHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(72),o=n(70),s=n(2),a=n(7),u=n(6),c=n(210),l=function(e){function t(t,n,r){var i=e.call(this)||this;return i.hashStorage=t,i.metrics=n,i.configuration=r,i.logger=new s.Logger("SegmentHashCheckerHandler"),i}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return e.isPdnDataFinished?e.isExternalHashCheckEnabled?[4,this.checkByExternalHash(e)]:[3,2]:(this.logger.info("Skip hashCheck for segment because data not loaded",e.id),[2]);case 1:return t.sent(),[3,4];case 2:return[4,this.checkByP2pHash(e)];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))},t.prototype.checkByExternalHash=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){return(t=e.externalHash)?e.response?((n=(new c).update(i.Buffer.from(e.response)).digest("hex"))===t?(e.flags.setIsHashCheckSuccess(),this.metrics.register("H_CHECK_SUCCESS"),this.logger.info("External HASHCHECK SUCCESS segId="+e.id+" size="+e.responseLength,"externalStoredHash=",t,"hashCalculated=",n)):(e.flags.setIsHashCheckFail(),e.goodPdnDownload=!1,this.metrics.register("H_CHECK_FAIL"),this.logger.info("External HASHCHECK FAIL segId="+e.id+" size="+e.responseLength,"externalStoredHash=",t,"hashCalculated=",n)),[2]):(this.logger.info("Response is empty. Force mark as bad pdn download"),e.goodPdnDownload=!1,[2]):(this.logger.info("External hash doesn't exist. Force mark as bad pdn download"),e.goodPdnDownload=!1,[2])}))}))},t.prototype.checkByP2pHash=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){return this.configuration.checkSegmentHash?(this.logger.info("Need hashCheck for segment",e.id),t=this.hashStorage.getBySegmentId(e.id),a.Runtime.isNull(t)?(this.logger.info("Hash not exist for",e.id),this.metrics.register("H_CHECK_SKIP"),[2]):(e.response?((n=o.Crc32.generate(e.response))===t?(e.flags.setIsHashCheckSuccess(),this.metrics.register("H_CHECK_SUCCESS"),this.logger.info("HASHCHECK SUCCESS "+e.id+" "+e.responseLength,"storedHash",t,"hash",n)):(e.flags.setIsHashCheckFail(),e.goodPdnDownload=!1,this.metrics.register("H_CHECK_FAIL"),this.logger.info("HASHCHECK FAIL "+e.id+" "+e.responseLength,"storedHash",t,"hash",n)),this.logger.info("flags",e.flags)):this.logger.info("ctx.response not true"),[2])):(this.logger.info("Skip hashCheck for segment by config",e.id,this.configuration.checkSegmentHash),this.metrics.register("H_CHECK_SKIP"),[2])}))}))},t}(u.TaskHandler);t.SegmentHashCheckerHandler=l},function(e,t,n){"use strict";var r=n(28),i=n(211),o=n(72).Buffer,s=new Array(16);function a(){i.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878}function u(e,t){return e<<t|e>>>32-t}function c(e,t,n,r,i,o,s){return u(e+(t&n|~t&r)+i+o|0,s)+t|0}function l(e,t,n,r,i,o,s){return u(e+(t&r|n&~r)+i+o|0,s)+t|0}function h(e,t,n,r,i,o,s){return u(e+(t^n^r)+i+o|0,s)+t|0}function d(e,t,n,r,i,o,s){return u(e+(n^(t|~r))+i+o|0,s)+t|0}r(a,i),a.prototype._update=function(){for(var e=s,t=0;t<16;++t)e[t]=this._block.readInt32LE(4*t);var n=this._a,r=this._b,i=this._c,o=this._d;r=d(r=d(r=d(r=d(r=h(r=h(r=h(r=h(r=l(r=l(r=l(r=l(r=c(r=c(r=c(r=c(r,i=c(i,o=c(o,n=c(n,r,i,o,e[0],3614090360,7),r,i,e[1],3905402710,12),n,r,e[2],606105819,17),o,n,e[3],3250441966,22),i=c(i,o=c(o,n=c(n,r,i,o,e[4],4118548399,7),r,i,e[5],1200080426,12),n,r,e[6],2821735955,17),o,n,e[7],4249261313,22),i=c(i,o=c(o,n=c(n,r,i,o,e[8],1770035416,7),r,i,e[9],2336552879,12),n,r,e[10],4294925233,17),o,n,e[11],2304563134,22),i=c(i,o=c(o,n=c(n,r,i,o,e[12],1804603682,7),r,i,e[13],4254626195,12),n,r,e[14],2792965006,17),o,n,e[15],1236535329,22),i=l(i,o=l(o,n=l(n,r,i,o,e[1],4129170786,5),r,i,e[6],3225465664,9),n,r,e[11],643717713,14),o,n,e[0],3921069994,20),i=l(i,o=l(o,n=l(n,r,i,o,e[5],3593408605,5),r,i,e[10],38016083,9),n,r,e[15],3634488961,14),o,n,e[4],3889429448,20),i=l(i,o=l(o,n=l(n,r,i,o,e[9],568446438,5),r,i,e[14],3275163606,9),n,r,e[3],4107603335,14),o,n,e[8],1163531501,20),i=l(i,o=l(o,n=l(n,r,i,o,e[13],2850285829,5),r,i,e[2],4243563512,9),n,r,e[7],1735328473,14),o,n,e[12],2368359562,20),i=h(i,o=h(o,n=h(n,r,i,o,e[5],4294588738,4),r,i,e[8],2272392833,11),n,r,e[11],1839030562,16),o,n,e[14],4259657740,23),i=h(i,o=h(o,n=h(n,r,i,o,e[1],2763975236,4),r,i,e[4],1272893353,11),n,r,e[7],4139469664,16),o,n,e[10],3200236656,23),i=h(i,o=h(o,n=h(n,r,i,o,e[13],681279174,4),r,i,e[0],3936430074,11),n,r,e[3],3572445317,16),o,n,e[6],76029189,23),i=h(i,o=h(o,n=h(n,r,i,o,e[9],3654602809,4),r,i,e[12],3873151461,11),n,r,e[15],530742520,16),o,n,e[2],3299628645,23),i=d(i,o=d(o,n=d(n,r,i,o,e[0],4096336452,6),r,i,e[7],1126891415,10),n,r,e[14],2878612391,15),o,n,e[5],4237533241,21),i=d(i,o=d(o,n=d(n,r,i,o,e[12],1700485571,6),r,i,e[3],2399980690,10),n,r,e[10],4293915773,15),o,n,e[1],2240044497,21),i=d(i,o=d(o,n=d(n,r,i,o,e[8],1873313359,6),r,i,e[15],4264355552,10),n,r,e[6],2734768916,15),o,n,e[13],1309151649,21),i=d(i,o=d(o,n=d(n,r,i,o,e[4],4149444226,6),r,i,e[11],3174756917,10),n,r,e[2],718787259,15),o,n,e[9],3951481745,21),this._a=this._a+n|0,this._b=this._b+r|0,this._c=this._c+i|0,this._d=this._d+o|0},a.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var e=o.allocUnsafe(16);return e.writeInt32LE(this._a,0),e.writeInt32LE(this._b,4),e.writeInt32LE(this._c,8),e.writeInt32LE(this._d,12),e},e.exports=a},function(e,t,n){"use strict";var r=n(212).Buffer,i=n(213).Transform;function o(e){i.call(this),this._block=r.allocUnsafe(e),this._blockSize=e,this._blockOffset=0,this._length=[0,0,0,0],this._finalized=!1}n(28)(o,i),o.prototype._transform=function(e,t,n){var r=null;try{this.update(e,t)}catch(e){r=e}n(r)},o.prototype._flush=function(e){var t=null;try{this.push(this.digest())}catch(e){t=e}e(t)},o.prototype.update=function(e,t){if(function(e,t){if(!r.isBuffer(e)&&"string"!=typeof e)throw new TypeError("Data must be a string or a buffer")}(e),this._finalized)throw new Error("Digest already called");r.isBuffer(e)||(e=r.from(e,t));for(var n=this._block,i=0;this._blockOffset+e.length-i>=this._blockSize;){for(var o=this._blockOffset;o<this._blockSize;)n[o++]=e[i++];this._update(),this._blockOffset=0}for(;i<e.length;)n[this._blockOffset++]=e[i++];for(var s=0,a=8*e.length;a>0;++s)this._length[s]+=a,(a=this._length[s]/4294967296|0)>0&&(this._length[s]-=4294967296*a);return this},o.prototype._update=function(){throw new Error("_update is not implemented")},o.prototype.digest=function(e){if(this._finalized)throw new Error("Digest already called");this._finalized=!0;var t=this._digest();void 0!==e&&(t=t.toString(e)),this._block.fill(0),this._blockOffset=0;for(var n=0;n<4;++n)this._length[n]=0;return t},o.prototype._digest=function(){throw new Error("_digest is not implemented")},e.exports=o},function(e,t,n){var r=n(27),i=r.Buffer;function o(e,t){for(var n in e)t[n]=e[n]}function s(e,t,n){return i(e,t,n)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=r:(o(r,t),t.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,n)},s.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"==typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}},function(e,t,n){(t=e.exports=n(101)).Stream=t,t.Readable=t,t.Writable=n(106),t.Duplex=n(38),t.Transform=n(108),t.PassThrough=n(220),t.finished=n(73),t.pipeline=n(221)},function(e,t){},function(e,t,n){"use strict";function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=n(27).Buffer,a=n(216).inspect,u=a&&a.custom||"inspect";e.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}var t,n;return t=e,(n=[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,n=""+t.data;t=t.next;)n+=e+t.data;return n}},{key:"concat",value:function(e){if(0===this.length)return s.alloc(0);for(var t,n,r,i=s.allocUnsafe(e>>>0),o=this.head,a=0;o;)t=o.data,n=i,r=a,s.prototype.copy.call(t,n,r),a+=o.data.length,o=o.next;return i}},{key:"consume",value:function(e,t){var n;return e<this.head.data.length?(n=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):n=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),n}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,n=1,r=t.data;for(e-=r.length;t=t.next;){var i=t.data,o=e>i.length?i.length:e;if(o===i.length?r+=i:r+=i.slice(0,e),0==(e-=o)){o===i.length?(++n,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=i.slice(o));break}++n}return this.length-=n,r}},{key:"_getBuffer",value:function(e){var t=s.allocUnsafe(e),n=this.head,r=1;for(n.data.copy(t),e-=n.data.length;n=n.next;){var i=n.data,o=e>i.length?i.length:e;if(i.copy(t,t.length-e,0,o),0==(e-=o)){o===i.length?(++r,n.next?this.head=n.next:this.head=this.tail=null):(this.head=n,n.data=i.slice(o));break}++r}return this.length-=r,t}},{key:u,value:function(e,t){return a(this,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t,{depth:0,customInspect:!1}))}}])&&o(t.prototype,n),e}()},function(e,t){},function(e,t,n){(function(t){function n(e){try{if(!t.localStorage)return!1}catch(e){return!1}var n=t.localStorage[e];return null!=n&&"true"===String(n).toLowerCase()}e.exports=function(e,t){if(n("noDeprecation"))return e;var r=!1;return function(){if(!r){if(n("throwDeprecation"))throw new Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),r=!0}return e.apply(this,arguments)}}}).call(this,n(34))},function(e,t,n){"use strict";(function(t){var r;function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=n(73),s=Symbol("lastResolve"),a=Symbol("lastReject"),u=Symbol("error"),c=Symbol("ended"),l=Symbol("lastPromise"),h=Symbol("handlePromise"),d=Symbol("stream");function f(e,t){return{value:e,done:t}}function p(e){var t=e[s];if(null!==t){var n=e[d].read();null!==n&&(e[l]=null,e[s]=null,e[a]=null,t(f(n,!1)))}}var _=Object.getPrototypeOf((function(){})),g=Object.setPrototypeOf((i(r={get stream(){return this[d]},next:function(){var e=this,n=this[u];if(null!==n)return Promise.reject(n);if(this[c])return Promise.resolve(f(void 0,!0));if(this[d].destroyed)return new Promise((function(n,r){t.nextTick((function(){e[u]?r(e[u]):n(f(void 0,!0))}))}));var r,i=this[l];if(i)r=new Promise(function(e,t){return function(n,r){e.then((function(){t[c]?n(f(void 0,!0)):t[h](n,r)}),r)}}(i,this));else{var o=this[d].read();if(null!==o)return Promise.resolve(f(o,!1));r=new Promise(this[h])}return this[l]=r,r}},Symbol.asyncIterator,(function(){return this})),i(r,"return",(function(){var e=this;return new Promise((function(t,n){e[d].destroy(null,(function(e){e?n(e):t(f(void 0,!0))}))}))})),r),_);e.exports=function(e){var n,r=Object.create(g,(i(n={},d,{value:e,writable:!0}),i(n,s,{value:null,writable:!0}),i(n,a,{value:null,writable:!0}),i(n,u,{value:null,writable:!0}),i(n,c,{value:e._readableState.endEmitted,writable:!0}),i(n,h,{value:function(e,t){var n=r[d].read();n?(r[l]=null,r[s]=null,r[a]=null,e(f(n,!1))):(r[s]=e,r[a]=t)},writable:!0}),n));return r[l]=null,o(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=r[a];return null!==t&&(r[l]=null,r[s]=null,r[a]=null,t(e)),void(r[u]=e)}var n=r[s];null!==n&&(r[l]=null,r[s]=null,r[a]=null,n(f(void 0,!0))),r[c]=!0})),e.on("readable",function(e){t.nextTick(p,e)}.bind(null,r)),r}}).call(this,n(35))},function(e,t){e.exports=function(){throw new Error("Readable.from is not available in the browser")}},function(e,t,n){"use strict";e.exports=i;var r=n(108);function i(e){if(!(this instanceof i))return new i(e);r.call(this,e)}n(28)(i,r),i.prototype._transform=function(e,t,n){n(null,e)}},function(e,t,n){"use strict";var r,i=n(37).codes,o=i.ERR_MISSING_ARGS,s=i.ERR_STREAM_DESTROYED;function a(e){if(e)throw e}function u(e){e()}function c(e,t){return e.pipe(t)}e.exports=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var l,h=function(e){return e.length?"function"!=typeof e[e.length-1]?a:e.pop():a}(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new o("streams");var d=t.map((function(e,i){var o=i<t.length-1;return function(e,t,i,o){o=function(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}(o);var a=!1;e.on("close",(function(){a=!0})),void 0===r&&(r=n(73)),r(e,{readable:t,writable:i},(function(e){if(e)return o(e);a=!0,o()}));var u=!1;return function(t){if(!a&&!u)return u=!0,function(e){return e.setHeader&&"function"==typeof e.abort}(e)?e.abort():"function"==typeof e.destroy?e.destroy():void o(t||new s("pipe"))}}(e,o,i>0,(function(e){l||(l=e),e&&d.forEach(u),o||(d.forEach(u),h(l))}))}));return t.reduce(c)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(74),s=n(3),a=n(2),u=function(e){function t(t,n,r,o,s){var u=e.call(this)||this;if(u._selector=t,u._haves=n,u._meta=r,u._timeout=o,u._config=s,u._logger=new a.Logger("CycleSelectPeerHandler"),!t)throw new i.ArgumentNullException("selector");if(!n)throw new i.ArgumentNullException("haves");if(!r)throw new i.ArgumentNullException("meta");if(!o)throw new i.ArgumentNullException("timeout");if(!s)throw new i.ArgumentNullException("config");return u}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,u,c,l,h,d=this;return r.__generator(this,(function(r){return!e.flags.isPeeringable||e.flags.isWaitHaveTimeout||e.flags.isSeedMode||(t=null,n=[],i=this._haves.getBySegmentId(e.id),u={filter:function(t){return-1===e.exceptConnectionList.indexOf(t)},timeout:this._timeout.getDownloadTimeout()},c=[],l=[],this._config.nodrLowPriority?(c=i.filter((function(e){var t=d._meta.getByUUId(e);return!(!t||"browser"!==t.type)})),l=i.filter((function(e){var t=d._meta.getByUUId(e);return!(!t||"nodr"!==t.type)})),this._logger.debugIf(s.Environment.isDevelopment,"Selecting (cycle) from browser haves "+i),null!=(h=this._selector.select(c,u))&&(t=h[0],n=h.slice(1)),t!==o.NO_GOOD_PEER_RESULT&&null!==t||(this._logger.debugIf(s.Environment.isDevelopment,"Selecting (cycle) from nodr haves "+i),h=this._selector.select(l,u),t=null!=h?h[0]:null)):(this._logger.debugIf(s.Environment.isDevelopment,"Selecting (cycle) from all haves "+i),h=this._selector.select(i,u),this._logger.debugIf(s.Environment.isDevelopment,"Selecting (cycle) "+h),null!=h&&(t=h[0],n=h.slice(1)),this._logger.debugIf(s.Environment.isDevelopment,"Selected (cycle) "+t+", "+n.length)),t===o.NO_GOOD_PEER_RESULT&&(t=null,e.flags.setIsNoGoodPeer()),null!=t&&(e.targetId=t,e.extraTargetId=n),a.PIPE_LOG(e.id+" CycleSelectPeerHandler :: step "+e.tryPdnCount+" :: new targetId "+e.targetId),this._logger.trace(e.id+": targetId="+e.targetId),e.targetId||e.flags.setIsEmptySelectorResult()),[2]}))}))},t}(n(6).TaskHandler);t.CycleSelectPeerHandler=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=function(e){function t(t,n,r){var i=e.call(this,t,n)||this;return i._logger=new o.Logger("SpeedPeerSelector"),i.SPEED_INTERVAL=.67,i.SPEED_BOUND=2,i._config=r,i}return r.__extends(t,e),t.prototype.select=function(e,t){for(var n=this,r=(t=t||{}).filter?t.filter:function(){return!0},o=0,s=[],a=0;a<e.length;a++){var u=e[a];if(this.isReady(u)&&r(u)){var c=this.meta.resolve(u);o<c.lastDownloadSpeed&&(o=c.lastDownloadSpeed),s.push(c)}}s.sort((function(e,t){return t.lastDownloadSpeed-e.lastDownloadSpeed})),this._logger.debugIf(i.Environment.isDevelopment,"Max speed from",s.length,"peers =",o,s.map((function(e){return[e.connectionId,e.lastDownloadSpeed]})));var l=s.filter((function(e,t){return e.lastDownloadSpeed>=o*n.SPEED_INTERVAL||e.lastDownloadSpeed>=n.SPEED_BOUND||t<n._config.raceRequestMaxPower}));if(l.length>0){this._logger.debugIf(i.Environment.isDevelopment,"Final filtered array contains",l.length,"peers",l.map((function(e){return[e.connectionId,e.lastDownloadSpeed]})));var h=[];for(a=0;a<l.length;a++)h.push(l[a].uuid);return h}return null},t}(n(224).SpeedPeerSelector);t.SpeedIntervalPeerSelector=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(1),s=n(13),a=function(e){function t(t,n){var r=e.call(this,t)||this;if(r.meta=n,!n)throw new o.ArgumentNullException("meta");return r}return r.__extends(t,e),t.prototype.select=function(e,t){for(var n=0,r=null,o=(t=t||{}).filter?t.filter:function(){return!0},a=0;a<e.length;a++){var u=e[a];if(this.isReady(u)&&o(u)){var c=this.meta.resolve(u);c&&s.Bitmask.check(c.mode,i.PeeringMode.Upload)&&!c.isChoked&&(c.lastDownloadSpeed===n&&0===n?r=u:c.lastDownloadSpeed>n&&(n=c.lastDownloadSpeed,r=u))}}return r?[r]:null},t}(n(225).FirstReadyPeerSelector);t.SpeedPeerSelector=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(4),o=function(){function e(e){if(this.pool=e,!e)throw new r.ArgumentNullException("pool")}return e.prototype.dispose=function(){i.Destructor.destroyObject(this)},e.prototype.select=function(e,t){for(var n=(t=t||{}).filter?t.filter:function(){return!0},r=0;r<e.length;r++)if(this.isReady(e[r])&&n(e[r]))return[e[r]];return null},e.prototype.isReady=function(e){var t=this.pool.get(e);return t&&t.ready||!1},e}();t.FirstReadyPeerSelector=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(74),o=n(2),s=function(e){function t(t,n,r,i,s){var a=e.call(this)||this;return a._selector=t,a._haves=n,a._meta=r,a._timeout=i,a._config=s,a._logger=new o.Logger("NodrSelectPeerHandler"),a}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,s,a,u=this;return r.__generator(this,(function(r){return!e.flags.isPeeringable||e.flags.isWaitHaveTimeout||e.flags.isSeedMode||e.isPdnDataFinished||!this._config.nodrExtraCycle||(n={filter:function(t){return-1===e.exceptConnectionList.indexOf(t)},timeout:this._timeout.getDownloadTimeout()},s=this._haves.getBySegmentId(e.id).filter((function(e){var t=u._meta.getByUUId(e);return!(!t||"nodr"!==t.type)})),a=this._selector.select(s,n),(t=null!=a?a[0]:null)===i.NO_GOOD_PEER_RESULT&&(t=null),null!=t&&(e.nodrTargetId=t),o.PIPE_LOG(e.id+" NodrSelectPeerHandler :: step "+e.tryPdnCount+" :: new nodrTargetId "+e.nodrTargetId),this._logger.trace(e.id+": nodrTargetId="+e.nodrTargetId)),[2]}))}))},t}(n(6).TaskHandler);t.NodrSelectPeerHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(2),s=function(e){function t(t,n,r,o,s){var a=e.call(this)||this;if(a._strategy=t,a._config=n,a._metrics=r,a._pool=o,a._wm=s,!t)throw new i.ArgumentNullException("strategy");if(!n)throw new i.ArgumentNullException("config");if(!r)throw new i.ArgumentNullException("metrics");if(!s)throw new i.ArgumentNullException("workMode");return a}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.streamingMode=this._strategy.isCanStreamingUpload(),this._strategy.isCanSafeDownload()&&e.flags.setIsSafeDownload(),!e.flags.isRepeated&&this._strategy.isCanDownloadSegment(e.request)&&this._pool&&this._pool.info.ready>0?(e.flags.setIsPeeringable(),o.PIPE_LOG(e.id+" SelectSourceHandler: is peeringable"),[2]):(this._metrics.register("DOWNLOAD_FORCE_CDN"),this._config.active||e.flags.setIsHttpNodrDownload(),e.request.bufferSize<this._config.msMinBufferSize/1e3&&e.flags.setIsMinBufferBound(),this._wm.isDownload()||e.flags.setIsDownloadOff(),(!this._pool||this._pool.info.ready<1)&&e.flags.setIsEmptyReadySwarm(),o.PIPE_LOG(e.id+" SelectSourceHandler: force CDN","flags",e.flags.value),[2])}))}))},t}(n(6).TaskHandler);t.SelectSourceHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(2),s=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._backend=t,o._session=n,o._config=r,!t)throw new i.ArgumentNullException("backend");if(!n)throw new i.ArgumentNullException("session");if(!r)throw new i.ArgumentNullException("config");return o}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return o.PIPE_LOG(e.id+" SendNodrEventHandler "+this._config.nodrStrategy+", "+this._config.nodrLowPriority+", "+this._config.nodrExtraCycle+", "+this._config.nodrProxy+", "+this._config.nodrByteRange+", "+this._config.nodrPutSegment+", "+this._config.nodrSendEvent),this._config.nodrSendEvent?(o.PIPE_LOG(e.id+" SendNodrEventHandler http dw flag: "+e.flags.isHttpNodrDownload+", http dw timeout flag: "+e.flags.isNodrDwTimeout+", http dw 301 flag: "+e.flags.isNodrRedirect301+", http dw 302 flag: "+e.flags.isNodrRedirect302),!e.flags.isHttpNodrDownload||e.flags.isNodrDwTimeout||e.flags.isNodrRedirect301||e.flags.isNodrRedirect302?[2]:(t={sender_id:e.targetId,receiver_id:this._session.connectionId,stream_id:this._session.streamId,segment_id:e.id,size:e.responseLength},o.PIPE_LOG(e.id+" SendNodrEventHandler, send to validator "+JSON.stringify(t)),[2,this._backend.sendNodrDownloadEvent(t)])):[2]}))}))},t}(n(6).TaskHandler);t.SendNodrEventHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(55),o=n(12),s=function(e){function t(){return e.call(this)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.playerRequestResolver?(e.responseLength||e.playerRequestResolver(null),e.playerRequestResolver({payload:e.response?o.Buffer.copy(e.response):null,headers:e.responseHeaders,timings:e.timings.toJSON(),sourceId:e.responseSource,tryPdnCount:e.tryPdnCount}),e.timings.register(i.RequestState.Finish),[2]):[2]}))}))},t}(n(6).TaskHandler);t.SendPlayerResponseHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(9),o=function(e){function t(t,n){var r=e.call(this)||this;return r._extractor=t,r._holder=n,r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.request.type===i.SegmentType.Audio||e.request.type===i.SegmentType.Caption||(t=this._extractor.extract(e.request.url),this._holder.registerSelf(t)),[2]}))}))},t}(n(6).TaskHandler);t.TimeslotHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(20),s=n(23),a=n(12),u=n(3),c=n(2),l=n(5),h=n(10),d=function(e){function t(t,n){var r=e.call(this)||this;if(r._analyzer=t,r._strategy=n,r.logger=new c.Logger("TryCdnDownloadHandler"),!t)throw new i.ArgumentNullException("analyzer");if(!n)throw new i.ArgumentNullException("strategy");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,s,a,l,d,f,p;return r.__generator(this,(function(r){switch(r.label){case 0:if(t=e.id,e.isPdnDataFinished&&e.goodPdnDownload&&e.isHashchainValid||e.downloadedThrowNodr){c.PIPE_LOG(t+" TryCdnDownloadHandler CDN download SKIP");try{e.awaitCdnTryFinish.resolveAll()}catch(e){this.logger.errorIf(u.Environment.isDevelopment,"ctx.awaitCdnTryFinish.resolveAll",e)}return[2]}e.downloadSourceId=h.DataSourceId.CDN,n=this._strategy.isCanDownloadPartial(),i=e.generateRangeOffset(),n&&e.flags.setIsPartialDownload(),s=this.createRequest(e,!n||i<1),n&&i>0&&(e.rangeOffset=i,s.setRequestHeader(o.HttpHeaders.Range,"bytes="+i+"-")),r.label=1;case 1:return r.trys.push([1,3,4,5]),c.PIPE_LOG(t+" TryCdnDownloadHandler req execute","isPartial",n,"offset",i),[4,s.send()];case 2:return a=r.sent(),c.PIPE_LOG(t+" TryCdnDownloadHandler req finish","isPartial",n,"offset",i),l=a.headers,this._analyzer.checkCdnHeaders(l),e.id&&!e.streamingMode&&(d=a.arrayBuffer(),c.PIPE_LOG(t+" TryCdnDownloadHandler","headers",l,"body len",d.byteLength),f=d&&d.byteLength||0,e.stream.write(d,f,f)),[3,5];case 3:return p=r.sent(),c.PIPE_LOG(t+" TryCdnDownloadHandler","error",p),e.stream&&e.stream.error&&e.stream.error(p),[3,5];case 4:try{e.awaitCdnTryFinish.resolveAll()}catch(e){this.logger.errorIf(u.Environment.isDevelopment,"ctx.awaitCdnTryFinish.resolveAll",e)}return e.stream&&e.stream.setAbortHandler&&e.stream.setAbortHandler(null),s.dispose(),[7];case 5:return[2]}}))}))},t.prototype.createRequest=function(e,t){c.PIPE_LOG(e.id+" TryCdnDownloadHandler resetStream",t);var n={method:"GET",url:e.request.url,binary:!0,streaming:e.streamingMode,headers:e.request.headers};e.request.timeout&&(n.timeout=l.TimeSpan.fromSeconds(e.request.timeout));var r=new s.HttpRequest(n),i=e.stream;return r.onProgress=function(t,n,r){return i.write(e.streamingMode&&t||a.Buffer.empty,n,r)},r.onHeaders=function(e){return i.writeHeaders(e)},i.setAbortHandler((function(){return r.abort()})),i.sourceId=h.DataSourceId.CDN,i.open(t,e.tryPdnCount>0),r},t}(n(6).TaskHandler);t.TryCdnDownloadHandler=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(52),o=n(23),s=n(56),a=n(12),u=n(3),c=n(2),l=n(5),h=n(10),d=function(e){function t(t,n,r,i,o,s,a){var u=e.call(this)||this;return u.nodrs=t,u.timeout=n,u.config=r,u.session=i,u.metrics=o,u.backend=s,u._timeout=a,u}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,a,d,f,p,_,g,m=this;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,e.awaitPdnTryFinish.acquire()];case 1:if(r.sent(),!this.config.nodrProxy||e.isPdnDataFinished)return[2];if(e.flags.isMinBufferBound){if(e.request.bufferSize<=0)return[2]}else if(!(e.flags.isSeedMode||e.flags.isEmptyReadySwarm||e.flags.isDownloadTimeout||e.flags.isWaitHaveTimeout))return[2];if(!(t=this.nodrs.getNodrPeerUrl(e)))return e.flags.setIsEmptySelectorResult(),[2];e.downloadSourceId=h.DataSourceId.NDR,(n=new URL(t)).searchParams.set("pid",this.session.connectionId),n.searchParams.set("stream",this.session.tokenStreamId),n.searchParams.set("s",e.id),n.searchParams.set("url",s.Base64.encode(e.request.url,!0)),n.searchParams.set("ty",e.request.type+""),e.flags.setIsHttpNodrDownload(),o=n.toString(),a=this.createRequest(e,o),r.label=2;case 2:return r.trys.push([2,4,5,6]),this.metrics.register("NODR_THROW_DOWNLOAD"),e.targetId=n.searchParams.get("id"),[4,a.send()];case 3:return d=r.sent(),g=d.headers,e.id&&!e.streamingMode&&(f=d.arrayBuffer(),c.PIPE_LOG(e.id+" TryNodrDownloadHandler","headers",g,"body",f),p=f&&f.byteLength||0,e.stream.write(f,p,p)),e.downloadedThrowNodr=!0,[3,6];case 4:switch(_=r.sent(),c.PIPE_LOG(e.id+" TryNodrDownloadHandler","error",_),g=_ instanceof i.HttpException&&_.res?_.res.headers:null,!0){case _ instanceof i.HttpException&&301===_.code:this._logger.infoIf(u.Environment.isDevelopment,"received nodr 301 response, disable nodr",t),e.flags.setIsNodrRedirect301(),this.nodrs.forceDisablePeer(t),g&&"CDN"===g["x-source"]&&(e.flags.setIsUpload(),e.nodrPutUrl=a.url);break;case _ instanceof i.HttpException&&302===_.code:this._logger.infoIf(u.Environment.isDevelopment,"received nodr 302 response",t),e.flags.setIsNodrRedirect302(),g&&"CDN"===g["x-source"]&&(e.flags.setIsUpload(),e.nodrPutUrl=a.url);break;case _ instanceof i.HttpTimeoutException:this._logger.infoIf(u.Environment.isDevelopment,"catch nodr download timeout",t),e.flags.setIsNodrDwTimeout();break;default:this._logger.infoIf(u.Environment.isDevelopment,"disable nodr by error",t),this.nodrs.disablePeer(t)}return m.backend.error(l.TimeSpan.now,{type:"nodrDownloadError TryNodrDownloadHandler",fromNodrUrl:!0,segmentId:e.id,nodrUrl:t,segmentUrl:o}),[3,6];case 5:return e.stream&&e.stream.setAbortHandler&&e.stream.setAbortHandler(null),a.dispose(),[7];case 6:return[2]}}))}))},t.prototype.createRequest=function(e,t,n){void 0===n&&(n=!0),c.PIPE_LOG(e.id+" TryNodrDownloadHandler");var r={method:"GET",url:t,binary:!0,streaming:e.streamingMode};if(!(n=!(e.stream.payloadSize&&this.config.nodrByteRange)&&n)){var i=new URL(t);i.searchParams.set("range",e.stream.payloadSize.toString(10)),r.url=i.toString()}r.timeout=l.TimeSpan.fromMilliseconds(this._timeout.getDownloadTimeout());var s=new o.HttpRequest(r),u=e.stream;return s.onProgress=function(t,n,r){return u.write(e.streamingMode&&t||a.Buffer.empty,n,r)},u.sourceId=h.DataSourceId.PDN,s.onHeaders=function(e){"CDN"===e["x-source"]&&(u.sourceId=h.DataSourceId.CDN),u.writeHeaders(e)},u.setAbortHandler((function(){return s.abort()})),u.open(n,e.tryPdnCount>0),s},t}(n(6).TaskHandler);t.TryNodrDownloadHandler=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(9),s=function(e){function t(t){var n=e.call(this)||this;if(n._matcher=t,!t)throw new i.ArgumentNullException("matcher");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e.request.type!==o.SegmentType.Audio&&e.request.type!==o.SegmentType.Caption&&this._matcher.registerSelf(e.id),[2]}))}))},t}(n(6).TaskHandler);t.UpdateMatchHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(10),s=function(e){function t(t){var n=e.call(this)||this;if(n._metrics=t,!t)throw new i.ArgumentNullException("metrics");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i;return r.__generator(this,(function(r){return t=e.responseSource===o.DataSourceId.CDN,n=e.responseSource===o.DataSourceId.PDN,i=e.responseSource===o.DataSourceId.NDR,this._metrics.registerIf(t,"DOWNLOAD_CDN_COUNT").registerIf(n,"DOWNLOAD_PDN_COUNT").registerIf(i,"DOWNLOAD_NDR_COUNT").registerIf(t,"DOWNLOAD_CDN_SIZE",e.responseLength).registerIf(n,"DOWNLOAD_PDN_SIZE",e.responseLength).registerIf(i,"DOWNLOAD_NDR_SIZE",e.responseLength).registerIf(t,"DOWNLOAD_CDN_TIME",e.timings.ttlb).registerIf(n,"DOWNLOAD_PDN_TIME",e.timings.ttlb).registerIf(i,"DOWNLOAD_NDR_TIME",e.timings.ttlb).registerIf(t,"DOWNLOAD_PDN_SKIPPED_SIZE",e.pdnReceivedBytes).registerIf(t&&e.pdnReceivedBytes>0,"DOWNLOAD_PDN_SKIPPED_TIME",(e.waitTimeout>0&&e.waitTimeout||0)+(e.downloadTimeout>0&&e.downloadTimeout||0)).registerIf(e.flags.isWaitHaveTimeout,"DOWNLOAD_IS_WAIT_TIMEOUT").registerIf(e.flags.isDownloadTimeout,"DOWNLOAD_PDN_GET_TIMEOUT").registerIf(e.flags.isNodrDwTimeout,"DOWNLOAD_NDR_GET_TIMEOUT").registerIf(e.flags.isRepeated,"DOWNLOAD_IS_REPEAT").registerIf(e.flags.isNoWebRtc,"DOWNLOAD_IS_NOWEBRTC").registerIf(e.flags.isSelfBlocking,"DOWNLOAD_IS_BLACKLIST").registerIf(e.flags.isBuffering,"DOWNLOAD_IS_BUFFERING").registerIf(e.flags.isHttpNodrDownload,"DOWNLOAD_IS_DEACTIVATED").registerIf(e.flags.isMinBufferBound,"DOWNLOAD_IS_MIN_BUFFER_BOUND").registerIf(e.flags.isDownloadOff,"DOWNLOAD_IS_DOWNLOAD_OFF").registerIf(e.flags.isEmptyReadySwarm,"DOWNLOAD_IS_EMPTY_SWARM").registerIf(e.flags.isEmptySelectorResult,"DOWNLOAD_IS_EMPTY_TARGET").registerIf(e.flags.isSeedMode,"DOWNLOAD_IS_SEED").registerIf(e.flags.isPeeringable,"DOWNLOAD_IS_CAN_PDN").registerIf(e.flags.isDownloadStreamingMode,"DOWNLOAD_IS_STRM").registerIf(e.flags.isUploadStreamingMode,"UPLOAD_IS_STRM").registerIf(e.flags.isPartialDownload,"DOWNLOAD_IS_PARTIAL_CDN").registerIf(e.flags.isPdnPartialDownload,"DOWNLOAD_IS_PARTIAL_PDN"),[2]}))}))},t}(n(6).TaskHandler);t.UpdateMetricsHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(7),s=n(57),a=n(10),u=n(9),c=function(e){function t(t){var n=e.call(this)||this;if(n._meta=t,!t)throw new i.ArgumentNullException("meta");return n}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){return e.responseSource!==a.DataSourceId.PDN||e.flags.isRaceRequest||e.request.type===u.SegmentType.Caption||e.request.type===u.SegmentType.Audio?[2]:(e.timeoutedSegment&&this.calcTimeoutedSegment(e.timeoutedSegment),(t=this._meta.getByUUId(e.targetId||""))?(n=s.Speed.calc(e.responseLength,e.timings.ttlb-e.timings.ttfb),o.Runtime.isSafeNumber(n)&&n>0&&(t.lastDownloadSpeed=n),this._meta.registerLastUtilityTime(e.targetId),[2]):[2])}))}))},t.prototype.calcTimeoutedSegment=function(e){if(e){var t=e.result.targetId,n=this._meta.findByConnectionId(t||"");if(n){var r=s.Speed.calc(e.result.size,e.timings.ttlb-e.timings.ttfb);o.Runtime.isSafeNumber(r)&&r>0&&(n.lastDownloadSpeed=r),this._meta.registerLastUtilityTime(t)}}},t}(n(6).TaskHandler);t.UpdatePeerSpeed=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(2),o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,Promise.all([e.awaitCdnTryFinish.acquire(),e.getDataLoadedAwaiter()])];case 1:return t.sent(),i.PIPE_LOG(e.id+" WaitFullPayloadHandler"),[2]}}))}))},t}(n(6).TaskHandler);t.WaitFullPayloadHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(55),s=n(2),a=n(9),u=function(e){function t(t,n,r,o,s){var a=e.call(this)||this;if(a._timeout=t,a._haves=n,a._joggler=r,a._config=o,a._session=s,!t)throw new i.ArgumentNullException("timeout");if(!n)throw new i.ArgumentNullException("haves");if(!r)throw new i.ArgumentNullException("joggler");return a}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,u,c;return r.__generator(this,(function(r){switch(r.label){case 0:return e.flags.isPeeringable?e.isExternalHashCheckEnabled&&!e.externalHash||e.segmentType===a.SegmentType.Caption||e.segmentType===a.SegmentType.Audio?[2]:(t=this._haves.exist(e.id),n=e.haveCountOnRequest,i=this._config.haveWaitCount,s.PIPE_LOG(e.id+" WaitHaveHandler: have exists="+t+", haves="+n+":"+i),t&&n>=i?[2]:(u=this._timeout.getWaitTimeout(e.request,e.id),e.waitTimeout=u,s.PIPE_LOG(e.id+" WaitHaveHandler: timeout="+u),0===u&&e.flags.setIsSeedMode(),u<1?[2]:(s.PIPE_LOG(e.id+" WaitHaveHandler: awaiting",u),[4,this._haves.await(e.id,u)]))):[2];case 1:return c=r.sent(),s.PIPE_LOG(e.id+" WaitHaveHandler: received="+c),c||(e.flags.setIsWaitHaveTimeout(),this._session.waitToHaveOnNextDownload=!1),e.request.type!==a.SegmentType.Caption&&e.request.type!==a.SegmentType.Audio&&(c?this._joggler.reset():this._joggler.registerHaveWaitFail()),e.timings.register(o.RequestState.ReceiveHave),[2]}}))}))},t}(n(6).TaskHandler);t.WaitHaveHandler=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(55),s=n(5),a=n(10),u=n(41),c=n(9),l=function(e){function t(t,n,r,o,s,a,u){var c=e.call(this)||this;if(c._config=t,c._conn=n,c._stat=r,c._meta=o,c._swarmStat=s,c._wm=a,c._hash=u,!t)throw new i.ArgumentNullException("config");if(!n)throw new i.ArgumentNullException("conn");if(!r)throw new i.ArgumentNullException("stat");if(!o)throw new i.ArgumentNullException("meta");if(!s)throw new i.ArgumentNullException("swarmStat");if(!a)throw new i.ArgumentNullException("workMode");if(!u)throw new i.ArgumentNullException("hash");return c}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return e.payload?(e.timings.register(o.RequestState.Finish),t=this.createStat(e),this._stat.upload(t),[2]):[2]}))}))},t.prototype.createStat=function(e){var t=this._swarmStat.getStat();return{timestamp:s.TimeSpan.value,request:{uri:e.id,url:e.id,quality:u.Quality.Other,type:c.SegmentType.Other,duration:0,bufferSize:0},result:{targetId:this._meta.resolvePublicId(e.request.connectionId),segmentId:e.request.s+","+(this._hash.getBySegmentId(e.request.s)||""),sourceId:a.DataSourceId.PDN,flags:e.flags.value,haves:-1,waitTimeout:-1,downloadTimeout:-1,size:e.payload.byteLength,swarmSize:t.ready,swarmSizeTotal:t.total,connected:this._conn.isOpened,mode:this._wm.selfPM,active:this._config.active},timings:e.timings.toJSON()}},t}(n(6).TaskHandler);t.FireStatHandler=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(12),o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return e.flags.isDownloadStreamingMode?[4,e.getDataLoadedAwaiter()]:[3,2];case 1:return t.sent(),e.payload=e.stream.payload,[2];case 2:return 500===e.status?(e.payload=i.Buffer.empty,e.stream.write(e.payload,0,0)):e.payload?e.stream.write(e.payload,e.payload.byteLength,e.payload.byteLength):(e.status=404,e.payload=i.Buffer.empty,e.stream.write(e.payload,0,0)),[2]}}))}))},t}(n(6).TaskHandler);t.FlushDataHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(20),o=n(2),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){return(t=e.request.range||"")?(n=i.HttpHeaders.parseRange(t)[0])?(e.isPartial=!0,e.rangeStart=n[0],-1!==n[1]&&(e.rangeEnd=n[1]),t&&o.PIPE_LOG(e.id+" parsed range for '"+e.request.range+"'",e.isPartial,e.rangeStart,e.rangeEnd),[2]):(e.isCanUpload=!1,[2]):[2]}))}))},t}(n(6).TaskHandler);t.RangeCheckHandler=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._cache=t,r._metrics=n,!t)throw new i.ArgumentNullException("cache");if(!n)throw new i.ArgumentNullException("metrics");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this._cache.load(e.request.s)];case 1:return(t=n.sent())&&this._metrics.register("CACHE_HITS"),t&&t.byteLength&&(e.payload=e.isPartial?t.slice(e.rangeStart,e.rangeEnd):t),[2]}}))}))},t}(n(6).TaskHandler);t.RetrieveCachedSegmentHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(13),a=n(12),u=n(2),c=n(10),l=function(e){function t(t,n,r){var i=e.call(this)||this;if(i._tasks=t,i._metrics=n,i._config=r,i._logger=new u.Logger("STRM_UPLD"),!t)throw new o.ArgumentNullException("tasks");if(!r)throw new o.ArgumentNullException("config");return i}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:if(t=e.request.s,!(n=this._tasks.getDownloadTask(t)))return this._metrics.register("CACHE_MISSES"),[2];this._metrics.register("CACHE_NOT_LOADED_YET"),u.PIPE_LOG(e.id+" RetrieveLoadingSegmentHandler","DWTask exist",n),r.label=1;case 1:return r.trys.push([1,3,,4]),u.PIPE_LOG(e.id+" RetrieveLoadingSegmentHandler","streamingMode",n.streamingMode),n.streamingMode&&this.streamSourceChecker(n)?(n.flags.setIsUploadStreamingMode(),e.flags.setIsDownloadStreamingMode(),u.PIPE_LOG(e.id+" RetrieveLoadingSegmentHandler","TaskId",n.id,"flags",n.flags),n.stream.pipe(e.stream,e.rangeStart,e.rangeEnd),this._logger.debug("pipe loading stream for UploadTask "+n.id+" ["+e.rangeStart+"-"+e.rangeEnd+"]",n,e,e.stream),[2]):(e.stream.write(a.Buffer.empty,0,0),[4,n.getDataLoadedAwaiter()]);case 2:return r.sent(),(i=n.response)&&i.byteLength&&(e.payload=e.isPartial?i.slice(e.rangeStart,e.rangeEnd):i),[3,4];case 3:return o=r.sent(),this._logger.debug("retrieveLoadingSegmentHandler error",o),e.status=500,[3,4];case 4:return[2]}}))}))},t.prototype.streamSourceChecker=function(e){return e.stream.sourceId===c.DataSourceId.PDN&&s.Bitmask.check(this._config.availableStreamSource,i.AvailableStreamSource.PDN)||e.stream.sourceId===c.DataSourceId.CDN&&s.Bitmask.check(this._config.availableStreamSource,i.AvailableStreamSource.CDN)},t}(n(6).TaskHandler);t.RetrieveLoadingSegmentHandler=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._metrics=t,r._controller=n,!t)throw new i.ArgumentNullException("metrics");if(!n)throw new i.ArgumentNullException("controller");return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){return t=200===e.status&&!!e.payload,this._metrics.registerIf(t,"UPLOAD_PDN_COUNT").registerIf(t,"UPLOAD_PDN_SIZE",e.payload&&e.payload.byteLength||0).registerIf(509===e.status&&this._controller.isCanUpload(),"PDN_GET_UPLOAD_ISOFF").registerIf(509===e.status&&!this._controller.isCanUpload(),"PDN_GET_UPLOAD_CHOKE").registerIf(404===e.status,"PDN_GET_UPLOAD_404"),[2]}))}))},t}(n(6).TaskHandler);t.UpdateUploadMetricsHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n){var r=e.call(this)||this;if(r._strategy=t,r._monitor=n,!t)throw new i.ArgumentNullException(t);return r}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return e.isCanUpload=this._strategy.isCanUpload()&&this._monitor.isCanUpload(),e.stream.open(!0),[4,e.next()];case 1:return t.sent(),e.payload&&e.payload.byteLength&&this._monitor.incrementUploadCount(),[2]}}))}))},t}(n(6).TaskHandler);t.UploadControlHandler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(5),a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._logger=new o.Logger("upload-pipe"),t}return r.__extends(t,e),t.prototype.handle=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return t=s.TimeSpan.now,[4,e.next()];case 1:return n.sent(),e.error?this._logger.errorIf(i.Environment.isDevelopment,"error  "+e.id+" | "+t.diff()+" ms",e.error):this._logger.info("handle "+e.id+" and uploaded "+(e.payload&&e.payload.byteLength||0)+" | "+t.diff()+" ms"),[2]}}))}))},t}(n(6).TaskHandler);t.UploadLogHandler=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(96),a=n(247),u=function(e){function t(){var t=e.call(this)||this;return t.useErrorHandler((function(e,n){return r.__awaiter(t,void 0,void 0,(function(){return r.__generator(this,(function(t){return o.Logger.errorIf(i.Environment.isDevelopment,"Execute uploading error:"+n.message,e),[2]}))}))})),t}return r.__extends(t,e),t.prototype.createTask=function(e,t){return new a.UploadTask(t,e)},t}(s.TaskPipeline);t.UploadTaskPipeline=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(97),o=n(10),s=function(e){function t(t,n){var r=e.call(this,t.s+"->"+t.connectionId,t,n)||this;return r.isCanUpload=!0,r.status=200,r.payload=null,r.isPartial=!1,r.flags.setIsUpload(),r.stream.sourceId=o.DataSourceId.PDN,r.startChunk=t.startChunk,r.shift=t.shift,r}return r.__extends(t,e),t}(i.BaseLoadingTask);t.UploadTask=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(56),i=n(3),o=n(5),s=function(){function e(e){this.statEndpoint="http://stat",this.swarmEndpoint="http://swarm",this.signalEndpoint="ws://signal",this.waitToHaveOnNextDownload=!1,this._apiKey="",this._accessToken="",this._tokenExpire=null,this._streamIdFromAccessToken="",this._connectionId="",this._sessionId="",this._userId="",this._streamId="",this._sessionUrl="",this._KEY="TLPRT_ID",this._MIN_TOKEN_LIFETIME=o.TimeSpan.fromMinutes(5).value,this._apiKey=e||"",this._sessionStorage=i.Environment.sessionStorage,this._localStorage=i.Environment.localStorage,this.initialize()}return Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._apiKey},set:function(e){this._apiKey=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connectionId",{get:function(){return this._connectionId},set:function(e){this._connectionId=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sessionId",{get:function(){return this._sessionId},set:function(e){this._sessionId=e,i.Environment.isDevelopment||(this._sessionStorage&&e?this._sessionStorage.setItem(this._KEY,e):this._sessionStorage&&!e&&this._sessionStorage.removeItem(this._KEY))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userId",{get:function(){return this._userId},set:function(e){this._userId=e,this._localStorage&&e?this._localStorage.setItem(this._KEY,e):this._localStorage&&!e&&this._localStorage.removeItem(this._KEY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"streamId",{get:function(){return this._streamId},set:function(e){this._streamId=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tokenStreamId",{get:function(){return this._streamIdFromAccessToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"streamUrl",{get:function(){return this._sessionUrl},set:function(e){this._sessionUrl=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accessToken",{get:function(){return this._accessToken},set:function(e){this._accessToken=e,e&&(this._streamIdFromAccessToken=this.parseTokenStreamId(e),this._tokenExpire=this.parseTokenExpiration(e))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAuthenticated",{get:function(){return!!this._accessToken&&!!this._tokenExpire&&this._tokenExpire.rdiff()>this._MIN_TOKEN_LIFETIME},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){i.Environment.isDevelopment||(this._localStorage&&(this._userId=this._localStorage.getItem(this._KEY)||""),this._sessionStorage&&(this._sessionId=this._sessionStorage.getItem(this._KEY)||""))},e.prototype.parseTokenExpiration=function(e){try{var t=e.split(".")[1],n=r.Base64.decode(t),i=JSON.parse(n);return i.exp?new o.TimeSpan(1e3*i.exp):null}catch(e){return null}},e.prototype.parseTokenStreamId=function(e){try{var t=e.split(".")[1],n=r.Base64.decode(t);return JSON.parse(n).r||""}catch(e){return""}},e}();t.Session=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(0),o=n(10),s=n(9),a=n(1),u=n(23),c=n(17),l=n(4),h=n(3),d=n(2),f=n(8),p=n(5),_=n(42);!function(e){e.SDP="sdp"}(r||(r={}));var g=function(){function e(e,t,n,r,i,o,s){var u=this;if(this.endpointUrl=e,this.connection=t,this.session=n,this.scoring=r,this.configuration=i,this.buff=o,this._metrics=s,this.configLoadCount=0,this._logger=new d.Logger("BACKEND"),this._buffer=[],this._active=!0,this._canRevive=!1,this._errorSumpStatCdn=null,this._errorSumpStatPdn=null,this._errorSumpMetrics=null,this.FLUSH_TIMEOUT=p.TimeSpan.fromSeconds(30),this.REQUEST_TIMEOUT=p.TimeSpan.fromSeconds(5),this._sessionOpenTime=null,this._initEventSent=!1,this._onAuthExecuted=!1,this._disposeEventSent=!1,!e)throw new a.ArgumentNullException("endpointUrl");if(!t)throw new a.ArgumentNullException("connection");if(!n)throw new a.ArgumentNullException("session");if(!r)throw new a.ArgumentNullException("scoring");if(!i)throw new a.ArgumentNullException("configuration");this.connection.onMessage=function(e){return u.handleMessage(e)},this._flushTimer=new f.Timer((function(){return u._flushSumps()}),this.FLUSH_TIMEOUT),this._metrics.addAppender((function(e){u._sessionOpenTime&&e.register("DURATION_SESSION",u._sessionOpenTime.diff()/1e3|0)}))}return e.prototype.dispose=function(){i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){switch(e.label){case 0:return[4,this.sendDisposeEvent()];case 1:return[2,e.sent()]}}))})),this.connection.onMessage=void 0,this._flushTimer.dispose(),l.Destructor.destroyArray(this._buffer).destroyObject(this)},Object.defineProperty(e.prototype,"authHeader",{get:function(){return{Authorization:"Bearer "+this.session.accessToken}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAuthenticated",{get:function(){return this.session.isAuthenticated},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.connection.isOpened},enumerable:!0,configurable:!0}),e.prototype.enable=function(){this._active=!0,this._canRevive=!1,i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){switch(e.label){case 0:return[4,this.connection.open()];case 1:return[2,e.sent()]}}))}))},e.prototype.disable=function(e){void 0===e&&(e=!1),this._active=!1,this._canRevive=e,this.connection.close()},e.prototype.init=function(e,t,n){return i.__awaiter(this,void 0,void 0,(function(){var r,o,s,a,c=this;return i.__generator(this,(function(i){switch(i.label){case 0:r=new URL(this.endpointUrl),e&&r.searchParams.set("key",e),r.searchParams.set("stream",t),r.searchParams.set("url",btoa(n)),this.session.userId&&r.searchParams.set("uid",this.session.userId),this.session.sessionId&&r.searchParams.set("sid",this.session.sessionId),o=new u.HttpRequest({url:r.toString(),method:"GET",timeout:this.REQUEST_TIMEOUT}),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,o.send()];case 2:return s=i.sent(),this._flushTimer.start(),this._sessionOpenTime||(this._sessionOpenTime=p.TimeSpan.now),f.Timer.timeout((function(){c.onInit&&c.onInit()}),1),a=s.json().result,this.onAuth&&!this._onAuthExecuted&&(this._onAuthExecuted=!0,this.onAuth(_.XXHash.generate(t+a.sid))),[2,a];case 3:return i.sent(),[2,null];case 4:return[2]}}))}))},e.prototype.config=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n;return i.__generator(this,(function(r){switch(r.label){case 0:if(this.configLoadCount++,!this._active&&!this._canRevive)return[2,[]];if(!this.isAuthenticated)return[2,[]];(t=new URL(this.endpointUrl)).search="",t.pathname="/v1/opts",n=new u.HttpRequest({url:t.toString(),method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{params:e}}),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,n.send()];case 2:return[2,r.sent().json().result];case 3:return r.sent(),[2,[]];case 4:return[2]}}))}))},e.prototype.signal=function(e,t,n){return this._active?(this.connection.send({cmd:"sdp",payload:{from:e,to:t,signal:n}}),Promise.resolve()):Promise.resolve()},e.prototype.metrics=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n;return i.__generator(this,(function(r){switch(r.label){case 0:if(!this._active||0===Object.keys(t).length)return[2];n=new u.HttpRequest({url:this.session.statEndpoint+"/v1/metrics",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:e,data:t}}),r.label=1;case 1:return r.trys.push([1,4,,5]),this.isAuthenticated?[4,n.send()]:[3,3];case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:return r.sent(),this._putMetricsToSump(t),[3,5];case 5:return[2]}}))}))},e.prototype.swarmSnapshot=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n;return i.__generator(this,(function(r){switch(r.label){case 0:if(!this.configuration.sendSwarmSnapshot)return[2];t=new u.HttpRequest({url:this.session.statEndpoint+"/v1/event",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:p.TimeSpan.now,type:"swarmSnapshot",data:JSON.stringify(e)}}),r.label=1;case 1:return r.trys.push([1,4,,5]),this.isAuthenticated?[4,t.send()]:[3,3];case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:return n=r.sent(),this._logger.errorIf(h.Environment.isDevelopment,"Can't send swarmSnapshot to stat",n),[3,5];case 5:return[2]}}))}))},e.prototype.nowebrtc=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n;return i.__generator(this,(function(r){switch(r.label){case 0:if(!this.configuration.sendEvents)return[2];t=new u.HttpRequest({url:this.session.statEndpoint+"/v1/event",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:e,type:"nowebrtc"}}),r.label=1;case 1:return r.trys.push([1,4,,5]),this.isAuthenticated?[4,t.send()]:[3,3];case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:return n=r.sent(),this._logger.errorIf(h.Environment.isDevelopment,"Can't send event to stat",n),[3,5];case 5:return[2]}}))}))},e.prototype.error=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n,r;return i.__generator(this,(function(i){switch(i.label){case 0:if(!this._active)return[2];if(!this.configuration.sendEvents)return[2];n=new u.HttpRequest({url:this.session.statEndpoint+"/v1/event",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:e,type:"error",data:JSON.stringify(t)}}),i.label=1;case 1:return i.trys.push([1,4,,5]),this.isAuthenticated?[4,n.send()]:[3,3];case 2:i.sent(),i.label=3;case 3:return[3,5];case 4:return r=i.sent(),this._logger.errorIf(h.Environment.isDevelopment,"Can't send event to stat",r),[3,5];case 5:return[2]}}))}))},e.prototype.sendTeleportStaticStat=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n;return i.__generator(this,(function(r){switch(r.label){case 0:if(this._logger.infoIf(h.Environment.isDevelopment,"sendTeleportStaticStat",e),!this._active)return[2];if(this._initEventSent)return[2];t=new u.HttpRequest({url:this.session.statEndpoint+"/v1/event",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:p.TimeSpan.value,type:"init",data:JSON.stringify(e)}}),r.label=1;case 1:return r.trys.push([1,4,,5]),this.isAuthenticated?[4,t.send()]:[3,3];case 2:r.sent(),this._initEventSent=!0,r.label=3;case 3:return[3,5];case 4:return n=r.sent(),this._logger.errorIf(h.Environment.isDevelopment,"Can't send init event",n),[3,5];case 5:return[2]}}))}))},e.prototype.stat=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n;return i.__generator(this,(function(r){if(!this._active||0===e.result.size)return[2];(t={}).ts=e.timestamp,t.qq=e.request.quality,t.qt=e.request.type,t.qd=e.request.duration,t.qbf=e.request.bufferSize,t.rseg=e.result.segmentId,t.rsrc=e.result.sourceId,t.rtrg=e.result.targetId,t.rr=e.result.range,t.rf=e.result.flags,t.rh=e.result.haves,t.rwt=e.result.waitTimeout,t.rdt=e.result.downloadTimeout,t.rs=e.result.size,t.rsps=e.result.skippedPdnSize,t.rss=e.result.swarmSize,t.rsst=e.result.swarmSizeTotal,t.rc=e.result.connected,t.rm=e.result.mode,t.ra=e.result.active,t.ttrs=e.timings.req_start,t.tthv=e.timings.tthave,t.ttsn=e.timings.ttsent,t.ttfb=e.timings.ttfb,t.ttlb=e.timings.ttlb,t.ttfn=e.timings.ttfinish,n=t;try{n.qsd=new URL(e.request.url).host}catch(e){}return e.meta&&e.meta.ratio>0&&(n.mr=e.meta.ratio,n.mc=e.meta.count,n.mb=e.meta.bufferingCount),[2,this.sendStat(n)]}))}))},e.prototype.registerInSwarm=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(n){switch(n.label){case 0:if(!this._active)return[2];if(!this.isAuthenticated)return[2];n.label=1;case 1:return n.trys.push([1,3,,5]),[4,new u.HttpRequest({url:this.session.swarmEndpoint+"/v1/",method:"PUT",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{ts:t,score:this.scoring.value,size:e,max:Math.floor(this.configuration.maxSwarmSize*this.buff.swarmSizeQuota*.9),ttl:Math.round(this.configuration.stateInterval/1e3)}}).send()];case 2:return n.sent(),[3,5];case 3:return n.sent(),[4,Promise.resolve()];case 4:return n.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.searchWebRTCPeers=function(e,t,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(r){return[2,this._searchPeers(e,t,n)]}))}))},e.prototype.searchWSPeers=function(e,t,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(r){return[2,this._searchPeers(e,t,n,"white")]}))}))},e.prototype.searchNodrPeers=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,n=this;return i.__generator(this,(function(r){switch(r.label){case 0:if(e=[],!this._active)return[2,e];if(!this.isAuthenticated)return[2,e];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,new u.HttpRequest({url:this.session.swarmEndpoint+"/v1/nodr/search",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{}}).send()];case 2:return t=r.sent(),e=t.json().result,[3,4];case 3:return r.sent(),this._logger.infoIf(h.Environment.isDevelopment,"/v1/nodr/search error"),n.error(p.TimeSpan.now,{type:"nodr search error",url:n.session.swarmEndpoint+"/v1/nodr/search"}),[2,e];case 4:return[4,Promise.all(e.map((function(e){return i.__awaiter(n,void 0,void 0,(function(){var t,n=this;return i.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,new u.HttpRequest({url:e,method:"GET",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader}).send()];case 1:return r.sent(),[2,e];case 2:return t=r.sent(),this._logger.infoIf(h.Environment.isDevelopment,"nodr url check error",e,t),n.error(p.TimeSpan.now,{type:"nodr url check error",nodrUrl:e,e:t}),[2,""];case 3:return[2]}}))}))})))];case 5:return[2,e=r.sent().filter((function(e){return!!e}))]}}))}))},e.prototype.sendDisposeEvent=function(e){return void 0===e&&(e=!1),i.__awaiter(this,void 0,void 0,(function(){var t,n,r;return i.__generator(this,(function(i){switch(i.label){case 0:if(this._logger.infoIf(h.Environment.isDevelopment,"sendDisposeEvent"),!this._active)return[2];if(this._disposeEventSent)return[2];t={type:"dispose"},e&&(t.internal=e),n=new u.HttpRequest({url:this.session.statEndpoint+"/v1/event",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{timestamp:p.TimeSpan.value,type:"dispose",data:JSON.stringify(t)}}),i.label=1;case 1:return i.trys.push([1,4,,5]),this.isAuthenticated?[4,n.send()]:[3,3];case 2:i.sent(),i.label=3;case 3:return[3,5];case 4:return r=i.sent(),this._logger.errorIf(h.Environment.isDevelopment,"Can't send dispose event",r),[3,5];case 5:return[2]}}))}))},e.prototype.handleMessage=function(e){if(e.cmd===r.SDP){var t=e.payload;this.onSdp&&this.onSdp(t.from,t.signal)}else this._logger.warnIf(h.Environment.isDevelopment,"Unknown response type",e)},e.prototype._flushSumps=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,n,r=this;return i.__generator(this,(function(i){return this._active&&this.isAuthenticated?((e=this._errorSumpStatCdn)&&(this._errorSumpStatCdn=null,r.sendStat(e)),(t=this._errorSumpStatPdn)&&(this._errorSumpStatPdn=null,r.sendStat(t)),(n=this._errorSumpMetrics)&&(this._errorSumpMetrics=null,r.metrics(p.TimeSpan.now,n)),[2]):[2]}))}))},e.prototype._searchPeers=function(e,t,n,r){return void 0===r&&(r=""),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:if(!this._active)return[2,{ids:[],type:"webrtc"}];if(!this.isAuthenticated)return[2,{ids:[],type:"webrtc"}];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,new u.HttpRequest({url:this.session.swarmEndpoint+"/v1"+(r?"/"+r:"")+"/search",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{ts:n,score:this.scoring.value,size:e,count:Math.max(Math.ceil(this.configuration.maxSwarmSize*this.buff.swarmSizeQuota-e-3),1),exclude:t}}).send()];case 2:return[2,{ids:i.sent().json().result,type:r?"ws":"webrtc"}];case 3:return i.sent(),[2,{ids:[],type:"webrtc"}];case 4:return[2]}}))}))},e.prototype.sendStat=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n,r;return i.__generator(this,(function(i){switch(i.label){case 0:for(n in(t=new URL(this.session.statEndpoint)).pathname="/v1/stat",e)e.hasOwnProperty(n)&&t.searchParams.append(n,c.Convert.toString(e[n]));r=new u.HttpRequest({url:t.toString(),headers:this.authHeader,method:"GET",timeout:this.REQUEST_TIMEOUT}),i.label=1;case 1:return i.trys.push([1,4,,5]),this.isAuthenticated?[4,r.send()]:[3,3];case 2:i.sent(),i.label=3;case 3:return[3,5];case 4:return i.sent(),e.rsrc===o.DataSourceId.CDN&&this._putCdnStatToSump(e),e.rsrc===o.DataSourceId.PDN&&this._putPdnStatToSump(e),[3,5];case 5:return[2]}}))}))},e.prototype._putCdnStatToSump=function(e){this._errorSumpStatCdn?(this._errorSumpStatCdn.ts=e.ts,this._errorSumpStatCdn.qt=s.SegmentType.Mixed,this._errorSumpStatCdn.tthv+=e.tthv,this._errorSumpStatCdn.ttsn+=e.ttsn,this._errorSumpStatCdn.ttfb+=e.ttfb,this._errorSumpStatCdn.ttlb+=e.ttlb,this._errorSumpStatCdn.ttfn+=e.ttfn,this._errorSumpStatCdn.rsps=(this._errorSumpStatCdn.rsps||0)+(e.rsps||0),this._errorSumpStatCdn.rs+=e.rs):this._errorSumpStatCdn=e},e.prototype._putPdnStatToSump=function(e){this._errorSumpStatPdn?(this._errorSumpStatPdn.ts=e.ts,this._errorSumpStatPdn.qt=s.SegmentType.Mixed,this._errorSumpStatPdn.tthv+=e.tthv,this._errorSumpStatPdn.ttsn+=e.ttsn,this._errorSumpStatPdn.ttfb+=e.ttfb,this._errorSumpStatPdn.ttlb+=e.ttlb,this._errorSumpStatPdn.ttfn+=e.ttfn,this._errorSumpStatPdn.rsps=(this._errorSumpStatPdn.rsps||0)+(e.rsps||0),this._errorSumpStatPdn.rs+=e.rs):this._errorSumpStatPdn=e},e.prototype._putMetricsToSump=function(e){this._errorSumpMetrics?(this._errorSumpMetrics.DOWNLOAD_CDN_COUNT+=e.DOWNLOAD_CDN_COUNT||0,this._errorSumpMetrics.DOWNLOAD_CDN_SIZE+=e.DOWNLOAD_CDN_SIZE||0,this._errorSumpMetrics.DOWNLOAD_CDN_TIME+=e.DOWNLOAD_CDN_TIME||0,this._errorSumpMetrics.DOWNLOAD_PDN_COUNT+=e.DOWNLOAD_PDN_COUNT||0,this._errorSumpMetrics.DOWNLOAD_PDN_SIZE+=e.DOWNLOAD_PDN_SIZE||0,this._errorSumpMetrics.DOWNLOAD_PDN_TIME+=e.DOWNLOAD_PDN_TIME||0,this._errorSumpMetrics.DOWNLOAD_NDR_COUNT+=e.DOWNLOAD_NDR_COUNT||0,this._errorSumpMetrics.DOWNLOAD_NDR_SIZE+=e.DOWNLOAD_NDR_SIZE||0,this._errorSumpMetrics.DOWNLOAD_NDR_TIME+=e.DOWNLOAD_NDR_TIME||0):this._errorSumpMetrics={DOWNLOAD_CDN_COUNT:e.DOWNLOAD_CDN_COUNT||0,DOWNLOAD_CDN_SIZE:e.DOWNLOAD_CDN_SIZE||0,DOWNLOAD_CDN_TIME:e.DOWNLOAD_CDN_TIME||0,DOWNLOAD_PDN_COUNT:e.DOWNLOAD_PDN_COUNT||0,DOWNLOAD_PDN_SIZE:e.DOWNLOAD_PDN_SIZE||0,DOWNLOAD_PDN_TIME:e.DOWNLOAD_PDN_TIME||0,DOWNLOAD_NDR_COUNT:e.DOWNLOAD_NDR_COUNT||0,DOWNLOAD_NDR_SIZE:e.DOWNLOAD_NDR_SIZE||0,DOWNLOAD_NDR_TIME:e.DOWNLOAD_NDR_TIME||0}},e.prototype.sendNodrDownloadEvent=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t;return i.__generator(this,(function(n){switch(n.label){case 0:if(!this._active)return[2];if(!this.isAuthenticated)return[2];n.label=1;case 1:return n.trys.push([1,3,,5]),[4,new u.HttpRequest({url:"https://validator1.nodr.app/api/v1/stat",method:"POST",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:e}).send()];case 2:return n.sent(),[3,5];case 3:return t=n.sent(),d.Logger.warnIf(h.Environment.isDevelopment,t),[4,Promise.resolve()];case 4:return n.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.loadExternalHash=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t;return i.__generator(this,(function(n){switch(n.label){case 0:if(!this._active||!this.isAuthenticated||!e)return[2,null];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,new u.HttpRequest({url:"https://check.teleport.media/?url="+e,method:"GET",timeout:this.REQUEST_TIMEOUT,headers:this.authHeader,body:{url:{}}}).send()];case 2:return[2,n.sent().json().result];case 3:return t=n.sent(),d.Logger.warnIf(h.Environment.isDevelopment,t),[2,null];case 4:return[2]}}))}))},e}();t.Backend=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=function(){function e(e){if(this.session=e,!e)throw new r.ArgumentNullException("session")}return e.prototype.build=function(){var e=new URL(this.session.signalEndpoint);return e.protocol="https:"===e.protocol?"wss:":"ws:",e.searchParams.set("token",this.session.accessToken),e.toString()},e}();t.BackendConnectionStringBuilder=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(9),o=n(1),s=n(17),a=n(7),u=n(8),c=n(5),l=function(e){function t(t,n){var r=e.call(this,n)||this;if(r.config=t,r.clearTime=c.TimeSpan.fromSeconds(30),!t)throw new o.ArgumentNullException("config");return r._expireAt={},r._timer=new u.Timer((function(){return r.clear()}),r.clearTime),r._timer.start(),r}return r.__extends(t,e),Object.defineProperty(t.prototype,"items",{get:function(){var e=[],t=c.TimeSpan.value;for(var n in this._data)if(this._data.hasOwnProperty(n)&&a.Runtime.isDefined(this._data[n])&&this._expireAt.hasOwnProperty(n)&&a.Runtime.isDefined(this._expireAt[n])){var r=this._expireAt[n]-t-this.config.segmentTtlDecrement;r>0&&e.push({id:n,type:this._type[n]||i.SegmentType.Unknown,ttl:r,size:this._data[n].byteLength})}return e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ttl",{get:function(){return this.config.segmentTTL},enumerable:!0,configurable:!0}),t.prototype.save=function(t,n,i){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return this._expireAt[t]=c.TimeSpan.value+this.ttl,[4,e.prototype.save.call(this,t,n,i)];case 1:return r.sent(),[2]}}))}))},t.prototype.remove=function(t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(n){switch(n.label){case 0:return delete this._expireAt[t],[4,e.prototype.remove.call(this,t)];case 1:return n.sent(),[2]}}))}))},t.prototype.exists=function(t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(n){switch(n.label){case 0:return this.isExpired(t)?[2,!1]:[4,e.prototype.exists.call(this,t)];case 1:return[2,n.sent()]}}))}))},t.prototype.load=function(t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(n){switch(n.label){case 0:return this.isExpired(t)?[2,null]:[4,e.prototype.load.call(this,t)];case 1:return[2,n.sent()]}}))}))},t.prototype.dispose=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this._timer&&this._timer.dispose(),this._timer=void 0,this._expireAt=void 0,this.config=void 0,this.clearTime=void 0,[4,e.prototype.dispose.call(this)];case 1:return t.sent(),[2]}}))}))},t.prototype.clear=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i;return r.__generator(this,(function(r){switch(r.label){case 0:for(t in e=[],this._expireAt)e.push(t);n=0,r.label=1;case 1:return n<e.length?(i=e[n],this._expireAt.hasOwnProperty(i)&&this.isExpired(i)?[4,this.remove(i)]:[3,3]):[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},t.prototype.isExpired=function(e){var t=s.Convert.toInt(this._expireAt[e]);return c.TimeSpan.value>t},t}(n(252).InMemoryCache);t.LifetimeInMemoryCache=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(10),o=n(9),s=n(4),a=n(7),u=function(){function e(e){var t=this;this.sourceId=i.DataSourceId.MEMORY,this._data={},this._type={},e.addAppender((function(e){e.register("STORAGE_SIZE",t.size)}))}return e.prototype.dispose=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){for(e in this._data)this._data.hasOwnProperty(e)&&(this._data[e]=void 0);return s.Destructor.destroyObject(this),[2]}))}))},Object.defineProperty(e.prototype,"size",{get:function(){var e=this._data,t=0;for(var n in e)e.hasOwnProperty(n)&&a.Runtime.isDefined(e[n])&&(t+=e[n].byteLength);return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){var e=this._data,t=0;for(var n in e)e.hasOwnProperty(n)&&a.Runtime.isDefined(e[n])&&t++;return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"keys",{get:function(){var e=this._data,t=[];for(var n in e)e.hasOwnProperty(n)&&a.Runtime.isDefined(e[n])&&t.push(n);return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"items",{get:function(){var e=this._data,t=[];for(var n in e)if(e.hasOwnProperty(n)&&a.Runtime.isDefined(e[n])){var r={id:n,type:this._type[n]||o.SegmentType.Unknown,size:e[n].byteLength};t.push(r)}return t},enumerable:!0,configurable:!0}),e.prototype.save=function(e,t,n){return this._data[e]=t,this._type[e]=n,Promise.resolve()},e.prototype.remove=function(e){return delete this._data[e],delete this._type[e],Promise.resolve()},e.prototype.exists=function(e){return Promise.resolve(!!this._data[e])},e.prototype.load=function(e){var t=this._data[e];return Promise.resolve(t||null)},e}();t.InMemoryCache=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(16),o=n(9),s=n(19),a=n(1),u=n(60),c=n(110),l=n(13),h=n(17),d=n(75),f=n(3),p=n(51),_=n(7),g=n(5),m=n(18);!function(e){e[e.active=1]="active",e[e.segmentTTL=2]="segmentTTL",e[e.initialStateInterval=3]="initialStateInterval",e[e.stateInterval=4]="stateInterval",e[e.signalReconnectDelay=5]="signalReconnectDelay",e[e.searchSwarmSize=6]="searchSwarmSize",e[e.searchInterval=7]="searchInterval",e[e.maxSwarmSize=8]="maxSwarmSize",e[e.rtcConnectTimeout=9]="rtcConnectTimeout",e[e.rtcWaitTimeout=10]="rtcWaitTimeout",e[e.rtcWaitTimeoutMobile=11]="rtcWaitTimeoutMobile",e[e.rtcDownloadTimeout=12]="rtcDownloadTimeout",e[e.rtcSoftDownloadTimeout=52]="rtcSoftDownloadTimeout",e[e.minBufferSize=13]="minBufferSize",e[e.useMinusBufferSize=53]="useMinusBufferSize",e[e.heartbeatInterval=14]="heartbeatInterval",e[e.pingLimit=15]="pingLimit",e[e.matchLimit=16]="matchLimit",e[e.matchLimitCount=17]="matchLimitCount",e[e.blacklistCheckLifetime=18]="blacklistCheckLifetime",e[e.blacklistLimit=19]="blacklistLimit",e[e.matcherSize=20]="matcherSize",e[e.peeringMode=21]="peeringMode",e[e.issQueryCount=25]="issQueryCount",e[e.issQuerySize=26]="issQuerySize",e[e.issMinSize=27]="issMinSize",e[e.chokeInterval=28]="chokeInterval",e[e.uploadLimit=29]="uploadLimit",e[e.blacklistErrorRate=30]="blacklistErrorRate",e[e.lastActivityLimit=31]="lastActivityLimit",e[e.seedChance=32]="seedChance",e[e.seedChanceBound=33]="seedChanceBound",e[e.availableStatTypes=34]="availableStatTypes",e[e.blacklistBound=35]="blacklistBound",e[e.statAggregationRatio=36]="statAggregationRatio",e[e.streamingUpload=37]="streamingUpload",e[e.partialDownload=38]="partialDownload",e[e.pdnPartialDownload=39]="pdnPartialDownload",e[e.downloadTimeoutLimit=40]="downloadTimeoutLimit",e[e.sendOldHaves=41]="sendOldHaves",e[e.backendReconnectTimeout=42]="backendReconnectTimeout",e[e.downloadPdnZeroByteErrorLimit=43]="downloadPdnZeroByteErrorLimit",e[e.statAggRatioVideoCdn=44]="statAggRatioVideoCdn",e[e.statAggRatioVideoPdn=45]="statAggRatioVideoPdn",e[e.statAggRatioAudioCdn=46]="statAggRatioAudioCdn",e[e.statAggRatioAudioPdn=47]="statAggRatioAudioPdn",e[e.scoreDiffInterval=48]="scoreDiffInterval",e[e.scoreDiffCount=49]="scoreDiffCount",e[e.useIssSdpInBlacklist=50]="useIssSdpInBlacklist",e[e.silentActivityLimit=51]="silentActivityLimit",e[e.forceDwPeeringQuota=101]="forceDwPeeringQuota",e[e.statMultiplier=666]="statMultiplier",e[e.statMultiplierTimeout=667]="statMultiplierTimeout",e[e.pdnSafeMode=54]="pdnSafeMode",e[e.pdnSafeModeDelta=55]="pdnSafeModeDelta",e[e.haveCountForJoggle=56]="haveCountForJoggle",e[e.minHaveCountForPartial=57]="minHaveCountForPartial",e[e.availablePdnDownloadType=58]="availablePdnDownloadType",e[e.swarmSizeQuota=59]="swarmSizeQuota",e[e.bufferDecayTime=60]="bufferDecayTime",e[e.minTimeSlotDiff=61]="minTimeSlotDiff",e[e.maxUtilityTime=62]="maxUtilityTime",e[e.availablePdnMessageType=63]="availablePdnMessageType",e[e.pdnCycleCount=64]="pdnCycleCount",e[e.issTimeslotDepth=65]="issTimeslotDepth",e[e.bypassBufferSize=66]="bypassBufferSize",e[e.availableStreamSource=67]="availableStreamSource",e[e.availablePdnTransport=68]="availablePdnTransport",e[e.minSwarmSize=69]="minSwarmSize",e[e.outgoingConnDelay=70]="outgoingConnDelay",e[e.backendLoadMode=71]="backendLoadMode",e[e.reviveTimeout=72]="reviveTimeout",e[e.haveDensityThreshold=73]="haveDensityThreshold",e[e.streamType=74]="streamType",e[e.abrPdnFakeStatFactor=75]="abrPdnFakeStatFactor",e[e.scoreNormalizer=76]="scoreNormalizer",e[e.metricsInfoLevel=77]="metricsInfoLevel",e[e.rtcCheckCount=78]="rtcCheckCount",e[e.checkSegmentHash=80]="checkSegmentHash",e[e.segmentHashTtl=81]="segmentHashTtl",e[e.hashDensityThreshold=82]="hashDensityThreshold",e[e.sendEvents=83]="sendEvents",e[e.useImpactMatcher=84]="useImpactMatcher",e[e.impactMatcherHaveDensityThreshold=85]="impactMatcherHaveDensityThreshold",e[e.sendSwarmSnapshot=86]="sendSwarmSnapshot",e[e.useEstimatePeerSelector=87]="useEstimatePeerSelector",e[e.estimateTimeoutRatio=88]="estimateTimeoutRatio",e[e.nodrStrategy=89]="nodrStrategy",e[e.sourceHaveFirstByte=90]="sourceHaveFirstByte",e[e.msMinBufferSize=91]="msMinBufferSize",e[e.haveWaitCount=92]="haveWaitCount",e[e.raceRequestMaxPower=93]="raceRequestMaxPower",e[e.p2pSpeedThreshold=94]="p2pSpeedThreshold",e[e.raceRedelegate=95]="raceRedelegate",e[e.externalHashCheck=96]="externalHashCheck"}(r||(r={}));var y=function(){function e(){this.onChangedDC=new d.DelegateCollection,this.onChangedBulkDC=new d.DelegateCollection,this._backendEntrypointUrl="https://gateway.teleport.media/v1/",this._timeSlotParser=/\d{6,9}\..*$/,this._backendReconnectTimeout=g.TimeSpan.fromMinutes(30).value,this._active=1,this._streamingUpload=0,this._partialDownload=0,this._pdnPartialDownload=0,this._segmentTTL=18e4,this._initialStateInterval=3e3,this._stateInterval=6e4,this._trackerReconnectDelay=1e4,this._searchSwarmSize=16,this._searchInterval=3e4,this._issQueryCount=15,this._issQuerySize=4,this._issMinSize=1,this._maxSwarmSize=24,this._minSwarmSize=4,this._rtcConnectTimeout=8e3,this._rtcWaitTimeout=100,this._rtcWaitTimeoutMobile=200,this._rtcDownloadTimeout=1,this._rtcSoftDownloadTimeout=12500,this._minBufferSize=5,this._useMinusBufferSize=0,this._peeringMode=f.Environment.isWebRtcSupported?i.PeeringMode.Upload:i.PeeringMode.Download,this._heartbeatInterval=15e3,this._pingLimit=3,this._matchLimit=0,this._matchLimitCount=3,this._blacklistCheckLifetime=3e5,this._blacklistLimit=100,this._matcherSize=30,this._chokeInterval=6e4,this._uploadLimit=1200,this._blacklistSuccessRate=96,this._blacklistBound=4,this._lastActivityLimit=18e4,this._seedChance=15,this._seedChanceBound=50,this._availableStatTypes=m.AvailableStatTypes.All,this._statAggregationRatio=0,this._downloadTimeoutLimit=0,this._sendOldHaves=0,this._segmentTtlDecrement=1e4,this._statMultiplier=0,this._statMultiplierTimeout=200,this._downloadPdnZeroByteErrorLimit=3,this._forceDwPeeringQuota=256,this._statAggRatioVideoCdn=1,this._statAggRatioVideoPdn=1,this._statAggRatioAudioCdn=1,this._statAggRatioAudioPdn=1,this._scoreDiffInterval=30,this._scoreDiffCount=3,this._useIssSdpInBlacklist=0,this._silentActivityLimit=3e5,this._pdnSafeMode=1,this._pdnSafeModeDelta=200,this._haveCountForJoggle=3,this._minHaveCountForPartial=3,this._availablePdnDownloadType=o.SegmentType.Audio|o.SegmentType.Caption|o.SegmentType.Video|o.SegmentType.Unknown|o.SegmentType.Other,this._swarmSizeQuota=67,this._swarmSizeExludes=40,this._bufferDecayTime=24e4,this._minTimeSlotDiff=1,this._maxUtilityTime=24e4,this._availablePdnMessageType=c.PdnMessageType.BROADCAST_HAVE|c.PdnMessageType.BROADCAST_SCORE|c.PdnMessageType.BROADCAST_CHOKE|c.PdnMessageType.BROADCAST_TIMESLOT|c.PdnMessageType.BROADCAST_HTS|c.PdnMessageType.BROADCAST_INFO|c.PdnMessageType.BROADCAST_SEGMENT_HASH|c.PdnMessageType.OLD_HAVES|c.PdnMessageType.SINGLE_CHOKE,this._pdnCycleCount=1,this._issTimeslotDepth=0,this._bypassBufferSize=0,this._availableStreamSource=m.AvailableStreamSource.OFF,this._availablePdnTransport=m.AvailablePdnTransport.WEBRTC,this._outgoingConnDelay=200,this._backendLoadMode=0,this._reviveTimeout=6e5,this._haveDensityThreshold=5,this._streamType=m.StreamType.VOD,this._abrPdnFakeStatFactor=100,this._scoreNormalizer=1,this._metricsInfoLevel=2,this._rtcCheckCount=3,this._checkSegmentHash=0,this._segmentHashTtl=2,this._hashDensityThreshold=3,this._sendEvents=1,this._useImpactMatcher=1,this._impactMatcherHaveDensityThreshold=1,this._sendSwarmSnapshot=0,this._useEstimatePeerSelector=0,this._estimateTimeoutRatio=85,this._nodrStrategy=m.NodrStrategy.NO,this._sourceHaveFirstByte=m.SourceHaveFirstByte.ALL_LAST_BYTE,this._msMinBufferSize=5e3,this._haveWaitCount=1,this._raceRequestMaxPower=0,this._p2pSpeedThreshold=0,this._raceRedelegate=0,this._externalHashCheck=m.ExternalHashCheckMode.OFF,this._serverParams={},this._clientParams={},this._override={};var e=p.QueryParams.getValue("media_tlprt_cfg");try{this._queryParams=JSON.parse(e)}catch(e){this._queryParams={}}}return Object.defineProperty(e.prototype,"onChanged",{get:function(){return this.onChangedDC.exec},set:function(e){this.onChangedDC.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onChangedBulk",{get:function(){return this.onChangedBulkDC.exec.bind(this.onChangedBulkDC)},set:function(e){this.onChangedBulkDC.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeSlotParser",{get:function(){return this._timeSlotParser},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"active",{get:function(){return this.getParamValue(r.active)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"streamingUpload",{get:function(){return this.getParamValue(r.streamingUpload)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"partialDownload",{get:function(){return this.getParamValue(r.partialDownload)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pdnPartialDownload",{get:function(){return this.getParamValue(r.pdnPartialDownload)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"segmentTTL",{get:function(){return this.getParamValue(r.segmentTTL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"initialStateInterval",{get:function(){return this.getParamValue(r.initialStateInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stateInterval",{get:function(){return this.getParamValue(r.stateInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backendEntrypointUrl",{get:function(){return this._backendEntrypointUrl},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"signalReconnectDelay",{get:function(){return this.getParamValue(r.signalReconnectDelay)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"searchSwarmSize",{get:function(){return this.getParamValue(r.searchSwarmSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"searchInterval",{get:function(){return this.getParamValue(r.searchInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"issQueryCount",{get:function(){return this.getParamValue(r.issQueryCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"issQuerySize",{get:function(){return this.getParamValue(r.issQuerySize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"issMinSize",{get:function(){return this.getParamValue(r.issMinSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxSwarmSize",{get:function(){return this.getParamValue(r.maxSwarmSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSwarmSize",{get:function(){return this.getParamValue(r.minSwarmSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcConnectTimeout",{get:function(){return this.getParamValue(r.rtcConnectTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcWaitTimeout",{get:function(){return this.getParamValue(r.rtcWaitTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcWaitTimeoutMobile",{get:function(){return this.getParamValue(r.rtcWaitTimeoutMobile)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcDownloadTimeout",{get:function(){return this.getParamValue(r.rtcDownloadTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcSoftDownloadTimeout",{get:function(){return this.getParamValue(r.rtcSoftDownloadTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minBufferSize",{get:function(){return this.getParamValue(r.minBufferSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useMinusBufferSize",{get:function(){return this.getParamValue(r.useMinusBufferSize)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"peeringMode",{get:function(){return this.getParamValue(r.peeringMode)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"heartbeatInterval",{get:function(){return this.getParamValue(r.heartbeatInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pingLimit",{get:function(){return this.getParamValue(r.pingLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"matchLimit",{get:function(){return this.getParamValue(r.matchLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"matchLimitCount",{get:function(){return this.getParamValue(r.matchLimitCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blacklistCheckLifetime",{get:function(){return this.getParamValue(r.blacklistCheckLifetime)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blacklistLimit",{get:function(){return this.getParamValue(r.blacklistLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blacklistErrorRate",{get:function(){return this.getParamValue(r.blacklistErrorRate)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blacklistBound",{get:function(){return this.getParamValue(r.blacklistBound)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"matcherSize",{get:function(){return this.getParamValue(r.matcherSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"chokeInterval",{get:function(){return this.getParamValue(r.chokeInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uploadLimit",{get:function(){return this.getParamValue(r.uploadLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastActivityLimit",{get:function(){return this.getParamValue(r.lastActivityLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"seedChance",{get:function(){return this.getParamValue(r.seedChance)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"seedChanceBound",{get:function(){return this.getParamValue(r.seedChanceBound)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"availableStatTypes",{get:function(){return this.getParamValue(r.availableStatTypes)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statAggregationRatio",{get:function(){return this.getParamValue(r.statAggregationRatio)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"downloadTimeoutLimit",{get:function(){return this.getParamValue(r.downloadTimeoutLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sendOldHaves",{get:function(){return this.getParamValue(r.sendOldHaves)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"segmentTtlDecrement",{get:function(){return this._segmentTtlDecrement},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statMultiplier",{get:function(){return this.getParamValue(r.statMultiplier)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statMultiplierTimeout",{get:function(){return this.getParamValue(r.statMultiplierTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backendReconnectTimeout",{get:function(){return this.getParamValue(r.backendReconnectTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pdnZeroByteDownloadLimit",{get:function(){return this.getParamValue(r.downloadPdnZeroByteErrorLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"forceDwPeeringQuota",{get:function(){return this.getParamValue(r.forceDwPeeringQuota)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statAggRatioVideoCdn",{get:function(){return this.getParamValue(r.statAggRatioVideoCdn)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statAggRatioVideoPdn",{get:function(){return this.getParamValue(r.statAggRatioVideoPdn)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statAggRatioAudioCdn",{get:function(){return this.getParamValue(r.statAggRatioAudioCdn)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"statAggRatioAudioPdn",{get:function(){return this.getParamValue(r.statAggRatioAudioPdn)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scoreDiffInterval",{get:function(){return this.getParamValue(r.scoreDiffInterval)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scoreDiffCount",{get:function(){return this.getParamValue(r.scoreDiffCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useIssSdpInBlacklist",{get:function(){return this.getParamValue(r.useIssSdpInBlacklist)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"silentActivityLimit",{get:function(){return this.getParamValue(r.silentActivityLimit)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pdnSafeMode",{get:function(){return this.getParamValue(r.pdnSafeMode)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pdnSafeModeDelta",{get:function(){return this.getParamValue(r.pdnSafeModeDelta)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"haveCountForJoggle",{get:function(){return this.getParamValue(r.haveCountForJoggle)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minHaveCountForPartial",{get:function(){return this.getParamValue(r.minHaveCountForPartial)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"availablePdnDownloadType",{get:function(){return this.getParamValue(r.availablePdnDownloadType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"swarmSizeQuota",{get:function(){return this.getParamValue(r.swarmSizeQuota)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"swarmSizeExludes",{get:function(){return this._swarmSizeExludes},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferDecayTime",{get:function(){return this.getParamValue(r.bufferDecayTime)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minTimeSlotDiff",{get:function(){return this.getParamValue(r.minTimeSlotDiff)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxUtilityTime",{get:function(){return this.getParamValue(r.maxUtilityTime)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"availablePdnMessageType",{get:function(){return this.getParamValue(r.availablePdnMessageType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pdnCycleCount",{get:function(){return this.getParamValue(r.pdnCycleCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"issTimeslotDepth",{get:function(){return this.getParamValue(r.issTimeslotDepth)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bypassBufferSize",{get:function(){return this.getParamValue(r.bypassBufferSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"availableStreamSource",{get:function(){return this.getParamValue(r.availableStreamSource)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"availablePdnTransport",{get:function(){return this.getParamValue(r.availablePdnTransport)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"outgoingConnDelay",{get:function(){return this.getParamValue(r.outgoingConnDelay)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backendLoadMode",{get:function(){return this.getParamValue(r.backendLoadMode)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"reviveTimeout",{get:function(){return this.getParamValue(r.reviveTimeout)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"haveDensityThreshold",{get:function(){return this.getParamValue(r.haveDensityThreshold)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"streamType",{get:function(){return this.getParamValue(r.streamType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"abrPdnFakeStatFactor",{get:function(){return this.getParamValue(r.abrPdnFakeStatFactor)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scoreNormalizer",{get:function(){return this.getParamValue(r.scoreNormalizer)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metricsInfoLevel",{get:function(){return this.getParamValue(r.metricsInfoLevel)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rtcCheckCount",{get:function(){return this.getParamValue(r.rtcCheckCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"checkSegmentHash",{get:function(){return this.getParamValue(r.checkSegmentHash)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"segmentHashTtl",{get:function(){return this.getParamValue(r.segmentHashTtl)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hashDensityThreshold",{get:function(){return this.getParamValue(r.hashDensityThreshold)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sendEvents",{get:function(){return this.getParamValue(r.sendEvents)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useImpactMatcher",{get:function(){return this.getParamValue(r.useImpactMatcher)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"impactMatcherHaveDensityThreshold",{get:function(){return this.getParamValue(r.impactMatcherHaveDensityThreshold)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sendSwarmSnapshot",{get:function(){return this.getParamValue(r.sendSwarmSnapshot)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useEstimatePeerSelector",{get:function(){return this.getParamValue(r.useEstimatePeerSelector)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"estimateTimeoutRatio",{get:function(){return this.getParamValue(r.estimateTimeoutRatio)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrStrategy",{get:function(){return this.getParamValue(r.nodrStrategy)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrLowPriority",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_LOW_PRIORITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrExtraCycle",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_EXTRA_CYCLE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrProxy",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_PROXY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrByteRange",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_BYTE_RANGE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrPutSegment",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_PUT_SEGMENT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nodrSendEvent",{get:function(){var e=this.getParamValue(r.nodrStrategy);return l.Bitmask.check(e,m.NodrStrategy.NODR_SEND_EVENT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sourceHaveFirstByte",{get:function(){return this.getParamValue(r.sourceHaveFirstByte)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"msMinBufferSize",{get:function(){return this.getParamValue(r.msMinBufferSize)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"haveWaitCount",{get:function(){return this.getParamValue(r.haveWaitCount)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"raceRequestMaxPower",{get:function(){return this.getParamValue(r.raceRequestMaxPower)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"p2pSpeedThreshold",{get:function(){return this.getParamValue(r.p2pSpeedThreshold)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"raceRedelegate",{get:function(){return this.getParamValue(r.raceRedelegate)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"externalHashCheck",{get:function(){return this.getParamValue(r.externalHashCheck)},enumerable:!0,configurable:!0}),e.prototype.updateConfig=function(e){if(e){var t=[];for(var n in e)if(e.hasOwnProperty(n))if("backendEntrypointUrl"===n&&e[n])this._backendEntrypointUrl=h.Convert.toString(e[n]);else if("timeSlotParser"!==n&&"timeSlotRegexp"!==n||!e[n]){var i=n,o=r[i];if(!_.Runtime.isDefined(o))throw new u.UnsupportedException('unknown configuration param "'+i+'"');var s=this.getParamValue(o);this._clientParams[i]=h.Convert.toInt(e[i]);var a=this.getParamValue(o);s!==a&&(this.onChangedDC.exec({paramName:i,oldValue:s,newValue:a}),t.push({paramName:i,oldValue:s,newValue:a}))}else try{_.Runtime.isString(e[n])?this._timeSlotParser=new RegExp(e[n]):_.Runtime.isRegExp(e[n])||_.Runtime.isFunction(e[n])?this._timeSlotParser=e[n]:this._timeSlotParser=null}catch(e){this._timeSlotParser=null}this.onChangedBulk(t)}},e.prototype.updateSerializedConfig=function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n],o=r[i[0]];if(_.Runtime.isDefined(o)&&_.Runtime.isString(o)){var s=this.getParamValue(i[0]);this._serverParams[o]=h.Convert.toInt(i[1]),this._override[o]=h.Convert.toInt(i[2])>0;var a=this.getParamValue(i[0]);s!==a&&(this.onChangedDC.exec({paramName:o,oldValue:s,newValue:a}),t.push({paramName:o,oldValue:s,newValue:a}))}}this.onChangedBulk(t)},e.prototype.toJSON=function(){var e=[],t=r;for(var n in t)if(t.hasOwnProperty(n)&&!_.Runtime.isString(t[n])){var i=t[n],o=this.getServerOrDefaultValue(i),s=+this.isForced(i);e.push([i,o,s])}return e},e.prototype.isForced=function(e){var t=r[e];return!!this._override[t]},e.prototype.getServerValue=function(e){var t=r[e];return this._serverParams[t]},e.prototype.getClientValue=function(e){var t=r[e];return this._clientParams[t]},e.prototype.getQueryValue=function(e){var t=r[e];return this._queryParams[t]},e.prototype.getDefaultValue=function(e){if(!e)throw new a.ArgumentNullException("param");switch(e){case r.active:return this._active;case r.segmentTTL:return this._segmentTTL;case r.initialStateInterval:return this._initialStateInterval;case r.stateInterval:return this._stateInterval;case r.signalReconnectDelay:return this._trackerReconnectDelay;case r.searchSwarmSize:return this._searchSwarmSize;case r.searchInterval:return this._searchInterval;case r.issQueryCount:return this._issQueryCount;case r.issQuerySize:return this._issQuerySize;case r.issMinSize:return this._issMinSize;case r.maxSwarmSize:return this._maxSwarmSize;case r.rtcConnectTimeout:return this._rtcConnectTimeout;case r.rtcWaitTimeout:return this._rtcWaitTimeout;case r.rtcWaitTimeoutMobile:return this._rtcWaitTimeoutMobile;case r.rtcDownloadTimeout:return this._rtcDownloadTimeout;case r.minBufferSize:return this._minBufferSize;case r.peeringMode:return this._peeringMode;case r.heartbeatInterval:return this._heartbeatInterval;case r.pingLimit:return this._pingLimit;case r.matchLimit:return this._matchLimit;case r.matchLimitCount:return this._matchLimitCount;case r.blacklistCheckLifetime:return this._blacklistCheckLifetime;case r.blacklistLimit:return this._blacklistLimit;case r.matcherSize:return this._matcherSize;case r.chokeInterval:return this._chokeInterval;case r.uploadLimit:return this._uploadLimit;case r.blacklistErrorRate:return this._blacklistSuccessRate;case r.blacklistBound:return this._blacklistBound;case r.lastActivityLimit:return this._lastActivityLimit;case r.seedChance:return this._seedChance;case r.seedChanceBound:return this._seedChanceBound;case r.availableStatTypes:return this._availableStatTypes;case r.statAggregationRatio:return this._statAggregationRatio;case r.streamingUpload:return this._streamingUpload;case r.partialDownload:return this._partialDownload;case r.pdnPartialDownload:return this._pdnPartialDownload;case r.downloadTimeoutLimit:return this._downloadTimeoutLimit;case r.sendOldHaves:return this._sendOldHaves;case r.statMultiplier:return this._statMultiplier;case r.statMultiplierTimeout:return this._statMultiplierTimeout;case r.backendReconnectTimeout:return this._backendReconnectTimeout;case r.downloadPdnZeroByteErrorLimit:return this._downloadPdnZeroByteErrorLimit;case r.forceDwPeeringQuota:return this._forceDwPeeringQuota;case r.statAggRatioVideoCdn:return this._statAggRatioVideoCdn;case r.statAggRatioVideoPdn:return this._statAggRatioVideoPdn;case r.statAggRatioAudioCdn:return this._statAggRatioAudioCdn;case r.statAggRatioAudioPdn:return this._statAggRatioAudioPdn;case r.scoreDiffInterval:return this._scoreDiffInterval;case r.scoreDiffCount:return this._scoreDiffCount;case r.useIssSdpInBlacklist:return this._useIssSdpInBlacklist;case r.silentActivityLimit:return this._silentActivityLimit;case r.rtcSoftDownloadTimeout:return this._rtcSoftDownloadTimeout;case r.useMinusBufferSize:return this._useMinusBufferSize;case r.pdnSafeMode:return this._pdnSafeMode;case r.pdnSafeModeDelta:return this._pdnSafeModeDelta;case r.haveCountForJoggle:return this._haveCountForJoggle;case r.minHaveCountForPartial:return this._minHaveCountForPartial;case r.availablePdnDownloadType:return this._availablePdnDownloadType;case r.swarmSizeQuota:return this._swarmSizeQuota;case r.bufferDecayTime:return this._bufferDecayTime;case r.minTimeSlotDiff:return this._minTimeSlotDiff;case r.maxUtilityTime:return this._maxUtilityTime;case r.availablePdnMessageType:return this._availablePdnMessageType;case r.pdnCycleCount:return this._pdnCycleCount;case r.issTimeslotDepth:return this._issTimeslotDepth;case r.bypassBufferSize:return this._bypassBufferSize;case r.availableStreamSource:return this._availableStreamSource;case r.availablePdnTransport:return this._availablePdnTransport;case r.minSwarmSize:return this._minSwarmSize;case r.outgoingConnDelay:return this._outgoingConnDelay;case r.backendLoadMode:return this._backendLoadMode;case r.reviveTimeout:return this._reviveTimeout;case r.haveDensityThreshold:return this._haveDensityThreshold;case r.streamType:return this._streamType;case r.abrPdnFakeStatFactor:return this._abrPdnFakeStatFactor;case r.scoreNormalizer:return this._scoreNormalizer;case r.metricsInfoLevel:return this._metricsInfoLevel;case r.rtcCheckCount:return this._rtcCheckCount;case r.checkSegmentHash:return this._checkSegmentHash;case r.segmentHashTtl:return this._segmentHashTtl;case r.hashDensityThreshold:return this._hashDensityThreshold;case r.sendEvents:return this._sendEvents;case r.useImpactMatcher:return this._useImpactMatcher;case r.impactMatcherHaveDensityThreshold:return this._impactMatcherHaveDensityThreshold;case r.sendSwarmSnapshot:return this._sendSwarmSnapshot;case r.useEstimatePeerSelector:return this._useEstimatePeerSelector;case r.estimateTimeoutRatio:return this._estimateTimeoutRatio;case r.nodrStrategy:return this._nodrStrategy;case r.sourceHaveFirstByte:return this._sourceHaveFirstByte;case r.msMinBufferSize:return this._msMinBufferSize;case r.haveWaitCount:return this._haveWaitCount;case r.raceRequestMaxPower:return this._raceRequestMaxPower;case r.p2pSpeedThreshold:return this._p2pSpeedThreshold;case r.raceRedelegate:return this._raceRedelegate;case r.externalHashCheck:return this._externalHashCheck;default:throw new s.ArgumentException("param="+r[e])}},e.prototype.getParamValue=function(e){var t=this.isForced(e),n=this.getServerValue(e),r=this.getClientValue(e),i=this.getQueryValue(e),o=this.getDefaultValue(e);return _.Runtime.isDefined(i)?i:t&&_.Runtime.isDefined(n)?n:_.Runtime.isDefined(r)?r:_.Runtime.isDefined(n)?n:o},e.prototype.getServerOrDefaultValue=function(e){var t=this.getServerValue(e);return _.Runtime.isDefined(t)?t:this.getDefaultValue(e)},e}();t.Configuration=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(3),s=n(2),a=n(5),u=n(111),c=n(112),l=n(255),h=n(256),d=function(){function e(e){var t=this;if(this._socket=e,this._readers={},this._logger=new s.Logger("P2P_CLIENT"),!e)throw new i.ArgumentNullException("socket");this._socket.onResponse=function(e){return t._handleReceivedChunk(e)}}return e.prototype.dispose=function(){this._socket.onResponse=void 0,delete this._socket,delete this._readers},e.prototype.createRequest=function(e,t){var n=this,r=new u.ChunkReader(t),i=new l.ClientP2PRequest(e,(function(){return n._socket.pool.get(e)||null}),r),s=function(){n._logger.debugIf(o.Environment.isDevelopment,"Delete reader","messageId:",i.id,"cutomData",t),delete n._readers[i.id]};return i.onInternalFinish=s,i.onInternalAbort=s,this._readers[i.id]=r,i},e.prototype.createBroadcast=function(e){return e?new h.FilteredBroadcastP2PRequest(this._socket,e):new c.BroadcastP2PRequest(this._socket)},e.prototype._handleReceivedChunk=function(e){var t=this._readers[e.id];if(t)try{t.read(e)}catch(n){s.Logger.errorIf(o.Environment.isDevelopment,"_handleReceivedChunk error","messageId:",e.id,n),t.error(n),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this._socket.backend?[4,this._socket.backend.error(a.TimeSpan.now,n)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}else s.Logger.warnIf(o.Environment.isDevelopment,"unknown chunk received","messageId:",e.id,"data.length",e.data.byteLength)},e}();t.P2PClient=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(11),s=n(54),a=n(43),u=n(4),c=n(3),l=n(2),h=n(69),d=n(61),f=n(59),p=n(58),_=n(76),g=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._connRef=n,o._reader=r,o._logger=new l.Logger("CLIENT_P2P_REQUEST"),!t)throw new i.ArgumentNullException("id");if(!n)throw new i.ArgumentNullException("pool");if(!r)throw new i.ArgumentNullException("reader");return o.id=f.P2PMessage.generateRequestId(),o.connectionId=t,o._logger=new l.Logger("P2P_REQUEST:"+("_".repeat(10)+o.id).slice(-10)),o._reader.onHeaders=function(e){return o._handleHeader(e)},o._reader.onProgress=function(e,t,n){return o._handleProgress(e,t,n)},o._reader.onData=function(e){return o._handleResponse(e)},o._reader.onError=function(e){return o._reject(e)},o}return r.__extends(t,e),t.prototype.dispose=function(){this._logger.debugIf(c.Environment.isDevelopment,"dispose"),u.Destructor.destroyObject(this)},Object.defineProperty(t.prototype,"response",{get:function(){return this._response},enumerable:!0,configurable:!0}),t.prototype.send=function(e){var t=this;return void 0===e&&(e=!0),this.count=1,e?new h.TimeoutPromise((function(e,n){t._response=new _.ClientP2PResponse,t._resolve=t._wrapResolver(e),t._reject=t._wrapRejector(n),t._send()}),this.timeout):(this._send(!1),this._response=new _.ClientP2PResponse,Promise.resolve(this._response))},t.prototype.abort=function(){if(this._logger.debugIf(c.Environment.isDevelopment,"abort"),this.onInternalAbort&&this.onInternalAbort(),!this._reject)throw new o.Exception("Can't abort request. request isn't sended.");this._reject(new s.OperationAbortException("request "+this.id+" is aborted by client"))},t.prototype._send=function(e){void 0===e&&(e=!0);var t=this._connRef();if(t){this.writeContentLength();for(var n=new d.ChunkIterator(this),r=n.next();r;)r.meta.isNeedAnswer=e,t.send(r.toArrayBuffer()),r=n.next();n.dispose()}else this._reject(new o.Exception("connection "+this.connectionId+" for sending the request is not found "))},t.prototype._wrapRejector=function(e){var t=this;return function(n){t.onInternalFinish&&t.onInternalFinish(),n instanceof a.OperationTimeoutException?t.onTimeout&&t.onTimeout():t.onError&&t.onError(n),e(n),t.dispose()}},t.prototype._wrapResolver=function(e){var t=this;return function(){t.onInternalFinish&&t.onInternalFinish(),e(t._response)}},t.prototype._handleHeader=function(e){this._response.headers=e,this.onHeaders&&this.onHeaders(e)},t.prototype._handleResponse=function(e){this._response.body=e,this.onLoad&&this.onLoad(),this._resolve()},t.prototype._handleProgress=function(e,t,n){this._logger.debugIf(c.Environment.isDevelopment,"_handleProgress","SIZE",e.data.byteLength),this.onProgress&&this.onProgress(e,t,n)},t}(p.P2PRequest);t.ClientP2PRequest=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(112),o=n(76),s=function(e){function t(t,n){var r=e.call(this,t)||this;return r._filter=n,r}return r.__extends(t,e),t.prototype.send=function(){return this.count=this._socket.broadcast(this,this._filter),delete this._socket,Promise.resolve(new o.ClientP2PResponse)},t}(i.BroadcastP2PRequest);t.FilteredBroadcastP2PRequest=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),i=n(1),o=n(4),s=function(){function e(){this._items={}}return e.prototype.dispose=function(){o.Destructor.destroyObject(this._items,!0).destroyObject(this)},Object.defineProperty(e.prototype,"size",{get:function(){return Object.keys(this._items).length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"keys",{get:function(){return Object.keys(this._items)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"info",{get:function(){var e=0,t=0;for(var n in this._items)if(this._items.hasOwnProperty(n)){var r=this._items[n];e++,t+=r&&r.ready?1:0}return{total:e,ready:t}},enumerable:!0,configurable:!0}),e.prototype.get=function(e){return this._items[e]},e.prototype.add=function(e){if(!e)throw new i.ArgumentNullException("it");var t=e.uuid;if(this.contains(t))throw new r.ArgumentException("it","Connection with id "+t+" already registered");this._items[t]=e,this.onAppend&&this.onAppend(e)},e.prototype.remove=function(e,t){void 0===t&&(t=!0);var n=this.get(e);return!!n&&(this.onRemove&&this.onRemove(n),t&&n.close(),delete this._items[e],!0)},e.prototype.contains=function(e){return!!this.get(e)},e.prototype.close=function(){for(var e in this._items)this._items.hasOwnProperty(e)&&this.remove(e,!0)},e.prototype[Symbol.iterator]=function(){var e=this,t=this.keys,n=0,r=t.length;return{next:function(){for(var i=e.get(t[n]);!i&&n<r;)n++,i=e.get(t[n]);return n<r?(n++,{done:!1,value:i}):{done:!0,value:null}}}},e}();t.P2PConnectionPool=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(3),a=n(2),u=n(5),c=n(61),l=n(111),h=n(71),d=n(259),f=n(260),p=function(e){return e.ready},_=function(){function e(e,t){if(void 0===t&&(t=null),this.pool=e,this._logger=new a.Logger("WebRtcSocket"),!e)throw new i.ArgumentNullException("pool");this.backend=t,this.initialize()}return e.prototype.broadcast=function(e,t){var n,i;void 0===t&&(t=p);var o=0,a=null;try{for(var u=r.__values(this.pool),l=u.next();!l.done;l=u.next()){var h=l.value;if(t(h))try{var d=new c.ChunkIterator(e);for(a=d.next();a;)h.send(a.toArrayBuffer()),a=d.next();o++}catch(t){this._logger.errorIf(s.Environment.isDevelopment,"broadcast message error for connection "+h.uuid,{e:t,conn:h,data:e,c:a})}}}catch(e){n={error:e}}finally{try{l&&!l.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}return o},e.prototype.dispose=function(){this._unbindEvents(),o.Destructor.destroyObject(this)},e.prototype.initialize=function(){this.chunks={},this._bindEvents()},e.prototype.read=function(e,t){var n=this,i=e.uuid,o=t.id,s=this.chunks[i]||null;s||(s={},this.chunks[i]=s);var a=s[o]||null;if(!a){a=new l.ChunkReader,s[o]=a;var c=new d.ServerP2PRequest(o,a),h=new f.ServerP2PResponse(o,t.meta.isNeedAnswer,e);c.connectionId=i,c.onLoad=function(){return r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return delete(s||{})[o],this.onRequest?[4,this.onRequest(c,h)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}}try{a.read(t)}catch(e){a.error(e),r.__awaiter(n,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return this.backend?[4,this.backend.error(u.TimeSpan.now,e)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}},e.prototype.handleMessage=function(e,t){var n=h.P2PDataChunk.fromBuffer(e);n.meta.isResponse?this.onResponse&&this.onResponse(n):this.read(t,n)},e.prototype.handleAppend=function(e){var t=this;e.onMessage=function(e,n){return t.handleMessage(e,n)}},e.prototype.handleRemove=function(e){e.onMessage=void 0,delete this.chunks[e.uuid]},e.prototype._bindEvents=function(){var e=this;this.pool.onAppend=function(t){return e.handleAppend(t)},this.pool.onRemove=function(t){return e.handleRemove(t)};for(var t=this.pool.keys,n=0;n<t.length;n++){var r=this.pool.get(t[n]);r&&(r.onMessage=function(t,n){return e.handleMessage(t,n)})}},e.prototype._unbindEvents=function(){this.pool.onAppend=void 0,this.pool.onRemove=void 0;for(var e=this.pool.keys,t=0;t<e.length;t++){var n=this.pool.get(e[t]);n&&(n.onMessage=void 0)}},e}();t.P2PSocketSync=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(60),s=function(e){function t(t,n){var r=e.call(this)||this;if(r._reader=n,!t)throw new i.ArgumentNullException("id");if(!n)throw new i.ArgumentNullException("reader");return r.id=t,r._reader.onHeaders=function(e){return r._handleHeaders(e)},r._reader.onProgress=function(e,t,n){return r._handleProgress(e,t,n)},r._reader.onData=function(e){return r._handleData(e)},r}return r.__extends(t,e),t.prototype.send=function(){throw new o.UnsupportedException("server request is not supports sending")},t.prototype.abort=function(){throw new o.UnsupportedException("server request is not support aborting")},t.prototype._handleHeaders=function(e){this.headers=e,this.onHeaders&&this.onHeaders(e)},t.prototype._handleProgress=function(e,t,n){this.onProgress&&this.onProgress(e,t,n)},t.prototype._handleData=function(e){this.body=e,this._reader.onHeaders=void 0,this._reader.onData=void 0,this.onLoad&&this.onLoad()},t}(n(58).P2PRequest);t.ServerP2PRequest=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(12),s=n(4),a=n(61),u=n(261),c=function(e){function t(t,n,r){var o=e.call(this)||this;if(o._writable=n,o._conn=r,o.id=t,!t)throw new i.ArgumentNullException("id");if(!r)throw new i.ArgumentNullException("conn");return o}return r.__extends(t,e),Object.defineProperty(t.prototype,"iter",{get:function(){return this._iter||(this._iter=this._iterFunc?this._iterFunc(this):new a.ChunkIterator(this)),this._iter},enumerable:!0,configurable:!0}),t.prototype.setChunkIteratorFactory=function(e){this._iterFunc=e},t.prototype.dispose=function(){this._iter&&this._iter.dispose(),s.Destructor.destroyObject(this)},t.prototype.write=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._writable?(this.body=o.Buffer.concat(this.body||o.Buffer.empty,e),[2]):[2]}))}))},t.prototype.flush=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(n){switch(n.label){case 0:if(!this._writable)return[2];for(this.writeContentLength(),e=new u.HashChainChecksum,t=this.iter.next(e);t;)t.meta.isResponse=!0,this._conn.send(t.toArrayBuffer()),t=this.iter.next(e);return[4,Promise.resolve()];case 1:return n.sent(),[2]}}))}))},t.prototype.close=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this._writable?[4,this.flush()]:(this.dispose(),[2]);case 1:return e.sent(),this.dispose(),[2]}}))}))},t}(n(113).P2PResponse);t.ServerP2PResponse=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(98),i=function(){function e(){this._sequence=-1,this._hashChain=new r.HashChain(-1)}return e.prototype.calc=function(e){return this._sequence++,this._hashChain.add(e,this._sequence),parseInt(this._hashChain.value,16)},e}();t.HashChainChecksum=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(7),a=n(44),u=function(e){function t(t,n,r){var i=e.call(this,t,n,r)||this;return i.logger=new o.Logger("SeparatedBlackList"),i.stunInfo=new Map,n.addAppender((function(e){var t=a.default.getAvailableCount();e.register("STUN_ACTIVE_COUNT",t,!0),e.register("STUN_BLOCKED_COUNT",a.default.getCount()-t,!0)})),i}return r.__extends(t,e),t.prototype.registerConnectionTry=function(t){var n=this;t?t.stunServers.forEach((function(e){n.getStunInfo(e).connectionCount++})):e.prototype.registerConnectionTry.call(this)},t.prototype.decrementConnectionTry=function(t){var n=this;t?t.stunServers.forEach((function(e){var t=n.getStunInfo(e);t.connectionCount--,t.connectionCount<0&&(t.connectionCount=0),t.connectionErrorCount=Math.min(t.connectionErrorCount,t.connectionCount)})):e.prototype.decrementConnectionTry.call(this,t)},t.prototype.registerConnectionFail=function(t){var n=this;t?(t.stunServers.forEach((function(e){n.getStunInfo(e).connectionErrorCount++})),this.checkSeparatedBlocking(t)):e.prototype.registerConnectionFail.call(this)},t.prototype.checkSeparatedBlocking=function(e){var t=this;if(!this._isBlocked){var n=this.config.blacklistLimit/a.default.getCount()/2;e.stunServers.reduce((function(e,r){var o=t.getStunInfo(r);return o.connectionCount>=n&&o.connectionErrorCount/o.connectionCount>=t.config.blacklistErrorRate/100&&a.default.getAvailableCount()>1&&(t.logger.infoIf(i.Environment.isDevelopment,"Disable stun server",r,o),o.connectionErrorCount=0,o.connectionCount=0,a.default.disableStun([r]),e=!0),e}),!1)||this.checkBlock(this.getStunInfoAll())&&this._block()}},t.prototype.checkBlock=function(e){var t=this.config,n=Math.round(e.connectionCount?e.connectionErrorCount/e.connectionCount*100:0);return this.metrics.register("BLACKLIST_LAST_MEASUREMENT",n,!0),this.metrics.register("BLACKLIST_CONNECTION_COUNT",e.connectionCount,!0),this.metrics.register("BLACKLIST_ERROR_COUNT",e.connectionErrorCount,!0),this.recalcMaxReady(),!(this._maxReadyCount>this.config.blacklistBound)&&e.connectionCount>=t.blacklistLimit&&n>=t.blacklistErrorRate},t.prototype.getStunInfoAll=function(){var e={connectionCount:0,connectionErrorCount:0};return Array.from(this.stunInfo.values()).forEach((function(t){e.connectionCount=e.connectionCount+t.connectionCount,e.connectionErrorCount=e.connectionErrorCount+t.connectionErrorCount})),e},t.prototype.getStunInfo=function(e){var t;t=s.Runtime.isArray(e.urls)?e.urls.join():e.urls;var n=this.stunInfo.get(t);return n||(n={connectionCount:0,connectionErrorCount:0},this.stunInfo.set(t,n)),n},t}(n(263).DefaultBlacklist);t.SeparatedBlackList=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(75),o=n(4),s=n(2),a=n(8),u=n(5),c=function(){function e(e,t,n){var o=this;if(this.config=e,this.metrics=t,this.swarmStat=n,this._maxReadyCount=0,this.onBlockingDC=new i.DelegateCollection,this.logger=new s.Logger("DefaultBlacklist"),!e)throw new r.ArgumentNullException("config");this.startAt=u.TimeSpan.now,this.connectionCount=0,this.connectionErrorCount=0,this._isBlocked=!1,this.metrics.addAppender((function(e){e.register("BLACKLIST_SELF",+o._isBlocked,!0)}))}return Object.defineProperty(e.prototype,"onBlocking",{get:function(){return this.onBlockingDC.exec.bind(this.onBlockingDC)},set:function(e){this.onBlockingDC.add(e)},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.onBlockingDC.dispose(),o.Destructor.destroyObject(this)},e.prototype.isBlocked=function(){return this._isBlocked},e.prototype.registerConnectionTry=function(e){this.connectionCount++},e.prototype.decrementConnectionTry=function(e){this.connectionCount--,this.connectionCount<0&&(this.connectionCount=0),this.connectionErrorCount=Math.min(this.connectionCount,this.connectionErrorCount)},e.prototype.registerConnectionFail=function(e){this.connectionErrorCount++,this.checkBlocking()},e.prototype.forceBlock=function(e){this._isBlocked||(this.logger.debug(e),this._block())},e.prototype.recalcMaxReady=function(){this._maxReadyCount=Math.max(this._maxReadyCount,this.swarmStat.getStat().ready),this.metrics.register("BLACKLIST_MAX_READY",this._maxReadyCount,!0)},e.prototype.checkBlocking=function(){this._isBlocked||this.willBlock()&&this._block()},e.prototype.willBlock=function(){var e=this.config,t=Math.round(this.connectionErrorCount/this.connectionCount*100);return this.metrics.register("BLACKLIST_LAST_MEASUREMENT",t,!0),this.metrics.register("BLACKLIST_CONNECTION_COUNT",this.connectionCount,!0),this.metrics.register("BLACKLIST_ERROR_COUNT",this.connectionErrorCount,!0),this.recalcMaxReady(),!(this._maxReadyCount>this.config.blacklistBound)&&this.connectionCount>=e.blacklistLimit&&t>=e.blacklistErrorRate},e.prototype._block=function(){var e=this;this._isBlocked=!0,a.Timer.timeout((function(){e.onBlockingDC.exec()}),100)},e}();t.DefaultBlacklist=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(4),o=function(){function e(e,t,n,r){this._pdn=e,this._config=t,this._cache=n,this._hashes=r}return e.prototype.sendAllHavesTo=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this._config.sendOldHaves?(t=this._cache.items,[4,this._pdn.multiHave(e,t.map((function(e){return{s:e.id,tt:e.ttl/1e3|0,h:n._hashes.getBySegmentId(e.id)||"",ty:e.type,cl:e.size}})))]):[2];case 1:return r.sent(),[2]}}))}))},e.prototype.dispose=function(){i.Destructor.destroyObject(this)},e}();t.HaveSender=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(3),a=n(2),u=n(8),c=n(5),l=function(){function e(e,t,n){var r=this;if(this._pdn=e,this._meta=t,this._config=n,this._logger=new a.Logger("Heartbeat"),!e)throw new i.ArgumentNullException("pdn");if(!t)throw new i.ArgumentNullException("meta");if(!n)throw new i.ArgumentNullException("config");this._pdn.onPing=function(e,t){return r._handlePing(e,t)},this._pdn.onRequest=function(e){return r._meta.registerActivity(e.connectionId)},this._connections=[],this._timer=new u.Timer((function(){return r._handleTick()}),(function(){return r._config.heartbeatInterval})),this._timer.start()}return e.prototype.dispose=function(){this._timer&&this._timer.dispose(),this._pdn.onPing=void 0,o.Destructor.destroyObject(this)},e.prototype.add=function(e){-1===this._connections.indexOf(e)&&this._connections.push(e)},e.prototype.remove=function(e){var t=this._connections.indexOf(e);-1!==t&&this._connections.splice(t)},e.prototype.isLive=function(e){return this._isLive(this._meta.resolve(e))},e.prototype._isLive=function(e,t){return void 0===t&&(t=c.TimeSpan.now),t.rdiff(e.lastActivity)<this._config.heartbeatInterval},e.prototype._isTimeout=function(e){return e.ping>=this._config.pingLimit},e.prototype._handlePing=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(n){return this._logger.debugIf(s.Environment.isDevelopment,"_handlePing","MessageId",e.id,e),this._meta.registerActivity(e.connectionId),t.status=200,[2]}))}))},e.prototype._executePing=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:if(n=this._meta.resolve(e),this._isLive(n,t))return[2];if(this._isTimeout(n))return this.onTimeout&&this.onTimeout(e),this.remove(e),[2];i=this._pdn.ping(e),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,i.send()];case 2:return 200===r.sent().status?this._meta.registerActivity(e):this._meta.incrementPingCount(e),[3,4];case 3:return r.sent(),this._meta.incrementPingCount(e),[3,4];case 4:return[2]}}))}))},e.prototype._handleTick=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this._connections.length?(e=this._connections,t=c.TimeSpan.now,[4,Promise.all(e.map((function(e){return n._executePing(e,t)})))]):[2];case 1:return r.sent(),[2]}}))}))},e}();t.Heartbeat=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(4),o=n(267),s=function(){function e(e,t,n){void 0===n&&(n=10);var i=this;if(this._meta=t,this.count=n,!t)throw new r.ArgumentNullException("meta");if(!e)throw new r.ArgumentNullException("metrics");this._myHaves=new Array(n),this._myHavesHash=new Set,this._storage={},this._uniqPeersWithHaves=new Set,e.addAppender((function(e){var t=i.info;e.register("SWARM_SIZE_HAVE",t.WITH_HAVES).register("SWARM_SIZE_M0",t.MATCHED_0).register("SWARM_SIZE_M149",t.MATCHED_BAD).register("SWARM_SIZE_M50",t.MATCHED_50).register("SWARM_SIZE_M75",t.MATCHED_75).register("SWARM_SIZE_M95",t.MATCHED_95).register("SWARM_SIZE_M99",t.MATCHED_99)}))}return e.prototype.dispose=function(){i.Destructor.destroyObject(this._storage,!0).destroyObject(this)},Object.defineProperty(e.prototype,"info",{get:function(){return this.calcStat()},enumerable:!0,configurable:!0}),e.prototype.register=function(e,t){var n=this.getStorage(e);n.add(t,this._myHavesHash.has(t)),this._uniqPeersWithHaves.add(e),this._meta.resolve(e).match=n.value},e.prototype.registerSelf=function(e){for(var t in this._addSelfHave(e),this._storage)if(this._storage.hasOwnProperty(t)){var n=this._storage[t];n.next(),n.match(e),this._meta.resolve(t).match=n.value}},e.prototype.remove=function(e){var t=this._storage[e];t&&t.dispose(),delete this._storage[e],this._uniqPeersWithHaves.delete(e)},e.prototype.getStorage=function(e){var t=this._storage[e];return t||(t=new o.MatchStorage(this.count),this._storage[e]=t),t},e.prototype.calcStat=function(){var e={MATCHED_0:0,MATCHED_50:0,MATCHED_75:0,MATCHED_95:0,MATCHED_99:0,MATCHED_BAD:0,WITH_HAVES:this._uniqPeersWithHaves.size};for(var t in this._storage)if(this._storage.hasOwnProperty(t)){var n=this._storage[t].value;0===n&&e.MATCHED_0++,n>=50&&e.MATCHED_50++,n>=75&&e.MATCHED_75++,n>=95&&e.MATCHED_95++,n>=99&&e.MATCHED_99++,n>0&&n<50&&e.MATCHED_BAD++}return this._uniqPeersWithHaves.clear(),e},e.prototype._addSelfHave=function(e){this._myHaves.push(e),this._myHavesHash.add(e);var t=this._myHaves.shift();t&&this._myHavesHash.delete(t)},e}();t.Matcher=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=function(){function e(e){void 0===e&&(e=10),this._havesCount=e,this._currentIndex=0,this.haves=new Array(e)}return e.prototype.dispose=function(){r.Destructor.destroyObject(this)},Object.defineProperty(e.prototype,"value",{get:function(){for(var e=0,t=0,n=0;n<this.haves.length;n++)this.haves[n]&&(e++,t+=+this.haves[n].status);return 0!==e?t/e*100|0:0},enumerable:!0,configurable:!0}),e.prototype.add=function(e,t){var n=this.getMatch(e);n?n.status=t:this.haves.splice(this._currentIndex,1,{segmentId:e,status:t})},e.prototype.match=function(e){var t=this.getMatch(e);t&&(t.status=!0)},e.prototype.next=function(){this._currentIndex=(this._currentIndex+1)%this._havesCount},e.prototype.getMatch=function(e){return this.haves.find((function(t){return t&&t.segmentId===e||!1}))||null},e}();t.MatchStorage=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(1),s=n(4),a=n(3),u=n(2),c=n(7),l=n(5),h=function(){function e(e,t,n){var r=this;this.scoring=n,this._logger=new u.Logger("SWARM_METADATA"),this._items={},e.addAppender((function(e){var t=r.calcScore();e.registerIf(t.score_0>0,"SWARM_SIZE_SNA",t.score_0,!0).registerIf(t.score_4>0,"SWARM_SIZE_S4",t.score_4,!0).registerIf(t.score_5>0,"SWARM_SIZE_S5",t.score_5,!0).registerIf(t.score_6>0,"SWARM_SIZE_S6",t.score_6,!0).registerIf(t.score_7>0,"SWARM_SIZE_S7",t.score_7,!0).registerIf(t.score_8>0,"SWARM_SIZE_S8",t.score_8,!0).registerIf(t.score_9>0,"SWARM_SIZE_S9",t.score_9,!0).registerIf(t.score_10>0,"SWARM_SIZE_S10",t.score_10,!0).registerIf(t.score_11>0,"SWARM_SIZE_S11",t.score_11,!0)})),t.onScore=function(e,t){return r._handleScore(e,t)},t.onIssTrigger=function(e,t){return r._handleIssTrigger(e,t)}}return e.prototype.dispose=function(){s.Destructor.destroyObject(this._items).destroyObject(this)},e.prototype.destroy=function(e){if(!e)throw new o.ArgumentNullException("uuid");return delete this._items[e],this},e.prototype.resolve=function(e){return this._items[e]||this.init(e)},e.prototype.resolvePublicId=function(e){return this.resolve(e).connectionId},e.prototype.resolveInternalId=function(e){var t=this.findByConnectionId(e);return t&&t.uuid||""},e.prototype.getByUUId=function(e){return this._items[e]||null},e.prototype.getAll=function(){var e=this;return Object.keys(this._items).map((function(t){return e._items[t]})).filter((function(e){return!!e}))},e.prototype.findByConnectionId=function(e){var t=this._items;for(var n in t)if(t.hasOwnProperty(n)&&t[n].connectionId===e)return t[n];return null},e.prototype.findBySessionId=function(e){var t=this._items;for(var n in t)if(t.hasOwnProperty(n)&&t[n].sessionId===e)return t[n];return null},e.prototype.registerActivity=function(e){var t=this.resolve(e);t.lastActivity=l.TimeSpan.value,t.ping=0},e.prototype.registerLastHaveTime=function(e){this.resolve(e).lastHaveTime=l.TimeSpan.value},e.prototype.registerLastUtilityTime=function(e){var t=this.resolve(e);t.lastUtilityTime=l.TimeSpan.value,this._logger.debugIf(a.Environment.isDevelopment,"New LastUtilityTime for "+t.connectionId,t.lastUtilityTime)},e.prototype.incrementPingCount=function(e){this.resolve(e).ping++},e.prototype.registerIssTrigger=function(e,t){this.resolve(e).issTrigger=t},e.prototype.dropPenalties=function(e){var t=this.resolve(e);t.scoreDiffMark=0,t.matchMark=0,this._logger.debugIf(a.Environment.isDevelopment,"Drop penalties for "+t.connectionId)},e.prototype.forEach=function(e){for(var t in this._items)this._items.hasOwnProperty(t)&&e(this._items[t])},e.prototype.registerOfferTime=function(e){var t=this.getByUUId(e);t&&(t.offerTime=l.TimeSpan.value)},e.prototype.registerAnswerTime=function(e){var t=this.getByUUId(e);t&&(t.answerTime=l.TimeSpan.value)},e.prototype.init=function(e){if(!e)throw new o.ArgumentNullException("uuid");var t={uuid:e,createAt:l.TimeSpan.value,connectionId:"",sessionId:"",lastDownloadSpeed:0,lastActivity:l.TimeSpan.value,lastHaveTime:l.TimeSpan.value,mode:i.PeeringMode.Full,isChoked:!1,match:0,matchMark:0,ping:0,downloadTimeout:0,closeInstantly:!1,pdnZeroByteDownload:0,score:0,scoreDiff:0,scoreDiffMark:0,timeslot:0,edgeTimeSlot:0,lastUtilityTime:l.TimeSpan.value,timeslotLastTime:l.TimeSpan.value,issTrigger:!0,muteSegmentHash:!1,muteImpactMatcher:!0,impactMatcherCandidates:new Set,publicIp:"",isReady:!1,offerTime:0,answerTime:0};return this._items[e]=t,t},e.prototype.calcScore=function(){for(var e={score_0:0,score_4:0,score_5:0,score_6:0,score_7:0,score_8:0,score_9:0,score_10:0,score_11:0},t=this.getAll(),n=0;n<t.length;n++){var r=0,i=Math.round(t[n].score);i>3&&(r=Math.min(Math.max(i,4),11)),e["score_"+r]++}return e},e.prototype._handleScore=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return n=e.json(),t.status=n?200:400,n&&((i=this.resolve(e.connectionId)).score=n.score,i.scoreDiff=10*Math.pow(this.scoring.value-n.score,2)),[2]}))}))},e.prototype._handleIssTrigger=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){return n=e.json(),t.status=n?200:400,n&&c.Runtime.isDefined(n.issTrigger)&&this.registerIssTrigger(e.connectionId,n.issTrigger),[2]}))}))},e}();t.SwarmMetadata=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(23),s=n(4),a=n(5),u=function(){function e(e){if(this.meta=e,!e)throw new i.ArgumentNullException("meta")}return e.prototype.dispose=function(){s.Destructor.destroyObject(this)},e.prototype.checkNodrUrl=function(e){var t=this.meta.getByUUId(e);if(t&&t.nodrUrl){var n=new o.HttpRequest({method:"GET",url:t.nodrUrl,timeout:a.TimeSpan.fromSeconds(30)});r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.send()];case 1:return e.sent(),t.nodrUrlAvailable=!0,[3,3];case 2:return e.sent(),t.nodrUrlAvailable=!1,[3,3];case 3:return[2]}}))}))}},e}();t.NodrCheckService=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(271),o=n(2),s=n(44),a=function(){function e(e,t,n){var r=this;this._blacklist=e,this._config=t,this.checkStatus=!1,this.checkCount=0,this.logger=new o.Logger("RtcCheckService"),this._publicIp="",n.addAppender((function(e){e.register("RTC_DESCRIPTION",+r.checkStatus,!0)}))}return Object.defineProperty(e.prototype,"publicIp",{get:function(){return this._publicIp},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasDescription",{get:function(){return this.checkStatus},enumerable:!0,configurable:!0}),e.prototype.check=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t=this;return r.__generator(this,(function(n){switch(n.label){case 0:return 0===this._config.rtcCheckCount?[2,!0]:!this.checkStatus&&this.checkCount<this._config.rtcCheckCount?(e=this,[4,this._check()]):[3,2];case 1:e.checkStatus=n.sent(),this.checkCount++,!this.checkStatus&&this.checkCount>=this._config.rtcCheckCount&&window.setTimeout((function(){t._blacklist.forceBlock("Failed to check Rtc description")}),0),n.label=2;case 2:return[2,this.checkStatus]}}))}))},e.prototype.dispose=function(){this._blacklist=void 0,this._config=void 0},e.prototype._check=function(){return r.__awaiter(this,void 0,void 0,(function(){var e=this;return r.__generator(this,(function(t){return[2,new Promise((function(t){return r.__awaiter(e,void 0,void 0,(function(){var e,n,o,a,u,c=this;return r.__generator(this,(function(r){switch(r.label){case 0:e=!1,n=null,o=setTimeout((function(){n&&(n.close(),n=null,t(e))}),2e3),r.label=1;case 1:return r.trys.push([1,4,,5]),(n=new RTCPeerConnection({iceServers:s.default.getServers()})).onicecandidate=function(r){if(r.candidate){var s=i.extractIpV4(r.candidate.candidate);s&&!i.ipInGreySubnet(s)&&(c._publicIp=s,e=!0,clearTimeout(o),n&&(n.close(),n=null),t(e))}},n.createDataChannel("dump"),[4,n.createOffer()];case 2:return a=r.sent(),[4,n.setLocalDescription(a)];case 3:return r.sent(),[3,5];case 4:return u=r.sent(),this.logger.warn("Error in RtcCheckService",u),[3,5];case 5:return[2]}}))}))}))]}))}))},e}();t.RtcCheckService=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=/([0-9]{1,3}(\.[0-9]{1,3}){3})/;function i(e){var t=e.split(".").map((function(e){return parseInt(e,10)}));return 4!==t.length?0:(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3]}t.ipToNumber=i,t.ipInGreySubnet=function(e){var t=i(e);if(i("127.0.0.1")===t)return!0;var n=i("10.0.0.0"),r=i("10.255.255.255");if(t>=n&&t<=r)return!0;var o=i("172.16.0.0"),s=i("172.31.255.255");if(t>=o&&t<=s)return!0;var a=i("192.168.0.0"),u=i("192.168.255.255");return t>=a&&t<=u},t.extractIpV4=function(e){var t=r.exec(e);return t?t[1]:null}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(18),o=n(1),s=n(4),a=n(29),u=function(){function e(e,t,n){if(this._backend=e,this._timeslot=t,this._config=n,this.id=a.ConnectionProviderId.Backend,!e)throw new o.ArgumentNullException("backend");if(!t)throw new o.ArgumentNullException("timeslot");if(!n)throw new o.ArgumentNullException("config")}return e.prototype.dispose=function(){s.Destructor.destroyObject(this)},e.prototype.register=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._backend.registerInSwarm(e,this.ttlsCalc())];case 1:return t.sent(),[2]}}))}))},e.prototype.search=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return"ws"!==e.type?[3,2]:[4,this._backend.searchWSPeers(e.swarmSize,e.except,this.ttlsCalc())];case 1:return t=n.sent(),[3,4];case 2:return[4,this._backend.searchWebRTCPeers(e.swarmSize,e.except,this.ttlsCalc())];case 3:t=n.sent(),n.label=4;case 4:return this.onSwarm&&this.onSwarm({providerId:this.id,result:t.ids,type:t.type}),[2]}}))}))},e.prototype.ttlsCalc=function(){var e=0;if(this._config.issTimeslotDepth&&this._config.streamType===i.StreamType.LIVE){var t=Math.floor(this._timeslot.currentTimeSlotDiff/this._config.issTimeslotDepth);e=Math.round(128*(1-1/(t/128+1)))}return e},e}();t.BackendSearcher=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(1),s=n(4),a=n(3),u=n(2),c=n(5),l=n(29),h=function(){function e(e,t,n,r,i,s,a,c){var h=this;if(this._api=e,this._meta=t,this._config=n,this._searcher=r,this._scoring=i,this._buff=s,this._timeslot=a,this._timeslotCorrector=c,this.id=l.ConnectionProviderId.InSwarm,this._logger=new u.Logger("ISS.searcher"),!e)throw new o.ArgumentNullException("api");if(!t)throw new o.ArgumentNullException("meta");if(!n)throw new o.ArgumentNullException("config");if(!r)throw new o.ArgumentNullException("searcher");if(!s)throw new o.ArgumentNullException("buff");if(!a)throw new o.ArgumentNullException("timeslot");this._api.onSearch=function(e,t){return h.handleRemoteRequest(e,t)}}return e.prototype.dispose=function(){this._api.onSearch=void 0,s.Destructor.destroyObject(this)},e.prototype.search=function(e){var t=this,n=this._timeslot.currentTimeSlotDiff<=this._config.issTimeslotDepth?this._config.issQueryCount:e.swarmSize,r=this._config.issQuerySize;return this._searcher.search(n,[],(function(){return!0}),{score:this._scoring.value}).map((function(e){return t._meta.findByConnectionId(e)})).filter((function(e){return!!e})).filter((function(e){return"browser"===e.type})).forEach((function(n){return t.executeSearch(n.uuid,r,e.except)})),Promise.resolve()},e.prototype.register=function(e){return Promise.resolve()},e.prototype.executeSearch=function(e,t,n){r.__awaiter(this,void 0,void 0,(function(){var i,o,s,u;return r.__generator(this,(function(r){switch(r.label){case 0:i=this._api.search(e,t,n),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,i.send()];case 2:return o=r.sent(),s=o.json(),this.onSwarm&&s&&this.onSwarm({providerId:e,result:s.result,type:"webrtc",priorityResult:s.priorityResult}),[3,4];case 3:return u=r.sent(),this._logger.errorIf(a.Environment.isDevelopment,"search error",{e:u,uuid:e,count:t,except:n}),[3,4];case 4:return[2]}}))}))},e.prototype.handleRemoteRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,o,s,a,u,l,h,d,f,p,_,g=this;return r.__generator(this,(function(r){return(n=e.json())?(o=this._meta.resolve(e.connectionId),s=c.TimeSpan.value,a=this._timeslotCorrector.getCorrection.bind(this._timeslotCorrector),u=o.score,l=o.timeslot+a(o,s),i.WorkMode.checkFullPM(o.mode)?h=this.getFilterForFullPM(s,u,l,this._config.scoreDiffInterval,this._config.issTimeslotDepth,a):i.WorkMode.checkDownloadPM(o.mode)?h=this.getFilterForDownloadPM(s,u,l,this._config.scoreDiffInterval,this._config.issTimeslotDepth,a):i.WorkMode.checkUploadPM(o.mode)&&(h=this.getFilterForUploadPM(s,u,l,this._config.scoreDiffInterval,this._config.issTimeslotDepth,a)),h?(d=o.connectionId,f=o.timeslot+a(o,s),p=this._searcher.search(n.count,[].concat(d,n.except),h,{timeslot:f}),_=p.map((function(e){var t=g._meta.findByConnectionId(e),n=NaN;return t&&(n=Math.abs(f-(t.timeslot+a(t,s)))),{id:e,priority:g._getPriority(n)}})),t.writeJSON({result:p,priorityResult:_}),[2]):[2]):[2]}))}))},e.prototype._getPriority=function(e){return e?Math.round(4*(1-1/(e/8+1))):4},e.prototype.getFilterForFullPM=function(e,t,n,r,i,o){return function(s){if(!s)return!1;if(!s.issTrigger)return!1;var a=s.timeslot+o(s,e);return!(10*Math.pow(s.score-t,2)>r)&&(!i||a<=n+i&&a>=n-i)}},e.prototype.getFilterForDownloadPM=function(e,t,n,r,o,s){return function(a){if(!a)return!1;if(!a.issTrigger)return!1;var u=a.timeslot+s(a,e);if(10*Math.pow(a.score-t,2)>r)return!1;var c=i.WorkMode.checkUploadPM(a.mode)&&u>n;return o?c&&u<=n+o:c}},e.prototype.getFilterForUploadPM=function(e,t,n,r,o,s){return function(a){if(!a)return!1;if(!a.issTrigger)return!1;var u=a.timeslot+s(a,e);if(10*Math.pow(a.score-t,2)>r)return!1;var c=i.WorkMode.checkDownloadPM(a.mode)&&u<n;return o?c&&u>=n-o:c}},e}();t.DefaultInSwarmSearcher=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(7),o=n(5),s=function(e){function t(t,n,r,i){return e.call(this,t,n,r,i)||this}return r.__extends(t,e),t.prototype.search=function(t,n,r,o){void 0===r&&(r=function(){return!0}),void 0===o&&(o={});var s=o.timeslot,a=o.timeslotTricky;return i.Runtime.isUndefined(s)||!0!==a?e.prototype.search.call(this,t,n,r,o):this._search(t,n,r,o)},t.prototype.getSortCompareFunction=function(e){var t=e.timeSlotCorrection||function(){return 0},n=e.now?e.now.value:o.TimeSpan.value,r=e.timeslot||0;return function(e,i){var o=Math.abs(e.timeslot+t(e,n)-r),s=Math.abs(i.timeslot+t(i,n)-r);return o===s?0:0===o?1:0===s?-1:o-s}},t}(n(275).TimeslotDiffMaxFirstSearchService);t.TimeslotTrickySearchService=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(7),o=n(5),s=function(e){function t(t,n,r,i){return e.call(this,t,n,r,i)||this}return r.__extends(t,e),t.prototype.search=function(t,n,r,o){void 0===r&&(r=function(){return!0}),void 0===o&&(o={});var s=o.timeslot,a=o.timeslotDiffMaxFirst;return i.Runtime.isUndefined(s)||!0!==a?e.prototype.search.call(this,t,n,r,o):this._search(t,n,r,o)},t.prototype.getSortCompareFunction=function(e){var t=e.timeSlotCorrection||function(){return 0},n=e.now?e.now.value:o.TimeSpan.value,r=e.timeslot||0;return function(e,i){return Math.abs(i.timeslot+t(i,n)-r)-Math.abs(e.timeslot+t(e,n)-r)}},t}(n(276).TimeslotSearchService);t.TimeslotDiffMaxFirstSearchService=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(7),o=n(5),s=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r)||this;return o.timeSlotCorrector=i,o}return r.__extends(t,e),t.prototype.search=function(t,n,r,o){void 0===r&&(r=function(){return!0}),void 0===o&&(o={});var s=o.timeslot;return i.Runtime.isUndefined(s)?e.prototype.search.call(this,t,n,r,o):(o.timeSlotCorrection=this.timeSlotCorrector.getCorrection.bind(this.timeSlotCorrector),this._search(t,n,r,o))},t.prototype.getSortCompareFunction=function(e){var t=e.timeSlotCorrection||function(){return 0},n=e.now?e.now.value:o.TimeSpan.value,r=e.timeslot||0;return function(e,i){return Math.abs(e.timeslot+t(e,n)-r)-Math.abs(i.timeslot+t(i,n)-r)}},t}(n(277).ScoreSearchService);t.TimeslotSearchService=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(7),o=function(e){function t(t,n,r){return e.call(this,t,n,r)||this}return r.__extends(t,e),t.prototype.search=function(t,n,r,o){void 0===r&&(r=function(){return!0}),void 0===o&&(o={});var s=o.score;return i.Runtime.isUndefined(s)?e.prototype.search.call(this,t,n,r,o):this._search(t,n,r,o)},t.prototype.getSortCompareFunction=function(e){var t=e.score||0;return function(e,n){return Math.pow(e.score-t,2)-Math.pow(n.score-t,2)}},t}(n(278).SearchService);t.ScoreSearchService=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(5),a=function(){function e(e,t,n){if(this._meta=e,this._pool=t,this._config=n,!e)throw new i.ArgumentNullException("meta");if(!t)throw new i.ArgumentNullException("pool");if(!n)throw new i.ArgumentNullException("config")}return e.prototype.dispose=function(){o.Destructor.destroyObject(this)},e.prototype.search=function(e,t,n,r){return void 0===n&&(n=function(){return!0}),void 0===r&&(r={}),this._search(e,t,n,r)},e.prototype._search=function(e,t,n,r){void 0===r&&(r={});var i=[],o=s.TimeSpan.now;return this.fillGoodPeers(i,o,t,n),r.now=o,i.sort(this.getSortCompareFunction(r)).slice(0,e).map((function(e){return e.connectionId}))},e.prototype.getSortCompareFunction=function(e){return function(e,t){return t.match-e.match||t.lastDownloadSpeed-e.lastDownloadSpeed}},e.prototype.fillGoodPeers=function(e,t,n,i){var o,s;void 0===i&&(i=function(){return!0});try{for(var a=r.__values(this._pool),u=a.next();!u.done;u=a.next()){var c=u.value;if(c.ready){var l=this._meta.getByUUId(c.uuid);this.isGoodCandidate(l,t,n,i)&&e.push(l)}}}catch(e){o={error:e}}finally{try{u&&!u.done&&(s=a.return)&&s.call(a)}finally{if(o)throw o.error}}},e.prototype.isGoodCandidate=function(e,t,n,r){if(!e)return!1;var i=t.rdiff(e.lastActivity)<this._config.heartbeatInterval,o=n.indexOf(e.connectionId)>-1;return i&&!o&&(!r||r(e))},e}();t.SearchService=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),i=n(1),o=n(4),s=n(29),a=function(){function e(e){var t=this;if(this._backend=e,this.id=s.ConnectionProviderId.Backend,!e)throw new i.ArgumentNullException("backend");this._backend.onSdp=function(e,n){return t._handleSdp(e,n)}}return e.prototype.dispose=function(){this._backend.onSdp=void 0,o.Destructor.destroyObject(this)},e.prototype.signal=function(e,t,n,i){if(e!==this.id)throw new r.ArgumentException("providerId");return this._backend.signal(t,n,i)},e.prototype._handleSdp=function(e,t){this.onSdp&&this.onSdp(this.id,e,t)},e}();t.BackendSignaller=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(3),a=n(2),u=n(29),c=function(){function e(e,t,n){var r=this;if(this._api=e,this._meta=t,this._session=n,this.id=u.ConnectionProviderId.InSwarm,this._logger=new a.Logger("iss.signaller"),!e)throw new i.ArgumentNullException("api");if(!t)throw new i.ArgumentNullException("meta");if(!n)throw new i.ArgumentNullException("session");this._api.onSdp=function(e,t){return r._handleSdp(e,t)}}return e.prototype.dispose=function(){this._api.onSdp=void 0,o.Destructor.destroyObject(this)},e.prototype.signal=function(e,t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var o,a;return r.__generator(this,(function(r){switch(r.label){case 0:this._logger.debug("send signal",e,t,n,i),o=this._api.signal(e,t,n,i),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,o.send()];case 2:return r.sent(),[3,4];case 3:return a=r.sent(),this._logger.errorIf(s.Environment.isDevelopment,"signal error",{e:a,providerId:e,sender:t,receiver:n,data:i}),[3,4];case 4:return[2]}}))}))},e.prototype._handleSdp=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:if(!(t=e.json()))return[2];if(this._logger.debug("receive sdp",t),e.connectionId&&t.from&&t.signal||this._logger.errorIf(s.Environment.isDevelopment,"Incorrect Sdp data",e.connectionId,t.from,t.signal),t.to===this._session.connectionId)return e.connectionId&&t.from&&t.signal?(this._logger.debug("handle sdp local",t),this.onSdp&&this.onSdp(e.connectionId,t.from,t.signal),[2]):(this._logger.errorIf(s.Environment.isDevelopment,"Incorrect incoming Sdp data","connectionId::",e.connectionId,"from::",t.from,"signal::",t.signal),[2]);if(!(n=this._meta.findByConnectionId(t.to)))return[3,4];if(!(n.uuid&&t.from&&t.signal&&t.to))return this._logger.errorIf(s.Environment.isDevelopment,"Incorrect outgoing Sdp data","uuid::",n.uuid,"from::",t.from,"to::",t.to,"signal::",t.signal),[2];i=this._api.signal(n.uuid,t.from,t.to,t.signal),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,i.send()];case 2:return r.sent(),[3,4];case 3:return o=r.sent(),this._logger.errorIf(s.Environment.isDevelopment,"resend error",{e:o,meta:n,data:t}),[3,4];case 4:return[2]}}))}))},e}();t.InSwarmSignaller=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(3),a=n(2),u=n(57),c=n(5),l=function(){function e(e,t){var n=this;if(this._pdn=e,this._meta=t,this.PROBE_SIZE=256e3,this._logger=new a.Logger("SpeedTester"),!e)throw new i.ArgumentNullException("pdn");if(!t)throw new i.ArgumentNullException("meta");e.onSpeedtest=function(e,t){return n.handleIncomingSpeedtest(e,t)}}return e.prototype.dispose=function(){this._pdn.onSpeedtest=void 0,o.Destructor.destroyObject(this)},e.prototype.test=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o,a,l,h,d;return r.__generator(this,(function(r){switch(r.label){case 0:t=c.TimeSpan.now,n=this._pdn.speedtest(e,this.PROBE_SIZE),i=this._meta.getByUUId(e),o="",o=i?i.connectionId:e,a=0,n.onProgress=function(e){a+=e.data.byteLength},r.label=1;case 1:return r.trys.push([1,3,,4]),[4,n.send()];case 2:return l=r.sent(),h=u.Speed.calc(l.body&&l.body.byteLength||0,t.diff()),this._logger.infoIf(s.Environment.isDevelopment,"New speed for "+o,h),this._logger.infoIf(s.Environment.isDevelopment,"loaded bytes "+o,a),[2,h];case 3:return d=r.sent(),this._logger.errorIf(s.Environment.isDevelopment,"Error speedtest "+o,d),this._logger.infoIf(s.Environment.isDevelopment,"loaded bytes "+o,a),[2,u.Speed.calc(a,n.timeout.value)];case 4:return[2]}}))}))},e.prototype.getAvgSpeed=function(){var e=0,t=0;return this._meta.forEach((function(n){n.lastDownloadSpeed>0&&(e+=n.lastDownloadSpeed,t++)})),t>0?e/t:0},e.prototype.handleIncomingSpeedtest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return n=e.json(),[4,t.write(new ArrayBuffer(n&&n.size||this.PROBE_SIZE))];case 1:return r.sent(),[2]}}))}))},e}();t.SpeedTester=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(18),s=n(13),a=n(17),u=n(4),c=n(2),l=n(7),h=n(5),d=n(77),f=function(e){function t(t,n,r,i,o,s,a,u,l,h){var d=e.call(this,t,n,r,i,o,s,a,u,l,h)||this;return d.logger=new c.Logger("DefaultPeerConnectionStrategy"),d}return r.__extends(t,e),t.prototype.dispose=function(){u.Destructor.destroyObject(this)},t.prototype.isCompatibleMode=function(e){return!(this._config.peeringMode===i.PeeringMode.Off||e===i.PeeringMode.Off||e===i.PeeringMode.Upload&&e===this._config.peeringMode||e===i.PeeringMode.Download&&e===this._config.peeringMode)},t.prototype.canWebRtcConnect=function(e){var t=this._meta.resolveInternalId(e);return!!e&&this._session.connectionId!==e&&this._back.isConnected&&!this._pool.contains(t)&&!this._blacklist.isBlocked()&&s.Bitmask.check(this._config.availablePdnTransport,o.AvailablePdnTransport.WEBRTC)},t.prototype.canDisconnect=function(e,t){var n,r=this._meta.resolve(e);return n=this.checkDisconnectReasonNone(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonNoActivity(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonNoPeering(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonNoMatching(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonBadScore(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonManyDownloadTimeout(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonManyPdnZeroByteDownloads(r,t),l.Runtime.isNull(n)?(n=this.checkDisconnectReasonLowSpeed(r,t),l.Runtime.isNull(n)?(r.match>=this._config.matchLimit&&(r.matchMark=0),d.RTCDisconnectReason.None):n):n):n):n):n):n):n):n},t.prototype.isCounterOffer=function(e,t){return!(!this._pool.contains(t)||this.willProcessOffer(e)&&(this._pool.remove(t),1))},t.prototype.canIssSearch=function(){return this.isConnectable()&&!this._blacklist.isBlocked()&&this._wm.isNotOff()&&!this._wm.isSilent()&&!this.isOverflow()},t.prototype.canSrvWebRtcSearch=function(){return this.isConnectable()&&!this._blacklist.isBlocked()&&this._wm.hasDownload()&&!this._wm.isSilent()&&!this.isOverflow()&&s.Bitmask.check(this._config.availablePdnTransport,o.AvailablePdnTransport.WEBRTC)},t.prototype.canSrvWsSearch=function(){return(!this._rtcCheckService.hasDescription||this._blacklist.isBlocked())&&this._config.active&&this._wm.hasDownload()&&!this._wm.isSilent()&&!this.isOverflow()&&s.Bitmask.check(this._config.availablePdnTransport,o.AvailablePdnTransport.WS)},t.prototype.canRegisterInSwarm=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return(t=this.isConnectable()&&!this._blacklist.isBlocked()&&this._wm.hasUpload()&&!this._wm.isSilent()&&e/Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota)<=.8)?[4,this._rtcCheckService.check()]:[3,2];case 1:t=n.sent(),n.label=2;case 2:return[2,t]}}))}))},t.prototype.willProcessOffer=function(e){return a.Convert.toInt((this._session.connectionId||"").substr(8,8))<a.Convert.toInt(e.substr(8,8))},t.prototype.checkDisconnectReasonNone=function(e,t){var n=d.RTCDisconnectReason.None;if(t.has(n))return null;var r=h.TimeSpan.now,i=e.lastUtilityTime,o=r.rdiff(e.lastUtilityTime);return this.logger.debug("Calculate utility time "+e.connectionId),this.logger.debug("now="+r+", ltu="+i+", diff="+o+", "+(o<this._config.maxUtilityTime)),o<this._config.maxUtilityTime?n:null},t.prototype.checkDisconnectReasonNoActivity=function(e,t){var n=d.RTCDisconnectReason.NoActivity;return t.has(n)?null:h.TimeSpan.now.rdiff(e.lastHaveTime)>this._config.lastActivityLimit?d.RTCDisconnectReason.NoActivity:null},t.prototype.checkDisconnectReasonNoPeering=function(e,t){var n=d.RTCDisconnectReason.NoPeering;return t.has(n)?null:i.WorkMode.checkOffPM(e.mode)?n:null},t.prototype.checkDisconnectReasonNoMatching=function(e,t){var n=d.RTCDisconnectReason.NoMatching;if(t.has(n))return null;var r=Math.max(this._config.matchLimit-100*this._tsh.currentTimeSlotDiff/this._config.matcherSize,10),i=null;return e.match<r?++e.matchMark>=this._config.matchLimitCount&&(i=n):e.matchMark=Math.max(0,e.matchMark-1),i},t.prototype.checkDisconnectReasonBadScore=function(e,t){var n=d.RTCDisconnectReason.BadScore;if(t.has(n))return null;var r=null;return e.scoreDiff>this._config.scoreDiffInterval?++e.scoreDiffMark>=this._config.scoreDiffCount&&(r=n):e.scoreDiffMark=Math.max(0,e.scoreDiffMark-1),r},t.prototype.checkDisconnectReasonManyDownloadTimeout=function(e,t){var n=d.RTCDisconnectReason.ManyDownloadTimeout;return t.has(n)?null:this._config.downloadTimeoutLimit&&e.downloadTimeout>=this._config.downloadTimeoutLimit?n:null},t.prototype.checkDisconnectReasonManyPdnZeroByteDownloads=function(e,t){var n=d.RTCDisconnectReason.ManyPdnZeroByteDownloads;return t.has(n)?null:this._config.pdnZeroByteDownloadLimit&&e.pdnZeroByteDownload>=this._config.pdnZeroByteDownloadLimit?n:null},t.prototype.checkDisconnectReasonLowSpeed=function(e,t){var n=d.RTCDisconnectReason.LowSpeed;return t.has(n)?null:this._config.p2pSpeedThreshold&&1024*e.lastDownloadSpeed<this._config.p2pSpeedThreshold?n:null},t}(n(115).NoWebRtcPeerConnectionStrategy);t.DefaultPeerConnectionStrategy=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(67),a=n(5),u=n(29),c=function(e){function t(t,n,r,o,s,a,u,c,l,h,d,f){var p=e.call(this)||this;if(p._pool=t,p._metrics=n,p._meta=r,p._blacklist=o,p._matcher=s,p._heartbeat=a,p._haves=u,p._speedtest=c,p._haveSender=l,p._config=h,p._issTrigger=d,p._backend=f,p._currentExcludeIndex=0,!t)throw new i.ArgumentNullException("pool");if(!n)throw new i.ArgumentNullException("metrics");if(!r)throw new i.ArgumentNullException("meta");if(!o)throw new i.ArgumentNullException("blacklist");if(!s)throw new i.ArgumentNullException("matcher");if(!a)throw new i.ArgumentNullException("heartbeat");if(!u)throw new i.ArgumentNullException("haves");if(!l)throw new i.ArgumentNullException("haveSender");if(!h)throw new i.ArgumentNullException("config");if(!d)throw new i.ArgumentNullException("issTrigger");if(!f)throw new i.ArgumentNullException("backend");return p._excludes=Array(p._config.swarmSizeExludes),p._blacklist.onBlocking=function(){return p.resetConnections()},p._heartbeat.onTimeout=function(e){return p._handleHeartbeatTimeout(e)},p}return r.__extends(t,e),Object.defineProperty(t.prototype,"excludes",{get:function(){return this._excludes.filter((function(e){return!!e}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pool",{get:function(){return this._pool},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._heartbeat.onTimeout=void 0,o.Destructor.destroyObject(this)},t.prototype.addConnection=function(e){var t=this._meta.resolve(e.uuid);e.providerId!==u.ConnectionProviderId.Backend&&!this._config.useIssSdpInBlacklist||t.closeInstantly||this._blacklist.registerConnectionTry(e),this._metrics.registerIf(!t.closeInstantly,"RTC_CONNECTION_CREATED"),this._bindRtcEvents(e),this._pool.add(e),this._issTrigger.update(this._pool.size)},t.prototype.removeConnection=function(e,t){void 0===t&&(t=!0),this._pool.remove(e.uuid,t),this._issTrigger.update(this._pool.size),this._meta.destroy(e.uuid),this._matcher.remove(e.uuid),this._heartbeat.remove(e.uuid),this._haves.removeByConnectionId(e.uuid)},t.prototype.rejectConnection=function(e){this._blacklist.decrementConnectionTry(e)},t.prototype.removeConnectionById=function(e,t){var n=this._pool.get(e);return n?(this.removeConnection(n,t),!0):(this._meta.destroy(e),this._matcher.remove(e),this._heartbeat.remove(e),this._haves.removeByConnectionId(e),!1)},t.prototype.resetConnections=function(){return this._pool.close(),Promise.resolve()},t.prototype.getConnection=function(e){return this._pool.get(e)||null},t.prototype._bindRtcEvents=function(e){var t=this;e.onOpened=function(e){return t._handleRtcOpened(e)},e.onClosed=function(e){return t._handleRtcClosed(e)},e.onError=function(e,n){return t._handleRtcError(e,n)},e.onReady=function(e){return t._handleRtcReady(e)},e.onTimeout=function(e){return t._handleRtcTimeout(e)}},t.prototype._unBindRtcEvents=function(e){e.onSignal=void 0,e.onReady=void 0,e.onClosed=void 0,e.onError=void 0,e.onMessage=void 0,e.onOpened=void 0,e.onTimeout=void 0},t.prototype._handleRtcOpened=function(e){this._metrics.register("RTC_CONNECTION_OPENED"),this.onConnected&&this.onConnected(this._meta.resolvePublicId(e.uuid))},t.prototype._handleRtcError=function(e,t){var n=this._meta.resolve(t.uuid);t.providerId!==u.ConnectionProviderId.Backend&&!this._config.useIssSdpInBlacklist||n.closeInstantly||t.wasReady||this._blacklist.registerConnectionFail(t),this._metrics.register("RTC_CONNECTION_ERROR");var i=this._meta.resolvePublicId(t.uuid);this._addToExclude(i),this.onError&&this.onError(i,e),"ws"===t.type&&r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this._backend.error(a.TimeSpan.now,{type:"wsConnectionError",id:n.connectionId,url:n.nodrUrl})];case 1:return e.sent(),[2]}}))})),this._unBindRtcEvents(t),this.removeConnection(t)},t.prototype._handleRtcClosed=function(e){this._meta.resolve(e.uuid).closeInstantly?this._metrics.register("RTC_CONNECTION_INSTANTLY_CLOSED"):this._metrics.register("RTC_CONNECTION_CLOSED"),this.onDisconnected&&this.onDisconnected(this._meta.resolvePublicId(e.uuid)),this._unBindRtcEvents(e),this.removeConnection(e,!1)},t.prototype._handleRtcReady=function(e){var t=this._meta.resolve(e.uuid);if(t.closeInstantly)return this._metrics.register("RTC_CONNECTION_INSTANTLY_CLOSE_READY"),void e.close();t.isReady=!0,this._blacklist.recalcMaxReady(),this._executeSpeedTest(e.uuid),this._heartbeat.add(e.uuid),this._metrics.register("RTC_CONNECTION_READY").register("RTC_CONNECTION_READY_TIME",e.createAt.diff()),this._executeOldHavesSend(e.uuid),this.onReady&&this.onReady(this._meta.resolvePublicId(e.uuid)),this.emit("connectionReady",{uuid:t.uuid},!0)},t.prototype._handleRtcTimeout=function(e){var t=this._meta.resolve(e.uuid);e.providerId!==u.ConnectionProviderId.Backend&&!this._config.useIssSdpInBlacklist||t.closeInstantly||this._blacklist.registerConnectionFail(e),this._metrics.register("RTC_CONNECTION_TIMEOUT");var n=this._meta.resolvePublicId(e.uuid);this._addToExclude(n),this.onTimeout&&this.onTimeout(n),this._unBindRtcEvents(e),this.removeConnection(e)},t.prototype._handleHeartbeatTimeout=function(e){this.removeConnectionById(e,!0),this._metrics.register("RTC_CLOSED_BYPING")},t.prototype._executeSpeedTest=function(e){r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(n){switch(n.label){case 0:return[4,this._speedtest.test(e)];case 1:return(t=n.sent())>0&&(this._meta.resolve(e).lastDownloadSpeed=t),[2]}}))}))},t.prototype._executeOldHavesSend=function(e){r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._haveSender.sendAllHavesTo(e)];case 1:return t.sent(),[2]}}))}))},t.prototype._addToExclude=function(e){e&&(this._excludes.indexOf(e)>-1||(this._excludes[this._currentExcludeIndex++]=e,this._currentExcludeIndex>=this._excludes.length&&(this._currentExcludeIndex=0)))},t}(s.SimpleEventEmitter);t.Swarm=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(116),o=n(119),s=n(3),a=n(2),u=n(7),c=n(53),l=n(8),h=n(44),d=n(29),f=n(289),p=function(e){function t(t,n,r,i,o,s,u,c,h,d,p){var _=e.call(this,t,n,r,i,o,s,u,c,h,d,p)||this;return _._conQueues=new f.ConnectionsQueue,_._log=new a.Logger("QUEUE_SWARM_BUILDER"),_._connectTimer=new l.Timer((function(){return _.handlerConnTimerTick()}),(function(){return _._config.outgoingConnDelay}),!0),_._connectTimer.start(),_}return r.__extends(t,e),t.prototype.dispose=function(){this._connectTimer&&this._connectTimer.dispose(),e.prototype.dispose.call(this)},t.prototype.handleRemoteSwarm=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o=this;return r.__generator(this,(function(r){return t=0,n=e.providerId===d.ConnectionProviderId.Backend,i=[],u.Runtime.isArray(e.priorityResult)?(this._log.debugIf(s.Environment.isDevelopment,"Handled priority result",e.priorityResult),t=e.priorityResult.length,i=e.priorityResult.map((function(t){return{id:c.StringUtils.padStart(t.id,16,"0"),isBackendProvider:n,providerId:e.providerId,type:e.type,priority:t.priority}}))):(this._log.debugIf(s.Environment.isDevelopment,"Handled simple result",e.result),t=e.result.length,i=e.result.map((function(t){return{id:c.StringUtils.padStart(t,16,"0"),isBackendProvider:n,providerId:e.providerId,type:e.type,priority:0}}))),i.forEach((function(e){return o._conQueues.append(e.priority,e)})),t&&this._connectTimer.isStopped&&this._connectTimer.start(1),this._metrics.registerIf(n,"SRV_SWARM_RECEIVE").registerIf(!n,"ISS_SWARM_RECEIVE").registerIf(n,"SRV_SWARM_SUM_RECEIVE",t).registerIf(!n,"ISS_SWARM_SUM_RECEIVE",t),[2]}))}))},t.prototype.handlerConnTimerTick=function(){var e=this._conQueues.length;if(!e)return this._log.debugIf(s.Environment.isDevelopment,"Queue is empty"),void this._connectTimer.stop();this._log.debugIf(s.Environment.isDevelopment,"Queue size is",e,", Meta size is",this._meta.getAll().length);var t=this._conQueues.getNext();if(t){if(!this._strategy.isConnectable())return this._metrics.register("SWARM_STRATEGY_SKIPPED"),this._log.debugIf(s.Environment.isDevelopment,"No connect to signal, clear queue"),void this._conQueues.clear();if(this._strategy.isNoEmptySlots())return this._metrics.register("SWARM_OVERFLOW_QUERY"),this._log.debugIf(s.Environment.isDevelopment,"No empty slots, clear queue"),void this._conQueues.clear();if(this._strategy.isDoubleConnect(t.id))this._metrics.register("RTC_CONNECTION_DOUBLE"),this._log.debugIf(s.Environment.isDevelopment,"Candidate is double, do not open connect");else if(h.default.canOpen(this._session.connectionId,t.id))if(this._strategy.canWebRtcConnect(t.id)||this._strategy.canWsConnect(t.id)){var n=null;"webrtc"===t.type&&this._strategy.canWebRtcConnect(t.id)?n=i.WebRtcConnectionFactory.createConnection(t.providerId,this._session.connectionId,t.id):"ws"===t.type&&this._strategy.canWsConnect(t.id)&&(n=o.WSPeerConnectionFactory.createConnection(t.providerId)),n&&this._addConnection(n,t.id)}else this._metrics.registerIf(t.isBackendProvider,"SRV_SWARM_SKIPPED").registerIf(!t.isBackendProvider,"ISS_SWARM_SKIPPED");else this._metrics.registerIf(t.isBackendProvider,"SRV_SWARM_SKIPPED_STUN_DISABLE").registerIf(!t.isBackendProvider,"ISS_SWARM_SKIPPED_STUN_DISABLE"),this._log.debugIf(s.Environment.isDevelopment,"Candidate is on disabled stun, do not open connect")}else this._log.errorIf(s.Environment.isDevelopment,"Can't get next candidate")},t}(n(290).SwarmBuilder);t.QueueSwarmBuilder=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n){var r=e.call(this,t+" is not implemented",n)||this;return r.name="NotImplementedException",r}return r.__extends(t,e),t}(n(11).Exception);t.NotImplementedException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(19),o=n(1),s=n(11),a=n(4),u=n(3),c=n(2),l=n(7),h=n(8),d=n(5),f=n(118),p=n(287),_=function(){function e(e,t,n){if(this.providerId=t,this.stunServers=n,this.type="rtc",this.uuid=f.UUID.generate(),this.createAt=d.TimeSpan.now,this._flags=p.WebRtcConnectionState.Inited,this._wasReady=!1,!t)throw new o.ArgumentNullException("providerId");this._initiator=e,this._logger=new c.Logger("webrtc#"+this.uuid),this._candidates=[]}return Object.defineProperty(e.prototype,"ready",{get:function(){return this._channel&&"open"===this._channel.readyState||!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wasReady",{get:function(){return this._wasReady},enumerable:!0,configurable:!0}),e.prototype.send=function(e){try{return this._send(e),!0}catch(e){return this._logger.warnIf(u.Environment.isDevelopment,"send error:",s.Exception.fromNativeError(e),this),!1}},e.prototype.close=function(e,t){this._timer&&(this._timer.dispose(),this._timer=void 0),this.unbindChannelEvents(),this.unbindConnectionEvents();try{this._channel&&this._channel.close()}catch(e){c.Logger.errorIf(u.Environment.isDevelopment,"close datachannel error",e)}finally{this._channel=null}try{this._connection&&this._connection.close()}catch(e){c.Logger.errorIf(u.Environment.isDevelopment,"close connection error",e)}finally{this._connection=null}this._candidates=[],this._flags=p.WebRtcConnectionState.ConnectionClosed|p.WebRtcConnectionState.ChannelClosed,this.onClosed&&this.onClosed(this),this.onMessage=void 0,this.onOpened=void 0,this.onReady=void 0,this.onError=void 0,this.onClosed=void 0,this.onSignal=void 0},e.prototype.openWithOffer=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(n){switch(n.label){case 0:if(!this._initiator)throw new s.Exception("openWithOffer available only for initiator connection type");return(e=this.createConnection())?(this.createDataChannel(),[4,e.createOffer()]):[3,3];case 1:return t=n.sent(),[4,e.setLocalDescription(t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))},e.prototype.openWithAnswer=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:if(this._initiator)throw new s.Exception("openWithAnswer is not available for non-initiator connection type");if("offer"!==e.type)throw new i.ArgumentException("data",JSON.stringify(e));return(t=this.createConnection())?[4,t.setRemoteDescription(new RTCSessionDescription(e.offer))]:[3,4];case 1:return r.sent(),[4,t.createAnswer()];case 2:return n=r.sent(),[4,t.setLocalDescription(n)];case 3:r.sent(),r.label=4;case 4:return[2]}}))}))},e.prototype.registerSignal=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,s,a,u,c,l,h=this;return r.__generator(this,(function(d){switch(d.label){case 0:if(!e||!e.type)throw new o.ArgumentNullException("signal",JSON.stringify(e));if(!this._connection)throw new o.ArgumentNullException("RTCPeerConnection");switch(e.type){case"answer":return[3,1];case"candidate":return[3,3];case"reject":return[3,11]}return[3,12];case 1:return s=new RTCSessionDescription(e.answer),[4,this._connection.setRemoteDescription(s)];case 2:return d.sent(),this._flags|=p.WebRtcConnectionState.AnswerReceive,this._fireCandidates(),[3,13];case 3:d.trys.push([3,8,9,10]),a=r.__values(e.candidates),u=a.next(),d.label=4;case 4:return u.done?[3,7]:(c=u.value,[4,this._connection.addIceCandidate(new RTCIceCandidate(c))]);case 5:d.sent(),d.label=6;case 6:return u=a.next(),[3,4];case 7:return[3,10];case 8:return l=d.sent(),t={error:l},[3,10];case 9:try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}return[7];case 10:return this._flags|=p.WebRtcConnectionState.IceCandidateReceive,this._fireCandidates(),[3,13];case 11:return setTimeout((function(){return h.close()})),[3,13];case 12:throw new i.ArgumentException("signal",JSON.stringify(e));case 13:return[2]}}))}))},e.prototype.dispose=function(){this._logger.debug("dispose",this),this.onClosed=void 0,this.close(),a.Destructor.destroyObject(this)},e.prototype.setConnectionTimeout=function(e,t){var n=this;void 0===t&&(t=!0),this._timer&&this._timer.dispose(),e instanceof d.TimeSpan&&0===e.value||l.Runtime.isSafeNumber(e)&&0===e||(this._timer=new h.Timer((function(){return n.handleTimer(t)}),e,!1),this._timer.start())},e.prototype.createConnection=function(){try{this._connection=new RTCPeerConnection(this.getRtcConfig()),this.bindConnectionEvents()}catch(e){this._connection=null}return this._connection},e.prototype.createDataChannel=function(){var e=this._connection;if(!e)throw new o.ArgumentNullException("connection");var t=e.createDataChannel(this.uuid,{ordered:!0});t.binaryType="arraybuffer",l.Runtime.isNumber(t.bufferedAmountLowThreshold)&&(t.bufferedAmountLowThreshold=65536),this._channel=t,this.bindChannelEvents()},e.prototype.handleTimer=function(e){!this.uuid||this.uuid&&this.ready||(this.onTimeout&&this.onTimeout(this),e&&this.close())},e.prototype.bindConnectionEvents=function(){var e=this,t=this._connection;t&&(t.onicecandidate=function(t){return e.handleIceCandidate(t)},t.oniceconnectionstatechange=function(){return e.handleIceConnectionStateChange()},t.onicegatheringstatechange=function(){return e.handleIceGatheringState()},this._initiator||(t.ondatachannel=function(t){return e.handleDataChannel(t)}))},e.prototype.unbindConnectionEvents=function(){var e=this._connection;e&&(e.onicecandidate=l.Runtime.noop,e.onicecandidateerror=l.Runtime.noop,e.oniceconnectionstatechange=l.Runtime.noop,e.onicegatheringstatechange=l.Runtime.noop,e.onsignalingstatechange=l.Runtime.noop,e.onconnectionstatechange=l.Runtime.noop,e.ondatachannel=l.Runtime.noop)},e.prototype.handleIceCandidate=function(e){e.candidate&&this._candidates.push(e.candidate)},e.prototype.handleIceGatheringState=function(){this._connection&&"complete"===this._connection.iceGatheringState&&(this._flags|=p.WebRtcConnectionState.IceGatheringComplete,this._fireCandidates())},e.prototype.handleIceConnectionStateChange=function(){if(this._connection)switch(this._connection.iceConnectionState){case"connected":this._flags|=p.WebRtcConnectionState.ConnectionOpened,this.onOpened&&this.onOpened(this);break;case"failed":this._flags&=~p.WebRtcConnectionState.ConnectionOpened,this._flags|=p.WebRtcConnectionState.ConnectionError,this.onError&&this.onError(new s.Exception("ConnectionState = failed",this.uuid),this);break;case"closed":this._flags&=~p.WebRtcConnectionState.ConnectionOpened,this._flags|=p.WebRtcConnectionState.ConnectionClosed,this.close()}},e.prototype.handleDataChannel=function(e){e.channel.binaryType="arraybuffer",this._channel=e.channel,this.bindChannelEvents(),"open"===this._channel.readyState&&(this._flags|=p.WebRtcConnectionState.ChannelOpened,this._fireReady())},e.prototype.bindChannelEvents=function(){var e=this,t=this._channel;t&&(t.onopen=function(t){return e.handleChannelOpen(t)},t.onmessage=function(t){return e.handleChannelMessage(t)},t.onbufferedamountlow=function(t){return e.handleChannelBufferedAmountLow(t)},t.onerror=function(t){return e.handleChannelError(t)},t.onclose=function(t){return e.handleChannelClose(t)})},e.prototype.unbindChannelEvents=function(){var e=this._channel;e&&(e.onopen=l.Runtime.noop,e.onmessage=l.Runtime.noop,e.onbufferedamountlow=l.Runtime.noop,e.onerror=l.Runtime.noop,e.onclose=l.Runtime.noop)},e.prototype.handleChannelOpen=function(e){this._flags|=p.WebRtcConnectionState.ChannelOpened,this._fireReady()},e.prototype.handleChannelMessage=function(e){this.onMessage&&this.onMessage(e.data,this)},e.prototype.handleChannelBufferedAmountLow=function(e){},e.prototype.handleChannelError=function(e){this._flags&=~p.WebRtcConnectionState.ChannelOpened,this._flags|=p.WebRtcConnectionState.ChannelError,this.onError&&this.onError(new s.Exception("datachannel error",this.uuid,e),this)},e.prototype.handleChannelClose=function(e){this._flags&=~p.WebRtcConnectionState.ChannelOpened,this._flags|=p.WebRtcConnectionState.ChannelClosed,this.close()},e.prototype.getRtcConfig=function(){return{iceServers:this.stunServers}},e.prototype._send=function(e){if(!this.ready)throw new s.Exception("WebRTCConnection isn't ready","target: "+this.uuid);if(null===this._channel)throw new o.ArgumentNullException("DataChannel");this._channel.send(e)},e.prototype._fireCandidates=function(){if(this._connection&&this._candidates.length&&this.onSignal)if(this._initiator&&this._flags&p.WebRtcConnectionState.IceGatheringComplete){var e=this._connection.localDescription;this.onSignal({type:"offer",offer:e},this),this._candidates=[]}else if(!this._initiator&&this._flags&p.WebRtcConnectionState.IceGatheringComplete){var t=this._connection.localDescription;this.onSignal({type:"answer",answer:t},this),this._candidates=[]}},e.prototype._fireReady=function(){this.ready&&this.onReady&&(this._wasReady=!0,this._logger.debug("ready",this),this._timer&&(this._timer.dispose(),this._timer=void 0),this.onReady(this),this.onReady=void 0)},e}();t.WebRtcConnection=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Inited=0]="Inited",e[e.ConnectionOpened=1]="ConnectionOpened",e[e.ConnectionError=2]="ConnectionError",e[e.ConnectionClosed=4]="ConnectionClosed",e[e.ChannelOpened=8]="ChannelOpened",e[e.ChannelError=16]="ChannelError",e[e.ChannelClosed=32]="ChannelClosed",e[e.IceGatheringComplete=64]="IceGatheringComplete",e[e.AnswerReceive=128]="AnswerReceive",e[e.IceCandidateReceive=256]="IceCandidateReceive"}(t.WebRtcConnectionState||(t.WebRtcConnectionState={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(19),o=n(1),s=n(11),a=n(60),u=n(4),c=n(3),l=n(2),h=n(7),d=n(8),f=n(5),p=n(118),_=function(){function e(e,t){if(this.providerId=t,this.uuid=p.UUID.generate(),this.createAt=f.TimeSpan.now,this.type="ws",this.stunServers=[],this._instance=null,this._wasReady=!1,!t)throw new o.ArgumentNullException("providerId");if(!e)throw new a.UnsupportedException("I'M MUST BE INITIATOR");this._logger=new l.Logger("wspeer#"+this.uuid)}return Object.defineProperty(e.prototype,"ready",{get:function(){return!!this._instance&&this._instance.readyState===WebSocket.OPEN||!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wasReady",{get:function(){return this._wasReady},enumerable:!0,configurable:!0}),e.prototype.send=function(e){try{return this._send(e),!0}catch(e){return this._logger.warnIf(c.Environment.isDevelopment,"send error:",s.Exception.fromNativeError(e),this),!1}},e.prototype.close=function(e,t){this._logger.debug("connection closed by client",e,t),this.unbindEvents(),this.ready&&this._instance.close(e,t),this.onClosed&&this.onClosed(this),this.onMessage=void 0,this.onOpened=void 0,this.onReady=void 0,this.onError=void 0,this.onClosed=void 0,this.onSignal=void 0},e.prototype.openWithOffer=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return this.onSignal&&this.onSignal({type:"offer",offer:{type:"offer",sdp:"websocket offer"}},this),[2]}))}))},e.prototype.openWithAnswer=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){throw new a.UnsupportedException("WS P2P connection can not be open by openWithAnswer",JSON.stringify(e))}))}))},e.prototype.registerSignal=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){if(this._logger.debug("registerSignal",e,this),!e||!e.type)throw new o.ArgumentNullException("signal",JSON.stringify(e));if(!this._isSignalAnswer(e)&&!this._isRejectAnswer(e))throw this.onError&&this.onError(new s.Exception("signal is not wss answer"),this),new i.ArgumentException("signal is not wss answer",JSON.stringify(e));if(this._isRejectAnswer(e))return[2,this.close(0,"reject")];try{this._instance=new WebSocket(e.answer.sdp),this._instance.binaryType="arraybuffer",this.bindEvents()}catch(e){this.handleError(e)}return[2]}))}))},e.prototype.dispose=function(){this._logger.debug("dispose",this),this.onClosed=void 0,this.close(),u.Destructor.destroyObject(this)},e.prototype.setConnectionTimeout=function(e,t){var n=this;void 0===t&&(t=!0),this._timer&&this._timer.dispose(),e instanceof f.TimeSpan&&0===e.value||h.Runtime.isSafeNumber(e)&&0===e||(this._timer=new d.Timer((function(){return n.handleTimer(t)}),e,!1),this._timer.start())},e.prototype.bindEvents=function(){var e=this;this._instance&&(this._instance.onopen=function(){return e.handleOpenEvent()},this._instance.onclose=function(t){return e.handleCloseEvent(t)},this._instance.onmessage=function(t){return e.handleMessageEvent(t)},this._instance.onerror=function(t){return e.handleError(t)})},e.prototype.unbindEvents=function(){this._instance&&(this._instance.onopen=h.Runtime.noop,this._instance.onclose=h.Runtime.noop,this._instance.onmessage=h.Runtime.noop,this._instance.onerror=h.Runtime.noop)},e.prototype.handleOpenEvent=function(){this.onOpened&&this.onOpened(this),this._fireReady()},e.prototype.handleCloseEvent=function(e){this.close(e.code,e.reason)},e.prototype.handleMessageEvent=function(e){this.onMessage&&this.onMessage(e.data,this)},e.prototype.handleError=function(e){this.onError&&this.onError(new s.Exception("Error",JSON.stringify(e)),this)},e.prototype.handleTimer=function(e){!this.uuid||this.uuid&&this.ready||(this._logger.debug("connection timeout",this),this.onTimeout&&this.onTimeout(this),e&&this.close())},e.prototype._send=function(e){if(!this.ready)throw new s.Exception("WSPeerConnection isn't ready","target: "+this.uuid);this._instance.send(e)},e.prototype._isSignalAnswer=function(e){return"answer"===e.type&&"answer"===e.answer.type&&0===e.answer.sdp.indexOf("ws")},e.prototype._isRejectAnswer=function(e){return"reject"===e.type},e.prototype._fireReady=function(){this.ready&&this.onReady&&(this._wasReady=!0,this._logger.debug("ready",this),this._timer&&(this._timer.dispose(),this._timer=void 0),this.onReady(this),this.onReady=void 0)},e}();t.WSPeerConnection=_},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(7),i=function(){function e(){this._queues=[]}return Object.defineProperty(e.prototype,"length",{get:function(){for(var e=this._queues.length,t=0,n=0;n<e;n++)t+=r.Runtime.isArray(this._queues[n])?this._queues[n].length:0;return t},enumerable:!0,configurable:!0}),e.prototype.append=function(e,t){var n=this._queues[e]||[];n.push(t),this._queues[e]=n},e.prototype.getNext=function(){for(var e=this._queues.length,t=0;t<e;t++){var n=this._queues[t];if(r.Runtime.isArray(n)){var i=n.shift();if(i)return i}}return null},e.prototype.clear=function(){this._queues=[]},e}();t.ConnectionsQueue=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(19),o=n(1),s=n(11),a=n(116),u=n(119),c=n(4),l=n(2),h=n(291),d=n(7),f=n(53),p=n(8),_=n(5),g=n(44),m=n(29),y=n(77),v=function(){function e(e,t,n,r,i,s,a,u,c,d,f){var g=this;if(this._strategy=e,this._meta=t,this._metrics=n,this._session=r,this._config=i,this._swarm=s,this._pm=a,this._buff=u,this._hdh=c,this._rtcCheckService=d,this._nodrCheckService=f,this.lastSearcher=-1,this.mAvgSdpAnswerDuration=new h.MovingAverage(500),this.sdpLocalAnswerTimeMap=new Map,this._logger=new l.Logger("SwarmBuilder"),!e)throw new o.ArgumentNullException("strategy");if(!t)throw new o.ArgumentNullException("meta");if(!n)throw new o.ArgumentNullException("metrics");if(!r)throw new o.ArgumentNullException("session");if(!i)throw new o.ArgumentNullException("config");if(!s)throw new o.ArgumentNullException("swarm");if(!a)throw new o.ArgumentNullException("pm");if(!u)throw new o.ArgumentNullException("buff");if(!c)throw new o.ArgumentNullException("hdh");if(!d)throw new o.ArgumentNullException("rtcCheckService");if(!f)throw new o.ArgumentNullException("nodrCheckService");this.searchers=[],this.signallers={},this._checkTimer=new p.Timer((function(){return g.check()}),(function(){return g._config.searchInterval})),this._lastCreate=new _.TimeSpan(0),this._metrics.addAppender((function(e){var t=0,n=0,r=0,i=0;g._meta.forEach((function(e){var o=g._swarm.getConnection(e.uuid);e.offerTime&&e.answerTime&&o&&(o.providerId!==m.ConnectionProviderId.Backend?(r+=e.answerTime-e.offerTime,i++):(t+=e.answerTime-e.offerTime,n++))})),n&&e.register("SDP_AVG_TIME_TO_ANSWER_SRV",t/n|0),i&&e.register("SDP_AVG_TIME_TO_ANSWER_ISS",r/i|0),g.mAvgSdpAnswerDuration.updateCount&&e.register("SDP_MAVG_LOCAL_TIME_TO_ANS",Math.floor(g.mAvgSdpAnswerDuration.value),!0)}))}return e.prototype.dispose=function(){this._checkTimer&&this._checkTimer.dispose(),c.Destructor.destroyArray(this.searchers,!1,!0).destroyObject(this.signallers,!0).destroyObject(this)},e.prototype.addSignaller=function(e){var t=this;return e.onSdp=function(e,n,r){return t.handleIncomingSdp(e,n,r)},this.signallers[e.id]=e,this},e.prototype.addSearcher=function(e){var t=this;return e.onSwarm=function(e){return t.handleRemoteSwarm(e)},this.searchers.push(e),this},e.prototype.startChecking=function(e){this._checkTimer.start(e)},e.prototype.stopChecking=function(){this._checkTimer&&this._checkTimer.stop()},e.prototype.addExternalCandidate=function(e){r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.handleRemoteSwarm(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getSignaller=function(e){var t=this.signallers[e];if(t||(t=this.signallers[m.ConnectionProviderId.InSwarm]),!t)throw new s.Exception("Signaller "+e+" not found");return t},e.prototype.check=function(){var e=this._meta.getAll().filter((function(e){return e.isReady})).map((function(e){return{cid:e.connectionId,ltu:e.lastUtilityTime,la:e.lastActivity,match:e.match,score:e.score,speed:e.lastDownloadSpeed}}));return this.clearSwarm(),this._buff.inBufferingMode&&(this._logger.debug("Start second clear swarm, "+JSON.stringify(e)),this.secondClearSwarm()),this.executeSearch()},e.prototype.clearSwarm=function(){var e,t,n,i,o=new Set;this._hdh.value>this._config.haveDensityThreshold&&(this._logger.debug("Have density is big, exclude match and score clear swarm"),o.add(y.RTCDisconnectReason.NoMatching).add(y.RTCDisconnectReason.BadScore));var s=this._meta.getAll(),a=s.length;try{for(var u=r.__values(s),c=u.next();!c.done;c=u.next()){var l=c.value;this._swarm.pool.contains(l.uuid)||this._meta.destroy(l.uuid)}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=u.return)&&t.call(u)}finally{if(e)throw e.error}}s=this._meta.getAll(),this._logger.debug("Meta cleared from , "+a+", to , "+s.length+",  items");try{for(var h=r.__values(s),d=h.next();!d.done;d=h.next()){var f=d.value;if(this._swarm.pool.size<=this._config.minSwarmSize)return;var p=this._strategy.canDisconnect(f.uuid,o);if(p!==y.RTCDisconnectReason.None){this._logger.debug("Remove connection "+f.connectionId+" reason "+p);var _=this._swarm.removeConnectionById(f.uuid,!0);this._metrics.registerIf(_&&p===y.RTCDisconnectReason.NoActivity,"RTC_CLOSED_BYHAVE").registerIf(_&&p===y.RTCDisconnectReason.NoPeering,"RTC_CLOSED_BYPEERINGOFF").registerIf(_&&p===y.RTCDisconnectReason.NotCompatibleConnect,"RTC_CLOSED_BYCOMPABILITY").registerIf(_&&p===y.RTCDisconnectReason.ManyDownloadTimeout,"RTC_CLOSED_BYDWTIMEOUT").registerIf(_&&p===y.RTCDisconnectReason.NoMatching,"RTC_CLOSED_BYMATCH").registerIf(_&&p===y.RTCDisconnectReason.BadScore,"RTC_CLOSED_BYSCORE").registerIf(_&&p===y.RTCDisconnectReason.LowSpeed,"RTC_CLOSED_BYLOWSPEED").registerIf(_&&p===y.RTCDisconnectReason.ManyPdnZeroByteDownloads,"RTC_CLOSED_BYDWZEROBYTE")}}}catch(e){n={error:e}}finally{try{d&&!d.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}},e.prototype.secondClearSwarm=function(){var e=this;if(!(this._swarm.pool.size<=this._config.minSwarmSize)){var t=this._meta.getAll(),n=Math.ceil(this._config.maxSwarmSize*this._buff.swarmSizeQuota);if(t.length>n){var r=t.length-n;t.sort((function(e,t){return e.match-t.match})).filter((function(e,t){return t<r})).forEach((function(t){e._swarm.removeConnectionById(t.uuid,!0),e._metrics.register("RTC_CLOSED_BYFORCEBUFFER")}))}}},e.prototype.rotate=function(){var e=this._config.matchLimit,t=Math.floor(this._config.matchLimitCount/2),n=this._meta.getAll().filter((function(n){return n.match<e&&n.matchMark>=t})).sort((function(e,t){return e.match-t.match||e.createAt-t.createAt}))[0]||null;return n&&(this._logger.info("[ROTATE]"),this._swarm.removeConnectionById(n.uuid,!0)),!!n},e.prototype.executeSearch=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,o,s,a,u,c=this;return r.__generator(this,(function(l){switch(l.label){case 0:return e=this._meta.getAll().map((function(e){return e.connectionId})).filter((function(e){return!!e})),t=e.length,[4,this._strategy.canRegisterInSwarm(t)];case 1:return l.sent()&&r.__awaiter(c,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,Promise.all(this.searchers.map((function(e){return e.register(t)})))];case 1:return[2,e.sent()]}}))})),this._strategy.canSearch()?(n=this.getSearcher(t))?(i=n.id===m.ConnectionProviderId.Backend&&this._strategy.canSrvWebRtcSearch(),o=n.id===m.ConnectionProviderId.InSwarm&&this._strategy.canIssSearch(),s=n.id===m.ConnectionProviderId.Backend&&this._strategy.canSrvWsSearch(),i||o||s?(a=e,n.id===m.ConnectionProviderId.Backend&&(a=Array.from(new Set(a.concat(this._swarm.excludes)))),u="webrtc",s&&(u="ws"),[4,n.search({swarmSize:t,except:a,type:u})]):[3,3]):[3,3]:[2];case 2:l.sent(),this._metrics.registerIf(n.id===m.ConnectionProviderId.Backend,"SRV_SWARM_SEND").registerIf(n.id===m.ConnectionProviderId.InSwarm,"ISS_SWARM_SEND"),l.label=3;case 3:return[2]}}))}))},e.prototype.getSearcher=function(e){return e>=this._config.searchSwarmSize?this.searchers.filter((function(e){return e.id===m.ConnectionProviderId.InSwarm}))[0]||null:0===e?this.searchers.filter((function(e){return e.id===m.ConnectionProviderId.Backend}))[0]||null:(this.lastSearcher++,this.lastSearcher>=this.searchers.length&&(this.lastSearcher=0),this.searchers[this.lastSearcher])},e.prototype.handleIncomingSdp=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:if(!e)throw new o.ArgumentNullException("providerId");if(!t)throw new o.ArgumentNullException("sender");if(!n)throw new o.ArgumentNullException("signal");switch(this._registerSdpMetrics(n,!1,e),n.type){case"offer":return[3,1];case"answer":case"candidate":case"reject":return[3,4]}return[3,6];case 1:return n.offer.sdp.match("websocket")?[3,3]:[4,this.handleIncomingOffer(e,t,n)];case 2:r.sent(),r.label=3;case 3:return[3,7];case 4:return[4,this.handleIncomingSignal(t,n)];case 5:return r.sent(),[3,7];case 6:throw new i.ArgumentException("signal.type");case 7:return[2]}}))}))},e.prototype.handleIncomingOffer=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o,s,u,c;return r.__generator(this,(function(r){return i=n.meta||null,o=this._meta.resolveInternalId(t),s=!1,this._strategy.isConnectable()?this._strategy.isDoubleConnect(i&&i.s||"")?(this._metrics.register("RTC_CONNECTION_DOUBLE"),[2]):this._strategy.isCounterOffer(t,o)?(this._metrics.register("SDP_COUNTER_OFFER_SKIPPED"),[2]):(this._strategy.isOverflow()&&((u=this.rotate())?this._metrics.register("SWARM_OVERFLOW_OFFER_ROTATE"):this._metrics.register("SWARM_OVERFLOW_OFFER_SKIPPED"),s=!u),g.default.canOpen(this._session.connectionId,i&&i.i||"0")||(s=!0),this._config.rtcCheckCount>0&&!this._rtcCheckService.hasDescription&&(s=!0),s||this.sdpLocalAnswerTimeMap.set(t,_.TimeSpan.now),c=a.WebRtcConnectionFactory.createFromOffer(e,n,this._session.connectionId,i&&i.i||"0"),this._addConnection(c,t,s),this._updateMetaFromSignal(c.uuid,n),[2]):(this._metrics.register("SDP_STRATEGY_OFFER_SKIPPED"),[2])}))}))},e.prototype.handleIncomingSignal=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this._meta.resolveInternalId(e),(i=this._swarm.getConnection(n))?("answer"===t.type&&this._meta.registerAnswerTime(n),"reject"===t.type&&this._swarm.rejectConnection(i),[4,i.registerSignal(t)]):[3,2];case 1:r.sent(),this._updateMetaFromSignal(n,t),r.label=2;case 2:return[2]}}))}))},e.prototype.handleLocalRtcSignal=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this._meta.resolvePublicId(t.uuid),i=this.getSignaller(t.providerId),"offer"===e.type&&this._meta.registerOfferTime(t.uuid),"reject"===e.type&&this._swarm.rejectConnection(t),"answer"===e.type&&((o=this.sdpLocalAnswerTimeMap.get(n))&&this.mAvgSdpAnswerDuration.update(o.diff()),this.sdpLocalAnswerTimeMap.delete(n)),[4,i.signal(t.providerId,this._session.connectionId,n,this._updateSignalFromMeta(e))];case 1:return r.sent(),this._registerSdpMetrics(e,!0,i.id),[2]}}))}))},e.prototype.handleRemoteSwarm=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o,s,c,l,h;return r.__generator(this,(function(r){switch(r.label){case 0:if(t=new Set(e.result.map((function(e){return f.StringUtils.padStart(e,16,"0")}))),n=Array.from(t),o=e.providerId===m.ConnectionProviderId.Backend,!n||!d.Runtime.isArray(n))throw new i.ArgumentException("data.result");this._metrics.registerIf(o,"SRV_SWARM_RECEIVE").registerIf(!o,"ISS_SWARM_RECEIVE").registerIf(o,"SRV_SWARM_SUM_RECEIVE",n.length).registerIf(!o,"ISS_SWARM_SUM_RECEIVE",n.length),s=0,r.label=1;case 1:if(!(s<n.length))return[3,6];c=this._lastCreate.diff(),r.label=2;case 2:return c<250?[4,p.Timer.delay(250-c)]:[3,4];case 3:return r.sent(),c=this._lastCreate.diff(),[3,2];case 4:if(!this._strategy.isConnectable())return this._metrics.register("SWARM_STRATEGY_SKIPPED"),[2];if(this._strategy.isOverflow())return this._metrics.register("SWARM_OVERFLOW_QUERY"),[2];l=n[s],this._strategy.isDoubleConnect(l)?this._metrics.register("RTC_CONNECTION_DOUBLE"):this._strategy.canWebRtcConnect(l)||this._strategy.canWsConnect(l)?(h=null,"webrtc"===e.type&&this._strategy.canWebRtcConnect(l)?h=a.WebRtcConnectionFactory.createConnection(e.providerId,this._session.connectionId,l):"ws"===e.type&&this._strategy.canWsConnect(l)&&(h=u.WSPeerConnectionFactory.createConnection(e.providerId)),h&&(this._lastCreate=_.TimeSpan.now,this._addConnection(h,l))):this._metrics.registerIf(o,"SRV_SWARM_SKIPPED").registerIf(!o,"ISS_SWARM_SKIPPED"),r.label=5;case 5:return s++,[3,1];case 6:return[2]}}))}))},e.prototype._registerSdpMetrics=function(e,t,n){var r=n===m.ConnectionProviderId.Backend;switch(e.type){case"offer":r?this._metrics.register(t?"SDP_SRV_OFFER_SEND":"SDP_SRV_OFFER_RECEIVE"):this._metrics.register(t?"SDP_ISS_OFFER_SEND":"SDP_ISS_OFFER_RECEIVE");break;case"answer":r?this._metrics.register(t?"SDP_SRV_ANSWER_SEND":"SDP_SRV_ANSWER_RECEIVE"):this._metrics.register(t?"SDP_ISS_ANSWER_SEND":"SDP_ISS_ANSWER_RECEIVE");break;case"candidate":r?(this._metrics.register(t?"SDP_SRV_CANDIDATE_SEND":"SDP_SRV_CANDIDATE_RECEIVE"),this._metrics.register(t?"SDP_SRV_CANDIDATE_SUM_SEND":"SDP_SRV_CANDIDATE_SUM_RECEIVE",e.candidates.length)):(this._metrics.register(t?"SDP_ISS_CANDIDATE_SEND":"SDP_ISS_CANDIDATE_RECEIVE"),this._metrics.register(t?"SDP_ISS_CANDIDATE_SUM_SEND":"SDP_ISS_CANDIDATE_SUM_RECEIVE",e.candidates.length));break;case"reject":this._metrics.register(t?"SDP_REJECT_SEND":"SDP_REJECT_RECEIVE")}},e.prototype._updateSignalFromMeta=function(e){return"offer"!==e.type&&"answer"!==e.type||(e.meta={i:this._session.connectionId||"",s:this._session.sessionId||"",m:this._pm.selfPM,ip:this._rtcCheckService.publicIp,t:"browser"}),e},e.prototype._updateMetaFromSignal=function(e,t){if("offer"===t.type||"answer"===t.type){var n=t.meta;if(!n)return;(r=this._meta.resolve(e)).connectionId=n.i,r.sessionId=n.s,r.mode=n.m,r.publicIp=n.ip,r.type=n.t,n.url&&(r.nodrUrl=n.url,this._nodrCheckService.checkNodrUrl(e))}var r;"reject"===t.type&&((r=this._meta.resolve(e)).closeInstantly=!0)},e.prototype._addConnection=function(e,t,n){var i=this;void 0===n&&(n=!1),this._logger.debug("add conn",e.uuid,t),this._swarm.addConnection(e);var o=this._meta.resolve(e.uuid);o.connectionId=t,o.closeInstantly=n,e.onSignal=function(e,t){return i.handleLocalRtcSignal(e,t)},e.setConnectionTimeout(this._config.rtcConnectTimeout,!1),n&&(r.__awaiter(i,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this.handleLocalRtcSignal({type:"reject"},e)];case 1:return[2,t.sent()]}}))})),e.close())},e}();t.SwarmBuilder=v},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(22),i=function(){function e(e,t){void 0===e&&(e=1),void 0===t&&(t=3),this.DEFAULT_VALUE=e,this.TUNE_FACTOR=t,this._value=0,this._updateCount=0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value||this.DEFAULT_VALUE},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updateCount",{get:function(){return this._updateCount},enumerable:!0,configurable:!0}),e.prototype.update=function(e){var t=this.value,n=e||this.DEFAULT_VALUE;this._value?this._value=r.MathUtils.round(2*t/this.TUNE_FACTOR+n/this.TUNE_FACTOR,3):this._value=n,this._updateCount++},e}();t.MovingAverage=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(4),o=function(){function e(e,t,n){if(this._config=e,this._swarm=t,this._metrics=n,this._failCount=0,!e)throw new r.ArgumentNullException("config");if(!t)throw new r.ArgumentNullException("swarm")}return e.prototype.dispose=function(){i.Destructor.destroyObject(this)},e.prototype.reset=function(){this._failCount=0},e.prototype.registerHaveWaitFail=function(){++this._failCount>=this._config.haveCountForJoggle&&this.exec()},e.prototype.exec=function(){this._swarm.startChecking(1),this._metrics.register("SWARM_JOGGLE_COUNT"),this._failCount=0},e}();t.SwarmJoggler=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._max=0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._max},enumerable:!0,configurable:!0}),e.prototype.setValue=function(e){this._max=Math.max(e,this._max)},e.prototype.dispose=function(){this._max=void 0},e}();t.SwarmMaxReadyHolder=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(1),s=n(4),a=n(5),u=function(){function e(e,t,n,r,i){var s=this;if(this._pool=e,this._meta=t,this._config=n,this._pm=i,!e)throw new o.ArgumentNullException("pool");if(!t)throw new o.ArgumentNullException("meta");if(!n)throw new o.ArgumentNullException("config");if(!r)throw new o.ArgumentNullException("metrics");if(!i)throw new o.ArgumentNullException("WorkMode");r.addAppender((function(e){var t=s.getStat();e.register("SWARM_SIZE_TOTAL",t.total,!0).register("SWARM_SIZE_READY",t.ready,!0).register("SWARM_SIZE_LIVE",t.live,!0).register("SWARM_SIZE_CHOKED",t.choked,!0).register("SWARM_SIZE_UPLOAD",t.canUpload,!0).register("SWARM_SIZE_DOWNLOAD",t.canDownload,!0),e.register("PEERING_MODE",s._pm.selfPM,!0).register("PEERING_MODE_CONFIG",s._config.peeringMode,!0)}))}return e.prototype.dispose=function(){s.Destructor.destroyObject(this)},e.prototype.getStat=function(){var e,t,n=this._pool,o=0,s=0,u=0,c=0,l=0,h=0,d=a.TimeSpan.now;try{for(var f=r.__values(n),p=f.next();!p.done;p=f.next()){var _=p.value;o++,s+=+_.ready;var g=this._meta.getByUUId(_.uuid);g&&_.ready&&(c+=+i.WorkMode.checkUploadPM(g.mode),l+=+i.WorkMode.checkDownloadPM(g.mode),u+=+(d.rdiff(g&&g.lastActivity||0)<this._config.heartbeatInterval),h+=+g.isChoked)}}catch(t){e={error:t}}finally{try{p&&!p.done&&(t=f.return)&&t.call(f)}finally{if(e)throw e.error}}return{total:o,ready:s,live:u,canUpload:c,canDownload:l,choked:h,downloadRate:l-c}},e}();t.SwarmStat=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(e){function t(t,n,r,o,s,a){var u=e.call(this,t,n,r,o)||this;if(u.session=s,u.pool=a,!s)throw new i.ArgumentNullException("session");if(!a)throw new i.ArgumentNullException("pool");return u}return r.__extends(t,e),t.prototype.incrementUploadCount=function(){this.uploadCounter++},t.prototype._handleTick=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,o,s,a,u,c,l;return r.__generator(this,(function(h){switch(h.label){case 0:return n=Math.ceil(this.config.uploadLimit/2),this.uploadCounter<=n&&this.isChoked?[4,this.api.broadcastChoke(!1,this.config.chokeInterval)]:[3,2];case 1:return h.sent(),this.isChoked=!1,[3,11];case 2:i=(this.uploadCounter-n)/n*65535,h.label=3;case 3:h.trys.push([3,8,9,10]),o=r.__values(this.pool),s=o.next(),h.label=4;case 4:return s.done?[3,7]:(a=s.value).ready&&(u=this.meta.getByUUId(a.uuid))?(c=(parseInt(this.session.connectionId.slice(-4),16)^parseInt(u.connectionId.slice(-4),16))<i,[4,this.api.choke(a.uuid,c,this.config.chokeInterval)]):[3,6];case 5:h.sent(),h.label=6;case 6:return s=o.next(),[3,4];case 7:return[3,10];case 8:return l=h.sent(),e={error:l},[3,10];case 9:try{s&&!s.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}return[7];case 10:this.isChoked=!0,h.label=11;case 11:return this.uploadCounter=0,[2]}}))}))},t}(n(296).ChokeUnchokeUploadController);t.FloatCUUploadController=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(4),s=n(8),a=function(){function e(e,t,n,r){var o=this;if(this.config=e,this.api=t,this.meta=n,this.metrics=r,!e)throw new i.ArgumentNullException("config");if(!t)throw new i.ArgumentNullException("api");if(!n)throw new i.ArgumentNullException("meta");if(!r)throw new i.ArgumentNullException("metrics");this.api.onChoke=function(e,t){return o._handleIncomingChoke(e,t)},this.uploadCounter=0,this.isChoked=!1,this.unchokers={},this.ticker=new s.Timer((function(){return o._handleTick()}),(function(){return o.config.chokeInterval})),this.ticker.start()}return e.prototype.dispose=function(){for(var e in this.unchokers)this.unchokers.hasOwnProperty(e)&&(s.Timer.removeTimeout(this.unchokers[e]),delete this.unchokers[e]);this.ticker&&this.ticker.dispose(),this.api.onChoke=void 0,o.Destructor.destroyObject(this)},e.prototype.isCanUpload=function(){return this.uploadCounter<this.config.uploadLimit},e.prototype.incrementUploadCount=function(){this.uploadCounter++,r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this.isCanUpload()||this.isChoked?[3,2]:(this.isChoked=!0,[4,this.api.broadcastChoke(!0,this.config.chokeInterval)]);case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype._handleTick=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this.isChoked?[4,this.api.broadcastChoke(!1,this.config.chokeInterval)]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.isChoked=!1,this.uploadCounter=0,[2]}}))}))},e.prototype._handleIncomingChoke=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i;return r.__generator(this,(function(r){return(n=e.json())?(i=this.meta.resolve(e.connectionId),t.status=200,i.isChoked=n.isChoked,n&&n.isChoked?this._registerUnchoker(e.connectionId,n.tt||this.config.chokeInterval):this._unregisterUnchoker(e.connectionId),this.metrics.registerIf(i.isChoked,"PDN_CHOKE_RECEIVE").registerIf(!i.isChoked,"PDN_UNCHOKE_RECEIVE"),[2]):[2]}))}))},e.prototype._unregisterUnchoker=function(e){this.unchokers[e]&&(s.Timer.removeTimeout(this.unchokers[e]),delete this.unchokers[e])},e.prototype._registerUnchoker=function(e,t){var n=this;this._unregisterUnchoker(e),this.unchokers[e]=s.Timer.timeout((function(){if(n.unchokers){delete n.unchokers[e];var t=n.meta&&n.meta.getByUUId(e)||null;t&&(t.isChoked=!1)}}),t)},e}();t.ChokeUnchokeUploadController=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t){var n=e.call(this)||this;return n.config=t,n}return r.__extends(t,e),t.prototype.register=function(t,n,r){return void 0===n&&(n=1),void 0===r&&(r=!1),this.config.metricsInfoLevel<=function(e){switch(e){case"GW_AUTH":case"SILENT_MODE":case"BLACKLIST_SELF":case"SWARM_SIZE_READY":case"QUALITY_SWITCH_COUNT":case"DOWNLOAD_CDN_COUNT":case"DOWNLOAD_CDN_SIZE":case"DOWNLOAD_CDN_TIME":case"DOWNLOAD_PDN_COUNT":case"DOWNLOAD_PDN_SIZE":case"DOWNLOAD_PDN_TIME":case"DOWNLOAD_PDN_GET_TIMEOUT":case"DOWNLOAD_PDN_SKIPPED_SIZE":case"DOWNLOAD_PDN_SKIPPED_TIME":case"DOWNLOAD_NDR_COUNT":case"DOWNLOAD_NDR_SIZE":case"DOWNLOAD_NDR_TIME":case"DOWNLOAD_NDR_GET_TIMEOUT":case"NODR_THROW_DOWNLOAD":case"NODR_NODES_COUNT":case"UPLOAD_PDN_COUNT":case"UPLOAD_PDN_SIZE":return 2;case"BLACKLIST_LAST_MEASUREMENT":case"CURRENT_HAVE_DENSITY":case"CURRENT_TIMESLOT":case"CURRENT_TIMESLOT_DIFF":case"RTC_CONNECTION_CREATED":case"RTC_CONNECTION_READY":case"RTC_DESCRIPTION":case"SDP_AVG_TIME_TO_ANSWER_ISS":case"SDP_AVG_TIME_TO_ANSWER_SRV":case"SDP_MAVG_LOCAL_TIME_TO_ANS":case"STORAGE_SIZE":case"STUN_ACTIVE_COUNT":case"SWARM_SIZE_TOTAL":case"TOTAL_PDN_MESSAGES_RECEIVE":case"TOTAL_PDN_MESSAGES_SEND":return 1;default:return 0}}(t)?e.prototype.register.call(this,t,n,r):this},t}(n(298).Metrics);t.MetricsWithCondition=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=n(7),o=function(){function e(){this.parent=null,this.reset(),this._appenders=[],this._childs=[]}return e.prototype.register=function(e,t,n){return void 0===t&&(t=1),void 0===n&&(n=!1),n||0!==t?(!i.Runtime.isDefined(this._data[e])||n?this._data[e]=t:this._data[e]+=t,this):this},e.prototype.registerIf=function(e,t,n,r){return void 0===n&&(n=1),void 0===r&&(r=!1),e&&this.register(t,n,r),this},e.prototype.addAppender=function(e){return this._appenders.push(e),this},e.prototype.addMetrics=function(e){e.parent=this,this._childs.push(e)},e.prototype.removeMetrics=function(e){this._childs&&(this._childs=this._childs.filter((function(t){return t!==e})))},e.prototype.flush=function(){if(!this._data)return{};for(var e=0;e<this._appenders.length;e++)this._appenders[e](this);var t=this._data;this.reset();var n={},r=this.merge(t);return Object.keys(r).sort().forEach((function(e){n[e]=r[e]})),n},e.prototype.dispose=function(){this.parent&&this.parent.removeMetrics(this),r.Destructor.destroyObject(this)},e.prototype.reset=function(){this._data={}},e.prototype.merge=function(e){if(0===this._childs.length)return e;for(var t=e,n=0;n<this._childs.length;n++)t=i.Runtime.extend(t,this._childs[n].flush());return t},e}();t.Metrics=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(36),i=n(10),o=n(9),s=n(1),a=n(13),u=n(4),c=n(2),l=n(300),h=function(){function e(e){var t=this;if(this._config=e,!e)throw new s.ArgumentNullException("config");this._cdnAny=new l.SegmentBucket((function(){return t._config.statAggRatioVideoCdn})),this._pdnAny=new l.SegmentBucket((function(){return t._config.statAggRatioVideoPdn})),this._cdnVideo=new l.SegmentBucket((function(){return t._config.statAggRatioVideoCdn})),this._pdnVideo=new l.SegmentBucket((function(){return t._config.statAggRatioVideoPdn})),this._cdnAudio=new l.SegmentBucket((function(){return t._config.statAggRatioAudioCdn})),this._pdnAudio=new l.SegmentBucket((function(){return t._config.statAggRatioAudioPdn})),this._nodrAny=new l.SegmentBucket((function(){return 0}))}return e.prototype.dispose=function(){u.Destructor.destroyObject(this)},e.prototype.append=function(e){var t=e.result.sourceId,n=e.request.type;switch(c.PIPE_LOG("StatAggregator",e.result.flags,a.Bitmask.check(e.result.flags,r.SegmentFlags.HttpNodrDownload)),!0){case a.Bitmask.check(e.result.flags,r.SegmentFlags.HttpNodrDownload):c.PIPE_LOG("StatAggregator","found nodr download stat"),this._nodrAny.append(e);break;case i.DataSourceId.CDN===t&&n===o.SegmentType.Video:this._cdnVideo.append(e);break;case i.DataSourceId.CDN===t&&n===o.SegmentType.Audio:this._cdnAudio.append(e);break;case i.DataSourceId.PDN===t&&n===o.SegmentType.Video:this._pdnVideo.append(e);break;case i.DataSourceId.PDN===t&&n===o.SegmentType.Audio:this._pdnAudio.append(e);break;case i.DataSourceId.CDN===t&&n===o.SegmentType.Unknown:this._cdnAny.append(e);break;case i.DataSourceId.PDN===t&&n===o.SegmentType.Unknown:this._pdnAny.append(e);break;default:return void c.Logger.info("unsupported source for aggregation")}},e.prototype.flush=function(){return[this._cdnVideo,this._pdnVideo,this._cdnAudio,this._pdnAudio,this._cdnAny,this._pdnAny,this._nodrAny].map((function(e){var t=e.value;return t&&e.reset(),t})).filter((function(e){return!!e}))},e}();t.StatAggregator=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(36),i=n(1),o=n(13),s=n(7),a=function(){function e(e){this._limitGetter=e,this.reset()}return Object.defineProperty(e.prototype,"value",{get:function(){var e=this._limitGetter();return this.count<e?null:(this._value&&(this._value.meta={ratio:e,count:this.count,bufferingCount:this.bufferingCount}),this._value)},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._value=null,this.count=0,this.bufferingCount=0},e.prototype.append=function(e){if(!e)throw new i.ArgumentNullException("it");if(this.count++,!this._value)return this._value=s.Runtime.cloneDeep(e),void(this._value.result.skippedPdnSize=e.result.skippedPdnSize||0);o.Bitmask.check(e.result.flags,r.SegmentFlags.Buffering)&&(this.bufferingCount++,this._value.result.flags|=r.SegmentFlags.Buffering),o.Bitmask.check(e.result.flags,r.SegmentFlags.PartialDownload)&&(this._value.result.flags|=r.SegmentFlags.PartialDownload),this._value.timestamp=e.timestamp,this._value.timings.tthave+=e.timings.tthave,this._value.timings.ttsent+=e.timings.ttsent,this._value.timings.ttfb+=e.timings.ttfb,this._value.timings.ttlb+=e.timings.ttlb,this._value.timings.ttfinish+=e.timings.ttfinish,this._value.result.skippedPdnSize+=e.result.skippedPdnSize||0,this._value.result.size+=e.result.size},e}();t.SegmentBucket=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(10),i=n(1),o=n(4),s=n(3),a=n(7),u=n(57),c=function(){function e(){this.reset()}return e.prototype.dispose=function(){o.Destructor.destroyObject(this)},e.prototype.download=function(e){var t=e.result.targetId;if(t&&e.result.sourceId===r.DataSourceId.PDN){this.registerPeer(t),this.update(this._totals.pdn,e);var n=this.resolveRow(t);this.update(n.download,e)}else this.update(this._totals.cdn,e);this.onDownload&&this.onDownload(a.Runtime.clone(e))},e.prototype.upload=function(e){var t=e.result.targetId;if(t){this.registerPeer(t),this.update(this._totals.upload,e);var n=this.resolveRow(t);this.update(n.upload,e),this.onUpload&&this.onUpload(a.Runtime.clone(e))}else if(s.Environment.isDevelopment)throw new i.ArgumentNullException("segment.result.targetId")},e.prototype.getTotals=function(){return a.Runtime.clone(this._totals)},e.prototype.getDetails=function(){return{totals:this.getTotals(),details:this.generateDetails()}},e.prototype.reset=function(){this._peers=[],this._totals={cdn:{size:0,count:0,time:0,speed:0},pdn:{size:0,count:0,time:0,speed:0},upload:{size:0,count:0,time:0,speed:0}},this._details={}},e.prototype.registerPeer=function(e){e&&-1===this._peers.indexOf(e)&&this._peers.push(e)},e.prototype.generateDetails=function(){var e=this;return this._peers.map((function(t){return a.Runtime.clone(e.resolveRow(t))}))},e.prototype.resolveRow=function(e){var t=this._details[e];return t||(t={id:e,download:{size:0,count:0,time:0,speed:0},upload:{size:0,count:0,time:0,speed:0}},this._details[e]=t),t},e.prototype.update=function(e,t){return e.count++,e.size+=t.result.size,e.time+=t.timings.ttlb-t.timings.ttsent,e.speed=u.Speed.hack(e.size,e.time),e},e}();t.Statistics=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(18),i=n(5),o=function(){function e(e){this.config=e}return e.prototype.getCorrection=function(e,t,n){var o=e.timeslotLastTime;return void 0===t&&(t=i.TimeSpan.value),void 0===n&&(n=6),this.config.streamType===r.StreamType.LIVE?Math.min(Math.floor((t-o)/1e3),n):0},e.prototype.dispose=function(){this.config=void 0},e}();t.TimeSlotCorrector=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(1),o=n(304),s=n(4),a=n(2),u=n(7),c=n(8),l=n(5),h=function(){function e(e,t,n,r){void 0===t&&(t=1e3);var o=this;if(this.url=e,this._reconnectDelay=t,this._wm=n,this._metrics=r,this._instance=null,this.MAX_RECONNECT_TIMEOUT=l.TimeSpan.fromHours(1).value,this._connectionOpenTime=null,this._connectionDuration=null,!e)throw new i.ArgumentNullException("url");if(!n)throw new i.ArgumentNullException("wm");this._buffer=[],this._timer=new c.Timer((function(){return o.handleReconnectTimeout()}),(function(){return o.reconnectDelay}),!1),this._logger=new a.Logger(this._buildUri().split("?")[0]),this._wm.onSilentModeChange=function(e){return o.silentModeChangeHandler(e)},this._metrics.addAppender((function(e){u.Runtime.isNull(o._connectionDuration)&&o._connectionOpenTime?e.register("DURATION_WS_CONNECTION",o._connectionOpenTime.diff()/1e3|0):o._connectionDuration?e.register("DURATION_WS_CONNECTION",o._connectionDuration/1e3|0):e.register("DURATION_WS_CONNECTION",0,!0)}))}return e.prototype.dispose=function(){this.close(),this._timer&&this._timer.dispose(),s.Destructor.destroyObject(this)},Object.defineProperty(e.prototype,"reconnectDelay",{get:function(){return Math.min(this._reconnectDelay,this.MAX_RECONNECT_TIMEOUT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOpened",{get:function(){return!!this._instance&&this._instance.readyState===WebSocket.OPEN||!1},enumerable:!0,configurable:!0}),e.prototype.open=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.openConnection()];case 1:return e.sent(),[2,!0];case 2:return e.sent(),this.tryReconnect(),[2,!1];case 3:return[2]}}))}))},e.prototype.close=function(e,t){this._logger.debug("connection closed by client",e,t),this._timer.stop(),this.unbindEvents(),this.isOpened&&this._instance.close(e,t)},e.prototype.send=function(e){this.isOpened?this._instance.send(JSON.stringify(e)):this._buffer.push(e)},e.prototype.openConnection=function(){var e=this;if(this.isOpened)throw new o.InvalidOperationException("WSConnection already opened");return this._logger.debug("connection opening"),new Promise((function(t,n){e._instance=e.createInstance(),e._instance.onerror=function(e){return n(e)},e._instance.onmessage=function(t){return e.handleMessage(t)},e._instance.onclose=function(t){return e.handleClose(t)},e._instance.onopen=function(n){t(n),e.handleOpen()}}))},e.prototype.createInstance=function(){return new WebSocket(this._buildUri())},e.prototype.handleMessage=function(e){var t=JSON.parse(e.data);this.onMessage&&this.onMessage(t)},e.prototype.handleClose=function(e){this._connectionOpenTime&&(this._connectionDuration=this._connectionOpenTime.diff()),this._logger.debug("connection closed, reason: "+e.reason),this.onConnectionStateChange&&this.onConnectionStateChange(!1),e.reason.indexOf("server namespace disconnect")>-1||(e.reason.indexOf("signal server is turned off")>-1?this.onNeedNewAddress&&this.onNeedNewAddress():this.tryReconnect())},e.prototype.handleOpen=function(){if(this._connectionOpenTime=l.TimeSpan.now,this._connectionDuration=null,this._logger.debug("connection opened, buffersize="+this._buffer.length),this.onConnectionStateChange&&this.onConnectionStateChange(!0),0!==this._buffer.length)for(var e=0;e<this._buffer.length;e++){var t=this._buffer.shift();t&&this.send(t)}},e.prototype.handleReconnectTimeout=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.openConnection()];case 1:return e.sent(),[3,3];case 2:return e.sent(),this._reconnectDelay*=2,this.tryReconnect(),[3,3];case 3:return[2]}}))}))},e.prototype.unbindEvents=function(){this._instance&&(this._instance.onopen=u.Runtime.noop,this._instance.onclose=u.Runtime.noop,this._instance.onmessage=u.Runtime.noop,this._instance.onerror=u.Runtime.noop)},e.prototype.tryReconnect=function(){this.close(),this._logger.debug("try reconnect after "+this.reconnectDelay+" ms"),this._timer.start(),this.onReconnect&&this.onReconnect(this.reconnectDelay)},e.prototype.silentModeChangeHandler=function(e){e?this.close():this.onNeedNewAddress?this.onNeedNewAddress():r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this.open()];case 1:return[2,e.sent()]}}))}))},e.prototype._buildUri=function(){return u.Runtime.isString(this.url)?this.url:this.url.build()},e}();t.WebSocketConnection=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r,i)||this;return o.name="InvalidOperationException",o}return r.__extends(t,e),t}(n(11).Exception);t.InvalidOperationException=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(16),o=n(109),s=n(1),a=n(20),u=n(306),c=n(12),l=n(4),h=n(3),d=n(2),f=n(8),p=n(5),_=n(42),g=function(){function e(e,t,n,r,i,o,a,u,c,l,h,_,g,m,y,v,w){var b=this;if(this._backend=e,this._auth=t,this._config=n,this._metrics=r,this._download=i,this._upload=o,this._swarmBuilder=a,this._connection=u,this._swarm=c,this._pdn=l,this._session=h,this._pm=_,this._meta=g,this._backendManager=m,this._segmentHash=y,this._tasks=v,this._issTrigger=w,this.EXECUTE_TIMEOUT=p.TimeSpan.fromSeconds(30),this.logger=new d.Logger("DefaultApp"),!e)throw new s.ArgumentNullException("backend");if(!t)throw new s.ArgumentNullException("auth");if(!n)throw new s.ArgumentNullException("config");if(!r)throw new s.ArgumentNullException("metrics");if(!i)throw new s.ArgumentNullException("pipe-download");if(!o)throw new s.ArgumentNullException("pipe-upload");if(!a)throw new s.ArgumentNullException("swarmBuilder");if(!u)throw new s.ArgumentNullException("connection");if(!c)throw new s.ArgumentNullException("swarm");if(!l)throw new s.ArgumentNullException("pdn");if(!h)throw new s.ArgumentNullException("session");if(!_)throw new s.ArgumentNullException("WorkMode");if(!g)throw new s.ArgumentNullException("swarmMetadata");if(!m)throw new s.ArgumentNullException("backendManager");if(!v)throw new s.ArgumentNullException("tasks");this._backendManager.onWorkModeChange=function(e){return b.handleBackendWorkModeChange(e)},this._pdn.onDownload=function(e,t){return b.handleDownloadRequest(e,t)},this._auth.onAuthenticate=function(e){return b.handleAuthEvent(e)},this._config.onChanged=function(e){return b.handleConfigChange(e)},this._connection.onReconnect=function(){b._metrics.register("WS_RECONNECT").register("WS_RECONNECT_TIMEOUT",b._connection.reconnectDelay,!0)},this._timer=new f.Timer((function(){return b.handleTick()}),(function(){return b.calcStateInterval()})),this._coreDestructors=[]}return e.prototype.dispose=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this._auth.onAuthenticate=void 0,this._config.onChanged=null,this._connection.onReconnect=void 0,this._timer.dispose(),[4,l.Destructor.disposeArray(this._coreDestructors)];case 1:return e.sent(),l.Destructor.destroyObject(this),[2]}}))}))},e.prototype.registerDisposableObjects=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=this._coreDestructors,r=0;r<e.length;r++)e[r]&&e[r].dispose?n.push(e[r]):n.push(l.Destructor.toDisposable(e[r]));return this},e.prototype.setActiveStream=function(e){if(!e)throw new s.ArgumentNullException("uri");this._auth.authenticate(this._session.apiKey,e)},e.prototype.abort=function(e){var t=_.XXHash.generate(e.uri.toLocaleLowerCase()),n=this._tasks.getDownloadTask(t);n&&(this.logger.infoIf(h.Environment.isDevelopment,"abort",n),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,n.abort()];case 1:return[2,e.sent()]}}))})))},e.prototype.download=function(e){return this._download.create(e)},e.prototype.handleAuthEvent=function(e){return void 0===e&&(e=!0),r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(n){switch(n.label){case 0:return this._metrics.register("GW_AUTH"),this._timer.stop(),this._swarmBuilder.stopChecking(),this._connection.close(),[4,Promise.all([e?this._swarm.resetConnections():Promise.resolve(),this.reloadConfiguration()])];case 1:return n.sent(),this._backendManager.workMode!==o.BackendWorkMode.DEFAULT?[3,3]:[4,this._connection.open()];case 2:n.sent(),n.label=3;case 3:return this._timer.start(1),this._swarmBuilder.startChecking(this._config.initialStateInterval),h.Environment.isWebRtcSupported||f.Timer.timeout((function(){return t._backend.nowebrtc(p.TimeSpan.now)}),100),[2]}}))}))},e.prototype.handleConfigChange=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return"backendReconnectTimeout"===e.paramName?(this._auth.restartReauthTimer(),[2]):"bypassBufferSize"===e.paramName&&this.onExternConfigChanged?(this.onExternConfigChanged({bypassBufferSize:e.newValue}),[2]):"peeringMode"!==e.paramName?[2]:e.newValue!==i.PeeringMode.Off?[3,2]:[4,this._swarm.resetConnections()];case 1:return t.sent(),[3,4];case 2:return[4,this._pdn.broadcastInfo({connectionId:this._session.connectionId,sessionId:this._session.connectionId,mode:this._pm.selfPM,issTrigger:this._issTrigger.value})];case 3:t.sent(),t.label=4;case 4:return this.onPeeringModeChanged&&this.onPeeringModeChanged(this._pm.selfPM),[2]}}))}))},e.prototype.handleDownloadRequest=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,o,s,l=this;return r.__generator(this,(function(_){switch(_.label){case 0:if(!(n=e.json()))return[2];(i={s:n.s,connectionId:e.connectionId,range:e.headers[a.HttpHeaders.Range],race:e.headers[a.HttpHeaders.RaceRequest],startChunk:n.sc,shift:n.sh}).startChunk>0&&this.logger.infoIf(h.Environment.isDevelopment,"RACELOG "+i.s+" received get seg","startChunk=",i.startChunk,"shift=",i.shift),this._meta.registerLastUtilityTime(i.connectionId),this._meta.dropPenalties(i.connectionId),(o=this._upload.create(i)).stream.onProgress=function(s,c,d){return r.__awaiter(l,void 0,void 0,(function(){var l;return r.__generator(this,(function(r){switch(r.label){case 0:return d&&(o.totalSize=d),o.flags.isDownloadStreamingMode?((l=this._segmentHash.getBySegmentId(i.s))&&(t.headers.segmentHash=l),t.headers[a.HttpHeaders.ContentLength]=d,t.headers[a.HttpHeaders.TransferMode]="streaming",o.isPartial&&(t.headers[a.HttpHeaders.ContentRange]=a.HttpHeaders.generateContentRangeValue(o.rangeStart||0,o.rangeEnd||-1,d)),this.logger.infoIf(h.Environment.isDevelopment,"Stream segment "+n.s+" chunk to "+e.connectionId,s,c,d,e,t),t.setChunkIteratorFactory((function(e){return new u.ShiftChunkIterator(e,n.sc,n.sh)})),[4,t.write(s)]):[2];case 1:return r.sent(),[4,t.flush()];case 2:return r.sent(),[2]}}))}))},r.__awaiter(l,void 0,void 0,(function(){var e,s,l,h,d=this;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,o.getDataLoadedAwaiter()];case 1:return r.sent(),o.flags.isDownloadStreamingMode?[2]:(o.isPartial&&(t.headers[a.HttpHeaders.ContentRange]=a.HttpHeaders.generateContentRangeValue(o.rangeStart||0,o.rangeEnd||-1,o.totalSize)),(e=this._segmentHash.getBySegmentId(i.s))&&(t.headers.segmentHash=e),[4,t.write(o.payload||c.Buffer.empty)]);case 2:return r.sent(),t.setChunkIteratorFactory((function(e){return new u.ShiftChunkIterator(e,n.sc,n.sh)})),[3,4];case 3:return s=r.sent(),h={isDownloadStreamingMode:void 0,segmentId:i.s,toId:this._meta.resolve(i.connectionId).connectionId},l="function"==typeof s.toJSON?Object.assign({id:o.id,type:"upload"},s.toJSON(),h):Object.assign({id:o.id,type:"upload"},JSON.parse(JSON.stringify(s)),h),f.Timer.timeout((function(){return d._backend.error(p.TimeSpan.now,l)}),100),[3,4];case 4:return[2]}}))})),_.label=1;case 1:return _.trys.push([1,3,4,5]),[4,o.execute(n.tm||this.EXECUTE_TIMEOUT.value)];case 2:return _.sent(),[3,5];case 3:return s=_.sent(),d.Logger.warnIf(h.Environment.isDevelopment,"Upload error",s),[3,5];case 4:return o.dispose(),[7];case 5:return[2]}}))}))},e.prototype.calcStateInterval=function(){switch(this._backendManager.workMode){case o.BackendWorkMode.STOP:return Number.MAX_VALUE;case o.BackendWorkMode.INTERVAL_REVIVE:return this.calcReviveTimeout();case o.BackendWorkMode.DEFAULT:default:return this._config.stateInterval}},e.prototype.calcReviveTimeout=function(){return this._config.reviveTimeout*(1+.25*(Math.floor(1001*Math.random())-500)/1e3)},e.prototype.handleTick=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,Promise.all([this.reloadConfiguration(),this.flushMetrics(),this.sendSwarmSnapshot()])];case 1:return e.sent(),[2]}}))}))},e.prototype.reloadConfiguration=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._backend.config(this._config.toJSON())];case 1:return e=t.sent(),this._metrics.registerIf(e.length>0,"SRV_OPTS_RECEIVE"),this._config.updateSerializedConfig(e),[2]}}))}))},e.prototype.flushMetrics=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return[4,this._backend.metrics(p.TimeSpan.now,this._metrics.flush())];case 1:return e.sent(),[2]}}))}))},e.prototype.sendSwarmSnapshot=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=this._meta.getAll().filter((function(e){return e.isReady})).map((function(e){return{ip:e.publicIp,cid:e.connectionId,speed:e.lastDownloadSpeed}})),[4,this._backend.swarmSnapshot(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.handleBackendWorkModeChange=function(e){switch(e){case o.BackendWorkMode.DEFAULT:this._backend.enable(),this._timer.start();break;case o.BackendWorkMode.INTERVAL_REVIVE:this._backend.disable(!0),this._timer.start();break;case o.BackendWorkMode.STOP:this._backend.disable(),this._timer.stop();break;default:d.Logger.warn("Unexpected Backend mode",e)}},e}();t.DefaultApp=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(61),o=n(114),s=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=1);var i=e.call(this,t)||this;return i.startChunk=n,i.shift=r,i}return r.__extends(t,e),t.prototype.next=function(t){void 0===t&&(t=o.DefaultChecksum.instance);for(var n=e.prototype.next.call(this,t);n;){if(this.shift>1&&(n.meta.isRace=!0),-1===n.position)return n;if(n.position>=this.startChunk&&n.position%this.shift==this.startChunk%this.shift)return n.position+this.shift>=n.chunkCount&&(n.meta.isEndOfTransfer=!0),n;n=e.prototype.next.call(this,t)}return null},t}(i.ChunkIterator);t.ShiftChunkIterator=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=function(){function e(){}return e.prototype.dispose=function(){r.Destructor.destroyObject(this)},e}();t.DefaultAppContainer=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(16),i=n(41),o=n(9),s=n(18),a=n(3),u=n(7),c=function(){return new Error("Teleport initialize error: your browser not supports ES5. \nIf you use IE11, install teleport.polyfill.js\nIE less 11 is not supported")},l=function(){function e(){}return Object.defineProperty(e.prototype,"version",{get:function(){return a.Environment.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Quality",{get:function(){return i.Quality},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"SegmentType",{get:function(){return o.SegmentType},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"PeeringMode",{get:function(){return r.PeeringMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"NodrStrategy",{get:function(){return s.NodrStrategy},enumerable:!0,configurable:!0}),e.prototype.initialize=function(e){if(Promise)return Promise.reject(c());throw c()},e.prototype.registerPlugin=function(e,t){u.Runtime.noop()},e}();t.TeleportStaticOldBrowser=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(310),n(315),n(320),n(342)},function(e,t,n){n(311),e.exports=n(21).Array.find},function(e,t,n){"use strict";var r=n(30),i=n(312)(5),o=!0;"find"in[]&&Array(1).find((function(){o=!1})),r(r.P+r.F*o,"Array",{find:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0)}}),n(122)("find")},function(e,t,n){var r=n(47),i=n(80),o=n(81),s=n(83),a=n(313);e.exports=function(e,t){var n=1==e,u=2==e,c=3==e,l=4==e,h=6==e,d=5==e||h,f=t||a;return function(t,a,p){for(var _,g,m=o(t),y=i(m),v=r(a,p,3),w=s(y.length),b=0,S=n?f(t,w):u?f(t,0):void 0;w>b;b++)if((d||b in y)&&(g=v(_=y[b],b,m),e))if(n)S[b]=g;else if(g)switch(e){case 3:return!0;case 5:return _;case 6:return b;case 2:S.push(_)}else if(l)return!1;return h?-1:c||l?l:S}}},function(e,t,n){var r=n(314);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,n){var r=n(25),i=n(121),o=n(14)("species");e.exports=function(e){var t;return i(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!i(t.prototype)||(t=void 0),r(t)&&null===(t=t[o])&&(t=void 0)),void 0===t?Array:t}},function(e,t,n){n(316),e.exports=n(21).Object.assign},function(e,t,n){var r=n(30);r(r.S+r.F,"Object",{assign:n(317)})},function(e,t,n){"use strict";var r=n(49),i=n(88),o=n(64),s=n(81),a=n(80),u=Object.assign;e.exports=!u||n(45)((function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach((function(e){t[e]=e})),7!=u({},e)[n]||Object.keys(u({},t)).join("")!=r}))?function(e,t){for(var n=s(e),u=arguments.length,c=1,l=i.f,h=o.f;u>c;)for(var d,f=a(arguments[c++]),p=l?r(f).concat(l(f)):r(f),_=p.length,g=0;_>g;)h.call(f,d=p[g++])&&(n[d]=f[d]);return n}:u},function(e,t,n){var r=n(40),i=n(83),o=n(319);e.exports=function(e){return function(t,n,s){var a,u=r(t),c=i(u.length),l=o(s,c);if(e&&n!=n){for(;c>l;)if((a=u[l++])!=a)return!0}else for(;c>l;l++)if((e||l in u)&&u[l]===n)return e||l||0;return!e&&-1}}},function(e,t,n){var r=n(84),i=Math.max,o=Math.min;e.exports=function(e,t){return(e=r(e))<0?i(e+t,0):o(e,t)}},function(e,t,n){n(124),n(321),n(326),n(329),n(340),n(341),e.exports=n(21).Promise},function(e,t,n){"use strict";var r=n(322)(!0);n(125)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=r(t,n),this._i+=e.length,{value:e,done:!1})}))},function(e,t,n){var r=n(84),i=n(82);e.exports=function(e){return function(t,n){var o,s,a=String(i(t)),u=r(n),c=a.length;return u<0||u>=c?e?"":void 0:(o=a.charCodeAt(u))<55296||o>56319||u+1===c||(s=a.charCodeAt(u+1))<56320||s>57343?e?a.charAt(u):o:e?a.slice(u,u+2):s-56320+(o-55296<<10)+65536}}},function(e,t,n){"use strict";var r=n(126),i=n(62),o=n(66),s={};n(31)(s,n(14)("iterator"),(function(){return this})),e.exports=function(e,t,n){e.prototype=r(s,{next:i(1,n)}),o(e,t+" Iterator")}},function(e,t,n){var r=n(32),i=n(24),o=n(49);e.exports=n(33)?Object.defineProperties:function(e,t){i(e);for(var n,s=o(t),a=s.length,u=0;a>u;)r.f(e,n=s[u++],t[n]);return e}},function(e,t,n){var r=n(26),i=n(81),o=n(86)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=i(e),r(e,o)?e[o]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t,n){for(var r=n(327),i=n(49),o=n(39),s=n(15),a=n(31),u=n(50),c=n(14),l=c("iterator"),h=c("toStringTag"),d=u.Array,f={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=i(f),_=0;_<p.length;_++){var g,m=p[_],y=f[m],v=s[m],w=v&&v.prototype;if(w&&(w[l]||a(w,l,d),w[h]||a(w,h,m),u[m]=d,y))for(g in r)w[g]||o(w,g,r[g],!0)}},function(e,t,n){"use strict";var r=n(122),i=n(328),o=n(50),s=n(40);e.exports=n(125)(Array,"Array",(function(e,t){this._t=s(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,i(1)):i(0,"keys"==t?n:"values"==t?e[n]:[n,e[n]])}),"values"),o.Arguments=o.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,n){"use strict";var r,i,o,s,a=n(65),u=n(15),c=n(47),l=n(89),h=n(30),d=n(25),f=n(63),p=n(330),_=n(331),g=n(128),m=n(129).set,y=n(336)(),v=n(90),w=n(130),b=n(131),S=u.TypeError,E=u.process,T=u.Promise,P="process"==l(E),C=function(){},D=i=v.f,O=!!function(){try{var e=T.resolve(1),t=(e.constructor={})[n(14)("species")]=function(e){e(C,C)};return(P||"function"==typeof PromiseRejectionEvent)&&e.then(C)instanceof t}catch(e){}}(),I=function(e){var t;return!(!d(e)||"function"!=typeof(t=e.then))&&t},A=function(e,t){if(!e._n){e._n=!0;var n=e._c;y((function(){for(var r=e._v,i=1==e._s,o=0,s=function(t){var n,o,s=i?t.ok:t.fail,a=t.resolve,u=t.reject,c=t.domain;try{s?(i||(2==e._h&&N(e),e._h=1),!0===s?n=r:(c&&c.enter(),n=s(r),c&&c.exit()),n===t.promise?u(S("Promise-chain cycle")):(o=I(n))?o.call(n,a,u):a(n)):u(r)}catch(e){u(e)}};n.length>o;)s(n[o++]);e._c=[],e._n=!1,t&&!e._h&&R(e)}))}},R=function(e){m.call(u,(function(){var t,n,r,i=e._v,o=M(e);if(o&&(t=w((function(){P?E.emit("unhandledRejection",i,e):(n=u.onunhandledrejection)?n({promise:e,reason:i}):(r=u.console)&&r.error&&r.error("Unhandled promise rejection",i)})),e._h=P||M(e)?2:1),e._a=void 0,o&&t.e)throw t.v}))},M=function(e){return 1!==e._h&&0===(e._a||e._c).length},N=function(e){m.call(u,(function(){var t;P?E.emit("rejectionHandled",e):(t=u.onrejectionhandled)&&t({promise:e,reason:e._v})}))},k=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),A(t,!0))},x=function(e){var t,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===e)throw S("Promise can't be resolved itself");(t=I(e))?y((function(){var r={_w:n,_d:!1};try{t.call(e,c(x,r,1),c(k,r,1))}catch(e){k.call(r,e)}})):(n._v=e,n._s=1,A(n,!1))}catch(e){k.call({_w:n,_d:!1},e)}}};O||(T=function(e){p(this,T,"Promise","_h"),f(e),r.call(this);try{e(c(x,this,1),c(k,this,1))}catch(e){k.call(this,e)}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=n(337)(T.prototype,{then:function(e,t){var n=D(g(this,T));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=P?E.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&A(this,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),o=function(){var e=new r;this.promise=e,this.resolve=c(x,e,1),this.reject=c(k,e,1)},v.f=D=function(e){return e===T||e===s?new o(e):i(e)}),h(h.G+h.W+h.F*!O,{Promise:T}),n(66)(T,"Promise"),n(338)("Promise"),s=n(21).Promise,h(h.S+h.F*!O,"Promise",{reject:function(e){var t=D(this);return(0,t.reject)(e),t.promise}}),h(h.S+h.F*(a||!O),"Promise",{resolve:function(e){return b(a&&this===s?T:this,e)}}),h(h.S+h.F*!(O&&n(339)((function(e){T.all(e).catch(C)}))),"Promise",{all:function(e){var t=this,n=D(t),r=n.resolve,i=n.reject,o=w((function(){var n=[],o=0,s=1;_(e,!1,(function(e){var a=o++,u=!1;n.push(void 0),s++,t.resolve(e).then((function(e){u||(u=!0,n[a]=e,--s||r(n))}),i)})),--s||r(n)}));return o.e&&i(o.v),n.promise},race:function(e){var t=this,n=D(t),r=n.reject,i=w((function(){_(e,!1,(function(e){t.resolve(e).then(n.resolve,r)}))}));return i.e&&r(i.v),n.promise}})},function(e,t){e.exports=function(e,t,n,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(n+": incorrect invocation!");return e}},function(e,t,n){var r=n(47),i=n(332),o=n(333),s=n(24),a=n(83),u=n(334),c={},l={};(t=e.exports=function(e,t,n,h,d){var f,p,_,g,m=d?function(){return e}:u(e),y=r(n,h,t?2:1),v=0;if("function"!=typeof m)throw TypeError(e+" is not iterable!");if(o(m)){for(f=a(e.length);f>v;v++)if((g=t?y(s(p=e[v])[0],p[1]):y(e[v]))===c||g===l)return g}else for(_=m.call(e);!(p=_.next()).done;)if((g=i(_,y,p.value,t))===c||g===l)return g}).BREAK=c,t.RETURN=l},function(e,t,n){var r=n(24);e.exports=function(e,t,n,i){try{return i?t(r(n)[0],n[1]):t(n)}catch(t){var o=e.return;throw void 0!==o&&r(o.call(e)),t}}},function(e,t,n){var r=n(50),i=n(14)("iterator"),o=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||o[i]===e)}},function(e,t,n){var r=n(89),i=n(14)("iterator"),o=n(50);e.exports=n(21).getIteratorMethod=function(e){if(null!=e)return e[i]||e["@@iterator"]||o[r(e)]}},function(e,t){e.exports=function(e,t,n){var r=void 0===n;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)}},function(e,t,n){var r=n(15),i=n(129).set,o=r.MutationObserver||r.WebKitMutationObserver,s=r.process,a=r.Promise,u="process"==n(48)(s);e.exports=function(){var e,t,n,c=function(){var r,i;for(u&&(r=s.domain)&&r.exit();e;){i=e.fn,e=e.next;try{i()}catch(r){throw e?n():t=void 0,r}}t=void 0,r&&r.enter()};if(u)n=function(){s.nextTick(c)};else if(!o||r.navigator&&r.navigator.standalone)if(a&&a.resolve){var l=a.resolve();n=function(){l.then(c)}}else n=function(){i.call(r,c)};else{var h=!0,d=document.createTextNode("");new o(c).observe(d,{characterData:!0}),n=function(){d.data=h=!h}}return function(r){var i={fn:r,next:void 0};t&&(t.next=i),e||(e=i,n()),t=i}}},function(e,t,n){var r=n(39);e.exports=function(e,t,n){for(var i in t)r(e,i,t[i],n);return e}},function(e,t,n){"use strict";var r=n(15),i=n(32),o=n(33),s=n(14)("species");e.exports=function(e){var t=r[e];o&&t&&!t[s]&&i.f(t,s,{configurable:!0,get:function(){return this}})}},function(e,t,n){var r=n(14)("iterator"),i=!1;try{var o=[7][r]();o.return=function(){i=!0},Array.from(o,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!i)return!1;var n=!1;try{var o=[7],s=o[r]();s.next=function(){return{done:n=!0}},o[r]=function(){return s},e(o)}catch(e){}return n}},function(e,t,n){"use strict";var r=n(30),i=n(21),o=n(15),s=n(128),a=n(131);r(r.P+r.R,"Promise",{finally:function(e){var t=s(this,i.Promise||o.Promise),n="function"==typeof e;return this.then(n?function(n){return a(t,e()).then((function(){return n}))}:e,n?function(n){return a(t,e()).then((function(){throw n}))}:e)}})},function(e,t,n){"use strict";var r=n(30),i=n(90),o=n(130);r(r.S,"Promise",{try:function(e){var t=i.f(this),n=o(e);return(n.e?t.reject:t.resolve)(n.v),t.promise}})},function(e,t,n){n(343),n(124),n(348),n(349),e.exports=n(21).Symbol},function(e,t,n){"use strict";var r=n(15),i=n(26),o=n(33),s=n(30),a=n(39),u=n(344).KEY,c=n(45),l=n(85),h=n(66),d=n(46),f=n(14),p=n(132),_=n(91),g=n(345),m=n(121),y=n(24),v=n(25),w=n(40),b=n(79),S=n(62),E=n(126),T=n(346),P=n(347),C=n(32),D=n(49),O=P.f,I=C.f,A=T.f,R=r.Symbol,M=r.JSON,N=M&&M.stringify,k=f("_hidden"),x=f("toPrimitive"),L={}.propertyIsEnumerable,H=l("symbol-registry"),j=l("symbols"),B=l("op-symbols"),U=Object.prototype,W="function"==typeof R,F=r.QObject,q=!F||!F.prototype||!F.prototype.findChild,V=o&&c((function(){return 7!=E(I({},"a",{get:function(){return I(this,"a",{value:7}).a}})).a}))?function(e,t,n){var r=O(U,t);r&&delete U[t],I(e,t,n),r&&e!==U&&I(U,t,r)}:I,z=function(e){var t=j[e]=E(R.prototype);return t._k=e,t},G=W&&"symbol"==typeof R.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof R},Q=function(e,t,n){return e===U&&Q(B,t,n),y(e),t=b(t,!0),y(n),i(j,t)?(n.enumerable?(i(e,k)&&e[k][t]&&(e[k][t]=!1),n=E(n,{enumerable:S(0,!1)})):(i(e,k)||I(e,k,S(1,{})),e[k][t]=!0),V(e,t,n)):I(e,t,n)},K=function(e,t){y(e);for(var n,r=g(t=w(t)),i=0,o=r.length;o>i;)Q(e,n=r[i++],t[n]);return e},Y=function(e){var t=L.call(this,e=b(e,!0));return!(this===U&&i(j,e)&&!i(B,e))&&(!(t||!i(this,e)||!i(j,e)||i(this,k)&&this[k][e])||t)},Z=function(e,t){if(e=w(e),t=b(t,!0),e!==U||!i(j,t)||i(B,t)){var n=O(e,t);return!n||!i(j,t)||i(e,k)&&e[k][t]||(n.enumerable=!0),n}},J=function(e){for(var t,n=A(w(e)),r=[],o=0;n.length>o;)i(j,t=n[o++])||t==k||t==u||r.push(t);return r},X=function(e){for(var t,n=e===U,r=A(n?B:w(e)),o=[],s=0;r.length>s;)!i(j,t=r[s++])||n&&!i(U,t)||o.push(j[t]);return o};W||(a((R=function(){if(this instanceof R)throw TypeError("Symbol is not a constructor!");var e=d(arguments.length>0?arguments[0]:void 0),t=function(n){this===U&&t.call(B,n),i(this,k)&&i(this[k],e)&&(this[k][e]=!1),V(this,e,S(1,n))};return o&&q&&V(U,e,{configurable:!0,set:t}),z(e)}).prototype,"toString",(function(){return this._k})),P.f=Z,C.f=Q,n(133).f=T.f=J,n(64).f=Y,n(88).f=X,o&&!n(65)&&a(U,"propertyIsEnumerable",Y,!0),p.f=function(e){return z(f(e))}),s(s.G+s.W+s.F*!W,{Symbol:R});for(var $="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ee=0;$.length>ee;)f($[ee++]);for(var te=D(f.store),ne=0;te.length>ne;)_(te[ne++]);s(s.S+s.F*!W,"Symbol",{for:function(e){return i(H,e+="")?H[e]:H[e]=R(e)},keyFor:function(e){if(!G(e))throw TypeError(e+" is not a symbol!");for(var t in H)if(H[t]===e)return t},useSetter:function(){q=!0},useSimple:function(){q=!1}}),s(s.S+s.F*!W,"Object",{create:function(e,t){return void 0===t?E(e):K(E(e),t)},defineProperty:Q,defineProperties:K,getOwnPropertyDescriptor:Z,getOwnPropertyNames:J,getOwnPropertySymbols:X}),M&&s(s.S+s.F*(!W||c((function(){var e=R();return"[null]"!=N([e])||"{}"!=N({a:e})||"{}"!=N(Object(e))}))),"JSON",{stringify:function(e){for(var t,n,r=[e],i=1;arguments.length>i;)r.push(arguments[i++]);if(n=t=r[1],(v(t)||void 0!==e)&&!G(e))return m(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!G(t))return t}),r[1]=t,N.apply(M,r)}}),R.prototype[x]||n(31)(R.prototype,x,R.prototype.valueOf),h(R,"Symbol"),h(Math,"Math",!0),h(r.JSON,"JSON",!0)},function(e,t,n){var r=n(46)("meta"),i=n(25),o=n(26),s=n(32).f,a=0,u=Object.isExtensible||function(){return!0},c=!n(45)((function(){return u(Object.preventExtensions({}))})),l=function(e){s(e,r,{value:{i:"O"+ ++a,w:{}}})},h=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!i(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!o(e,r)){if(!u(e))return"F";if(!t)return"E";l(e)}return e[r].i},getWeak:function(e,t){if(!o(e,r)){if(!u(e))return!0;if(!t)return!1;l(e)}return e[r].w},onFreeze:function(e){return c&&h.NEED&&u(e)&&!o(e,r)&&l(e),e}}},function(e,t,n){var r=n(49),i=n(88),o=n(64);e.exports=function(e){var t=r(e),n=i.f;if(n)for(var s,a=n(e),u=o.f,c=0;a.length>c;)u.call(e,s=a[c++])&&t.push(s);return t}},function(e,t,n){var r=n(40),i=n(133).f,o={}.toString,s="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return s&&"[object Window]"==o.call(e)?function(e){try{return i(e)}catch(e){return s.slice()}}(e):i(r(e))}},function(e,t,n){var r=n(64),i=n(62),o=n(40),s=n(79),a=n(26),u=n(120),c=Object.getOwnPropertyDescriptor;t.f=n(33)?c:function(e,t){if(e=o(e),t=s(t,!0),u)try{return c(e,t)}catch(e){}if(a(e,t))return i(!r.f.call(e,t),e[t])}},function(e,t,n){n(91)("asyncIterator")},function(e,t,n){n(91)("observable")},,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=n(2),s=n(7),a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),Object.defineProperty(t.prototype,"isAbortableShakaVersion",{get:function(){var e=parseFloat(this.playerVersion)||0;return!isNaN(e)&&isFinite(e)||(e=2.3),o.Logger.debug("shaka version parsed "+e),e>=2.3},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isVersion3",{get:function(){return(parseFloat(this.playerVersion)||0)>=3},enumerable:!0,configurable:!0}),t.prototype.mergeParams=function(e){var t=this,n=e.player;if(!n)throw new Error("params.player is null");return this.instance=n,Object.assign({qualityGetter:function(){return t.getQuality()},bufferSizeGetter:function(){return t.getBufferSize()}},e)},t.prototype.onStartListening=function(){var t=this;e.prototype.onStartListening.call(this);var n=this.isAbortableShakaVersion?function(e,n,r,i){return t.handleAbortable(e,n,r,i)}:function(e,n,r,i){return t.handle(e,n,r,i)};shaka.net.NetworkingEngine.registerScheme("http",n,3),shaka.net.NetworkingEngine.registerScheme("https",n,3)},t.prototype.onStopListening=function(){var t;e.prototype.onStopListening.call(this),t=this.isAbortableShakaVersion?this.isVersion3?shaka.net.HttpFetchPlugin.parse:shaka.net.HttpFetchPlugin:shaka.net.HttpPlugin,shaka.net.NetworkingEngine.registerScheme("http",t),shaka.net.NetworkingEngine.registerScheme("https",t)},t.prototype.getPlayerName=function(){return"shaka"},t.prototype.getPlayerVersion=function(){return(shaka&&shaka.Player&&shaka.Player.version||"v.2.3.0").replace("v","")},t.prototype.getQuality=function(){var e=this.instance.getVariantTracks().find((function(e){return e&&e.active}));return e&&e.videoId||teleport.Quality.Unknown},t.prototype.getBufferSize=function(){try{var e=this.instance,t=(e.getPlayheadTimeAsDate().getTime()-e.getPresentationStartTimeAsDate().getTime())/1e3,n=e.getBufferedInfo(),r=n&&n.video&&n.video[0]&&n.video[0].end||0,s=r>t?r-t:0;return i.Environment.isDevelopment&&o.Logger.info("getBuffferSize",s),s}catch(e){return this.UNKNOWN_BUFFER_SIZE}},t.prototype.handle=function(e,t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var s,a;return r.__generator(this,(function(r){switch(r.label){case 0:return this.getPathThrowRequest()?[2,shaka.net.HttpPlugin(e,t,n,i)]:(o.Logger.debug("shaka handle "+e),s=this.makeRequestParams(e,t,i),[4,this.execute(s)]);case 1:return(a=r.sent())&&a.payload?[2,{uri:e,data:a.payload,headers:a.headers,fromCache:!1,timeMs:a.timings.ttlb-a.timings.ttfb}]:[4,shaka.net.HttpPlugin(e,t,n,i)];case 2:return[2,r.sent()]}}))}))},t.prototype.handleAbortable=function(e,t,n,i){var s=this;if(this.getPathThrowRequest())return(this.isVersion3?shaka.net.HttpXHRPlugin.parse(e,t,n,i):shaka.net.HttpXHRPlugin(e,t,n,i)).promise;o.Logger.debug("shaka handle abortable "+e);var a=this.makeRequestParams(e,t,i),u=!1,c=r.__awaiter(s,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.execute(a)];case 1:return o=r.sent(),u?[2,Promise.reject(new shaka.util.Error(1,1,7001))]:o&&o.payload?[3,3]:[4,(this.isVersion3?shaka.net.HttpXHRPlugin.parse(e,t,n,i):shaka.net.HttpXHRPlugin(e,t,n,i)).promise];case 2:return[2,r.sent()];case 3:return[2,{uri:e,data:o.payload,headers:o.headers,fromCache:!1,timeMs:o.timings.ttlb-o.timings.ttfb}]}}))}));return new shaka.util.AbortableOperation(c,(function(){return u=!0,s.abort(a),Promise.resolve()}))},t.prototype.makeRequestParams=function(e,t,n){var r;if(s.Runtime.isFunction(n)){var a=0,u=Date.now();r={url:e,headers:t.headers,onProgressCb:function(e){if(e.headers){var t=Date.now()-u,r=e.payload.byteLength||e.loaded,i=parseInt(e.headers["content-length"],10)||0,s=r-a,c=i-r;(t>=100||r===i)&&i>0&&c>=0&&(a=e.payload.byteLength||e.loaded,u=Date.now(),n(t,s,c),o.Logger.debug("onProgressCb deltaTime "+t+", deltaBytes "+s+", remainBytes "+c))}}}}else o.Logger.debugIf(i.Environment.isDevelopment,"progressUpdate not a function"),r={url:e,headers:t.headers};return r},t}(n(92).BaseLoaderPlugin);t.ShakaLoaderPlugin=a,teleport.registerPlugin("media.teleport.loaders.shaka",(function(){return new a}))},,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(353),o={};o[1]=teleport.Quality.Q720P,o[2]=teleport.Quality.Q720PLow,o[3]=teleport.Quality.Q360PHigh,o[4]=teleport.Quality.Q480P,o[5]=teleport.Quality.Q480PLow,o[6]=teleport.Quality.Q144P;var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.mergeParams=function(t){var n=this,r=e.prototype.mergeParams.call(this,t);return Object.assign(r,{urlCleaner:function(e){return n.urlCleaner(e)},durationGetter:function(){return 5},segmentTypeGetter:function(e){return n.getSegmentType(e)},qualityGetter:function(){return n.getQuality()}})},t.prototype.getQuality=function(){var e=this.instance.getVariantTracks().find((function(e){return e&&e.active}));return e&&e.videoId&&o[e.videoId]||teleport.Quality.Unknown},t.prototype.getSegmentType=function(e){return e.indexOf("-caption-")>-1?teleport.SegmentType.Caption:e.indexOf("-audio-")>-1?teleport.SegmentType.Audio:teleport.SegmentType.Video},t.prototype.urlCleaner=function(e){var t=new URL(e).pathname;return t.indexOf(".mpd")?t.replace(/\/1tvdash\.mpd/g,"/1tvdash-mob.mpd"):t},t}(i.ShakaLoaderPlugin);teleport.registerPlugin("media.teleport.loaders.shaka.1tv",(function(){return new s}))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){n(309),n(137),e.exports=n(375)}]);